# 且慢收件箱抓取工具设计文档

## 1. 目标
抓取 `https://qieman.com/inbox` 中的消息，专门过滤来自 "ETF拯救世界" 的内容。
输出应为每条消息的独立 Markdown 文件，包含元数据（日期、标题、URL）和完整内容。

## 2. 架构

### 2.1 技术栈
-   **运行时**: Node.js
-   **浏览器自动化**: Playwright (连接到现有 Chrome 实例)
-   **Markdown 转换**: `turndown`

### 2.2 鉴权策略
-   **方法**: 通过远程调试协议 (CDP) 复用现有 Chrome 窗口。
-   **端口**: 9222 (默认参数 `--remote-debugging-port=9222`)。
-   **优势**: 绕过登录复杂性（验证码、短信等），因为用户已经在主浏览器中登录。

### 2.3 数据流
1.  连接到 Chrome。
2.  导航至 `https://qieman.com/inbox`。
3.  **列表解析循环**:
    -   识别列表中的消息项。
    -   过滤发送者 "ETF拯救世界"（或其他关键词）。
    -   提取基本信息：标题、日期（相对时间如 "2天前" 需转换）、摘要（预览文本）、详情 URL。
    -   **增量检查**: 如果本地已存在相同日期/标题的文件，则停止（除非开启“强制全量”模式）。
    -   **分页**: 点击“加载更多” / 向下滚动以获取更多项目，直到结束或触发增量检查。
4.  **详情获取循环**:
    -   对于发现的每个 *新* 项目：
        -   导航至详情页。
        -   提取完整的 HTML 内容。
        -   转换为 Markdown。
        -   保存到文件。

### 2.4 输出格式
-   **目录**: `qieman-archive/` (或类似)
-   **文件名**: `YYYY-MM-DD-标题.md`
-   **文件内容**:
    ```markdown
    ---
    title: "消息标题"
    date: YYYY-MM-DD HH:mm
    url: https://qieman.com/inbox/...
    summary: "从列表视图提取的摘要..."
    tags: ["ETF拯救世界", "Qieman"]
    ---

    [从 HTML 转换的 Markdown 内容]
    ```

## 3. 实现细节

### 3.1 项目结构
我们将创建一个新目录 `qieman-scraper`，包含：

```text
qieman-scraper/
├── index.js           # 主脚本
├── package.json       # 依赖配置
├── archive/           # 输出目录
└── README.md          # 说明文档
```

### 3.2 关键逻辑：日期解析
相对日期（"11天前"、"2小时前"）需要根据当前运行时间转换为绝对日期。
-   "刚刚" -> 当前时间
-   "N分钟前" -> 当前时间 - N 分钟
-   "N小时前" -> 当前时间 - N 小时
-   "昨天" -> 当前时间 - 1 天
-   "N天前" -> 当前时间 - N 天

### 3.3 关键逻辑："加载更多"
列表页可能使用无限滚动或“加载更多”按钮。
脚本将循环：
1.  选择所有项目。
2.  检查最后一项的日期/ID 是否在于本地归档中。
3.  如果找到重叠 -> 跳出列表循环。
4.  否则 -> 点击“加载更多”，等待网络空闲，重复。
5.  (安全中断：最大 50 页或类似限制以防止无限循环)。

### 3.4 速率限制
-   在详情页导航之间添加随机延迟 (1-3秒) 以对服务器保持友好。

## 4. 工作流

### 4.1 首次运行 (全量)
-   运行脚本。
-   尽可能向回滚动（或直到用户中断）。
-   保存所有 "ETF拯救世界" 的消息。

### 4.2 日常运行 (增量)
-   运行脚本。
-   加载列表。
-   遇到已存在于 `archive/` 中的消息日期/标题。
-   停止滚动。
-   仅处理新项目。
