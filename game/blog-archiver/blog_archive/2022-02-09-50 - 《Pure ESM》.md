---
title: "50 - 《Pure ESM》"
date: 2022-02-09
url: https://sorrycc.com/pure-esm
---

发布于 2022年2月9日

# 50 - 《Pure ESM》

Pure ESM 是指发布的 npm 包只产出 ESM 模块类型，不再产出 CJS 格式，社区上 sindresorhus 在积极地推这件事，他维护的很多包的最新版只提供 ESM，虽然带来一些不便，但也是把社区往 ESM 方向推进。

昨晚尝试把 umi 4 迁到 Pure ESM 模式，由于遇到卡点，未果，详见 [https://github.com/umijs/umi-next/pull/348](https://github.com/umijs/umi-next/pull/348) ，下面做一些记录。

1、现在是否应该迁 Pure ESM？  
2、如何迁移？  
3、有啥跨不过去的坑？  
4、esm 里可以引用 cjs 的包吗？

是否应该迁？想推着社区快速前进？用 Pure ESM。只给 browser 渲染用的包？用 Pure ESM。否则，还是同时产出 CJS + ESM 吧，减少用户在使用时的挫败感。比如 1）用户是 CJS，可以引 ESM，但由于 ESM 的特性，必须改成异步的方式引用，require(‘foo’) 改成 await import(‘foo’)；2）Electron Main 端暂无法使用 ESM，需要一些额外手段，比如先把依赖打包好。

如何迁移？TypeScript 项目参考 [https://gist.github.com/sindresorhus/a39789f98801d908bbc7ff3ecc99d99c#how-can-i-make-my-typescript-project-output-esm](https://gist.github.com/sindresorhus/a39789f98801d908bbc7ff3ecc99d99c#how-can-i-make-my-typescript-project-output-esm) ，我再补几个注意实现。

1、package.json 中 `"exports": "./index.js"` 可以改成 `"exports": { ".": "./index.js" }`，方便扩展  
2、包的子路径比如 `import 'foo/bar'` 必须在 package.json 的 `"exports"` 中声明才能使用，支持通配符，比如 `"./compiled/*": "./compiled/*"`  
2、相对路径的 import 加全路径是迁移过程中改动最大的地方，基本每个文件都得改一遍，比如把 `import foo from './foo'` 改成 `import foo from './foo/index.js'`  
3、`__dirname` 和 `__filename` 没有了，需要用 import.meta.url 中推导得出，分别是 `const __dirname = path.dirname(url.fileURLToPath(import.meta.url))` 和 `const __filename = url.fileURLToPath(import.meta.url)`  
4、require 和 require.resolve 等不能用，需前置一个 `const require = module.createRequire(import.meta.url)`，但注意 require.cache 和 require.extensions 不支持且无法模拟

有啥跨不过去的坑？我遇到的一个是 require.extensions 的实现问题，比如要让配置文件支持 .ts 文件的，需要实时编译 .ts，虽然 esm 也有方案，通过 loader 的方式，但目前没有提供 API，看讨论未来也不会，只能通过命令行参数的形式使用个，比如 node --loader fooLoader。

esm 里可以引用 cjs 的包吗？可以，正常 import 就好。node 运行时是以 package.json 为边界，所以比如 esm 包中一部分要用 cjs，加个 package.json，并且其中不声明 “type”: “module” 即可。

参考：  
[Pure ESM package · GitHub](https://gist.github.com/sindresorhus/a39789f98801d908bbc7ff3ecc99d99c)  
[TypeScript and native ESM on Node.js](https://2ality.com/2021/06/typescript-esm-nodejs.html)  
[Ship ESM & CJS in one Package](https://antfu.me/posts/publish-esm-and-cjs)  
[Modules: ECMAScript modules | Node.js v21.6.1 Documentation](https://nodejs.org/api/esm.html)  
[GitHub - nodejs/loaders: ECMAScript Modules Loaders](https://github.com/nodejs/loaders)
