---
title: "141 - 《手撕源码15：father 4》"
date: 2022-06-28
url: https://sorrycc.com/source-15-father-4
---

发布于 2022年6月28日

# 141 - 《手撕源码15：father 4》

[https://github.com/umijs/father-next](https://github.com/umijs/father-next)

father 是面向 npm 库研发的工具，预计这周会发 4 的 rc。虽然全程参与了设计，但源码是由 dumi 作者辟起操刀的，所以趁着 rc 前翻了一遍源码，提了些 PR 和建议。

father 4 有啥卖点？

1、基于 @umijs/core 的工具实现。所以和 umi 的代码组织、插件体系、配置方式都是一脉相承，这意味着你也可以给 father 写插件了。如果你看过 umi 的源码，看 father 的源码会非常熟悉。除了 @umijs/core，father 还用了 @umijs/bundler-webpack、@umijs/utils 和 @umijs/babel-preset-umi 等底层库。如果你有写工具的需求，并且需要插件体系、配置读取等，这一套可能也适合你。

2、全功能的 npm 包打包工具。支持 umd、esm、cjs，支持 browser 和 node，支持 dts。umd 基于 @umijs/bundler-webpack（背后是 webpack）；esm 和 cjs 是 bundless 的方式，即 src 下的每个文件在 output 目录都会产生一个对应的文件，这个 rfc 时讨论了好久，选择 bundless 是因为相比 bundle 的方式更通用，实现是基于 babel 或 esbuild，esbuild 针对 node 平台产物。

3、prebundle 依赖预打包。这是源于 umi 的功能，这个功能已经帮我们拦截了多次 babel 的 bug 和社区中有问题的包更新。我们把这个功能提取到 father 以让更多人可以实现依赖预打包，让工具更稳定。

4、changelog、release、doctor、deploy、generate 等。这些还没有实现，预期是让 father 成为 all in one 的工具集，所有和 npm 包相关的操作，均可通过 father 完成。

再来看 father 4 的源码和实现。

1、入口是 cli/cli.ts，他会通过定制的 service/service.ts 加载插件集 preset.ts，这里是 father 的功能入口，可以看到各 command 和 feature 的插件列表

2、dev 和 build 最终都会调 builder/index.ts，只是参数不同，前者会加 watch: true，后者会加 clean: args.clean

3、builder 是构建的入口，分 bundle 和 bundless 两类，bundle 适用于 umd 格式，bundless 适用于 cjs 和 esm 格式

4、bundless 忽略掉一些 fixtures、test、.d.ts、md 文件之后，会交给 loader 做文件编译，剩下的直接 copy 到 output 目录；loader 目前有 esbuild 和 babel 两种，platform 为 node 时用 esbuild，为 browser 时用 babel，platform 默认是 browser；bundless 还会根据 tsconfig 的配置做 dts 类型文件的生成，基于 typescript 包的 createCompilerHost 和 createProgram 实现

5、再看 prebundle 命令，包含两部分功能，1）依赖的打包，2）依赖类型的生成。前者基于 ncc；后者基于 @microsoft/api-extractor，由于其不支持 export = 的老版本语法，还加了一层 patch 代码。
