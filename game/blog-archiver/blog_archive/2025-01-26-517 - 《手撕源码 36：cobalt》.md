---
title: "517 - 《手撕源码 36：cobalt》"
date: 2025-01-26
url: https://sorrycc.com/source-35-cobalt
---

发布于 2025年1月26日

# 517 - 《手撕源码 36：cobalt》

![](https://tcc.sorrycc.com/p/136db1b5-a9db-4281-bdbd-3194d1df5ac5.png)

1、[cobalt](https://cobalt.tools/) 是一个网页内容保存和下载工具，可以从各种网站保存视频、音频、图片、GIF 等，支持小红书、Twitter、YouTube、Bilibili 等。之前就看到过，不知道是开源的，今天重新看到，就顺手看了下源码，理解下这些网站的下载逻辑是怎样的。

2、小红书的逻辑很简单，带 UA fetch url 后，拿到 HTML，从 `window.__INITIAL_STATE__` 中拿到数据，然后下载。

```ts
const res = await fetch(url, { headers: { 'user-agent': '...' } });
const html = await res.text();
const data = JSON.parse(html.split('window.__INITIAL_STATE__ = ')[1].split('</script>')[0]);
```

3、Twitter 相对复杂点，分两步。1）拿 guest token，2）从 graphql api 里拿 twitter 信息。

```ts
const graphqlURL = 'https://api.x.com/graphql/I9GDzyCGZL2wSoYFFrrTVw/TweetResultByRestId';
const tokenURL = 'https://api.x.com/1.1/guest/activate.json';

// 1. 拿 guest token
const tokenRes = await fetch(tokenURL, { headers: ... });
const tokenData = await tokenRes.json();
const guestToken = tokenData.guest_token;

// 2. 从 graphql api 里拿 twitter 信息
const url = new URL(graphqlURL);
url.searchParams.set('variables', JSON.stringify({ tweetId: '...' }));
url.searchParams.set('features', ...);
url.searchParams.set('fieldToggles', ...);
const tweetRes = await fetch(url, { headers: ... });
const tweetData = await tweetRes.json();
```

4、YouTube。

没细看他的实现，感觉明显用 yt-dlp 更简单一些。

```bash
$ uv add yt-dlp
```

然后这样即可。

```ts
const ytDlpBinPath = path.resolve(__dirname, '../../.venv/bin/yt-dlp');
await $`${ytDlpBinPath} -f "bestvideo[ext=mp4][height<=720]+bestaudio[ext=m4a]/best[ext=mp4]/best" ${url}`.stdout.pipe(
    process.stdout,
  );
```

5、Bilibili 和小红书的类似，也是 fetch url 后，拿到 HTML，从 `window.__playinfo__` 中拿到数据，然后下载。

```ts
const res = await fetch(url, { headers: { 'user-agent': '...' } });
const html = await res.text();
const data = JSON.parse(html.split('window.__playinfo__ = ')[1].split('</script>')[0]);
```

参考：  
[https://github.com/imputnet/cobalt](https://github.com/imputnet/cobalt)  
[https://cobalt.tools/](https://cobalt.tools/)  
[https://www.swyx.io/youtube-download](https://www.swyx.io/youtube-download)
