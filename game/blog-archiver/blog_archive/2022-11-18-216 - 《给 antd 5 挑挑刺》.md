---
title: "216 - 《给 antd 5 挑挑刺》"
date: 2022-11-18
url: https://sorrycc.com/antd-5-problems
---

发布于 2022年11月18日

# 216 - 《给 antd 5 挑挑刺》

好的就不说了，太多了数不过来。

1、css in js 性能问题

没有具体数据，以下是我的推测。希望 antd 的同学能解我的疑惑。

现在的方案里用的动态插大量 style 的方式，我看 antd 官网里就插了 80 个 style 标签到 head 元素里，这真的不会有性能问题吗？之前参与双 12 时一开始也用的动态插 style 的方式，后来加的样式多了性能实在不行了，禾登同学加入 extract-css-webpack-plugin 提取成单独的 css 后秒解。

动态插 style 为啥有性能损耗？我觉得是这样。1）css 全部变成了 js，要计算后变成 style 标签，所以有计算的消耗，2）js 变大了，有额外的解析 js 文件的消耗 3）css 之前单独成文件，比如用户引入 antd.css，会有更大的缓存命中率。

附 4 和 5 只有 Button 的产物对比。4 是 61K 的 index.css + 46K 的 index.js，5 是 91K 的 index.js。

2、babel-plugin-import

发布稿说「新的 CSS-in-JS 方案原生支持 Tree Shaking，在 v5 你不在需要使用 babel-plugin-import 摘除未使用到的样式。新的方案将自动按需加载样式。」功能上没问题，我试过 dev 和 build 模式下，用 import { Button } from ‘antd’ 和 import Button from ‘antd/es/button’ 的产物尺寸是完全一致的。但是在构建速度上会有差异，因为 tree-shaking 是有消耗的。

我用 hyperfine benchmark 了下，排除了所有其他内容包括 react 和 react-dom，只有 antd 的 Button 的场景，用 babel-plugin-import 相比不用会快 38%（根据用的 antd 组件数量会有不同）。所以基于此，Bigfish 框架里还是会默认带上 babel-plugin-import。

```bash
hyperfine --runs 5 'rm -rf node_modules/.cache && bundler-webpack build'
```

```bash
# with babel-plugin-import
Benchmark 1: rm -rf node_modules/.cache && bundler-webpack.js build
  Time (mean ± σ):      2.283 s ±  0.010 s    [User: 2.164 s, System: 0.289 s]
  Range (min … max):    2.273 s …  2.295 s    5 runs

# without babel-plugin-import
Benchmark 1: rm -rf node_modules/.cache && bundler-webpack.js build
  Time (mean ± σ):      3.692 s ±  0.562 s    [User: 4.503 s, System: 0.659 s]
  Range (min … max):    3.275 s …  4.340 s    5 runs
```
