---
title: "164 - 《手撕源码 23：docusaurus 2》"
date: 2022-08-08
url: https://sorrycc.com/source-23-docusaurus-2
---

发布于 2022年8月8日

# 164 - 《手撕源码 23：docusaurus 2》

docusaurus 是 facebook 出的文档工具，Prettier、Figma Developer、Supabase、StackBliz、Gulp、Tauri、Babel、React Native 等网站都基于 Docusaurus（React 没有用）。umi 最早一段时间的文档也是用 docusaurus，umi 1 还是 0.x 有点忘了，后来才切换的 vuepress 再到 dumi。

docusaurus 提供 build、swizzle、deploy、start、serve、clear、write-translations、write-headings-ids 命令。大部分都可以见名知意，除了 swizzle。swizzle 是一套主题定制方案，可以定制主题和插件提供的各种元素，定制方式包括 wrap 和 eject，前者是包一层，后者是替换，见图 1 GIF。

build 和 start 的实现和元框架（比如 umi）差不多，包括装载配置和插件、生成临时文件和构建。临时文件会生成到 .docusaurus 目录下，包含路由、i18n 和各种元信息，插件也可以生成临时文件。构建基于 webpack，build 会做 client 和 ssr 构建然后根据路由生成 html 文件，start 只做 client 构建同时生成 index.html 给路由 fallback 使用。build 完还会额外做 handleBrokenLinks（处理死链），只针对内链，方法是针对无 protocol 的链接做路由匹配。

webpack 基于 webpack-merge 做配置合并。配置层没啥特别的，1）devtool 用 eval-cheap-module-source-map，相比 umi 的 cheap-module-source-map 更快一些，2）注意到一个 resolve.unsafeCache 配置，但被注释了说效果不明显，3）开 fs cache，themeAliases md5hash 之后计算在内，4）通过 ChunkAssetPlugin 提供 `__webpack_require__.gca`（get chunk asset）信息，用于在 prefetch 方法里获取到 chunk 的真实路径，5）默认合并 CSS 到一个文件，避免顺序问题，配置方法是 `splitChunks: { cacheGroups: { styles: { name: 'styles', type: 'css/mini-extract', chunks:` all`, enforce: true, priority: 50 }}}`。

插件机制比较简单，插件写法比如 export default async function() { return { name, extendCli, configureWebpack, … } }，提供 10+ 方法。实现层 loadPlugin 之后在需要的地方 plugins.forEach 执行。

mdx 基于 @mdx-js/mdx 处理 md 和 mdx 文件，但用的是老版本 1，计划 docusaurus 3 会升级到 2。他们自研了 @docusaurus/mdx-loader 处理 mdx 的编译，其间会加上各种 remark 插件。

client 入口在 packages/docusaurus/src/client/clientEntry.tsx。基于 react + react-router-dom + react-loadable + react-helmet-async 等。路由基于 react-router-dom，注意 react-router-dom 是用的老版本 5，渲染路由基于 react-router-config 的 renderRotues，umi 上个版本是这么用的。内部在 client/exports 下拆了很多文件，可通过 @docusaurus/xxx 访问到。

工程化基于 lerna + yarn + jest + eslint + lint-staged + prettier + typescript 等，没啥亮点。唯一新发现是 yarn-deduplicate，在 postinstall 时执行，解 yarn 1 的 lock 文件中依赖重复的问题。

参考：  
[https://github.com/facebook/docusaurus](https://github.com/facebook/docusaurus)  
[https://docusaurus.io/](https://docusaurus.io/)
