---
title: "289 - 《手撕源码 32：lazyrepo》"
date: 2023-04-17
url: https://sorrycc.com/source-32-lazyrepo
---

发布于 2023年4月17日

# 289 - 《手撕源码 32：lazyrepo》

1、[lazyrepo](https://github.com/ds300/lazyrepo) 看介绍是 0 配置带缓存能力的 task runner，适用于 npm/pnpm/yarn monorepo。 作为 turborepo 的竞品，官网介绍说「虽然是 TypeScript 编写，但速度比 turborepo 快很多。」（HOW？）同时从 commit 上看，作者改了好几次名字，从 butbo 到 daddyrepo 再到 lazyrepo。

2、怎么用？

先安装依赖。

```bash
$ pnpm i lazyrepo -Dw
```

然后初始化配置。

```bash
$ npx lazy :init
```

再用 npx lazy 代替 pnpm 执行命令。

```bash
$ npx lazy test packages/*-utils
```

3、lazyrepo 还内置了一些命令，包括 :init、:clean、:inherit 和 :run。1）加 `:` 前缀的方式比较贴心，可以和 package.json scripts 里定义的命令区分开来，2）:inherit 解决在多个 package 里重复写一条命令的繁琐。

4、源码照例从前几个 commit 开始看会比较容易上手。以用户执行 `npx lazy test` 为例，看看是怎么实现的。

基本流程是，1）找到所有 package，2）把 packages 做拓扑排序，3）找到所有包含 test 命令的 package，然后按需执行。怎么按需执行？1）如果有 manifest，更名为 prev manifest，2）生成当前 manifest，3）比对前后两次的 manifest，如果不不同，则执行命令，否则不执行。怎么生成 manifest？1）包含两部分信息，env 和 file，2）env 即环境变量，3）file 信息通过 glob 拿文件列表，然后针对每个文件做 sha256 hash 计算，4）排序。
