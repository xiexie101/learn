---
title: "157 - 《手撕源码 20：zustand》"
date: 2022-07-27
url: https://sorrycc.com/source-20-zustand
---

发布于 2022年7月27日

# 157 - 《手撕源码 20：zustand》

zustand 昨天（2022.7.26）发布了 4.0，趁这个机会翻翻源码。

zustand 目前的维护者是 Daishi Kato，应该很多人都很熟悉吧。Github ID dai-shi，自由职业者，来自日本，状态库大师。除了 zustand，valtio、jotai、react-tracked、use-context-selector 等也都出自他手。他今年还写了本书《Micro State Management with React Hooks》和录制了 EggHead 的视频《Complex State Management in React with Jotai and XState》。

zustand 是和 redux、dva 类似的数据流方案，都属于 immutable state 的数据流。但相比来说，zustand 在 TypeScript 方面支持地更好。

先看使用方式。

```ts
// 1、定义 store
const useCountStore = create(set => ({
 count: 0,
 add: () => set(state => ({ count: state.count + 1 })),
});
// 2.1、hook 方式使用 store
const { cont, add } = useCountStore();
// 2.2、非 hooks 方式使用 store
const { getState, setState, subscribe, destory } = useCountStore;
```

再看源码。看之前其实没想到 19K Star 的代码居然如此简单。我提取了下 zustand 的主逻辑代码，[仅 42 行](https://gist.github.com/sorrycc/9c66208de6c2e4c0b981ad5f02aa91e5)。1）create 后拿到的是一个 hook，可以在组件或 hook 里使用，2）为了方便在 hook 外使用，导出了getState、setState 等额外的 API，3）useStore 基于 React 官方提供的 useSyncExternalStore 之后变得格外简单，只需一个函数调用完成 store 到 hook 的转换。

剩下的其他代码用于实现类型、中间件、Context 模式等。实现类型的代码量应该是正常代码的 2-3 倍，为了支持 TypeScript 也算是尽心尽力了；中间件和 redux 的机制差不多，把 store creator 包起来，这样中间件层就可以通过修改 api 方法实现扩展，zustand 内置了redux、immer、persist、devtools 等 6 个中间件；Context 模式我猜是为 ssr 等需要 Provider 提供数据的场景准备的，但一旦切换到这种模式，使用起来就相对需要多一点代码了。

参考：  
[https://github.com/pmndrs/zustand](https://github.com/pmndrs/zustand)  
[https://www.amazon.com/dp/1801812373](https://www.amazon.com/dp/1801812373)  
[https://egghead.io/courses/complex-state-management-in-react-with-jotai-and-xstate-3be0a740](https://egghead.io/courses/complex-state-management-in-react-with-jotai-and-xstate-3be0a740)  
[https://github.com/pmndrs/zustand/wiki/Difference-between-zustand-and-valtio](https://github.com/pmndrs/zustand/wiki/Difference-between-zustand-and-valtio)  
[https://gist.github.com/sorrycc/9c66208de6c2e4c0b981ad5f02aa91e5](https://gist.github.com/sorrycc/9c66208de6c2e4c0b981ad5f02aa91e5)
