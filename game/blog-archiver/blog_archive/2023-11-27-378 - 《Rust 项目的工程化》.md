---
title: "378 - 《Rust 项目的工程化》"
date: 2023-11-27
url: https://sorrycc.com/rust-engineering
---

发布于 2023年11月27日

# 378 - 《Rust 项目的工程化》

1、项目的 Rust 版本可以在 rust-toolchain.toml 里声明且可以考虑用 nightly 版。比如写构建工具的应该都是用的 nightly，因为大家都重度依赖 swc，而涉及 ast 操作时有 box\_patterns feature 提供的 box 析构写起来会简洁很多。这个 feature 目前只在 nightly 里提供。比如。

```rust
#![feature(box_patterns)]
if let ModuleItem::Stmt(Stmt::Expr(ExprStmt {
    expr: box Expr::Call(CallExpr { args, .. }),
    ..
})) = stmt {}
```

2、前端任务大家都是用 package.json 的 scripts 管理，而 rust 下，常用做法是用 just + tasks crates 来管理。just 在 justfile 里声明任务，支持 alias，支持组合等，配置上比 package.json scripts 灵活；然后在项目下新增 tasks 目录，里面的 crates 是 rust 编写的脚本，用于实现自定义任务。

```rust
#!/usr/bin/env -S just --justfile

_default:
  @just --list -u

alias r := ready

init:
  cargo binstall cargo-edit

ready
  typos
  cargo fmt
  just test
```

3、cargo-binstall 和 cargo install 类似，其中的 b 表示 Binary。顾名思义，binstall 是下载预编译好的 Binary 而非从源码编译。优点是快，可用于本地安装 cargo 扩展包，也可用于 CI 提速。

```bash
$ cargo install cargo-binstall
$ cargo binstall cargo-nextest cargo-watch cargo-insta typos-cli taplo-cli cargo-llvm-cov cargo-edit wasm-pack -y
```

4、测试可以用 cargo test，但更推荐用 cargo-nextest，下一代的 test？优点是不仅界面更好看，同时速度也更快，3X？此外，可以用 cargo-insta 实现 snapshot，用 llvm-cov 实现测试覆盖率，用 pretty\_assertions 代替 assert\_eq! 和 assert\_ne! 实现有颜色的 DIFF。

```bash
$ cargo nextest run
$ cargo insta review
$ cargo codecov --html
```

5、Rust 中 Lint 和 Format 是分开的，就像 ESLint 和 Prettier 一样。Lint 统一用 Clippy，同时可以新增一个 CODE\_STYLE\_GUIDE.md 文件，向开发者补充一些代码规范；Format Rust 文件用官方的 cargo fmt 即可，但除了 Rust，toml 可以用 taplo-cli，JavaScript 可以用 rome。

```rust
#[allow(clippy::module_inception)]
```

6、typos-cli 可用于检查 typos，以避免一些低级错误。typos 有配套的 VSCode 插件，可以一起安装，在编辑时就发现问题，不用等到 CI 阶段。typos-cli 推荐非 Rust 工程也可以用起来，让你的代码更专业。

参考：  
[https://github.com/casey/just](https://github.com/casey/just)  
[https://github.com/cargo-bins/cargo-binstall](https://github.com/cargo-bins/cargo-binstall)  
[https://github.com/tamasfe/taplo](https://github.com/tamasfe/taplo)  
[https://github.com/crate-ci/typos](https://github.com/crate-ci/typos)  
[https://nexte.st/](https://nexte.st/)  
[https://github.com/rust-pretty-assertions/rust-pretty-assertions](https://github.com/rust-pretty-assertions/rust-pretty-assertions)  
[https://github.com/rust-lang/rust-clippy](https://github.com/rust-lang/rust-clippy)
