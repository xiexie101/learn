---
title: "449 - 《从 0 实现 Rust 构建工具》"
date: 2024-06-16
url: https://sorrycc.com/write-rust-bundle-from-0
---

发布于 2024年6月16日

# 449 - 《从 0 实现 Rust 构建工具》

> 本文是 2024.06.28 将在 SECon 上分享的主题的第二部分，先写个文字稿。

> sorrycc/toy-mako 的仓库会在分享那天公开。

和大家分享下如何从 0 实现一个 Rust 构建工具，我把很多内容和功能都做了简化，让大家可以花 10 分钟大概理解一个构建工具的构成。如果你想自己实现一个，或者参与贡献，或者遇到问题有个大致的思路，了解构建工具的原理还是有必要的。

1、

首先，我们需要一点前置知识。分两部分，1）Rust 语言基础，2）前端构建领域知识。当然，如果不会 Rust 也没关系，这里不涉及具体语法，用 JS 也可以完成，只是使用到的相关依赖时需要替换为 JS 生态的版本。

2、

![](https://res.cloudinary.com/sorrycc/image/upload/v1718438449/blog/nkzv9520.png)

如果你是 Rust 0 基础，关于如何学 Rust，我有一些建议。个人的经验是 B 站视频快速打底，推荐下这个 B 站频道的免费课程，这是对应一本书的视频讲解，我个人和身边的一些同事都是先 2 倍速快速过完他，对整体的 Rust 体系会有个整体的了解；然后再看电子书时就比较顺畅，通过电子书做系统学习和深入；再就是多实践，不写容易忘，肯定每个人身边都有一些学过 N 边 Rust 的同学吧；最后，遇到不懂可以问身边会 Rust 的同学，或者 AI。

3、

![](https://res.cloudinary.com/sorrycc/image/upload/v1718517739/blog/qcz6e7ev.png)

再就是「前端构建」的领域知识了。关于这部分，Google 出的 bundlers.tooling.report 上有详细介绍，我对此做了一些梳理，同时补充了一些个人觉得应该需要的点。

4、

![](https://res.cloudinary.com/sorrycc/image/upload/v1718518416/blog/tfa7quwtab.png)

先看一下 Mako 完整的构建流程，主要分两个阶段，Build 和 Generate。其实大部分构建工具都大同小异，Esbuild、Farm、Webpack 等，基本都是这个流程，做的功能也都类似，只是取名、顺序、整体设计、边界场景处理、特色功能、业务场景等方面可能有所不同。

Build 阶段的输入是文件列表和配置，输出是模块图谱；Generate 阶段的输入是模块图谱，输出是以 chunk 为维度的代码，以及和这个代码相关的 sourcemap、manifest 等。

5、

![](https://res.cloudinary.com/sorrycc/image/upload/v1718523409/blog/pvfvvy0j.png)

如果大家用过 Webpack，应该都有配置过入口文件，而 Build 阶段的输入就是入口文件，输出是一个模块图谱。由于文件可能存在依赖，我们需要一个队列来保存它。而要输出模块图谱，我们需要对每个进入到队列的文件做 load、parse、transform、analyze deps 和 resolve 等操作。

6、

![](https://res.cloudinary.com/sorrycc/image/upload/v1718523709/blog/84prjmhb.png)

然后把中间这个过程拆开，以一个简单的 JS 文件为例，看下他在 Build 过程中是怎么流转的。

1）文件首先是路径  
2）经过 load 之后通常会转换为文本内容，但也有不少例外，比如图片、WASM 等，会需要输出一个虚拟的 js 模块来指向他  
3）parse 是把 js 代码转成 ast，ast 是写构建工具必不可少的知识，至少有 1/3 的时间你会需要和 ast 打交道  
4）transform 是把一份 ast 转换成另外一份，这里做的事情比如你是用 typescript 写的代码，这里面会包含类型，而浏览器是不认类型的，就需要把类型去掉，再比如你用了一些高级语法，这在一些低版本浏览器里也是不认的，就需要转换成功能相同但略微复杂的低版本浏览器认的等同实现  
5）analyze deps 是依赖分析，比如你 import 了 a，那 a 就是这个文件（模块）的依赖  
6）为啥有 resolve 这个步骤？因为 a 并没有关联到具体的文件路径，或者你用了相对路径的依赖，或者你写依赖的时候没有指定扩展名，如何决定这个 a 背后应该关联到具体哪个文件路径，就是 resolve 要做的事情

然后这个流程结束，有了新的依赖路径，我们把这个依赖放到构建队列里开始新的流程。以此往复，就能形成一个模块图谱。

7、

![](https://res.cloudinary.com/sorrycc/image/upload/v1718525386/blog/2ul2vf7y.png)

这是 Build 阶段的代码实现以及执行后打印 Module Graph 的效果，具体代码见这个链接，我故意写在了一个文件里，同时省去了不必要的细节。AST 部分的处理基于 SWC，大家可以想象成是 Rust 界的 Babel，resolve 基于 oxc\_resolver，这应该是目前大部分构建工具的选择。同时，Module Graph 为了简单，我只用了 HashMap。而通常正式写时大家可能会倾向于用一个图的库，比如 petgraph 。

8、

![](https://res.cloudinary.com/sorrycc/image/upload/v1718525844/blog/iof8fk8g.png)

如果说 Build 阶段的复杂度是 10，那 Generate 阶段的复杂度可能是 50。

Generate 阶段先会拿着上一阶段生成好的模块图谱，先对图做优化，比如 tree shaking、模块合并、chunks 的分组和优化等，然后会针对每个模块，处理他的模块系统（比如 esm 转 cjs）、替换依赖、注入 helpers 等。最后就是处理 chunk，把 chunk 里的 ast 转成代码，以及用一个 Runtime 把所有代码串起来。

9、

![](https://res.cloudinary.com/sorrycc/image/upload/v1718526789/blog/6gpce2tw.png)

这是 Generate 阶段的代码实现，以及执行后的效果，具体代码见这个链接。为了简化，这里省去大量 Module Graph 的优化处理，以及 Chunks 的处理，然后用了一个简单的 Runtime 把整体串起来能跑。如果大家感兴趣，后续可以关注这个仓库地址，我如果有时间会逐步迭代，把这个写成一个系列。

10、

![](https://res.cloudinary.com/sorrycc/image/upload/v1718527196/blog/s3ahbr08.png)

好了，如果你成功到这一步，那么恭喜你，这已经是一个能跑的构建工具了。就像右边这个图，我们已经画好两个圆了。剩下的就是花时间去完善剩下的功能缺失、边界场景、构建速度、产物性能、研发体验等等，以及去满足特定的业务场景。

11、

![](https://res.cloudinary.com/sorrycc/image/upload/v1718528008/blog/ypycbd51.png)

比如说功能缺失，我们已经完成了 5 个功能的基本实现，还剩下 95 个等着大家。。

12、

![](https://res.cloudinary.com/sorrycc/image/upload/v1718528590/blog/en34xelv.png)

举个边界场景的例子，先看 CSS 的。大家能看出这段 CSS 有啥问题吗？（互动）

13、

![](https://res.cloudinary.com/sorrycc/image/upload/v1718528735/blog/bg55sxrj.png)

略。

14、

![](https://res.cloudinary.com/sorrycc/image/upload/v1718528765/blog/c2bicbra.png)

略。

15、

![](https://res.cloudinary.com/sorrycc/image/upload/v1718528790/blog/dirwet5g.png)

再就是构建速度。这是我们用 Rust 写构建工具的根本原因，Mako 在这方面也有一些优势和积累，下一部分我们就和大家详细聊聊我们在这方面所用到的各种方案。

参考：  
\[\[SECon 2024 深圳\]\]  
[444 - 《Mako：用 Rust 实现极速的构建工具 - 大纲》](https://sorrycc.com/mako-a-rust-based-fast-bundler)  
[369 - 《如何开发构建工具》](https://sorrycc.com/how-to-write-bundler)  
[443 - 《分享：Rust 构建工具在蚂蚁的研发和落地》](https://sorrycc.com/rust-bundle-tool-at-antgroup)
