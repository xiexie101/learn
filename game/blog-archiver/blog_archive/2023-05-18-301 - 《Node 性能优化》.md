---
title: "301 - 《Node 性能优化》"
date: 2023-05-18
url: https://sorrycc.com/node-performance-optimization
---

发布于 2023年5月18日

# 301 - 《Node 性能优化》

Vite 4.3 在启动时间和 HMR 方面都有长足的提升，冷启动提升 400%+，HMR 提升 70%，具体见参考 [How we made Vite 4.3 faaaaster 🚀 | sun0day’s blog - lost in code](https://sun0day.github.io/blog/vite/why-vite4_3-is-faster.html) 这篇文章。本文会先分析 Vite 4.3 做了啥，然后聊下我对 Node 性能提升部分的看法。

Vite 4.3 的性能提升都做了啥？

1、不用 resolve 库，改成自己实现，更简单、严格、准确，同时利用缓存。这是大头，应该占了提升了 80%？  
2、用 fs.realpathSync.native 代替 fs.realpathSync，后者慢 70 倍  
3、阻塞式改非阻塞式，比如 fs.readFileSync 改成 fs.readFile，这样不会阻塞主线程  
4、HMR 更新缓存，比如 A>B>C 和 A>B>D 两个依赖链，A 编辑更新后会同事更新两个依赖链，此时 A 和 B 需要被处理两遍，再加 cache 或 debounce 之后就只需处理一遍了，这对于 git checkout 的场景的提升尤其有效  
5、并行，比如用 Promise.all 代替 for 循环  
6、=== 相比 startsWith 和 endsWith 快 20% 到 60%  
7、避免重复创建正则表达式

我的感受是。1）前四个优化是需要的，后 3 个感觉有点「过度优化」，为了小优化把代码改地复杂可能会提高维护成本，最后反而得不偿失，2）resolve 确实是很多构建工具优化到极致之后的的性能问题关键所在，3）如果要进一步优化，应该只剩把瓶颈实现改用原生语言这一条路了。

如何做 Node 性能优化？

1、不要过度优化。应该每本讲性能优化的书都会这么说，但实操时大家还是因为各种原因过度研究和做性能上的优化。

2、确定慢的类型和痛点。是 CPU 密集型的慢，还是 I/O 密集型的慢，或者是内存使用过高？不同类型会有不同的解。要确定这点，通常需要先 Profile Node 应用。分两步，1、跑 Node 时加 `--cpu-prof` 参数，比如 `node --cpu-prof $(which npm) run version`，结束后会产出一个或多个 `.cpuprofile` 文件，2、打开 [https://www.speedscope.app/](https://www.speedscope.app/) 上传文件即可查看火焰图，包含详细的堆栈信息。参考[这个](https://t.me/yqtalk/184)和[这个](https://marvinh.dev/blog/speeding-up-javascript-ecosystem-part-4/)。

3、优化代码。1）CPU 密集型的慢常见的解比如优化算法、优化方案、基于 Worker 实现多线程、换原生语言等，2）I/O 密集型的慢，通常利用 Node 的异步特性就好了，减少阻塞，或者比如使用流来大文件，3）缓存应该是不分类型的通用解，缺点是针对首次执行无效。

4、注意程序外的优化。可以带来意想不到的结果，比如换硬件，M2 Max 相比 Intel 可能会有 5-10 倍的差异；比如升 Node 版本或依赖库的版本，新版本往往会包括性能改进，除了 Node 版本，比如前面的 Vite 4.2 到 Vite 4.3，Webpack 4 到 Webpack 5，都属于这类。

5、还有一些优化 Umi 时尝试过有效的点。1）打包依赖，把程序打包成一个或数个文件，或者把依赖做打包，其中一个优点就是性能提升，因为文件 IO 少了，2）lazy import，或者叫按需加载，只加载需要的部分，3）`require('v8-compile-cache')`。

6、还有个建议是要建立 Benchmark 库和 CI Action。如果每个 PR 都能看到提升或降低了多少，那你和你的团队就会更关注性能。比如 [GitHub - vitejs/vite-benchmark: Benchmark tool for vitejs/vite](https://github.com/vitejs/vite-benchmark) 。

参考：  
[How we made Vite 4.3 faaaaster 🚀 | sun0day’s blog - lost in code](https://sun0day.github.io/blog/vite/why-vite4_3-is-faster.html)  
[Speeding up the JavaScript ecosystem 系列](https://marvinh.dev/blog/speeding-up-javascript-ecosystem-part-5/)  
[77 - 《火焰图与 Umi Cli 性能 5 倍提升》](https://sorrycc.com/flame-graph-and-umi-cli)
