---
title: "408 - 《分享：蚂蚁前端框架历史》"
date: 2024-01-29
url: https://sorrycc.com/antfin-framework-history
---

发布于 2024年1月29日

# 408 - 《分享：蚂蚁前端框架历史》

![](https://img.alicdn.com/imgextra/i2/O1CN014ZJF2K1XjjHFkqGVz_!!6000000002960-0-tps-1920-1282.jpg_1200x1200.jpg)

题图：joannakosinska @ unsplash.com

> 感谢 @灏辰 邀请，这是应要求新写的一篇命题作文，和大家聊聊蚂蚁前端框架、构建和数据流的历史，时间是 15 分钟。为啥要把这些混着聊呢？因为最早我们的方案里是没有框架的，只有数据流和脚手架，迭代到后期才开始做框架。

> 本篇不包含蚂蚁的移动端框架历史。

**1、Roof。**

最早是 Roof，作者是 @加缪。Roof 不是框架，而是一个数据流方案。为啥叫 Roof？这和 Node 框架 Chair 还有一点点联系。Roof 经历了好几个版本，最早的可用版本 0.4，很多概念是由 [baobab](https://github.com/Yomguithereal/baobab) 而来，基于 cursor 设计了针对复杂场景的解法。然后随着 Redux 的流行，Roof 的 0.5 提供了 createRootContainer 和 createContainer，实现类似 react-redux 里 Provider 和 connect 的功能。

```ts
// 定义 state
createRootContainer({
  user: { name: 'chris', age: 30 }
})(App);

// 绑定 state
createContainer({
  myUser: 'user',
})(UserInfo);
```

**2、Redux。**

![](https://img.alicdn.com/imgextra/i3/O1CN01xBjsSV1ijEciMJR9U_!!6000000004448-2-tps-3440-3109.png_160x160.jpg)

随着 Redux 的继续流行，大家更倾向于直接使用 Redux。虽然 Roof 迭代了几个版本，越来越像 Redux，但到 0.5.6@beta 之后就停滞了，大家开始考虑拥抱 Redux。

![](https://img.alicdn.com/imgextra/i2/O1CN01AbPa9G1DjSjM6EAr5_!!6000000000252-2-tps-998-530.png)

但 Redux 本身是个很小的库，他本身并没有针对很多问题的解，比如异步、路由等，当时我还画了上面这张图。这看起来是个缺点，但回头看我觉得是优点。没有解决同时提供了插件机制意味着给社区留下了很大的空间，当时社区有非常多的方案。比如异步这块有 redux-thunk、redux-promise 和 redux-saga 等，然后我们选择了 redux-saga。

**3、Dva。**

![](https://img.alicdn.com/imgextra/i3/O1CN01kTWLPx1OFCKfQ2YOz_!!6000000001675-2-tps-350-350.png_160x160.jpg)

基于 redux 虽然灵活，但对团队而言，灵活不是我们想要的，因为灵活也会带来非常大的应用治理成本。同时，虽然 redux-saga 很强大，但也有saga 创建麻烦、脚手架代码多等问题。

```ts
function *userCreate() {
  try {
    // Your logic here
  } catch(e) {}
}
function *userCreateWatcher() {
  takeEvery('user/create', userCreate);
}
function *rootSaga() {
  yield fork(userCreateWatcher);
}
```

![](https://img.alicdn.com/imgextra/i4/O1CN01RQ3Qq11ig1q9Zjwup_!!6000000004441-2-tps-1614-486.png)

所以我们就有了 dva。

```tsx
import React from 'react';
import dva, { connect } from 'dva';
import { Route } from 'dva/router';

// 1. Initialize
const app = dva();

// 2. Model
app.model({
  namespace: 'count',
  state: 0,
  reducers: {
    ['count/add'  ](count) { return count + 1 },
    ['count/minus'](count) { return count - 1 },
  },
});

// 3. View
const App = connect(({ count }) => ({
  count
}))(function(props) {
  return (
    <div>
      <h2>{ props.count }</h2>
      <button key="add" onClick={() => { props.dispatch({type: 'count/add'})}}>+</button>
      <button key="minus" onClick={() => { props.dispatch({type: 'count/minus'})}}>-</button>
    </div>
  );
});

// 4. Router
app.router(
  <Route path="/" component={App} />
);

// 5. Start
app.start(document.getElementById('root'));
```

**4、atool-build、dora 和 Roadhog。**

![](https://img.alicdn.com/imgextra/i3/O1CN012wz95T1mMZTVVtP1p_!!6000000004940-2-tps-1100-1100.png_160x160.jpg)

前面是数据流的时间线，下面介绍下构建工具的时间线，简单说就是从 [atool-build](https://github.com/ant-tool/atool-build) + [dora](https://github.com/dora-js/dora) 到 [roadhog](https://github.com/sorrycc/roadhog)。atool-build 是基于 webpack 的构建工具，提供 build 命令，dora 是提供了 dev 命令。dora 有插件机制，atool-build 的配置和 webpack 一样，基于编程。这两种扩展方式都太灵活，灵活是优点，但导致我们做功能升级时需要考虑太多的事情，并且无法保证兼容。

roadhog 把 atool-build 和 dora 的功能做了合并，并改用了配置式，同时从 create-react-app 里学习了很多先进的功能。

![](https://img.alicdn.com/imgextra/i1/O1CN01kNCl1g1D1x5uojhwm_!!6000000000157-1-tps-1584-891.gif)

**5、Umi 和 Bigfish。**

![](https://gw.alipayobjects.com/zos/rmsportal/CZcJsXOXCqIbglBjTrWs.png_160x160.jpg)

最早的 Umi 是黄色系的，后面才改成蓝色系。

Umi 的由来有些坎坷。在 dva 之后，然后我们有 twa 的理念。然后不知道为啥，要分拆无线和 PC 两套方案。徐飞做 koi，开发了新的 model 库 twa-model，面向无线；水鱼做 bigfish，用 dva 加 react-router，面向 PC。而当时我所在的组负责对外 ISV 的无线方案，也需要一套方案。

中间略去很多讨论、迭代、组织结构调整。最终，koi 消失，koi-core 更名为 umi，定位为通用框架，对外开源，Bigfish 基于 umi 实现，定位对内的 PC 业务。

![](https://img.alicdn.com/imgextra/i1/O1CN01bGY10x1z17wqil6kS_!!6000000006653-2-tps-2726-1182.png)

从这个阶段开始，蚂蚁的前端方案把数据流和构建两条线合到了一起，框架即编译器，[上面的这篇文章](https://tomdale.net/2017/09/compilers-are-the-new-frameworks/)对这个阶段的框架影响很深。

![](https://img.alicdn.com/imgextra/i4/O1CN01t074hx1l1fnbE0uJs_!!6000000004759-2-tps-2558-1218.png)

Bigfish = Umi + 对内的插件集。Bigfish 的意义就如这张图所示，社区有太多方案，哪些是好的，哪些是不好的，由大家讨论之后，然后选择最佳实践集成到框架里，然后大家用一致的方案。然后，大家只要装一个 Bigfish 依赖即可。

![](https://img.alicdn.com/imgextra/i4/O1CN01hLDAJe1gz99QOfxZQ_!!6000000004212-2-tps-3430-1126.png)

然后就是长达 5 年+ 的迭代，目前 Umi 和 Bigfish 都已经是 4.0 的版本了。

**6、Mako。**

时间回到 2023 年，大家都认同[《Rust 是 JavaScript 基建的未来》](https://leerob.io/blog/rust)，同时蚂蚁大量中台项目，依赖非常大，构建非常慢，虽然我们也有做 MFSU 等构建提速方案，但只能解部分场景下的问题。不进则退，所以我们也立项做「基于 Rust 的新前端研发态」。

![](https://img.alicdn.com/imgextra/i2/O1CN01zr4hLP1snUSdEOa1O_!!6000000005811-2-tps-2716-1514.png)

耗时半年多，Mako 对内正式发布，预计明年 6 月开源。Mako 现阶段是构建器，但我们志不仅在此，构建是第一个里程碑，后续也可能演化成框架。

参考：  
[React + Redux 最佳实践 – 云谦的博客](https://sorrycc.com/react-redux-best-practice/)  
[支付宝前端应用架构的发展和选择 – 云谦的博客](https://sorrycc.com/antfin-roadmap/)  
[dva 1.0 – 基于 react 和 redux 的轻量级框架 – 云谦的博客](https://sorrycc.com/dva)  
[从 roof@0.5 到 dva](https://yuque.antfin.com/dva/docs/from-roof-0.5-to-dva)  
[发布 Umi 1.0 – 云谦的博客](https://sorrycc.com/umi-1/)  
[如何评价支付宝新出的框架 五米？ - 知乎](https://www.zhihu.com/question/266579173)  
[Umi 的由来](https://yuque.antfin.com/yunqian/blog/umi-history)  
[那些年的体验技术部](https://www.yuque.com/afx/about/those-days)  
[RFC#1 基于 Rust 的新前端研发态](https://yuque.antfin.com/default-break/start/glhz1eikorpuysid)
