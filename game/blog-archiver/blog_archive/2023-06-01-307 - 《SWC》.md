---
title: "307 - 《SWC》"
date: 2023-06-01
url: https://sorrycc.com/swc
---

发布于 2023年6月1日

# 307 - 《SWC》

最近一直在和 SWC 相爱相杀。

1、SWC 是啥？SWC 是 Babel 的替代品，单线程比 Babel 快 20 倍，4 核 CPU 上比 Babel 快 70 倍。作者是 kdy1，97 年的韩国程序员，真名강동윤，他在 2017 年开始写 SWC，那一年他 20 岁，上大二。

2、SWC 怎么用？

分三个方向，JS、Rust 和 CLI。SWC 提供多个 JS 方式的库，比如 @swc/core、@swc/wasm-web、swcMinify、swc-loader、@swc/jest 等，可以和测试、构建、webpack 等工具集成使用，现在的应用大部分都是基于此类；同时如果你要开发 Rust 工具，还可以基于 SWC 底层 crate（相当于 npm 包）实现各种功能，效率也更高；CLI 就是 @swc/cli 这个包，可以做文件的 Transpile 操作。

@swc/core。

```ts
import swc from '@swc/core';
// transform
const result = await swc.transform(code, opts);
// parse to ast
const ast = await swc.parse(code, opts);
```

@swc/wasm-web。

```ts
import initSwc, { transformSync } from '@swc/wasm-web';
await initSwc();
const result = transformSync(code, opts);
```

@swc/jest。

```ts
module.exports = {
  transform: {
    "^.+\\.(t|j)sx?$": "@swc/jest",
  },
};
```

3、如何基于 SWC 开发插件？

SWC 插件我记得之前是可以用 JavaScript 开发的，后来由于性能上的考虑，只有基于 Rust 开发的了。然后产出 crate 和 WASM 分别给 Rust 和 JavaScript 生态使用。官网有 swc\_cli 和 swc\_plugin 两个包来辅助开发。

```bash
$ cargo install swc_cli
$ swc plugin new --target-type wasm32-wasi first-plugin
$ rustup target add wasm32-wasi
```

插件长这样。

```rust
pub struct TransformVisitor {}
impl VisitMut for TransformVisitor {
  // https://rustdoc.swc.rs/swc_ecma_visit/trait.VisitMut.html
}
```

开发插件必然会接触 AST，SWC 的 AST 和 Babel 的略有不同，可以在 [SWC Playground – SWC](https://swc.rs/playground) 或 [AST explorer](https://astexplorer.net/) 查看 AST 结构。

4、在 Rust 里如何使用 SWC ？

我理解分三块，1）code to ast，2）transform ast（含压缩等优化措施），3）ast to code（含 sourcemap 生成）。

code to ast

```rust
let cm = Default::default();
let fm = cm.new_source_file(filename, code);
let syntax = Syntax::Typescript(TsConfig { ..Default::default() });
let lexer = Lexer::new(syntax, swc_ecma_ast::EsVersion::Es2015, StringInput::from(&*fm), None);
let mut parser = Parser::new_from(lexer);
let ast = parser.parse_module().unwrap();
ast
```

transform

```rust
let cm = cm.clone();
let globals = Globals::default();
GLOBALS.set(&globals, || {
  ast.visit_mut_with(&mut react { ... });
  // ... more visit_mut here
  // 前面写的 swc 插件也可以放这
});
```

optimize（压缩等）

```rust
let cm = cm.clone();
let unresolved_mark = Mark::new();
let top_level_mark = Mark::new();
let mut ast = optimize(
	ast.into(),
	cm.clone(),
	None,
	None,
	&MinifyOptions { ..Default.default() },
	&ExtraOptions { unresolved_mark, top_level_mark },
)
.expect_module();
```

ast to code

```rust
let cm = cm.clone();

// generate code
let mut buf = vec![];
let mut emitter = Emitter {};
emitter.emit_module(&ast).unwrap();
let code = String::from_utf8(buf).unwrap();

// generate source map
let src_buf = build_source_map(&source_map_buf, cm);
let mut mappings = Vec::new();
cm.build_source_map_with_config(mappings, None, config)
	.to_writer(&mut src_buf)
	.unwrap();
let sourcemap = String::from_utf8(src_buf).unwrap();
(code, sourcemap)
```

参考：  
[Rust-based platform for the Web – SWC](https://swc.rs/)  
[VisitMut in swc\_ecma\_visit - Rust](https://rustdoc.swc.rs/swc_ecma_visit/trait.VisitMut.html)  
[https://yuque.antfin.com/luoqixing.lqx/pwap7m/sxuf00oah8m4mkkk](https://yuque.antfin.com/luoqixing.lqx/pwap7m/sxuf00oah8m4mkkk)
