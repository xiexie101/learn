---
title: "155 - 《JS 问题的本质解：从 with 语句说起》"
date: 2022-07-20
url: https://sorrycc.com/javascript-basics-with
---

发布于 2022年7月20日

# 155 - 《JS 问题的本质解：从 with 语句说起》

背景是昨天辟起（dumi 作者）和有知（qiankun 作者）排查 qiankun 沙箱问题时遇到的知识点。qiankun 沙箱会通过 `with(window){}` 给子应用的 JS 代码包一层以避免子应用 JS 影响父应用，但这种方式在结合 esbuild 压缩代码时触发了非常巧合的异常，导致页面执行时出错和白屏。

总结成最简复现，就是早上发在群里的题。

```ts
const foo = { bar: 1 };
with(foo) { var bar = 2 };
console.log(foo.bar); // 2
```

为啥 `foo.bar` 是 2？我用 var 声明了变量而已，为啥会修改外部的值？

```ts
const foo = { bar: 1 };
with(foo) { const bar = 2 };
console.log(foo.bar); // 1
```

再试试 const，为啥 const 行为不一致，只有 var 会触发吗？

```ts
const foo = { bar: 1 };
with(foo) { var hoo = 2 };
console.log(foo.hoo); // undefined
```

为啥这又是 undefined？var 一个 with 对象上不存在的值就不会修改了吗？

with 现在很少用了，但可以借此看下如何探究 JS 语法问题的本质解。这种 JS 语法问题，要追寻本质解，最好的方法就是[查规范了](https://tc39.es/ecma262/)，因为各个浏览器和 runtime 实例都是基于此实现。群里不少朋友也找了，但感觉没找到点。这里有两个点，1）with 语句 2）var 语句。大家找了 with 语句，但没找 var 语句。

在规范的 var 声明语句部分可以找到这一段，「If a VariableDeclaration is nested within a with statement and the BindingIdentifier in the VariableDeclaration is the same as a property name of the binding object of the with statement’s object Environment Record, then step 5 will assign value to the property instead of assigning to the VariableEnvironment binding of the Identifier.」用 DeepL 翻译下，「如果一个VariableDeclaration嵌套在一个with语句中，并且VariableDeclaration中的BindingIdentifier与with语句的对象环境记录的绑定对象的一个属性名相同，那么步骤5将为该属性赋值，而不是赋值给Identifier的VariableEnvironment绑定。」

这问题的本质原因其实很简单，就一句，一个条件判断而已。回到题目，`with(foo) { var bar = 2 }` 里的 `var bar = 2` 执行时，因为是 var 声明语句，所以会检查 foo 里有没有 bar，如果有则变成 `foo.bar = 2`，如果没有继续用 `var bar = 2`。

参考：  
[https://tc39.es/ecma262/](https://tc39.es/ecma262/)
