---
title: "162 - 《ESMi》"
date: 2022-08-04
url: https://sorrycc.com/esmi
---

发布于 2022年8月4日

# 162 - 《ESMi》

ESMi 不开源，只能讲个大概的，本文包含大量「知识诅咒」。

大家可能有听到过 ESMi 这个词，中文名「一丝米」，这是蚂蚁内部非常激进的 ESM Bundless 方案，基于 Vite，但理论上会比 Vite 更快。名字取自 esm 和 umi 的组合，我在去年 GMTC 深圳和今年初 SEE Conf 时都有提到。

![](https://img.alicdn.com/imgextra/i2/O1CN01ZDp27q1IBBAIHSXl2_!!6000000000854-2-tps-1080-601.png)

这是面向未来的方案，不仅适用于本地命令，还适用于搭建系统。他包含 Server 和 Client 两部分功能。Client 会把 depinfo 传给 Server 并要求 ImportMaps，Server 需要分析依赖并做云端构建，继而返回 ImportMaps，Client 拿到 ImportMaps 后就可以在浏览器里渲染了。这个方案里用到非常多前沿技术，esbuild、cjs2esm、import maps、es-module-shims、module preload 等。但由于重服务端，所以不考虑开源，因为开了大家也用不起来，只能对外聊聊方案。

去年做了 ESMi 1，但由于服务端优化的问题，实际跑起来比 webpack 还慢，以及由于 esm 和 qiankun 沙箱的兼容问题，基本上没有落地。所幸这是面向未来的研究方向，KPI 要求上也比较宽容。今年重新捡起来，今天（2022.8.4）下午刚做完 ESMi 2 的 kickoff，计划 2022.10 月底发布 ESMi 2。

ESMi 2 主要解 ESMi 1 遇到的 dev 性能问题和 qiankun 沙箱问题。dev 性能问题的解法主要是利用缓存和提前做，1）依赖包的构建不在请求发起后进行，而是前置到 tnpm sync 时进行，2）Server 不做依赖树分析，前置到 umi 里分析，本地文件 IO 肯定比网络快，不是一个量级。qiankun 沙箱和 esm 的兼容会结合编译工具来做，具体方案还不明确，预计细节比较多，比如 import maps 只能由一个，那主应用和子应用的是否需要进行合并。

拭目以待 10 月底的进展吧，目标是任意项目秒开。

参考：  
[SEE Conf：Umi 4 设计思路文字稿](https://sorrycc.com/umi-4-thoughts)
