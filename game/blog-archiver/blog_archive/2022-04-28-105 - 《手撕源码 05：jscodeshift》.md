---
title: "105 - 《手撕源码 05：jscodeshift》"
date: 2022-04-28
url: https://sorrycc.com/source-05-jscodeshift
---

发布于 2022年4月28日

# 105 - 《手撕源码 05：jscodeshift》

## jscodeshift 是什么？

Star 7.3K，周下载 222W，facebook 出品。jscodeshift 是老牌的 JS 语言（也支持 TS 等类 JS 语言）的 codemod 工具，官方定义是「A JavaScript codemod toolkit.」。codemod 是什么？就是你之前代码是这么写的，然后希望改成另一个样子，要么手动改，要么通过工具改，而 codemod 就是通过工具改代码的一种方式。

比如要把 const abc = 1 改成 const cba = 1，就需要把 identifier（语法树里的一种类型）翻转一下，用 jscodeshift 的话，先定义一个 transformer。

```ts
// 接口：transform({ path, source }, { j, jscodeshift, stats, report }, options)
export default transformer(file, api) {
  return api.j(file.source).find(j.Identifier).replaceWith(
    p => j.identifier(p.node.name.split('').reverse().join(''))
  ).toSource();
}
```

然后，执行命令指定 transformer 和要转的代码，

$ jscodeshift -t path/to/transformer.js src

✅ 大功告成！

## 为什么调研 jscodeshift？

今天（2022.4.28）发布了 Bigfish 4，Bigfish 是蚂蚁内网基于 Umi 的前端框架。新的框架总会带来 break change，而这些 break change 又不希望框架用户一行行改，就需要提供 codemod 工具。

Bigfish 2 升 3 时就提供过，当时其他同事负责的，用的 jscodeshift。不说难用，但不能很好的满足我们的场景。1）Bigfish 的升级，通常需要改是三个地方，配置、package.json 和代码，代码又分 js 和 css，2）jscodeshift 适用于目的很明确的场景，如果有前后依赖或者参数传递时，并不好操作。所以做下调研，准备参考 jscodeshift 手写一个。

注：中文社区阿里妈妈也有开发一个类似的工具 [gogocode](https://github.com/thx/gogocode)（Star 3.2K）。

## jscodeshift 怎么 run 起来？

jscodeshift 的核心流程是「Runner > Worker > Parser > 准备 j > Transformer > 产出新代码」。

Runner 部分。1）支持远程的 transformer，如果是 http 开头，则会下载到本地后再执行；2）支持多核并行以提升性能，此模式下会 forker 多个子进程（Worker）执行。

Worker 部分。1）支持多种 parser 供选择，比如 babylon、flow、ts、tsx 和 babel5Compat，用于将源码转化为 AST（语法树），parser 优先用 transformer 指定的，然后再考虑用户指定的，2）AST 的转换基于 [recast](https://github.com/benjamn/recast)（Star 4.1K），recast 默认 parser 是 Esprima，但通常不用这个，3）j（即 jscodeshift）是此工具提供给 transformer 的核心能力，开发者基于此可通过链式的方式「解析代码到 AST、修改 AST、转换 AST 源码」，同时提供大量的辅助方法，让修改 AST 变得简单，这部分主要基于 recast 封装。

## jscodeshift 的工程化

库太老了，没啥参考价值。

## 我理想的 codemod 工具

脑暴下，可能不通用，但适用于 umi 或其他框架。

1、提供 config、package.json 和 code 三部分的修改能力。config 虽然也是 js，但需特殊处理，因为可能有多种配置语法，多个配置文件，同时配置也能依赖其他配置；package.json 比较简单；code 类似 jscodeshift 的实现，走 Runner、Worker、Transformer（parse、transform、generate 可以用 babel 全家桶或 swc，不走 recast）  
2、代码修改前后走一遍 prettier  
3、codemod 前检查 .git 状态  
4、提供 dry（不修改）模式，产出报告供用户评估  
5、…

预计 5.1 回来后动工。

参考：  
[https://github.com/facebook/jscodeshift](https://github.com/facebook/jscodeshift)  
[https://github.com/thx/gogocode](https://github.com/thx/gogocode)  
[https://www.sitepoint.com/getting-started-with-codemods/](https://www.sitepoint.com/getting-started-with-codemods/)
