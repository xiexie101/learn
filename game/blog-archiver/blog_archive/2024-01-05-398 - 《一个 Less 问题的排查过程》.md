---
title: "398 - 《一个 Less 问题的排查过程》"
date: 2024-01-05
url: https://sorrycc.com/less-problem
---

发布于 2024年1月5日

# 398 - 《一个 Less 问题的排查过程》

> 一个问题的排查过程，绕了一圈，原来解法很简单。但一个收获是把 Less 的插件机制搞透了。

1、问题。

昨天用户遇到一个问题，使用 Mako 时遇到 Less 的使用问题。

目录结构如下。

```
+ bar
	- bar.less
	- zzz.css
- index.js
- index.less
```

代码如下。

```ts
// index.js
import './index.less';
// index.less
import './bar/bar.less';
// bar/bar.less
@import './zzz.css'
```

抛开 index.js，直接用 lessc 编译 less，执行 `lessc index.less`，得到结果如下。

```css
@import './zzz.css';
```

less 编译后保留 css 的 import 是符合预期的，但是路径原样保留下来，回到 `index.less` 的编译结果时，他去找 `./zzz.css` 就会从当前目录去找，而根目录不存在 `zzz.css`，然后就有问题了。

但是 webpack 是好的。

2、思路。

两个思路，1）排查为啥 webpack 是好的，Mako 的 less 插件是抄的 less-loader，理论上不应该存在差异，2）用我自己的思路去解，通过 less 的插件，加 visitor，找到 @import 语句的 ast 节点，用 enhanced-resolve 库去找下依赖，然后替换为绝对路径。

3、过程。

我先用自己的思路去解，跑通了，写了一个 less 插件如下，运行良好，用例也过了。（为了写 less 插件，还把 less 插件完整地重新过了一遍，花了 1 个多小时）

```ts
class CSSImportVisitor {
  constructor() {
    this._visitor = new less.visitors.Visitor(this);
  }
  run(root) {
    this._visitor.visit(root);
  }
  visitImport(node) {
    const isCSS = node.path.value.endsWith('.css');
    if (isCSS && node.path) {
      const context = node.path._fileInfo.currentDirectory;
      const request = node.path.value;
      if (context && request) {
        try {
          // syncResolver 来自 enhanced-resolve
          const resolved = syncResolver(context, request);
          node.path.value = resolved;
        } catch (error) {
          throw new Error(`Failed to resolve ${request} from ${context}`);
        }
      }
    }
    return node;
  }
  visitUrl(node) {/*类似visitImport的处理*/}
}
```

然后总觉得我做的思路可能有问题，就又去排查 webpack 下用 less-loader 为啥是好的，插件行为是一致的。最后发现不一致的点是，他多传了一个 `relativeUrls: true` 的参数。

最后再翻了下 less 文档，发现 `relativeUrls` 已经 deprecated，推荐用 `rewriteUrls: 'all'` 代替。于是我换成了后者。

4、总结。

很多问题，社区已经考虑的很全了，优先看社区怎么做，远比用自己的思路实现一遍要来的效率高。如果我先验 webpack 的逻辑，就能省出 1 小时了。但是，也会错过 less 插件的学习。

参考：  
[https://lesscss.org/usage/#less-options-relative-urls-deprecated-](https://lesscss.org/usage/#less-options-relative-urls-deprecated-)  
[https://webpack.js.org/loaders/less-loader/](https://webpack.js.org/loaders/less-loader/)
