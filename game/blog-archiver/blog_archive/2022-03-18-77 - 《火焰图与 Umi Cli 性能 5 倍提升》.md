---
title: "77 - 《火焰图与 Umi Cli 性能 5 倍提升》"
date: 2022-03-18
url: https://sorrycc.com/flame-graph-and-umi-cli
---

发布于 2022年3月18日

# 77 - 《火焰图与 Umi Cli 性能 5 倍提升》

这是今天从同事那学到的一个知识点，用火焰图排查 CLI 性能。

火焰图早在 2011.12 就被发明出来了，用于分层数据的可视化。常用场景是通过软件的堆栈信息，分析出最频繁调用的代码，见图 1。

![](https://img.alicdn.com/imgextra/i4/O1CN01ILnLq81yNjt2Q3jys_!!6000000006567-0-tps-500-508.jpg)

Umi 遇到的问题是 Cli 启动缓慢，在 M1 上还好，只要 2S，所以之前也没太大感受，非 M1 上要 5S+，这就很浪费生命了。

Node 下可以通过 perf 手动分析，但简单场景大家通常用 0x 直接分析拿到火焰图，比如 umi cli 的分析。

```bash
# 先安装全局依赖
$ pnpm i 0x -g
# 之前是这个
$ umi build
# 现在加 0x，然后用 umi 的正式路径跑
$ 0x `which umi` build
```

然后就能得到图 2 的火焰图，分析后发现插件的注册花了很多时间。慢背后的原因有两个。1）插件会通过 require extension 加 hook 用 esbuild 自动编译，JS 也会走这个逻辑，所以量很大；2）每个插件注册完会清空相关缓存，注册其他插件时重新来一遍，这会导致插件背后重复的依赖被初始化很多遍。

![](https://img.alicdn.com/imgextra/i2/O1CN01PJA2ew1nIjmzaTVxR_!!6000000005067-0-tps-956-700.jpg)

把这两个问题解掉之后，见 [PR](https://github.com/umijs/umi-next/pull/514)，CLI 在非 M1 电脑下启动也只需 1S+，提升 4-5 倍。

参考：  
[https://www.brendangregg.com/flamegraphs.html](https://www.brendangregg.com/flamegraphs.html)  
[https://nodejs.org/en/docs/guides/diagnostics-flamegraph/](https://nodejs.org/en/docs/guides/diagnostics-flamegraph/)  
[https://github.com/davidmarkclements/0x](https://github.com/davidmarkclements/0x)  
[https://github.com/umijs/umi-next/issues/504](https://github.com/umijs/umi-next/issues/504)
