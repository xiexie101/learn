---
title: "533 - 《手写 sorrycc.com》"
date: 2025-03-10
url: https://sorrycc.com/rewrite-sorrycc-com
---

发布于 2025年3月10日

# 533 - 《手写 sorrycc.com》

简单记录下手写 [sorrycc.com](http://sorrycc.com) 的过程。

1、契机是我之前用 WordPress 做的[博客](https://sorrycc.com/)，一周之前，在我的小破 VPS 上的 CPU 和内存都占得比较满，一度导致网站非常卡顿。卡顿的原因，我觉得可能是有很多垃圾的注册信息，后天有几千个奇怪邮件的注册用户。然后我尝试了各种性能优化的手段，但效果都不太好，还导致了一个 bug。于是，作为程序员，手痒了就决定手写一个版本。

2、之前没有正式用过 Next.js，借这一次机会试试看。整个研发过程中大量使用 AI、Cursor、Gemini 等工具，参考 [530 - 《我怎么用 AI 辅助编程》](https://sorrycc.com/how-to-use-ai-to-assist-programming)。虽然是第一次使用，但是研发的过程还是很流畅的。

3、我的技术选型如下。

框架：Next.js with App Router  
数据库：Prisma  
UI：Shadcn/ui + TailwindCSS  
邮件：AWS SES  
Cookie Session：iron-session  
压测：[k6](https://grafana.com/docs/k6/latest/)  
API Test：[REST Client](https://marketplace.visualstudio.com/items?itemName=humao.rest-client)  
工程化：Pnpm、TypeScript、Prettier 等  
部署：pm2、1panel  
其他工具：TablePlus

4、我的大部分时间花在想需求和写 prompt 上。 以下是我的第一个 Prompt。

```
我要写一个 App。

技术栈如下。
1、Next.js
2、Prisma （先用 Sqlite，后续部署时用 PostgreSQL）
3、UI 用 shadcn/ui
4、提供 /api，基于 header 中的 token 访问，类 chatgpt api 的授权方式，提供给三方开发者
5、api 基于 swagger，主要用于文档
6、pnpm
7、邮件发送基于 AWS SES，用 aws-sdk 这个依赖

细节如下：
1、/category/$id 用于渲染某个分类下的文章列表
2、/$post_id 用于渲染某个 post
3、/ 用 page_on_front 的 page 渲染
4、/login、/logout、/signup、/active、/reset_password 等用于鉴权，登录 Cookie 保持时间为 3 个月，注册后有一个激活邮箱的流程，会给用户发一封邮件，然后用户点击邮件里的地址进行激活

表结构要求如下，基于前面的描述，如有补充，可以增加表结构。
1、users 表，包含 id、name、photo、mail、role（包含 subscriber、contributor、admin）、mail_confirmed、articles、created_at、expired_at 等
subscriber 可以评论，contributor 可以浏览 categories 中 slug 为 vip 的文章，。
2、tokens 表，包含 id、user_id、key 等，用于 api
3、posts 表，包含 id、user_id、parent_id（optional）、title、content、post_name、created_at、modified_at、type（包含 page、post 等）、status（包含 draft、publish）、comment_count、comment_status（包含 open、closed）、权限（部分用户可访问，比如 contributor 和 admin 才能访问）
4、comments 表，包含 id、post_id、user_id、parent_id（用于实现评论回复功能）、content、created_at、modified_at、author_ip、
5、categories 表，包含 id、name、slug，表示分类（需要有个表维护 posts 和 categories 之间的多对多关系）
6、settings 表、包含 id、name、value

一些 settings 如下。
1、page_on_front，首页用于渲染的 post_id
2、title，用于渲染页面标题

请给我一份非常详细的分步操作指南，要求 Cursor Agent 友好。
```

5、本地调试。创建 `.vscode/launch.json` 即可，内容如下。

```json
{
    "version": "0.2.0",
    "configurations": [
        {
            "type": "node-terminal",
            "request": "launch",
            "name": "Next.js: Debug Development",
            "command": "npm run dev",
            "cwd": "${workspaceFolder}",
            "serverReadyAction": {
                "pattern": "started server on .+, url: (https?://.+)",
                "uriFormat": "%s",
                "action": "openExternally"
            }
        }
    ]
}
```

6、Auth 其实有更好的选择，像 [Better Auth](https://www.better-auth.com/) 之类的。但是由于 [sorrycc.com](http://sorrycc.com) 这个网站有一些特殊性，需要把之前大家在知识星球上的会员信息迁过来，万一搞到一半搞不下去又得重头来过，所以还是决定保险点，手动实现注册、登录、忘记密码、Session Cookie 等，没直接用社区的 Auth 方案。

7、部署也没有选 Vercel，还是用的[搬瓦工的 VPS](https://bandwagonhost.com/aff.php?aff=74975) 。因为感觉这个站点的体量比较小，没必要用 Serverless。同时手边也有一台 VPS 在，所以就想把它利用起来。数据库可选 Sqlite 或者 PostgreSQL，访问量不大其实可以先用 Sqlite，省点事。（注：我的部署脚本也是 AI 写的，感觉 AI 最擅长这类简单需求的功能。）

```bash
curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
apt install nodejs
pm2 start npm --name "sorrycc.com" -- start
```

8、还花了一些时间做数据的迁移。这里分两部分：一部分是博客，另一部分是用户。博客我就重新跑了一遍我的「本地文章发布」脚本，让所有的文章在新网站上走了一遍发布流程。用户是把之前 Wordpress 的数据和知识星球的数据 merge 了一下，然后更新到新的会员数据库里。由于新老网站的密码算法不是同一套，所以需要老用户重新走一遍「密码重置」的流程。

9、一些想法和 Tips 。

1）AI 给的答案对于最新的技术跟进没有那么快。比如，shadcn cli AI 给的是 shadcn-ui 这个包，而最新应该是要用 shadcn 这个包。比如。

```bash
pnpm dlx shadcn@latest init
pnpm dlx shadcn@latest add skeleton
```

2）还有些没做好的地方。如果重新写的话，我应该会再调整一下方法。比如说，数据库可以尝试直接用 [https://strapi.io/](https://strapi.io/) 的方式，估计接入成本会更低。比如说，TailwindCSS 也会做更主题友好的方式，这样子我们能比较方便地去接入暗色的主题。

3）部署脚本在安装依赖时加 `--production` 可以省去部分时间。
