---
title: "42 - 《Umi 4 的强约束》"
date: 2022-01-20
url: https://sorrycc.com/umi-4-constraints
---

发布于 2022年1月20日

# 42 - 《Umi 4 的强约束》

大家可能听说过 Bigfish 的强约束，50+ 规则对内部同学做团队级约束。由于是后加的功能，Umi 3 设计里没有为此考虑，所以实现时较为复杂，Umi 4 中加入了相关设计，让新增约束规则变得异常简单。

约束通常分几类：

1、依赖类，比如不能使用 redux 依赖  
2、代码类，比如对语法、行数、文件的检查  
3、配置类，有些配置太灵活，不让用

Umi 4 的插件里新增了几个 API，专门用于检测类，

1、`api.onCheck`，提供专门的检测阶段，做任意的自定义检测  
2、`api.onCheckConfig`，做配置检测  
3、`api.onCheckPkgJSON`，做 package.json 检测  
4、`api.onCheckCode`，提供 file、code、import 和 export 信息等，做代码级检测

举一些例子。

比如源码中不允许使用 cjs 模块规范，

```ts
api.onCheckCode((args) => {  
  if (args.cjsExports.length) throw new Error('')  
});
```

比如只能用 less 写样式，

```ts
api.onCheckCode(args => {  
  if (args.imports.any(import => /\.(css|sass|scss|stylus)/.test(import.source))) throw new Error('')  
});
```

比如不让用 redux，

```ts
api.onCheckPkgJSON(args => {  
  if ('redux' in args.current.dependencies) throw Error('');  
  if ('redux' in args.current.devDependencies) throw Error('');  
});
```
