---
title: "332 - 《npm 包可用性检测》"
date: 2023-08-10
url: https://sorrycc.com/npm-usability-check
---

发布于 2023年8月10日

# 332 - 《npm 包可用性检测》

> 记录一个交给团队同学在做的任务。

假如你有个任务，要验证所有公司在用前端的 npm 包的可用性。背景可能是新上了一个规范，或者切换到另一个构建工具，你会怎么做？这是一项团队同学正在做的任务，以下是思路。

1、找到所有在用的 npm 包。

这比较依赖基建，如果之前有收集相关数据，直接捞数据即可，如果没有，就比较麻烦了。

捞的方式有两种思路，1）找到活跃项目的仓库列表，依次 git clone，2）在统一构建工具里埋点统计。前者成本较低，但可能会遇到权限问题，通常个人账号不能访问所有项目仓库；后者成本较高，优点是可持续且数据比较准确和全面。

捞的数据也有两种思路，1）基于 package.json，2）基于使用。前者噪音比较多，比如你不知道某个依赖是 node 还是 browser 的，还得额外话成本手动区分，比如你不知道用户用了某个依赖的哪些导出属性；推荐后者，即当用户在代码里写了 `import { x } from 'foo';` 时，才会把 foo 依赖的 x 方法加入统计，缺点是成本略高，但有 babel 全家桶还是可控的。

还有需要注意的是，npm 包有不同版本，得分开做检测。比如 foo@1 和 foo@2，表现肯定是不同的。所以拿到 package.json 里的版本号之后，比如 foo@^1.0.3，得拿着 ^1.0.3 去查一下 npm server，拿到匹配后的真实版本，再添加到列表里。

最终的 npm 包列表可能如下。

```ts
foo@1.0.0
foo@2.0.0
bar@1.0.0
```

2、检测 npm 包。

npm 包的可用性检测分两步，1）构建可用性，2）运行可用性。前者就是拿构建工具跑一下看会不会报错；后者是在构建后，把产物放到浏览器里运行，看控制台是否有报错。

基于公司项目的多少，通常可能得检测几百到几千个依赖，还得来回验跑多遍，手动做肯定不靠谱。

基本思路是这样。

1）`npm i name@version` 安装依赖  
2）自动生成 index.ts，内容为 `import * as x from '%%name%%';document.getElementById('root').innerHTML = typeof x;`  
3）自动生成 public/index.html，内容为 `<div id="root"></div><script src="index.js"></script>`  
4）跑构建任务，打包 index.ts 到 dist/index.js，并复制 public/index.html 到 dist/index.html，记录报错情况  
5）启 server 或直接打开 dist/index.html 所在路径，检测 root 里是否有输出内容，记录情况，这一步可用无头浏览器比如 puppeteer 来自动做

3、还会有一些细节。

比如因为量太大，加个分布式跑第二步，可能让跑几天的任务减少到几小时。
