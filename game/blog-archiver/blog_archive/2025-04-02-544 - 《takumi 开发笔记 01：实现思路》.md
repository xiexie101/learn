---
title: "544 - 《takumi 开发笔记 01：实现思路》"
date: 2025-04-02
url: https://sorrycc.com/takumi-01-implementation-ideas
---

发布于 2025年4月2日

# 544 - 《takumi 开发笔记 01：实现思路》

> 有内部的同学感兴趣，应邀写了这一篇，顺便分享到这里。

1、takumi 的实现参考了 [Claude Code](https://github.com/anthropics/claude-code) 的第一个版本，包括内置 tools、context 的组织和部分功能等。但其中 LLMs 调用的方案不同，Claude Code 是基于 OpenAI 然后剩下的都是手写，我为了快速实现 MVP，用了 [ai](https://sdk.vercel.ai/) 这个 npm 包。

2、我理解 Agent = LLMs + System Prompt + Context + Tools 。Agent 接收 User Prompt 的输入，执行任务并返回结果。目前 takumi 的 Context 包含 目录结构、Git、Code Style、Claude Files、[README.md](http://README.md) 等信息；而 Tools 则包含 FileEdit、Bash、FileRead、FileWrite、Glob、Grep、Ls 等，具备了编辑、搜索、查找代码的基本能力；同时 Tools 支持通过 MCP 的方式进行扩展。

![](https://cdn.jsdelivr.net/gh/sorrycc-bot/images@main/uPic/takumi-what-is-agent.png)

3、再说一下为什么用 AI 这个 npm 包。

1）他支持各种 llms 的 provider，市面上有的，应该都能够非常快速地去接入  
2）支持 Tools ，并且内部考虑了各种并发执行来提出的场景  
3）最近试验性地支持了 MCP

一些示例。

```ts
import { createOpenAI } from '@ai-sdk/openai';
import { streamText } from 'ai';
const openai = createOpenAI({ apiKey, baseURL });
const model = openai('<your-model-name>');
const result = streamText({ model, messages, system, tools });
for await (const text of result.textStream) {
  process.stdout.write(text + '\n');
}
```

不过，用 AI 这个包有好也有坏。就是你用框架来开发 Agent，优点是自己写的代码少了，缺点则是可控性降低，都是权衡。比如说，你对 Tools 执行的步骤如果有很高的定制性，用 AI 这个包就不行了。比如说，如果内部的模型对 function call 的支持力度不好，那就要降级成指令形式的方式去调用 Tools，这种场景 AI 这个包也不支持。

4、为了让大模型能够更好地理解项目，很多工具都会有一些 Rules 文件，比如 Cursor 的 Cursor Rules，以及 Claude Code 有 [CLAUDE.md](http://CLAUDE.md)，Cline 和 Aider 也有自己的。那如何基于你的项目的选型和依赖快速生成这些 rules 呢？takumi 提供了一个 init 命令。实现比较简单，就是组织了一个 Prompt 如下。当然，后面加入内部框架后，还会需要做更细致的处理。

```txt
Please analyze this codebase and create a TAKUMI.md file containing:
1. Build/lint/test commands - especially for running a single test
2. Code style guidelines including imports, formatting, types, naming conventions, error handling, etc.

The file you create will be given to agentic coding agents (such as yourself) that operate in this repository. Make it about 20 lines long.
If there's already a TAKUMI.md, improve it.
If there are Cursor rules (in .cursor/rules/ or .cursorrules) or Copilot rules (in .github/copilot-instructions.md), make sure to include them.
```

5、takumi 还有个 plan 命令，它用于交互式地帮用户梳理需求，产出一份详细的可一步一步执行的文档。这份文档可以后续交给 CodeAgent 去执行。这是我自己用 AI 开发项目的方式，参考 [530 - 《我怎么用 AI 辅助编程》](https://sorrycc.com/how-to-use-ai-to-assist-programming)，也希望把它通过工具的方式沉淀下来，让更多的人按这种方式去试验一下是否可行。

Plan 的执行逻辑基本上是这样的。

1）递归通过 LLMs 检查 REQUIREMENT 是否完整  
2）如果不完整，通过 LLMs 提问，并要求用户补充  
3）如果完整，产出详细的 Step by Step 的操作文档

![](https://cdn.jsdelivr.net/gh/sorrycc-bot/images@main/uPic/takumi-plan.png)
