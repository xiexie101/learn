---
title: "419 - 《分享：Mako 如何 从 0 到 1 到落地到开源》"
date: 2024-03-09
url: https://sorrycc.com/mako-from-zero-to-open-source
---

发布于 2024年3月9日

# 419 - 《分享：Mako 如何 从 0 到 1 到落地到开源》

> 周五（2024.03.08）内部分享版，只列了大纲，讲故事风。

![](https://img.alicdn.com/imgextra/i2/O1CN01OzzzMJ1KEVH8lc4DQ_!!6000000001132-2-tps-7040-6260.png)

去年一年的主线都是 Mako。

Mako `['mɑːkoʊ]` 经历 3 个阶段，从 0 到 1，从 1 到落地，从落地到开源。

*   Mako 如何从 0 到 1
    *   2023.3 Kickoff
        *   老板成立「体验科技小队」，立了三个项，Rust、SSR & RSC 和 AIGC，我领了 Rust 的部分，写了个 RFC \[\[基于 Rust 的新前端研发态：RFC\]\]
            *   [https://img.alicdn.com/imgextra/i4/O1CN01UKhG1g1uj1qyMQcoX\_!!6000000006072-0-tps-4032-3024.jpg](https://img.alicdn.com/imgextra/i4/O1CN01UKhG1g1uj1qyMQcoX_!!6000000006072-0-tps-4032-3024.jpg)
            *   [https://img.alicdn.com/imgextra/i3/O1CN01Nfzy6e2AI2MW58aZT\_!!6000000008179-0-tps-5472-3648.jpg](https://img.alicdn.com/imgextra/i3/O1CN01Nfzy6e2AI2MW58aZT_!!6000000008179-0-tps-5472-3648.jpg)
            *   [https://img.alicdn.com/imgextra/i4/O1CN01A1WJBt1ocGJ1qLUhE\_!!6000000005245-0-tps-960-1280.jpg](https://img.alicdn.com/imgextra/i4/O1CN01A1WJBt1ocGJ1qLUhE_!!6000000005245-0-tps-960-1280.jpg)
    *   取名
        *   Mako 是最快的鲨鱼 🦈
    *   面临的问题
        *   意义感，为什么做
        *   从 webpack 配置工程师到 webpack 研发工程师的角色转变
        *   Rust 0 基础
        *   人员有限
        *   大量应用 Less，而 Less 无 Native 语言实现
    *   竞品调研
        *   esbuild、farm、rspack、turbopack、swc-bundler 等，turbopack 对于当时的我们来说真是看不懂
        *   为啥社区有 Farm、Turbopack 等了之后，我们还要重新写一个？[334 - 《Mako 开发日志（1）》](https://sorrycc.com/mako-devlog-01)
        *   万事从 Toy Version 开始
            *   [284 - 《手写 Toy Bundler》](https://sorrycc.com/toy-bundler)
        *   [280 - 《构建工具应该包含哪些能力》](https://sorrycc.com/build-tool-features)
    *   团队和协作方式
        *   虚线 + 实线团队，虚线团队有好有坏，好处是补充人力，坏处是不稳定，业务有事就撤，所以不能 assign 大功能，撤了再找人顶上成本太大
        *   Github 私库协作（Github Action 得花钱，真的贵）
    *   学习 Rust
        *   团队大多 Rust 0 基础，边学边写还是很刺激的，感谢 ChatGPT，不然真没那么快上手。
        *   [302 - 《Rust 资料》](https://sorrycc.com/rust-resources)
        *   [7 - 《资源整理：前端视角学 Rust》](https://sorrycc.com/learn-rust-as-f2e)
        *   [364 - 《作为前端开发者，到底有没有必要学 Rust》](https://sorrycc.com/learn-rust-or-not)
    *   开发迭代
        *   调研、学 Rust、开发、修 Bug、提升性能、调研、学 Rust、…
        *   代码重构了好几次，最近在做第三次重构。之前为了能跑和出于开发时间原因，做了比较多的战术性编程，不必要的复杂度堆得比较多。
        *   一边学一边写的过程还是很累的，因为很容易卡主，影响心流，很多脑子里想的设计不能落地还是很恼火的。所以一开始 Rust 开发速度可能只有 JavaScript 的 1/10 到 1/5，随着逐渐深入，目前已达 2/3 到 3/4。
        *   开发 Mako 需要两个技能点，Rust 和构建。Rust 熟练后，大部分时间是在学习竞品（看 Farm 和 Webpack 偏多），了解构建相关的领域知识，完善用例。
        *   [341 - 《Mako 开发日志（3） - 架构图》](https://sorrycc.com/mako-devlog-03)
        *   [https://github.com/evanw/esbuild/blob/main/docs/architecture.md#overview](https://github.com/evanw/esbuild/blob/main/docs/architecture.md#overview)
    *   Mako x Less
        *   [木桶原理](https://wiki.mbalib.com/zh-tw/%E6%9C%A8%E6%A1%B6%E5%8E%9F%E7%90%86)
        *   [352 - 《Mako 开发日志（4）：Less》](https://sorrycc.com/mako-devlog-04)
        *   \[\[难题：Rust 版 Less\]\]
    *   2023.07.07，[Mako 发布 Alpha](https://yuque.antfin.com/bigfish/blog/hvy7t3i2kdku01ua)
*   Mako 如何从 1 到落地
    *   从 0 到 1 是简单的，从 1 到落地就复杂了
        *   前端生态充满了各种 edge case，以及打包不仅要构建快，还要产物快。其中有些点的技术门槛还是有的，比如 tree-shaking、code splitting、hmr 等。
    *   面临的问题
        *   edge case
        *   构建性能
        *   产物性能
        *   dx
        *   稳定性
    *   用工程化解 edge case 问题
        *   Mako 要落地，得提前覆盖大部分的 edge case 问题，不能等到用户切过去了，发现不行，再换回去。这样口碑就砸了。
            *   [358 - 《CSS 错误片段集锦》](https://sorrycc.com/css-common-errors)
        *   方法 1：验所有 Bigfish 3 和 4 项目里用到的所有前端 npm 包及用到的所有版本，确保构建能过，且 require 入口文件不会报错
        *   方法 2：验所有 Bigfish 4 项目，确保构建能过
        *   方法 3：为确保 tree shaking 不误删代码，自动 + 手动的方式确保抽样 100+ 的项目用 mako 构建后跑起来没问题
        *   方法 4：补充了几百个 e2e 用例，这些用例是我们后续发版和重构的信心来源
        *   综合这些方法，让我们提前发现的大量问题，同时 Mako 落地时还是比较平稳的。
    *   深挖构建性能，力求业界第一
        *   Benchmark 是主观的，因为维度太多了。[206 - 《Benchmark》](https://sorrycc.com/benchmark)
        *   Mako 的性能数据见下面两个发布稿。
        *   不是用 Rust 写的代码都快，只是 Rust 给了更多快的可能性，包括内存分配、并发、缓存等，得充分利用后才会变快。
        *   如何充分利用并发？能并发的地方必须并发，基于 rayon crate 实现。整体构建流程参考 [esbuild 的设计](https://github.com/evanw/esbuild/blob/main/docs/architecture.md#overview)，大同小异
        *   性能这块有很多分析工具，比如 [422 - 《Xcode Instruments》](https://sorrycc.com/xcode-instruments) 做分析、hyperfine 做 benchmark、puffin 做统计和分析等，策略是利用工具找到卡点，权衡复杂度和性能提升效果，合适就落地
    *   产物性能
        *   产物性能分两个衡量标准，1）相同拆包策略下的尺寸，2）不同拆包策略下的加载性能。前者包括压缩、tree shaking、scope hoisting（模块合并）等；后者主要是 code splitting。
        *   我们需要赶上 webpack，这是考虑硬实力的时候。比如 tree-shaking 的解应该是耗时最长的，解了好多个月了，目前还在解，要考虑的点和场景非常多。
    *   2023.10.24，[Mako 发布 RC](https://yuque.antfin.com/bigfish/blog/aauufeza7s7vg1i5)
    *   2023.11.24，[Mako 在内网正式发布](https://yuque.antfin.com/bigfish/blog/231124-faster)
    *   2023.12，落地 Bigfish、Minifish、闪蝶
    *   落地数据（截止 2024.03.26）
        *   Bigfish
            *   [https://img.alicdn.com/imgextra/i1/O1CN01nyKTlo1zjYNnCznjs\_!!6000000006750-2-tps-696-628.png](https://img.alicdn.com/imgextra/i1/O1CN01nyKTlo1zjYNnCznjs_!!6000000006750-2-tps-696-628.png)
        *   Minifish
            *   ?
*   Mako 如何从落地到开源
    *   2024.06.28（计划） 开源，提升社区影响力
    *   卖点是啥？
        *   速度（力求做到业界第一）
        *   覆盖率（场景、业务、Edge Case 覆盖）
        *   性能（产物尺寸和 Code Splitting 策略等）
        *   开箱即用（定位和 Webpack 不同，不做通用方案）
        *   和 Umi 深度集成（元框架用 Rust 不仅仅是构建）
        *   WASM 产物
    *   所以这段时间，我们会在代码质量、构建速度和产物性能这三块继续深挖
    *   代码质量
        *   做重构，减少复杂度
        *   [413 - 《读书笔记：A Philosophy of Software Design》](https://sorrycc.com/book-a-philosophy-of-software-design)
    *   构建速度
        *   卡点分析，针对卡点做优化。找到真正的卡点，优先效果可能是惊人的，比如最近一个优化改了下正则和内存分配，构建速度提升了 25% - 30%。\[\[Bigfish 月报 2024-02\]\]
        *   [422 - 《Xcode Instruments》](https://sorrycc.com/xcode-instruments)
        *   可能要做的点，MFSU、物理缓存、按需编译、桶文件优化方案、充分发挥多线程（目前 ast to code 阶段还不够多线程）等
    *   产物性能
        *   tree shaking、scope hoisting、code splitting 的继续优化
        *   Module Concatenating
        *   Code Splitting
        *   常量折叠
        *   …
*   Mako 2024 规划
    *   两件事，1）开源（见上一条），2）业务落地
    *   借着落地去完善功能，包括支持 node、ssr、rsc、组件研发等，构建感觉是个很大的坑，需要明确知道不做什么，否则很难填完
    *   2024.XX.XX，落地云凤蝶、闪蝶、Smallfish、Dumi、Father、…
