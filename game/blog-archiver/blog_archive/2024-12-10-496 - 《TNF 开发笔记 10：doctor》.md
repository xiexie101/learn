---
title: "496 - 《TNF 开发笔记 10：doctor》"
date: 2024-12-10
url: https://sorrycc.com/tnf-10
---

发布于 2024年12月10日

# 496 - 《TNF 开发笔记 10：doctor》

1、今天在 tnf 里把 checker 改了个名，加了些功能后[实现了 doctor 的雏形](https://github.com/umijs/tnf/commit/5676479b369c7edcbec742b23e5d733d49791262)。或者可以理解为之前蚂蚁内部框架里强约束功能的升级版。之前有些一个 [458 - 《RFC：强约束迭代》](https://sorrycc.com/constraints-2024)，这次的方案也顺便解这些问题。

2、这一版 doctor 的特点是啥？

1）支持独立运行。之前是和构建强绑的，因为有些信息只有构建时能拿到，比如 imports 和 exports 信息，多跑一次构建就会减慢整体流程。  
2）利用 Rust 提速（TODO）

3、doctor 原理。

doctor 是用来分析代码，然后评估代码中的潜在问题。所以需要先收集信息，信息包括配置、package.json、源码信息、依赖信息等。而源码和依赖的信息要准确地拿，就得做一次构建的基本链路。处于 ROI 的考虑，通常不拿依赖信息，因为，1）慢，2）得 npm i 安装依赖。

4、源码构建 buildSrc 的实现调整了几个版本。

1）本想着[用 Rust 来实现的](https://github.com/umijs/tnf/issues/70)，但算了算时间，还是先用 JS 吧  
2）先尝试用 mako 打包，ignore 掉所有依赖，没成功，同时产物格式可能没那么匹配，由于没时间深究，先放弃  
3）然后先是准备沿着 [NodeJS 的路](https://github.com/nodejs/node/pull/53725)，用了 [amaro](https://github.com/nodejs/amaro) strip types，再用 [es-module-lexer](https://github.com/guybedford/es-module-lexer) 提取 imports 和 exports 信息，但是做完发现漏了一点是，amaro 虽然 strip 了 types，但是还留下了 jsx 语法，而这个语法 es-module-lexer 不支持 （也可以考虑用 [oxc-node](https://github.com/oxc-project/oxc-node) 代替 amaro，但没具体试）  
4）再改用 esbuild transform 去掉 types 和 jsx，然后 es-module-lexer 提取 imports 和 exports 信息。

5、规则。

现在有 3 个，

1）checkPhantomDeps，用于检查潜在的 [238 - 《幽灵依赖》](https://sorrycc.com/phantom-deps) 。  
2）checkPackageUsage，不允许用户用 @tanstack/react-router，应该改用 @umijs/tnf/router 。  
3）checkReactConflicts，react 版本和 @types/react 版本之间的各种冲突提醒 。

后续会陆续把 Bigfish 强约束和 Doctor 里的规则挑合适的提进来。

参考：  
[458 - 《RFC：强约束迭代》](https://sorrycc.com/constraints-2024)  
[42 - 《Umi 4 的强约束》](https://sorrycc.com/umi-4-constraints)  
[Support typescript with --experimental-strip-types · Issue #208 · nodejs/loaders · GitHub](https://github.com/nodejs/loaders/issues/208)
