---
title: "140 - 《手撕源码14：vitepress》"
date: 2022-06-24
url: https://sorrycc.com/source-14-vitepress
---

发布于 2022年6月24日

# 140 - 《手撕源码14：vitepress》

[vitepress](https://github.com/vuejs/vitepress) 是 vuepress 的 vite 版本，相比 vuepress，特点是速度快，缺点是功能少且不够稳定。最近看 vitepress 1.0 alpha 了，于是翻翻源码看，顺便给完善 umi 4 的文档和 Blog 方案提供思路。

vitepress 支持 3 个命令，dev、build 和 serve。

dev 入口文件仅 23 行代码。由于不走 ssr，特别简单，用 vite.createServer + vitePressPlugin 就完事了。

build 分三步，bundle、render 和写 hashmap.json。bundle 会同时做 server 和 client 的构建，input 除了运行时的 client/app，还有每个页面的 markdown 文件。render 是拿 server 的产物，把每个页面挨个渲染一遍。hashmap.json 是每个页面的 chunk hash，用于部署后缓存的增量更新。

serve 是基于 build 后的产物启一个静态服务群，基于 [polka](https://github.com/lukeed/polka) + [sirv](https://github.com/lukeed/sirv)。

作为文档工具，最核心的还是 markdown 的处理。vitepress 的 markdown 基于 [markdown-it](https://github.com/markdown-it/markdown-it)，然后加了 10+ 插件，完成从 markdown 到 html 的解析；此外还有提供 markdownToVue.ts，在 html 的基础上，将其通过 `<template>` 包装成一个 vue 组件；返回的数据除了 vueSrc，还有 pageData、deadLinks 和 includes；整体基于 [lru-cache](https://github.com/isaacs/node-lru-cache) 加了一层缓存。

看完这个，我已经有了 umi 4 文档方案的改进思路。
