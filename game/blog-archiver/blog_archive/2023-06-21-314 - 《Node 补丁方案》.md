---
title: "314 - 《Node 补丁方案》"
date: 2023-06-21
url: https://sorrycc.com/node-polyfill
---

发布于 2023年6月21日

# 314 - 《Node 补丁方案》

1、三类补丁。

这里很容易做漏了。

1）可以打补丁的模块。解法是通过 alias 隐射到补丁路径。

```ts
import path from 'path';
console.log(path.join('a', 'b'));
```

2）不可以打补丁的模块。解法是通过 externals 返回空包。

```ts
import fs from 'fs';
console.log(fs);
```

3）可以打补丁但不需要 import 即可使用。解法是写 swc 插件，遇到比如 process 但有没有 bindings（被定义）时改成 `require('process')` 。

```ts
console.log(process);
```

2、集成 node-libs-browser。

node-libs-browser 的入口文件是 js，通过 js 执行后会返回补丁包的路径。

```ts
exports.cluster = null;
exports.console = require.resolve('console-browserify');
// ...
```

这对于 Rust 库集成就不友好了，先跑一遍 Node 解析既麻烦又慢，所以 fork 了一份 [GitHub - sorrycc/node-libs-browser-okam](https://github.com/sorrycc/node-libs-browser-okam)，在 polyfill 目录下为有补丁的包各自建立一个文件作为补丁，然后比如 console 模块，通过 alias 隐射到 node-libs-browser-okam/polyfill/console 即可。

一个小问题：nodejs 项目，项目里安装了 events 包，应该怎么 require 到安装的 events 包而不是 node 内置的 event 包？

参考：  
[GitHub - webpack/node-libs-browser](https://github.com/webpack/node-libs-browser)  
[RFC：node polyfill 方案完善](https://github.com/umijs/mako/issues/141)
