---
title: "306 - 《代码门禁》"
date: 2023-06-01
url: https://sorrycc.com/code-guard
---

发布于 2023年6月1日

# 306 - 《代码门禁》

为了代码质量和一致性，我们多少会通过一些手段对代码进行检测、提醒、报错、拦截。比如 Bigfish doctor、强约束、门禁、eslint、precommit、husky、lint-staged 等名词，都是和此相关，公司内部也还有不少其他工具。但不同的工具，其执行时机、效果、性能、规则都是不同的。下面是一些我的理解。

1、在哪执行？

集成到编辑器  
集成到框架  
pre-commit  
eslint 规则  
ci  
cd（流程平台）  
独立 cli

能想到的有以上这些。我理解是越早越好，越独立越好。越早越好比如在用户编码保存时就能发现肯定比发布时才能发现要好。越独立越好指如果能独立运行，那这个工具就可以在多个环节集成和执行，满足用户在不同场景下的需要。

2、可以做什么？

风格类  
质量类  
业务类  
安全类  
一致性

ESLint 的规则里就分了风格类和质量类的。风格类比如空格、代码行数的限制等；质量类比如能否用 eval、catch block 能否为空等；业务类比如…（一时没想到，但应该有）；安全类比如金额计算避免浮点数、幽灵依赖检测等；一致性比如指允许使用 a 库而不允许用 b 库、只允许使用框架最新版等。

3、如何提速？

有些规则只需要检测源码，但有些规则会需要检测依赖，比如。同时随着项目大了之后，源码可能有数千上万个文件。此时，速度可能会成为瓶颈。尤其是如何这个操作是高频操作时，比如随着框架运行，或者在 precommit 里执行。

多线（进）程  
原生语言  
缓存

多进程可以用 child\_process、cluster，多线程可以用 work\_thread 或 [piscina](https://github.com/piscinajs/piscina)；原生语言就是 Rust 了；缓存方案很多比如基于 [node-cache](https://github.com/node-cache/node-cache) 等。

4、如何让门禁有效？

要做一些动态化，让其不允许绕过。比如很多项目数千个 ESLint 报错，但是照样没人管。

5、如何做大？可扩展、配置化、可视化、平台化、数据大盘、规则动态化、钉钉通知、见缝插针推广、… 。

不展开了，懂的都懂。

参考：  
[https://xargin.com/seeking-for-high-tech-in-business-system-dev/](https://xargin.com/seeking-for-high-tech-in-business-system-dev/)  
[https://yuque.antfin.com/chenhan.wb/og335k/tlgytuhu2dwbt74w](https://yuque.antfin.com/chenhan.wb/og335k/tlgytuhu2dwbt74w)  
[256 - 《Bigfish Doctor》](https://sorrycc.com/bigfish-doctor)
