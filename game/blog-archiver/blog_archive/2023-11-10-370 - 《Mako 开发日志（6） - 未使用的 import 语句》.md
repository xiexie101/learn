---
title: "370 - 《Mako 开发日志（6） - 未使用的 import 语句》"
date: 2023-11-10
url: https://sorrycc.com/mako-devlog-06
---

发布于 2023年11月10日

# 370 - 《Mako 开发日志（6） - 未使用的 import 语句》

> 上午刚修完的一个问题，记录下。

## 问题

先看一个场景。

```ts
// entry
import * as foo from 'foo'
console.log('entry');

// foo/index.js
export const foo = 'foo';
console.log('foo');
```

此时打包结果应该是啥？

## 答案

这样？

```ts
console.log('entry');
```

你没考虑到的点是，foo/index.js 可能有 side effects。

还是这样？

```ts
console.log('foo');
console.log('entry');
```

两个答案的差异是：foo 模块有没有被保留。

事实上，会稍微更复杂些。在没有补充更详情的信息前，这题没有标准答案。那有哪些决定因素呢？1）文件是 ts 还是 js，2）被 import 的 foo 有没有 side effects。

答案是，

*   如果是 ts 文件（包含 tsx），不管 foo 有没有 side effects，foo/index.js 模块都不会被保留
*   如果是 js 文件，foo 在 side-effects: false 时被删除，否则会保留

为啥 ts 会全删？我猜是因为 tsc 就这么做的，所以各个 bundler 都遵循 tsc 的逻辑。那为啥 js 要这么做？我猜可能是历史原因要考虑 cjs 的场景，或者因为 webpack 是这么做的，所以遵循这个事实标准。

## 实现

1、如果是 ts，transform 阶段直接删所有没用到的 import 就完了  
2、如果是 js，transform 阶段先得全部留着，交给 tree shaking 处理，因为 transform 阶段是模块级的，transform entry.js 时并不知道 foo 这个模块有没有 side effect，只有在 tree shaking 阶段才知道所有的模块关系

然后，具体实现时，还和 dead code delete 有些交集要处理。比如不能让 dead code delete 删除顶层 import 过来的语句，因为删了后 tree shaking 阶段就拿不到信息，从而无法做进一步的分析和 shaking 。

## BONUS

一个小知识点。

```ts
import * as foo from 'foo';
import 'bar';
```

这段代码中，下一句 `import 'bar'` 不管啥场景都不会被删除。
