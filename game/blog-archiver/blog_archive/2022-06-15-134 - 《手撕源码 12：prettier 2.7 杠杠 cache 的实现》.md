---
title: "134 - ã€Šæ‰‹æ’•æºç  12ï¼šprettier 2.7 æ æ  cache çš„å®ç°ã€‹"
date: 2022-06-15
url: https://sorrycc.com/source-12-prettier-27-cache
---

å‘å¸ƒäº 2022å¹´6æœˆ15æ—¥

# 134 - ã€Šæ‰‹æ’•æºç  12ï¼šprettier 2.7 æ æ  cache çš„å®ç°ã€‹

æ˜¨å¤©å‘å¸ƒçš„ [prettier 2.7](https://prettier.io/blog/2022/06/14/2.7.0.html) é‡Œæ”¯æŒäº† `--cache` å‚æ•°ï¼Œæ”¯æŒç¼“å­˜èƒ½åŠ›ï¼Œåœ¨æœ‰ç¼“å­˜æ—¶ç›´æ¥åè¾“å…¥ä¸åšå‡ºå…¥ï¼Œä»è€Œå¤§å¹…æå‡ prettier çš„æ‰§è¡Œæ•ˆç‡ã€‚è¿™èƒŒåæ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ

å…ˆçœ‹ç¤ºä¾‹ï¼Œ

```bash
$ prettier --write --cache ./src
src/index.test.ts 0ms (cached)
src/index.ts 0ms (cached)
```

æŠ±ç€å¥½å¥‡çš„å¿ƒæƒ…ï¼Œæ˜¨å¤©åœ¨ç›´æ’­æ—¶å°±å¿ä¸ä½çœ‹äº†ä¸‹ prettier çš„å®ç°ã€‚è§‚å¯Ÿ [PR](https://github.com/prettier/prettier/pull/12800/files) ä¸éš¾å‘ç°è¿™æ¬¡æ–°å¢äº†å‡ ä¸ªä¾èµ–ï¼Œfile-entry-cacheã€find-cache-dir å’Œ sdbmã€‚

1ã€[file-entry-cache](https://github.com/royriojas/file-entry-cache) è™½ç„¶åªæœ‰ Star åªæœ‰ 30+ï¼Œä½†å‘¨ä¸‹è½½å´æœ‰ 1.8 åƒä¸‡+ï¼ŒåŒ…æ‹¬ eslintã€stylelintã€textlint ç­‰å¤§ç‰Œåº“éƒ½æ˜¯åŸºäºä»–æ¥å®ç°ç¼“å­˜ã€‚

```ts
// 1ã€å¼•å…¥ä¾èµ–
const fec = require('file-entry-cache');
// 2ã€åˆ›å»ºç¼“å­˜å®ä¾‹
const cache = fec.create('foo.json', __dirname, /*åŸºäºæ–‡ä»¶æ ¡éªŒ*/true);
// 3ã€è®¿é—®æ–‡ä»¶ï¼Œæ‰¹é‡æˆ–å•ä¸ªéƒ½å¯ä»¥ï¼Œè®¿é—®åå°±ä¼šè®°å½•åœ¨å†…å­˜é‡Œ
// ç¬¬äºŒæ¬¡æ‰§è¡Œæ—¶å°±èƒ½æ‹¿åˆ° changed ä¿¡æ¯
cache.getUpdatedFiles(['/foo.js', '/bar.js', ...]);
cache.getFileDescriptor('/foo.js');
// 4ã€ä¿å­˜æ–‡ä»¶ä¿¡æ¯åˆ°ç‰©ç†æ–‡ä»¶ foo.json
cache.reconcile(/* ä¸æ¸…ç†æœªè®¿é—®çš„æ–‡ä»¶ */true)
```

2ã€[find-cache-dir](https://github.com/avajs/find-cache-dir) æ˜¯å®šä½ç¼“å­˜è·¯å¾„ï¼Œé»˜è®¤ç”¨ `./node_modules/.cache/xxx`ï¼Œè¿™æ˜¯ node ç¤¾åŒºä¸æˆæ–‡çš„çº¦å®šã€‚

3ã€[sdbm](https://github.com/sindresorhus/sdbm) ç”¨äºä¸ºå­—ç¬¦ä¸²ç”Ÿæˆ hash å€¼ï¼Œæ¯”å¦‚ `sdbm('ğŸ¦„ğŸŒˆ')` å¯ä»¥æ‹¿åˆ° 4053542802ï¼Œprettier é‡Œæ‹¿åˆ°åšé…ç½®é¡¹çš„ hash åŒ–ã€‚

çœ‹å®Œæ–°å¢ä¾èµ–åº“çš„åŠŸèƒ½ï¼Œå†çœ‹ prettier çš„å®ç°å°±å¾ˆæ¸…æ™°äº†ï¼Œä¸»è¦ä»£ç åœ¨ `src/cli/format.js`ã€‚

1ã€å…ˆå®ä¾‹åŒ– FormatResultsCacheï¼Œæ”¯æŒä¸¤ç§ç¼“å­˜ç­–ç•¥ï¼Œmetadata å’Œ contentï¼Œå‰è€…åŸºäº mtime å’Œæ–‡ä»¶å°ºå¯¸ï¼Œåè€…åŸºäºæ–‡ä»¶å†…å®¹  
2ã€æ ¼å¼åŒ–å…·ä½“æ–‡ä»¶æ—¶ï¼Œåˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨äºç¼“å­˜ï¼Œåˆ¤æ–­çš„åŒæ—¶å…¶å®ä¹Ÿæ˜¯å†™å…¥ä¿¡æ¯çš„è¿‡ç¨‹ï¼ŒæˆåŠŸåæ›´æ–°æ–‡ä»¶çš„ meta ä¿¡æ¯ï¼Œå†™å…¥åŸºäº sdbm hash åçš„ options å€¼  
3ã€æ‰€æœ‰æ–‡ä»¶æ ¼å¼åŒ–ä¹‹åæ‰§è¡Œ cache çš„ reconcileï¼Œå†™å…¥ç¼“å­˜ä¿¡æ¯åˆ°ç‰©ç†æ–‡ä»¶

å‚è€ƒï¼š  
[https://github.com/prettier/prettier/pull/12800/files](https://github.com/prettier/prettier/pull/12800/files)  
[https://github.com/royriojas/file-entry-cache](https://github.com/royriojas/file-entry-cache)  
[https://github.com/avajs/find-cache-dir](https://github.com/avajs/find-cache-dir)  
[https://github.com/sindresorhus/sdbm](https://github.com/sindresorhus/sdbm)
