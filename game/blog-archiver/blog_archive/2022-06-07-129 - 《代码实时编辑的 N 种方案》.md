---
title: "129 - 《代码实时编辑的 N 种方案》"
date: 2022-06-07
url: https://sorrycc.com/how-to-edit-code-lively
---

发布于 2022年6月7日

# 129 - 《代码实时编辑的 N 种方案》

上午做了一些调研，目的是想给 Umi 加上实时编辑能力，让开发者在 Umi 官网即可实时编辑代码并看到结果。如果你想的官网、组件库、课程、Blog 等加上实时代码编辑功能？不妨试试以下方案。

1、最新出的 [devjar](https://github.com/huozhi/devjar) 是最潮的，esm + import-maps + sucrase 实时编译，缺点是兼容性要求高且不支持 hmr。实现部分，用 es-module-shims 支持 import-maps；传入的代码模块转化成 Inline Modules；用 sucrase 实时编译代码，支持 jsx 和 typescript；用 es-module-lexer 提取 import 并替换路径为 cdn 上 esm 格式的地址，同时支持 externals。

```ts
// 第一步：import
import { useLiveCode } from 'devjar';

// 第二步：使用 useLiveCode 拿到 ref 和 load
const { ref, error, load } = useLiveCode({ getModulePath(m) { return `https://cdn.skypack.dev/${m}` } });

// 第三步：把 ref 传给 iframe
<iframe ref={ref} />

// 第四步：用 load 加载文件，index.js 是必须的
load({
 'index.js': `export default () => 'Hello world!'`,
});
```

2、[react-runner](https://github.com/nihgwu/react-runner) 看名字就是和 react 耦合的，源码翻了下感觉平平无奇。用 sucrase 编译代码，然后通过 scope.import 声明依赖；依赖代码需要自己手动引入，如果要处理 import，还需要手动调 importCode 编译一次；通过 (new Function(…scopeKeys, code))(…scopeValues) 来执行代码，传入 require、exports、render、React 等，然后拿修改过的 exports.default 交给 createElement 渲染。

```ts
import { importCode, Runner } from 'react-runner';
<Runner
 code={code}
 scope={{ import: { foo, './local-file': importCode(content, baseScope) } }}
/>
```

3、[react-live](https://github.com/FormidableLabs/react-live) 和 react-runner 类似，或者说 react-runner 的实现中大量 copy 了 react-live 的代码。盲猜 react-live 之前使用 Bublé 编译代码，不支持进阶语法，然后 react-runner 将其改成了 sucrase，但后来 react-live 也换成了 sucrase。编码源码部分唯一的不同点是，react-live 用 return (code) 的方式拿到入口组件，而 react-runner 是通过 exports + require 拿，后者更通用一些，比如可以兼容 export default 不是写在最后的场景。

4、[sandpack](https://github.com/codesandbox/sandpack) 是 codesandbox 产品中实时编辑的部分，体验非常好，支持 HMR、Fast Refresh、Error Overlay 等。React 新官网（[https://beta.reactjs.org/learn](https://beta.reactjs.org/learn) ）也基于此。实现上基于 iframe，通过 postMessage 的方式进行通信，默认会用 [https://1-0-0-sandpack.codesandbox.io/](https://1-0-0-sandpack.codesandbox.io/) 处理代码的编译和打包。如果对性能、安全有要求的场景，可以部署一份他们后来开源的 [sandpack-bundler](https://github.com/codesandbox/sandpack-bundler)。sandpack-bundler 的实现值得单独写一篇，这里不展开了。

5、以上是相对轻量的方案，更重的还有 codesandbox 和 [stackbliz](https://stackblitz.com/) 等也是一个选择，其中后者 stackbliz 可完美跑 umi 4 + mfsu。

参考：  
[https://github.com/huozhi/devjar](https://github.com/huozhi/devjar)  
[https://www.yuque.com/mdh/weekly/ogpmv4#devjar](https://www.yuque.com/mdh/weekly/ogpmv4#devjar)  
[https://github.com/nihgwu/react-runner](https://github.com/nihgwu/react-runner)  
[https://github.com/FormidableLabs/react-live](https://github.com/FormidableLabs/react-live)  
[https://github.com/codesandbox/sandpack](https://github.com/codesandbox/sandpack)  
[https://github.com/codesandbox/sandpack-bundler](https://github.com/codesandbox/sandpack-bundler)  
[https://www.joshwcomeau.com/react/next-level-playground/](https://www.joshwcomeau.com/react/next-level-playground/)  
[https://www.ctnicholas.dev/articles/how-to-use-sandpack-for-code-demos](https://www.ctnicholas.dev/articles/how-to-use-sandpack-for-code-demos)
