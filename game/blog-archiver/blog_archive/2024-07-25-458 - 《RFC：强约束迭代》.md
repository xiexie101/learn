---
title: "458 - 《RFC：强约束迭代》"
date: 2024-07-25
url: https://sorrycc.com/constraints-2024
---

发布于 2024年7月25日

# 458 - 《RFC：强约束迭代》

> 刚写的一个 RFC。

## 背景

现在强约束分几类，

1、依赖类，比如不能使用 redux 依赖  
2、代码类，比如对语法、行数、文件的检查  
3、配置类，有些配置太灵活，不让用

在 2022 版的强约束实现里，Umi 4 的插件里新增了几个 API，专门用于检测类，

1、`api.onCheck`，提供专门的检测阶段，做任意的自定义检测  
2、`api.onCheckConfig`，做配置检测  
3、`api.onCheckPkgJSON`，做 package.json 检测  
4、`api.onCheckCode`，提供 file、code、import 和 export 信息等，做代码级检测

注：在强约束规则里，其实并不需要对 ast 做操作，所有信息都是前置分析完成的。

## 问题

1、强约束不能独立跑，这导致的问题是，比如，1）不能在流程平台、CI 平台里跑和产出结果日志  
2、切换到 Mako 后部分强约束条件失效，这导致的问题是，比如，1）有些用户切换到 Mako 后由于一些原因要切回 Webpack，就可能会触发强约束

2 是目前面临的主要问题，1 是之前就想做的。期望通过这次调整，解 2 的同时把 1 的问题也一起解掉。

## 调研

关于独立跑，有一些方案，

1、oxc / eslint + 自定义规则  
2、原来那一套单独提出来跑，config + package.json + babel + others  
3、基于 2，把 babel 的部分换成 mako

2 和 3 的区别，除了速度上的差异，还有增量处理的差异。用 mako 或者其他构建工具，主要是，1）可以处理增量，2）可以精确处理 import 到的文件。怎么理解精确？比如 src/a.ts，只有被 import 到，存在于 module graph 时才应该被强约束校验。

所以，倾向于 3。

## 方案

1、新增一个包，比如 @umijs/constraints，用于实现通用的约束  
2、提供 onCheck、onCheckConfig、onCheckPkgJSON 和 onCheckCode 的能力，和 Umi 现有功能对齐，其中 onCheckCode 的能力通过跑 Mako build + externals 所有依赖 + 新增 build 阶段的 js hook 来实现（支持 watch）  
3、支持挂载规则和规则集  
4、支持应用级和规则级的白名单配置机制

## 集成到 Bigfish

1、由于开启 Mako 之后，现有 Mako 项目部分规则的强约束是失效的，所以在集成到 Bigfish 时，需要对这些 Mako 项目单独跑一遍规则，把冲突的部分加白。

参考：  
[42 - 《Umi 4 的强约束》](https://sorrycc.com/umi-4-constraints)
