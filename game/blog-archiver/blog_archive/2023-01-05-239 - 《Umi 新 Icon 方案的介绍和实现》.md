---
title: "239 - 《Umi 新 Icon 方案的介绍和实现》"
date: 2023-01-05
url: https://sorrycc.com/umi-icons
---

发布于 2023年1月5日

# 239 - 《Umi 新 Icon 方案的介绍和实现》

这两天花了两个下午（4hx2）实现了 Umi 的新 Icons 方案，目前已随着今晚的发版更新上去了，但是，1）文档还没有加，2）还有大量细节和优化问题。这里展开介绍下他是什么以及是如何实现的。

这个方案是什么？通过以下方式即可在 Umi 中使用 Icon。效果见 PR [https://github.com/umijs/umi/pull/10202](https://github.com/umijs/umi/pull/10202) ，有 GIF 图。

```tsx
import { Icon } from 'umi';
<Icon name="fa:home" />
```

1、fa:home 是啥一次？fa 是 icon 集，home 是 icon 名。icon 集可以在 [https://icones.js.org/](https://icones.js.org/) 查看和搜索，然后复制 `{collection}:{icon}` 到代码中即可使用。也就是说这个方案可以使用这里的几万个 icon，包含 antd 的 icons 等。

2、此方案在思路和实现都参考了 [https://github.com/antfu/unplugin-icons](https://github.com/antfu/unplugin-icons) ，区别是 1）性能更好，unplugin-icons 在多个地方使用相同的 icon 时会重复（我理解的），2）API 调用方式不同，unplugin-icons 需要写子路径，比如 `import x from '~/icons/fa/home'`，3）Umi 的方案会支持类型提示，4）Umi 方案在运行时也会支持更多功能，比如 antd icon 的 spin、rotate、default component config 等（目前还没有，等下个迭代…），unplugin-icons 只是用 svgr 转完就直出给用户了。

3、除了支持定义好的 icon 集，也会支持本地的 svg、远程的 icon（比如 [iconfont.cn](http://iconfont.cn) 上的）、内部也会计划和设计工程化平台（海兔）做集成（设计师传到平台上的 icon 工程师就可以通过约定的字符串拿来使用，工具会自动做 svg 的拉取和格式化）。

再看此方案是如何实现？代码见 PR。简单说是基于 esbuild + svgr + iconify + Icon 组件，展开说的话有这么几步。

1、如何把用户代码中的 `<Icon icon="fa:home" />` 中的 `fa:home` 提取出来？我问了 ChatGPT，他给了一些方案，但都不好。比如，1）用正则，2）用 babel 全家桶。目前我是写了个简单的 token 分析器，性能相对来说更好。具体实现是先找到 `<Icon`，再往下找 `icon="`，然后遇到 `>` 结束，但是没处理边界场景，比如，1）`/* <Icon icon="fa:home" />*/`，2）`const str = '<Icon icon="fa:home" />'`，3）Icon 不是来自 umi 或 `@umijs/max`。后续可能考虑换 [https://github.com/lydell/js-tokens](https://github.com/lydell/js-tokens) 。

2、上一步是单个文件的分析，那如何做整体项目的分析，并且保证其性能呢？这里有两个选择，1）用 glob 找出所有 src 下的代码，生成 map，然后合成一个大文件分析，增量更新或删除时更新 map，再合成大文件分析，unocss 和 mfsu eager 模式都用的这种方式，优点是性能好，缺点是不准确，因为会包含未使用的 dead code，2）用 esbuild 打包入口文件，只处理项目内文件，所有依赖、非项目路径的绝对路径引用、非 js 或 ts 文件全部走 external，这样比较准确，同时又保证了速度。我是用的后者。

3、分析出 `fa:home` 集合（`Set<string>`）之后，要将他转换成具体的 svg。这个环节有现成的工具，基于 `@iconify/utils/lib/loader/node-loader` 的 `loadNodeIcon` 方法即可。

4、注意，上一步拿到的 svg 并不能直接在 React 组件中使用，要在 React 内用，通用的做法是用 svgr 这个工具转一遍成 React 组件，基于 `@svgr/core` 的 `transform` 方法即可。一个额外的好处是他还会用 svgo 做一遍压缩。

5、拿到 svg 组件之后，我会在 `.umi` 临时目录下生成一个临时文件，包含 `fa:home` 和 svg react 组件的映射关系。

```tsx
const faHome = props => <svg>...</svg>;
export { faHome };
const faXXX = props => <svg>...</svg>;
export { faXXX };
...
```

6、最后一步就是 Icon 运行时组件了，基于传入的 `icon` props 找到 faHome 对应的 svg react 组件，渲染出来即可。这里还有很多可以做的事，包括 ts 类型提示、spin、rotate、flip、twoToneColor 等，感兴趣的同学可以直接提 PR 加上。

好了，这就是 Umi 新的 Icon 方案，希望大家看完能有所收获。
