---
title: "158 - 《手撕源码 21：Valtio》"
date: 2022-07-28
url: https://sorrycc.com/source-21-valtio
---

发布于 2022年7月28日

# 158 - 《手撕源码 21：Valtio》

Valtio 的作者和 zustand 一样，也是 Daishi Kato，就不重复介绍了。

Valtio 是 mutable state 的数据流，和 mobx、overmind、react-easy-state 是同一类。相比 immutable state 数据流，mutable state 数据流的优点是 1）数据更新更符合习惯 2）原子化更新优化，无需手写 selector 函数；同时缺点也比较明显，1）由于基于 Proxy 实现所以兼容性要求高，比如不支持 IE 或支持起来有缺陷 2）对一些数据结构有限制比如 Map。

先看使用方式。

```ts
// 1、定义数据
const state = proxy({ count: 0 });
// 2、在 react 外使用和更新数据
state.count += 1;
// 3、在 react 中使用和更新数据
const snap = useSnapshot(state);
snap.count;
state.count += 1;
```

再看源码。整体分两部分，定义数据的 proxy 和使用数据的 useSnapshot。我提取了下核心代码（未支持嵌套对象），仅 109 行，见 [toy-valtio.ts · GitHub](https://gist.github.com/sorrycc/af0f48f8a44deddf591e7a7bf74da4a7)。代码量少还有个原因是复杂的「自动渲染优化」功能已被提取到底层库 proxy-compare 中。

proxy 基于 Proxy 实现，把原始数据包起来。通过在 set 和 deleteProperty handler 里用递增的 version 数字来记录是否发生变更，变更之后执行所有 listener；再对外提供 snapshot 和 listeners 接口，用于和 react 或其他消费方对接；嵌套对象更新的 track 实现「?待补充」。

useSnapshot 基于 useSyncExternalStore 和 proxy-compare 实现，前者用于连接 proxy 创建的 state 和 react，后者用于实现「自动渲染优化」（根据使用做最小范围的更新）。proxy-compare 的自动渲染优化是基于 proxy 的 get handler 记录有使用到哪些属性，然后在 state 更新后决定是否要更新组件。

作者也有些两篇文章分别介绍 [proxy](https://blog.axlight.com/posts/how-valtio-proxy-state-works-vanilla-part/) 和 [useSnapshot](https://blog.axlight.com/posts/how-valtio-proxy-state-works-react-part/)，我阅读时顺手整理了中英文翻译版，见附件。

Valtio 还支持 React Suspense，实现方式是在 snapshot 时检测到 Promise 会直接 throw 出来。

参考：  
[https://github.com/pmndrs/valtio](https://github.com/pmndrs/valtio)  
[https://blog.axlight.com/posts/when-i-use-valtio-and-when-i-use-jotai/](https://blog.axlight.com/posts/when-i-use-valtio-and-when-i-use-jotai/)  
[https://blog.axlight.com/posts/how-valtio-proxy-state-works-vanilla-part/](https://blog.axlight.com/posts/how-valtio-proxy-state-works-vanilla-part/)  
[https://blog.axlight.com/posts/how-valtio-proxy-state-works-react-part/](https://blog.axlight.com/posts/how-valtio-proxy-state-works-react-part/)  
[https://gist.github.com/sorrycc/af0f48f8a44deddf591e7a7bf74da4a7](https://gist.github.com/sorrycc/af0f48f8a44deddf591e7a7bf74da4a7)
