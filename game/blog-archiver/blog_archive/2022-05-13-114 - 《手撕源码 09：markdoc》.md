---
title: "114 - 《手撕源码 09：markdoc》"
date: 2022-05-13
url: https://sorrycc.com/source-09-markdoc
---

发布于 2022年5月13日

# 114 - 《手撕源码 09：markdoc》

markdoc 是最近 Stripe 出的文档工具，吸引了不少眼球。markdoc 引入了一种新的 markdown 编写方式，可以和任意语言结合使用，目前支持 react 和 html。

和 mdx 有啥区别？mdx 只针对 react，并且自定义内容的接入方式只能是组件；markdoc 理论上可接入任意语言，接入方式除了组件（tag），还有函数、attriubte、variable、表达式等。以下是 markdoc 和 mdx 的语法例子。

```ts
# Hello Umi
{% image src="/logo.svg" /%}
{% callout type="check" %}
Umi is yet another React Framework.
{% /callout %}

import { Image, Callout } from './components';
# Hello Umi
<Image src="/logo.svg" />
<Callout type="check">
Umi is yet another React Framework.
</Callout>
```

markdoc 提供 3 个功能，parse、transform 和 render。parse 包括 tokenize 和 parser 两个过程，tokenize 有额外增加处理 annotation（{% test %}） 和 frontmatter 的插件，parser 是把 token 合成 ast 的过程；transform 负责把 ast 转换成可渲染的树，每个节点包含 name、attributes 和 children 三个属性；render 负责把可渲染树转化成 dom 结构，react render 是转化成 React 组件树。

```ts
const ast = Markdoc.parse(doc);
const content = Markdoc.transform(ast);
Markdoc.renderers.react(content, React);
```

markdoc 有依赖 markdown-it，但主要用他来处理 tokenize 的过程（renderers/html 也用了一部分），剩下 transform 和 render 的过程都是自己实现的。

工程化部分。用了好多几年未更新的老库，比如 pegjs 和 ts-eager；利用 patch-package 给 markdown-it 库打补丁；类型通过 tsc --emitDeclarationOnly --outDir dist 单独生成；build 基于 esbuild，把依赖全打包到一起，生成 index.js、index.mjs 和 react.js，其中 react.js 是针对 react 的渲染器。

参考：  
[https://markdoc.io/](https://markdoc.io/)  
[https://github.com/markdoc/markdoc](https://github.com/markdoc/markdoc)  
[https://github.com/markdoc/docs](https://github.com/markdoc/docs)  
[54 - 《unified、remark、rehype 和 mdx》](https://sorrycc.com/markdown-parser)
