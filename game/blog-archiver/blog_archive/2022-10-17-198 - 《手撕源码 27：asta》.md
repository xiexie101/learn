---
title: "198 - 《手撕源码 27：asta》"
date: 2022-10-17
url: https://sorrycc.com/source-27-asta
---

发布于 2022年10月17日

# 198 - 《手撕源码 27：asta》

翻下 132 的新库，周末 132 在群里喊了好久，就翻翻看。

地址在 [https://github.com/yisar/asta](https://github.com/yisar/asta) 。star 有水分，好像之前是 smox 状态库，然后改了个名。整体库还是 POC 的状态，可以验证一些想法，离上生产还早。

**如何实现 Resumable？**

挂载 asta.js，处理 document.addEventListener，监听绑了 $on 前缀属性的元素，目前只处理了 click，click 之后动态 import 并用 mod 参数声明的方法执行并拿到新的 state，新的 state 用 window.dispatch 执行下。

```ts
document.addEventListener((e) => {
  const target = e.target;
  const url = target.getAttribute('$on' + event);
  const { mod } = parseUrl(url);
  import(url).then(mods => {
    const newState = mods[mod](window.__state, e);
    window.dispatch(newState);
  });
});
```

dispatch 做了啥？1）合并 state，2）挂载 client 的 app.js 拿到 vdom，3）patch，同步 vdom 到 html 。

```ts
window.dispatch = (newState) => {
  window.__state = { ...window.__state, ...newState };
  import('./app.js').then((mod) => patch(root, mod.default(window.__state), root.firstChild, 0));
};
```

**如何打包 server 和 client 产物？**

基于 esbuild，然后作者写了 2 个 esbuild 插件。

1、server 生成 sdom，client 生成 vdom  
2、action 部分，server 保留路径，client 直接返回代码

参考：  
[https://github.com/yisar/asta](https://github.com/yisar/asta)
