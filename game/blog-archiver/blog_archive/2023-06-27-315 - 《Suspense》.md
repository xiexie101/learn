---
title: "315 - 《Suspense》"
date: 2023-06-27
url: https://sorrycc.com/suspense
---

发布于 2023年6月27日

# 315 - 《Suspense》

1、为啥会有 Suspense？

其实最初是为了解 Client 的 CLS 问题。CLS 全称 Cumulative Layout Shift（累积布局偏移），可以看 [web.dev 的详细介绍](https://web.dev/cls/) ，如果没时间，通过下面两个形象的例子应该也能感受到是啥问题。

![](https://img.alicdn.com/imgextra/i3/O1CN01HGI7dv1bd5w54pTvm_!!6000000003487-1-tps-638-360.gif)

![](https://img.alicdn.com/imgextra/i4/O1CN01H1OZUD1NQMIfFLsqu_!!6000000001564-1-tps-1316-1020.gif)

例子 1 来源于 [Facebook Ad Manager](https://twitter.com/acdlite/status/991503599246098432)，大家可以数数有多少个 Loading/Spinner 占位符，这应该是 Ajax 出来后比较典型的问题之一，也称「Spinner Hell」；例子 2 可太有趣了，哈哈，坑用户没商量。

Suspense 是 React 针对这个问题的解。比如下面代码的 Foo 和 Bar，如果都有 loading 状态，会统一先渲染 LoadingComponent，等 Foo 和 Bar 都渲染完成之后，再一下子显示出来。当然，在 Suspense 之外也自行通过维护大量的 Loading 状态来处理，只不过比较麻烦。

```tsx
<Suspense fallback={<Spinner />}>
  <Foo />
  <Bar />
</Suspense>
```

大家可能会好奇的是，Suspense 是如何知道子组件里的 Foo 和 Bar 的加载状态的？

2、Suspense 原理。

Suspense 原理类似 Error Boundary，在通过 throw + try…catch 实现子组件消息的上报，这用于 Error Boundary 还算合理，用于 Suspense 总感觉有些奇怪。不同的是，用于 Suspense 时，throw 的是 Promise，然后 Suspense 基于 Promise 的状态觉得子组件的加载状态。

```tsx
function Foo() {
  const [fetchRequest] = React.useState(() => {
    return fetch('/api/foo');
  });
  if (fetchRequest.status === 'pending') {
    throw fetchRequest;
  }
  return </>;
}
```

React Query 和 SWR 都可通过配置切换到 Suspense 模式。

```tsx
import useSWR from 'swr';
function Profile () {
  const { data } = useSWR('/api/user', fetcher, { suspense: true })
  return <div>hello, {data.name}</div>
}
```

3、Suspense 应用场景。

[react.dev 官网](https://react.dev/reference/react/Suspense) 提供了大量 Suspense 的应用场景。

举一些场景的：

1）等一组组件全部加载完成后，一次性渲染  
2）加载新内容时显示老内容（基于 useDeferredValue）

```tsx
function Foo() {
  const deferredQuery = useDeferredValue(query);
  const isStale = query !== deferredQuery;
}
```

3）路由切换时等新页面的组件加载完成后再切过去（基于 startTransition + useTransition）

```tsx
function Foo() {
  const [isPending, startTransition] = useTransition();
  // 用 startTransition 告诉 React 该操作不紧急，继续显示之前的 UI 状态
  startTransition(() => {
    setPage(url);
  });
}
```

4）按需加载 React 组件（基于 React.lazy）

```tsx
const Component = React.lazy(() => import('./Component'));
function Foo () {
  return <Suspense fallback={<Spinner />}>
    <Component />
  </Suspense>
};
```

4、Suspense on Server 。

到目前为止，我们聊的其实是 Suspense on Client/Browser。这是设计 Suspense 的初心，但随着 React 团队的深入，发现当与 SSR 结合时，Suspense 能发挥更强大的作用。

SSR 的标准流程是 4 个步骤，分别是服务端获取数据、服务端渲染 HTML 给客户端、客户端加载 JS、客户端注水让交互生效。SSR 可以提升 LCP（首屏渲染时间），同时对 SEO 友好，但不能提升（可能还有损）TTI（可交互时间）。

先看 SSR 的三个问题。

1）在你展示任何东西之前，你必须先获取所有东西。即获取数据虽然挪到了服务端，但仍不可省略或跳过。  
2）你必须先加载所有的东西，然后才能水化任何东西。即 JS 必须全部加载，才能开始水化。  
3）在你与任何东西互动之前，你必须水化所有东西。即不支持渐进式水化，水化一部分，交互，然后接着水化。

React 对于上述问题的解同样是 Suspense，通过 Streaming HTML + Selective Hydration，这也是 React 18 的主打功能之二。

我们可以通过三张图来对比 Suspense 和 SSR、SWR 这几种渲染策略之间的差异。

![](https://img.alicdn.com/imgextra/i4/O1CN01E7OzbC1cTlU4HhCqZ_!!6000000003602-2-tps-2200-1274.png)  
SSR。

![](https://img.alicdn.com/imgextra/i2/O1CN012J40061HKVY0FyFj7_!!6000000000739-2-tps-2208-1284.png)  
SWR。

![](https://img.alicdn.com/imgextra/i1/O1CN01BS2rfR1VubNeUEKBk_!!6000000002713-2-tps-2210-1256.png)  
Suspense。

从图中可以清楚地看出，SSR with Suspense 快的原因是把后端获取数据和渲染的部分拆成多个不阻塞的块，让 TTI（可交互时间）和 LCP（首屏渲染时间） 两项数据都大幅提前。比如可以先渲染骨架屏，下载 JS 进行注水；然后并行地进行服务端的数据获取，有数据后再进行增量注水。

5、Suspense 问题。

举几个常见问题。

1）纯 Client Suspense 能代替 SWR / React Query 吗？明显不能。因为 1）Suspense 不能解请求瀑布流的问题，2）Suspense 不是请求方案，不包含 Cache 等能力。但是加上 RSC（React Server Component）和 React Cache 之后，还需要 SWR / React Query 吗？在 SSR 的场景下可能不需要了，可以等 React Cache 出来之后再看。

2）Antd + Dumi 的场景有遇到 [421 错误](https://legacy.reactjs.org/docs/error-decoder.html/?invariant=421)。当 Antd 网站加载时，页头和侧边栏出来后而右下内容没有出来时，点击侧边栏，会导致这个错误。

```ts
This Suspense boundary received an update before it finished hydrating. This caused the boundary to switch to client rendering. The usual way to fix this is to wrap the original update in startTransition.
```

原因是点击菜单会导致 react-router context 里的 location 更新，而子组件订阅了这个更新，注水时会用更新后的 location，此时会导致和 ssr 给的节点不一致，从而导致前面的问题。解法是相关的路由等副作用切换加 startTransition。

参考：  
[https://github.com/reactwg/react-18/discussions/37](https://github.com/reactwg/react-18/discussions/37)  
[https://react.dev/reference/react/Suspense](https://react.dev/reference/react/Suspense)  
[https://yuque.antfin.com/shizexian.szx/bq38rg/gceidq0hnr6e28xd](https://yuque.antfin.com/shizexian.szx/bq38rg/gceidq0hnr6e28xd)  
[https://courses.joshwcomeau.com/joy-of-react/06-full-stack-react/10-suspense](https://courses.joshwcomeau.com/joy-of-react/06-full-stack-react/10-suspense)  
[https://zhuanlan.zhihu.com/p/486544341](https://zhuanlan.zhihu.com/p/486544341)
