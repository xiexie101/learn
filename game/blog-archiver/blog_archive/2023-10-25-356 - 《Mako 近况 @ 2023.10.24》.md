---
title: "356 - 《Mako 近况 @ 2023.10.24》"
date: 2023-10-25
url: https://sorrycc.com/mako-status-2023-10
---

发布于 2023年10月25日

# 356 - 《Mako 近况 @ 2023.10.24》

> 今天 10.24 的 10:24 对内发布了 Mako RC。这是一个里程碑式的发布，和大家汇报下 Mako 的现状和计划。

1、从 \[\[Mako 发布 Alpha\]\] 到现在已经 3 个多月，Mako 在能力上做了很多补齐，在构建和产物性能方面也做了很多努力，同时为了发布后的稳定性做了不少工程化的事情，以及做了和内网框架 Bigfish 的深度集成。

2、Mako 在功能方面已是成熟的构建工具。我们补齐了 Tree Shaking、Code Splitting、Top Level Await、Transpile、Cache、Plugin 等能力，同时针对内网项目环境补充了 Less 的支持，以及细调了 CSS 加载问题、Auto CSS Modules、Px2rem、HMR 大量 DX 问题等之后，目前已能跑 80% 以上的项目。但是，需要注意的是，部分功能是需要一定的时间完善的。比如 Tree Shaking，我们的打包产物和 Webpack 还会有 10% - 20% 的差距；比如 Code Splitting，在产物尺寸和页面性能之间找一个好的平衡点，并不是件容易的事。同时，也还有不少边缘功能需要补齐，比如 Worker、Node 目标产物、多 Entry、Dev 阶段的 Tree Shaking、按需 External、Case Sensitive 检测等等。

![](https://img.alicdn.com/imgextra/i1/O1CN01Fgjr8J1r6bjKmoTSh_!!6000000005582-2-tps-1690-1680.png)

当前架构图。

3、数据方面例行做了 Benchmark，见下图，分别是 Mac Intel 和 Mac M2 Max 的。代码是基于 Farm 和 Rspack 的 Benchmark 仓库加了 Mako 的，和他们相比各有优缺点，大家都是一个数量级的。但是，Benchmark 只能说明小部分问题，Benchmark 快其实跑真实项目不一定快。因为 Benchmark 有很多不同维度，同时大家日常的中后台项目的量级（模块数和依赖数）都远超这个项目，可能是他的 100 倍。

![](https://img.alicdn.com/imgextra/i3/O1CN01uzlJwu20zs3s2fJ5e_!!6000000006921-0-tps-1744-466.jpg)

Mac Intel。

![](https://img.alicdn.com/imgextra/i2/O1CN01ncQKPm23Wxubbdyyg_!!6000000007264-2-tps-2456-542.png)

Mac M2 Max。

另外值得一提的是，Mako 还内置了另一种热更模式，开启后能在 Intel 下能达 M2 Max 的热更效果，见下图。预计正式版发布之前会打磨好并默认开启。

![](https://img.alicdn.com/imgextra/i2/O1CN01SrhwZ91zyD0Wg7q8B_!!6000000006782-0-tps-3476-920.jpg)

4、工程化方面也做了不少事。比如，我们提供了 codemod 脚本，让用户可一键将 Bigfish 项目的构建工具切换为 Mako，见下方命令，同时也做了不少兼容以确保项目通过 codemod 调整的代码尽可能少，通常只会有配置项和 package.json 的调整。

```bash
$ tnpx @内网域/mako-codemod
```

此外还有。我们手动验了几十个项目，并通过脚本验了几百个项目的 Build 可用性，在 11.24 正式发布前会验完 1900+ Bigfish 4 项目；我们还通过脚本跑了 1800+ Bigfish 项目在用 npm 包及其不同版本的入口文件的 build 可用性和运行时可用性；我们针对 mako 做了 e2e 测试，确保各种场景下的用例能正确执行（用例持续完善中）；以及，基于 commit 的 Benchmark 脚本，用来检查是哪个 Commit 让构建性能或产物性能劣化了。

5、Bigfish 上做的工作是很薄的胶水层。Mako 对于 Bigfish 来说是继 Webpack、Vite、esbuild 之后的第四个构建工具，所以只需要照例增加一个 bundler-mako，然后用户使用时通过配置开启即可，代码如下。当然，作为新兴工具，二者在配置层有不少差异，我们也在其中做了抹平。

```ts
export default {
  mako: {},
}
```

但是如果仅作为构建，那我们当初选 Rspack 或 Farm 就好了。构建工具对于框架来说并不仅仅是构建，Bigfish 会做很多前置或后置的操作，比如 icons 和 overrides.css 的预分析、补丁文件的前置生成、配置的预编译和读取、强约束校验里的规则、前置分析得到的 imports 和 exports 模块图谱、ssr 产物的构建、mfsu 的构建和串联，等等，都需要构建工具的支持。注：时间原因，这些都还没做，可能在正式发布之后处理。

经统计，根据项目的不同，Bigfish 在 Build 阶段能减少 20% 到 80% 的时间消耗。由于 Bigfish 本身基于 Node 实现，其所消耗时间在上一段做完之前不会有明显变化，所以项目越大，效果会越明显。同时，值得注意的是，目前我们的 Tree Shaking 效果还不如 Webpack，部分场景下产物尺寸会有 10% 到 20% 的增加，这需要时间进行打磨。

6、下一步做啥？在 11.24 发布日（对内）之前的最后一个月，我们会把精力放在稳定性、边界场景的处理、性能优化和研发体验上。

在构建性能上还有很多可以做的事，比如利用 optimizePackageImports 大幅减少模块总量、拆分 HMR 的两个阶段大幅提升 HMR 速度；在产物性能上会打磨 Code Splitting 策略以让加载页面所需字节最小化；稳定性方面，会跑完 1900+ Bigfish 4 的构建验证，以及重新跑 1800+ npm 包不同版本的入口文件可用性验证；研发体验方面主要是对于热更时边界场景的处理。
