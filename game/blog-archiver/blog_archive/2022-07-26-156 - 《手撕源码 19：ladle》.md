---
title: "156 - 《手撕源码 19：ladle》"
date: 2022-07-26
url: https://sorrycc.com/source-19-ladle
---

发布于 2022年7月26日

# 156 - 《手撕源码 19：ladle》

为啥看 ladle？一个原因是最近 dumi 2 开始启动，但是和项目的集成模式这块还没有想地很清楚，需要通过一些竞品来寻找灵感。

ladle 是 Storybook 的极简版，支持 Storybook 提出的 [CSF 规范](https://storybook.js.org/docs/react/api/csf)，目前仅支持 react，而由于基于 Vite，主打速度快的特点。

作者是 Vojtech Miksu，来自 San Francisco, CA，目前就职于 Uber，之前在 Cloudflare。

ladle 提供 3 个命令，serve（dev）、build 和 preview。同时提供可编程的 API，让 ladle 可以方便地被集成到其他工具或框架中，这点和 Vite 很像，现在大量工具和框架基于 Vite 的一个原因也是由于 Vite 除了 CLI 之外，还提供了可编程的接口，可以方便地被接入。

ladle 如何接入 Vite？基本思路是 express + vite middleware mode + ladle plugin。以 packages/ladle/lib/app 为 Vite 的 root 配置来跑应用，然后通过 `import from "virtual:generated-list"` 的方式加载动态的 story 数据，而 `virtual:generated-list` 模块在 ladle plugin 中动态处理和生成。

story 文件如何被处理？通过 globby 模块找所有 .stories. 文件，然后用模板和语法树的方式动态生成文件（这部分代码很丑）；同时给 .stories. 文件夹上热更能力，单个 stories 文件更新时会基于 axe-core 重新跑可访问性测试；stories 文件的添加和删除会触发页面刷新，通过比对每次生成的 meta 信息来决定是否需要 invalidate module 和刷新页面。

一些小的细节。1）兼容 react 17 的方式，和 umi 一样，给 react-dom/client 配置了到 react-dom 的 alias，2）手写了好多 optmizeDeps，这是为啥？Vite 分析不到吗？

工程化方面比较潮，重复的就不说了，只记录下不太一样或者说新看到的。1）基于 commitlint 做 commit lint，但好像只安装了依赖没有用？2）看到有 .devcontainer，这是啥？3）文档基于 docusaurus 2 RC 。

参考：  
[https://github.com/tajo/ladle](https://github.com/tajo/ladle)  
[https://storybook.js.org/docs/react/api/csf](https://storybook.js.org/docs/react/api/csf)
