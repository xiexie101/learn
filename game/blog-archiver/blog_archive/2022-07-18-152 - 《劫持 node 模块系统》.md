---
title: "152 - 《劫持 node 模块系统》"
date: 2022-07-18
url: https://sorrycc.com/hijacking-node-module-system
---

发布于 2022年7月18日

# 152 - 《劫持 node 模块系统》

通常有两种需求，1）劫持内容，2）劫持路径。比如 import ‘foo’，劫持内容指修改 foo 模块内容，劫持路径指修改 foo 模块路径。这两类在 umi 框架也都有不少场景。

下午又有个 Umi 场景需要做路径劫持，在这里整理记录下。

1、劫持内容

劫持内容在 umi 的场景比如用户定义的依赖、插件、mock 文件都是 .ts 格式的，而 node 原生并不支持 .ts，所以需要 require ts 文件时动态做编译。实现通常基于封装好的 privates 库就好。

```ts
import { addHook } from 'privates';
const revert = addHook(
 (code, fileName) => transform(...),
 { ext: ['.ts'], ignoreNodeModules: true, match: (fileName) => {} }
);
revert();
```

如果去翻翻 [privates 的实现](https://github.com/danez/pirates/blob/main/src/index.js)，会发现背后是通过修改 `require('module')._extensions` 实现的。

```ts
const mod = require('module');
mod._extensions['.ts'] = function newLoader(mod, filename) {
 mod._compile = (code) => {
  const newCode = hook(code, filename);
  mod._compile(newCode, filename);
 };
};
```

这个方案有个明显的缺点是，就是不能劫持 esm 模块。官方推荐的方案是通过 loader 解，比如 `node --loader fooLoader`，我在 [50 - 《Pure ESM》](https://sorrycc.com/pure-esm) 也有聊到这。但如果是工具或框架，显然不应该直接要求用户配 `NODE_OPTIONS`，做法通常是 fork 一份子进程来实现。

更早一些，还有通过 `require.extensions` 劫持的方案，不过已在 node 0.10.6 被官方 deprecated 了。

2、劫持路径

劫持路径在 umi 中也有两个场景，1）对于 webpack 模块的处理，因为 umi 打包了 webpack，所以并不会存在真实的 webpack 模块，当 webpack 插件比如 monaco-editor-plugin 依赖 webpack 时就会报错 2）对于 umi 模块的处理，umi 插件会依赖 umi，但 umi 插件不会声明 umi 作为依赖，当使用 @umijs/max 作为依赖框架时，不会有显式的 umi 依赖，会导致 umi 插件 import 不到 umi。

方案是通过修改 `require('module')._resolveFilename` 方法实现。

```ts
const mod = require('module');
const resolveFilename = mod._resolveFilename;
mod._resolveFilename = function (request, parent, isMain, options) {
 const newRequest = hook(request);
 return resolveFilename.call(mod, newRequest, parent, isMain, options);
};
```

参考：  
[https://gist.github.com/jamestalmage/df922691475cff66c7e6](https://gist.github.com/jamestalmage/df922691475cff66c7e6)  
[https://dev.to/jakobjingleheimer/custom-esm-loaders-who-what-when-where-why-how-4i1o](https://dev.to/jakobjingleheimer/custom-esm-loaders-who-what-when-where-why-how-4i1o)  
[https://mp.weixin.qq.com/s?\_\_biz=MzkzMjIxNTcyMA%3D%3D&mid=2247490796&idx=1&sn=ceaf8c0292012e56f35ab1205f9be330](https://mp.weixin.qq.com/s?__biz=MzkzMjIxNTcyMA%3D%3D&mid=2247490796&idx=1&sn=ceaf8c0292012e56f35ab1205f9be330)
