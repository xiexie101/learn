---
title: "173 - 《前端架构师阅读笔记》"
date: 2022-08-23
url: https://sorrycc.com/book-front-end-architect
---

发布于 2022年8月23日

# 173 - 《前端架构师阅读笔记》

本书地址是，[https://book.douban.com/subject/36049173/](https://book.douban.com/subject/36049173/)。上周在 Yingci 的简报中看到，看目录还不错就买了本，都是前端工程化和架构相关的内容，和我的经验比较契合，看起来很快，利用周一和周二两个中午快速翻完。

作者是「候策」，之前没了解过，目前在百度？除了这本书，还写过《前端开发核心知识进阶：从夯实基础到突破瓶颈》和《React状态管理与同构实战》。

说下好的和不好的。好的地方是目录质量高，内容比较全，能感受到作者的功底非常不错，有不少点是我之前也没探究过的，比如 npm 极致、axios 设计等。不好的点是，1）代码量有些大，有些地方直接好几页的代码，2）有较多「盘古之白」的错误用法，看的时候容易出戏，3）有些内容过时，比如 Yarn 感觉没必要学，4）不少内容讲地不够深，感觉刚进入状态，就没了。

此外，在书里发现我写的 babel-plugin-import 解读（108 页）和 umi（204页）。

以下是我在看的时候做的一些摘录，

1、npm 安装机制与 Ruby Gem 和 Python Pip 都不同，后两者是全局安装，前者优先本地安装，所有只有 Node 社区才有 node\_modules 黑洞的抱怨。这种方式的优点是每个项目各成体系，互不影响；缺点就是占硬盘尺寸。

2、npm init 是可以自定义的，通过 `npm config set init-module ~/.npm-init.js` 来自定义脚本，通过 `npm config set` [init.author.name](http://init.author.name)、init.author.email、init.author.url 和 init.license 来自定义其他字段。

3、npx 的运行机制。比如 npx create-react-app，每次运行时会将目标包下载到临时文件，同时使用后会删除。所以每次执行 npx 都会安装新的。

4、私有 npm 镜像方案除了 cnpm，还有 nexus 和 verdaccio。

5、synp 可以在 yarn.lock 和 package-lock.json 之间来回转换。

6、npm ci 和 npm install 类似，区别是 npm ci 要求项目中必须有 package-lock.json，同时他会完全根据 lock 文件仅依赖安装，如果和 package.json 中的文件有冲突，会报错。同时顾名思义，npm ci 是在 ci 环境中推荐使用的 npm install。

7、lock 文件要不要提交到仓库？书中解释的几点我是有不同看法的。1）npm 包提不提 lock 文件应该无所谓，因为 npm install 不会认 node\_modules 下依赖里的 lock 文件，2）项目开发提不提看实践，比如蚂蚁内部是不推荐提的，因为不推荐锁依赖，锁依赖虽然有好处，但其带来的技术债也是需要有人来背的。

8、package.json 中的 bundledDependencies 作用于 npm pack（npm install 时会调用），会让发布到 npm 里的 tgz 包额外包含一些依赖。（具体场景是啥？我还没遇到过）

9、core-js 分 core-js、core-js-pure、core-js-compat、core-js-bundle 和 core-js-builder，core-js-compat 包含特性和浏览器之间的兼容表，core-js-builder 用于生成需要的补丁包。后面「如何复用一个 polyfill」有点标题党，讲的是 core-js 内部组织问题，复用了对开发者又有啥意义呢？

10、babel polyfill 包含 core-js 和 regenerator-runtime。

11、按需补丁（babel-preset-env useBuiltIns: usage）的缺点。由于需要考虑 JavaScript 的动态性，可能不准，可能算多了也可能算少了，比如 x.includes 不能判断出是来自字符串还是数组，所以会把两者都包进去，会算多。此外，还要考虑 node\_modules 默认不做 babel 编译的现实情况。（希望 swc 能带来改变）

12、Babel 家族非常庞大，packages 目录下有 140+ 包。plugin-syntax-\* 是语法插件，用于扩展 @babel/parser 的能力；plugin-proposal-\* 用于对提议阶段的语言特性进行转换；plugin-transform-\* 是转换插件（应该是针对 proposal 之外的语言特性，比如 plugin-transform-react-display-name）；template 封装模板能力，将字符串转为 AST；此外，还有 node、register、parser、traverse、generator、types、core、preset、runtime、polyfill 等。

13、vue-cli 也支持用 babel 编译 node\_modules 下的依赖，通过配置 transpileDependencies 实现。

14、webpack 实现 tree-shaking 时是先做标记，然后交给 Terser 或 UglifyJS 等压缩插件处理，所以换一种压缩器可能就不支持（webpack + esbuild 支持吗？）。标记分三种，used export、unused harmony export 和 harmony import，第二种会被 shaking 掉。

15、css 的 tree-shaking 可借助 purgecss-webpack-plugin 实现。（我之前在 umi 4 中试过，没搞成功）

16、webpack 和 rollup 的打包结果是不同的。webpack 内部维护了 module graph，以此来处理模块之间的依赖关系；而 rollup 是拍平的，通过重命名模块主体避免冲突。

17、Axios 的设计。包含了拦截器、适配器和安全思想。拦截器用于拦截 req 和 res；适配器用于改写请求实现，默认 fetch，可改成 xhr，或用于数据 mock；安全主要是考虑 xsfr，有 xsfrCookieName、xsfrHederName 两个配置项。

18、npm scripts 里可通过 npm\_package\_name、npm\_package\_version、npm\_lifecycle\_event 等环境变量拿到额外信息（bun、pnpm 支持吗？）。

* * *

p.s. 包邮送这本书，送给「第一个回复此贴」的同学，回复后请私发我邮寄的地址等信息。
