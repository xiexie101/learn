---
title: "181 - 《手撕源码 25：Rollup 3 上》"
date: 2022-09-05
url: https://sorrycc.com/source-25-rollup-3-01
---

发布于 2022年9月5日

# 181 - 《手撕源码 25：Rollup 3 上》

Rollup 和 Webpack 齐名，都是打包工具。通常大家用 Webpack 打包项目，用 Rollup 打包 npm 包，这在 Vite 出来之后有了些变化。著名的 Tree Shaking 也是源自 Rollup。Rollup 作者是大名鼎鼎的 Rich Harris，他也是 Svelte 的作者。目前的维护者是 lukastaegert。

趁着 Rollup 即将发布 3，翻了翻源码。时间有限，只看了 2 小时，理解比较浅，还有很多内容值得深挖。

1、Rollup 如何打包？

大家可能知道 rollup 的配置分 inputOptions 和 outputOptions 两部分，这和实现有关，所以实现也是分了两部分。

```ts
// 1、处理 input
const bundle = await rollup(inputOptions);
// 2、output 输出
await Promise.all(outputOptions.map(bundle.write));
```

input 的主体逻辑在 src/Graph.ts，代码是 `await (new Graph()).build()`，这里会做三件事。

```ts
// 1、生成依赖图谱
this.generateModuleGraph();
// 2、给模块排序，同时标记 statement 到模块的引用
this.sortModules();
// 3、tree-shaking？
this.includeStatements();
```

生成依赖图谱时会通过 src/ModuleLoader.ts 添加入口模块，然后递归分析和添加其依赖。此时会生成大量 Module 实例，Module 通常(？）是文件，每个 Module 会做 transform 并返回 ast 等信息。

output 的主体逻辑在 src/Bundle.ts，代码是 `await (new Bundle()).generate()`。这里会先为 dynamic import 的模块和入口模块生成 Chunk，然后生成物理文件。

2、Rollup 的插件机制？

插件通常分定义、使用和内部实现。

Rollup 的插件是包含了一个或多个属性的对象，比如 `{ name, resolveId, load }`；使用方式是在 plugins 属性里通过 Plugin\[\] 的方式加上；内部实现代码在 src/utils/PluginDriver.ts。

内部调用方式比如 `await graph.pluginDriver.hookParallel('buildStart', [inputOptions]);`，可以看到，就是以一种方式去调用定义好的 Hook，和 umi、webpack 的方式都大同小异。

Rollup 提供了 hookFirst、hookFirstSync、hookParallel、hookReduceArg0、hookReduceArg0Sync、hookReduceValue、hookReduceValueSync、hookSeq 共 8 种 Hook 调用机制，有同步和异步，有顺序和并行，等。

Rollup 执行 hook 执行会获取所有包含这个 hook 的插件列表，同时执行 pre 和 post 两种排序方式，相比 tapable 弱一点，但够用。

3、Rollup 的工程化？

npm client 用的是 npm（这是为啥？rollup/plugins 里已换到 pnpm）；用自己（rollup）打自己，安装了 rollup，然后辅助 build-plugins 里的大量插件做打包；test runner 是 mocha。

Rollup 3 拆了一个 @rollup/browser 的包，生成这个包的产物时会额外用 build-plugins/replace-browser-modules.ts mock node 相关模块，比如 fs 会报错，path 会做 polyfill 等。

Release 脚本里有处理 changelog 的生成，解了我一个困惑点，就是如果用本地 commit 信息生成 changelog，那 commit author 和 github user 可能对应不上。上次看的 changelogen 包也没有解这个问题。这里的解法是，利用 github api 获取 pr 和 issue 信息，而不使用本地的 commit author。

Rollup docs 目录下的文档是如何生成的？（我没找到）同时文档里有 .mmd（Mermind）格式的文件，会生成流程图，同时具备响应点击事件的能力。
