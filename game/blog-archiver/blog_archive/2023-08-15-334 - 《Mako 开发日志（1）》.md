---
title: "334 - 《Mako 开发日志（1）》"
date: 2023-08-15
url: https://sorrycc.com/mako-devlog-01
---

发布于 2023年8月15日

# 334 - 《Mako 开发日志（1）》

Mako 开发了几个月，在功能上已经比较全面了，但细节还有非常多需要打磨的地方，团队同学也都逐渐从 Rust 新手变成熟手。挖个坑写写开发日志，第一篇先写点面上的吧。

1、任何有性能问题的工具，都会基于 Rust 重写。下午还新看到一个，叫 Ruff，是个 Python linter，相比现有的 Lint 工具会快 10 到 100 倍。JavaScript 生态里，感觉大部分耗时的工具都有 Rust 版的替代，虽然不少还不够成熟，但方向是这个方向。

2、从头写一个构建工具，和基于配置使用 Webpack 和 Vite，完全是两种体验。作为 N 年的 Webpack 配置工程师，当需要自己去实现一个时，还是会有大量知识需要重新学习。举个例子，比如 [328 - 《CSS Import》](https://sorrycc.com/css-import) 里写过的 CSS Import 的顺序问题，很多除 esbuild 外的现有工具的实现都是有问题的。

3、最近一个感受是，构建工具是强需求，写好了是不用愁应用场景的，包括各种框架、工具、平台的接入和升级。工程师天生对效率和时间敏感，就我个人来说，对于能提升效率和性能的工具就没啥抵抗力。

4、为啥社区有 Farm、Turbopack 等了之后，我们还要重新写一个。原因很多，1）社区库不够成熟，或者在当初做决定时还没有成熟的方案，2）接社区库主动权不在自己这，大公司通常有各种奇怪的需求，而 Rust 库不想 JavaScript 库一样容易定制或者定制之后会有性能下降，3）现在的框架都是编译时框架，和构建耦合很深，4）开发者和团队都有需求，对开发者来说，有个带薪学 Rust 的机会是很难得的，对团队来说，Rust 工具链可以讲个很好的故事，同时，团队具备 Rust 研发能力，在未来是件很重要的事，遇到问题时解法也会开阔很多。

5、但是，自己写一个构建工具的成本还是很高的，需要数个 P7 + P8 的长时间投入。同时也伴随着风险，新技术研发，可能有失败的可能性。成本高的原因是，构建涉及的知识点非常多，我能列出数十个来。我之前写过一篇 [284 - 《手写 Toy Bundler》](https://sorrycc.com/toy-bundler)，一个 Toy 版的构建工具还是挺简单，针对文件做 load、parse、transform，然后生成 module graph，最后基于 module graph 合成一份可运行的大 JS 文件即可，上千行代码就够。但如果要生产可用，代码量可能得几万到几十万行。

6、构建工具的难点在哪？个人感觉，最难的比如 Tree Shaking、Code Splitting、HMR 等，次难的比如 Runtime、Performance、CSS、插件体系、DX（含命令行交互、报错处理和 Error Overlay 等）。很多难点难的不在于跑通，而在于把方案想清楚，以及把各种 Edge Case 都想到。比如为了验 Edge，我收集了中台在用的 1800 多个组件库，然后写了脚本自动验构建和构建后运行的可用性。

7、用 Rust 写和用 JavaScript 写有啥不一样？我觉得比如，1）时刻考虑性能，Rust 要快，除了代码本身的质量外，还得充分利用多核 CPU、缓存等，这意味着 tokio、rayon 等异步库也是必学的，2）生态没 JavaScript 丰富，比如 watch 库就没找到很好用的，3）语法解析强依赖 SWC，Rust 界的 Babel，包括 JavaScript、CSS 全含在里面了，你会发现大量时间其实是在处理和 SWC 相关的逻辑，4）Rust 的门槛，我们几个都是从 0 开始学的，一开始的门槛是真高，后面写熟了感觉也还好，甚至写 Rust 会相比 TypeScript 有更好的安全感。
