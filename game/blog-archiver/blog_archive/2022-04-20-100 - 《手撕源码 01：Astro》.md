---
title: "100 - 《手撕源码 01：Astro》"
date: 2022-04-20
url: https://sorrycc.com/source-01-astro
---

发布于 2022年4月20日

# 100 - 《手撕源码 01：Astro》

[Astro](https://github.com/withastro/astro) 是最近比较火的 0JS 框架。

工程化基于 pnpm + typescript + turbo + prettier+ changeset + esbuild，都是现时最流行的社区方案。pnpm 用于安装依赖和管理 monorepo；turbo 用于 monorepo 命令提速；changeset 用于生成 changelog；源码构建是 esbuild + tsc，esbuild 编译 src 目录到 dist，tsc 生成类型到 dist/types。

这部分有一些值得学习的点。1）scripts 目录独立成包，设置为 private，方便在子包中通过 @astro/scripts 直接调用；2）esbuild + tsc 的源码构建方案，在不需要类型时（比如 CI）速度会很快；3）产出的 npm 包是 type=module，面向未来，通过 exports 声明导出文件，通过 typesVersions 映射类型文件到产物。

配置部分。配置读取基于 [https://github.com/natemoo-re/proload，50+](https://github.com/natemoo-re/proload%EF%BC%8C50+) Star，通过插件支持 TypeScript 格式的配置文件读取；配置校验基于 [https://github.com/colinhacks/zod，7K+](https://github.com/colinhacks/zod%EF%BC%8C7K+) Star，TypeScript first 的 schema 校验工具。

Astro 无插件能力，但有 Integration 的配置。通过 integrations: \[\] 可在 config、server 和 build 环节的 7 个 Hook 中实现扩展。

Astro 也是约定式路由，在 [https://github.com/withastro/astro/blob/c6f8bce7c35cc4fd450fe1b6cc8297a81e413b8e/packages/astro/src/core/routing/manifest/create.ts#L169](https://github.com/withastro/astro/blob/c6f8bce7c35cc4fd450fe1b6cc8297a81e413b8e/packages/astro/src/core/routing/manifest/create.ts#L169) 中实现，路由是中间产物，最终会转为 Page，之后的构建、SSR、SSG 也都是基于 Page 去做。Astro 的路由有个 draft 属性还挺有意思，如果声明某个页面为 draft（草稿），则只在 dev 时有效，build 时会删除。

构建主 Vite 副 esbuild，如果要学基于 Vite 的封装，这是个很好的示范。Astro 利用 Vite 搭建整体的 dev 和 build 流程；esbuild 则处理零散和临时的构建任务。大部分 Astro 的定制构建任务均由 Vite 插件实现。

Astro 最核心的编译器部分是 @astrojs/compiler，负责把 .astro 文件拆分出 css、script、code 等。独立的 npm 包和 github 仓库管理，实现基于 go，然后打包出 WASM 分发到各环境使用。

没时间看了，留了个 TODO：和不同框架的结合方式（比如 @astrojs/react）是如何 run 起来的。
