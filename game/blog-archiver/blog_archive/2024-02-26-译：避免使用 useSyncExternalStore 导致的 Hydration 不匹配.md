---
title: "è¯‘ï¼šé¿å…ä½¿ç”¨ useSyncExternalStore å¯¼è‡´çš„ Hydration ä¸åŒ¹é…"
date: 2024-02-26
url: https://sorrycc.com/avoiding-hydration-mismatches-with-use-sync-external-store
---

å‘å¸ƒäº 2024å¹´2æœˆ26æ—¥

# è¯‘ï¼šé¿å…ä½¿ç”¨ useSyncExternalStore å¯¼è‡´çš„ Hydration ä¸åŒ¹é…

![](https://tkdodo.eu/blog/static/4c3fb2e346536b940032b1d2d3e1449a/bbe0c/mismatch.jpg)

Photo by [Chanhee Lee](https://unsplash.com/@jjik_da)

Hydration ä¸åŒ¹é…æ˜¯ React å¼€å‘è€…å¯èƒ½é¢ä¸´çš„æœ€ä»¤äººç•æƒ§çš„é”™è¯¯ä¹‹ä¸€ï¼š

```
Uncaught Error: Text content does not match server-rendered HTML.
```

æˆ‘ä»¬æ€ä¹ˆä¼šè¿™æ ·ï¼Ÿæˆ‘ä»¬è¢«æ‰¿è¯ºäº†åŒæ„æ¸²æŸ“â€”â€”å…ˆåœ¨æœåŠ¡å™¨ä¸Šï¼Œç„¶ååœ¨å®¢æˆ·ç«¯ã€‚ç¼–å†™ä¸€æ¬¡ä»£ç ï¼Œæ‰§è¡Œä¸¤æ¬¡ã€‚

æœåŠ¡å™¨ä¸æ˜¯å®¢æˆ·ç«¯ã€‚å®ƒå¯èƒ½åœ¨å¦ä¸€ä¸ªæ—¶åŒºè¿è¡Œï¼Œæˆ–è€…ä½¿ç”¨ä¸åŒçš„åŒºåŸŸè®¾ç½®ï¼Œå› æ­¤æ¸²æŸ“çš„ä¿¡æ¯ä¸å®¢æˆ·ç«¯ä¸åŒï¼Œä¾‹å¦‚æ¶‰åŠæ—¥æœŸæ—¶ã€‚å®ƒä¹Ÿæ— æ³•è®¿é—®åªæœ‰åœ¨æµè§ˆå™¨ä¸­æ‰å¯ç”¨çš„ APIï¼Œæ¯”å¦‚ `window` ã€‚

```tsx
// æ—¥æœŸæ¸²æŸ“
function LastUpdated() {
  const date = getLastUpdated()
  return <span>Last updated at: {date.toLocaleDateString()}</span>
}
```

å¦‚æœæœåŠ¡å™¨çš„åŒºåŸŸè®¾ç½®ä¸å®¢æˆ·ç«¯ä¸åŒï¼Œæ—¥æœŸå¯èƒ½åœ¨ä¸€ç«¯æ˜¾ç¤ºä¸º â€œ21/02/2024â€ï¼Œè€Œåœ¨å¦ä¸€ç«¯æ˜¾ç¤ºä¸º â€œ2/21/2024â€ã€‚å½“å‘ç”Ÿè¿™ç§ä¸åŒ¹é…æ—¶ï¼ŒReact ä¼šå‘æˆ‘ä»¬æŠ¥é”™ï¼Œå› ä¸ºå®ƒå¸Œæœ›æœåŠ¡å™¨æ¸²æŸ“çš„è¾“å‡ºä¸å®¢æˆ·ç«¯ä¸Šçš„å®Œå…¨åŒ¹é…ï¼Œä»¥æä¾›[æœ€ä½³çš„ç”¨æˆ·ä½“éªŒ](https://react.dev/reference/react-dom/client/hydrateRoot#hydrating-server-rendered-html)ã€‚

ä½†æ­£å¦‚æˆ‘ä»¬æ‰€è§ï¼Œæœ‰äº›æƒ…å†µä¸‹çš„ä¸åŒ¹é…æ˜¯ä¸å¯é¿å…çš„ã€‚é‚£ä¹ˆæˆ‘ä»¬è¯¥å¦‚ä½•â€œä¿®å¤â€å®ƒå‘¢ï¼Ÿ

## suppressHydrationWarning

è¿™æ„Ÿè§‰æœ‰ç‚¹åƒ `eslint-ignore` æˆ– `@ts-expect-error` ï¼Œå¦‚æœä½ çŸ¥é“è‡ªå·±åœ¨åšä»€ä¹ˆï¼Œè¿™å¤§æ¦‚æ˜¯æ²¡é—®é¢˜çš„ã€‚åªéœ€åœ¨ç›¸å…³å…ƒç´ ä¸ŠåŠ ä¸Š `suppressHydrationWarning` ï¼Œç„¶åå°±å¤§åŠŸå‘Šæˆäº†ï¼š

```tsx
function LastUpdated() {
  const date = getLastUpdated()
  return (
    <span suppressHydrationWarning>
      Last updated at: {date.toLocaleDateString()}
    </span>
  )
}
```

æ ¹æ®[æ–‡æ¡£](https://react.dev/reference/react-dom/components/common#common-props)ï¼Œè¿™æ˜¯ä¸€ä¸ªç´§æ€¥å‡ºå£ï¼Œä¸åº”è¯¥è¢«è¿‡åº¦ä½¿ç”¨ã€‚é‚£ä¹ˆæˆ‘ä»¬è¿˜èƒ½åšä»€ä¹ˆå‘¢ï¼Ÿ

## åŒé‡æ¸²æŸ“é€šé“

å¦ä¸€ä¸ªæµè¡Œçš„è§£å†³æ–¹æ¡ˆæ˜¯åœ¨å®¢æˆ·ç«¯æ¸²æŸ“ä¸¤æ¬¡ã€‚æˆ‘ä»¬åœ¨æœåŠ¡å™¨ä¸Šç”¨æˆ‘ä»¬æ‹¥æœ‰çš„ä¿¡æ¯è¿›è¡Œæ¸²æŸ“ï¼Œè¿™å°†äº§ç”Ÿé™æ€æ ‡è®°ã€‚ç„¶åï¼Œåœ¨å®¢æˆ·ç«¯ï¼Œæˆ‘ä»¬ä¼šå°è¯•åœ¨ç¬¬ä¸€æ¬¡æ¸²æŸ“å‘¨æœŸäº§ç”Ÿä¸æœåŠ¡å™¨ä¸Šç›¸åŒçš„è¾“å‡ºã€‚è¿™ç¡®ä¿äº† hydration ä¸ä¼šå‡ºé”™ã€‚ä¹‹åï¼Œæˆ‘ä»¬å°†è§¦å‘å¦ä¸€ä¸ªæ¸²æŸ“å‘¨æœŸï¼Œä½¿ç”¨â€œçœŸå®â€çš„å®¢æˆ·ç«¯ä¿¡æ¯ã€‚

å½“ç„¶ï¼Œè¿™é‡Œçš„ç¼ºç‚¹æ˜¯å†…å®¹çŸ­æš‚çš„é—ªç°ï¼Œæ­£å¦‚æˆ‘ä»¬åœ¨è¿™ä¸ªåŠ¨ç”»ä¸­çœ‹åˆ°çš„ï¼ˆæ³¨æ„æ—¶é—´ï¼‰ï¼š

![](https://img.alicdn.com/imgextra/i3/O1CN01juFnwG1PvAFE1jMDE_!!6000000001902-1-tps-964-306.gif)

ç”±äºæ—¶åŒºä¿¡æ¯åªæœ‰å®¢æˆ·ç«¯çŸ¥é“ï¼ŒæœåŠ¡å™¨æ¸²æŸ“ä¸å¯èƒ½çŸ¥é“è¦æ˜¾ç¤ºçš„æ­£ç¡®æ—¶é—´ï¼Œå› ä¸ºè¿™å¯¹æ¯ä¸ªç”¨æˆ·æ¥è¯´éƒ½æ˜¯ä¸åŒçš„ï¼Œè¿™å–å†³äºä»–ä»¬çš„ä½ç½®ã€‚

å¦ä¸€ç§å˜ä½“æ˜¯ä»…åœ¨æœåŠ¡å™¨ä¸Šæ¸²æŸ“ `null` ï¼Œå¹¶è®©æ­£ç¡®çš„å†…å®¹ä»…åœ¨å®¢æˆ·ç«¯â€œå‡ºç°â€ã€‚

æ— è®ºä½ ä¸ºæœåŠ¡å™¨æ¸²æŸ“é€‰æ‹©ä»€ä¹ˆå€¼ï¼Œä»£ç é€šå¸¸çœ‹èµ·æ¥ä¼šåƒè¿™æ ·ï¼š

```tsx
function LastUpdated() {
  const [isClient, setIsClient] = React.useState(false)

  React.useEffect(() => {
    setIsClient(true)
  }, [])

  if (!isClient) {
    return null
  }

  const date = getLastUpdated()
  return <span>Last updated at: {date.toLocaleDateString()}</span>
}
```

ç”±äºæ•ˆæœä¸ä¼šåœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œï¼Œ `null` å°†é¦–å…ˆè¢«è¿”å›ã€‚ç„¶åï¼Œåœ¨å®¢æˆ·ç«¯ï¼Œç¬¬ä¸€æ¬¡æ¸²æŸ“å‘¨æœŸä¹Ÿä¼šäº§ç”Ÿ `null` ã€‚åœ¨æ•ˆæœç”Ÿæ•ˆåï¼Œæˆ‘ä»¬çš„æ—¥æœŸå°†è¢«æ­£ç¡®æ˜¾ç¤ºã€‚

è¿™æ®µä»£ç æœ‰ç‚¹åƒæ ·æ¿ä»£ç ï¼Œä½†å¦‚æœæˆ‘ä»¬æ„¿æ„çš„è¯å¯ä»¥å°†å…¶æŠ½è±¡å‡ºæ¥ï¼ˆæˆ‘æ•¢è‚¯å®šä¹Ÿæœ‰ç°æˆçš„åŒ… ğŸ˜‚ï¼‰ï¼Œè€Œä¸”è¿™æ˜¯ä¸€ä¸ªç›¸å½“å¸¸è§çš„æ¨¡å¼ã€‚

é‚£ä¹ˆé—®é¢˜å‡ºåœ¨å“ªé‡Œï¼Ÿ

## å®¢æˆ·ç«¯è½¬åœº

åœ¨ç»„ä»¶æ˜¯æœåŠ¡å™¨æ¸²æŸ“çš„æƒ…å†µä¸‹ï¼ŒåŒé‡æ¸²æŸ“æ˜¯æœ‰é—®é¢˜çš„ã€‚ä½†åœ¨ä¼ ç»Ÿçš„ SSR åº”ç”¨ç¨‹åºä¸­ï¼Œå¹¶ä¸æ˜¯æ¯ä¸ªé¡µé¢éƒ½æ˜¯æœåŠ¡å™¨æ¸²æŸ“çš„ã€‚é€šå¸¸ï¼Œåªæœ‰ä½ é¦–æ¬¡è®¿é—®çš„é¡µé¢éœ€è¦ç”Ÿæˆé™æ€æ ‡è®°ã€‚ä¹‹åï¼Œæ¯æ¬¡å¯¼èˆªéƒ½æ˜¯å®¢æˆ·ç«¯è½¬æ¢ï¼Œç±»ä¼¼äº SPAã€‚å®ƒä»¬ä¼šå‘å‡ºå¼‚æ­¥è¯·æ±‚æ¥è·å–æ•°æ®ï¼ˆæƒ³è±¡åœ¨ nextJs ä¸­çš„ `getServerSideProps` ï¼‰ï¼Œç„¶ååªåœ¨å®¢æˆ·ç«¯æ¸²æŸ“ä¸‹ä¸€ä¸ªé¡µé¢ã€‚

åœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œä½¿ç”¨ `useEffect` çš„åŒé‡æ¸²æŸ“é€šé“è§£å†³æ–¹æ³•ä¼šä¸å¿…è¦åœ°æ‹–æ…¢æˆ‘ä»¬çš„é€Ÿåº¦ã€‚æˆ‘ä»¬å·²ç»åœ¨å®¢æˆ·ç«¯äº†ï¼Œä½†æˆ‘ä»¬çš„ä»£ç å¹¶ä¸çŸ¥é“è¿™ä¸€ç‚¹ã€‚å®ƒä¼šæ— è®ºå¦‚ä½•æ¸²æŸ“ `null` ï¼Œç„¶åè§¦å‘ effectï¼Œç„¶åæ¸²æŸ“å†…å®¹ã€‚è€Œä¸”å¦‚æœæˆ‘ä»¬åœ¨å®¢æˆ·ç«¯ï¼Œæˆ‘ä»¬ä¹Ÿä¸èƒ½æ·»åŠ é¢å¤–çš„æ£€æŸ¥ï¼Œå› ä¸º SSR åçš„ç¬¬ä¸€æ¬¡å®¢æˆ·ç«¯æ¸²æŸ“ä¹Ÿéœ€è¦æ¸²æŸ“ `null` ã€‚ğŸ˜­

æˆ‘ä»¬æ­£åœ¨å¯»æ‰¾çš„è§£å†³æ–¹æ¡ˆéœ€è¦äº†è§£æœåŠ¡å™¨æ¸²æŸ“ï¼Œæ›´é‡è¦çš„æ˜¯ï¼Œè¦çŸ¥é“é¦–æ¬¡å®¢æˆ·ç«¯æ¸²æŸ“ä½•æ—¶å‘ç”Ÿã€‚è€Œä»¤äººæƒŠè®¶çš„æ˜¯ï¼Œå¯¹æ­¤æœ€ä½³çš„é’©å­ä¼¼ä¹æ˜¯ `useSyncExternalStore` ã€‚

## useSyncExternalStore

å³ä½¿ `useSyncExternalStore` çš„ä¸»è¦ç”¨é€”æ˜¯è®¢é˜…å¤–éƒ¨å­˜å‚¨ï¼Œå®ƒè¿˜æœ‰ä¸€ä¸ªæœ‰è¶£çš„ç¬¬äºŒç‰¹æ€§ï¼šå®ƒå…è®¸æˆ‘ä»¬åŒºåˆ† `serverSnapshot` å’Œ `clientSnapshot` ã€‚è®©æˆ‘ä»¬çœ‹çœ‹[æ–‡æ¡£](https://react.dev/reference/react/useSyncExternalStore)å¯¹ `getServerSnapshot` çš„è¯´æ˜ï¼š

> getServerSnapshot
> 
> è¿”å›å­˜å‚¨ä¸­æ•°æ®åˆå§‹å¿«ç…§çš„å‡½æ•°ã€‚å®ƒå°†ä»…åœ¨æœåŠ¡å™¨æ¸²æŸ“æœŸé—´ä»¥åŠåœ¨å®¢æˆ·ç«¯å¯¹æœåŠ¡å™¨æ¸²æŸ“å†…å®¹è¿›è¡Œæ°´åˆä½œç”¨æ—¶ä½¿ç”¨ã€‚æœåŠ¡å™¨å¿«ç…§åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´å¿…é¡»ç›¸åŒï¼Œé€šå¸¸ä¼šåºåˆ—åŒ–åä»æœåŠ¡å™¨ä¼ é€’åˆ°å®¢æˆ·ç«¯ã€‚

è¿™æ­£æ˜¯æˆ‘ä»¬éœ€è¦é¿å…æ°´åˆé”™è¯¯çš„å†…å®¹ï¼Œè€Œä¸”ï¼Œå¦‚æœæˆ‘ä»¬åœ¨å®¢æˆ·ç«¯è½¬åˆ°ä¸€ä¸ªåŒ…å« `useSyncExternalStore` çš„é¡µé¢ï¼Œ `clientSnapshot` å°†ä¼šç«‹å³è¢«é‡‡ç”¨ã€‚

åªæœ‰ä¸€ä¸ªé—®é¢˜ï¼šæˆ‘ä»¬åº”è¯¥è®¢é˜…å“ªä¸ªâ€œstoreâ€ï¼Ÿè¿™çœ‹èµ·æ¥å¯èƒ½æœ‰ç‚¹å¥‡æ€ªï¼Œä½†ç­”æ¡ˆæ˜¯ï¼šæˆ‘ä»¬å°†ä½¿ç”¨ä¸€ä¸ªç©ºçš„ store è®¢é˜…ï¼Œå®ƒæ°¸è¿œä¸ä¼šæ›´æ–°ã€‚ `clientSnapshot` åœ¨æ¯æ¬¡æ¸²æŸ“æ—¶éƒ½ä¼šè¢«è¯„ä¼°ï¼Œè€Œä¸”æ²¡æœ‰å¿…è¦ä» react å¤–éƒ¨æ¨é€æ›´æ–°åˆ°è¿™ä¸ªç»„ä»¶ã€‚

ç”±äº `subscribe` å‚æ•°æ˜¯å¿…é¡»çš„ï¼Œæˆ‘ä»¬çš„ä»£ç å¯èƒ½çœ‹èµ·æ¥åƒè¿™æ ·ï¼š

```tsx
const emptySubscribe = () => () => {}

function LastUpdated() {
  const date = React.useSyncExternalStore(
    emptySubscribe,
    () => lastUpdated.toLocaleDateString(),
    () => null
  )

  return date ? <span>Last updated at: {date}</span> : null
}
```

`subscribe` éœ€è¦æ˜¯ä¸€ä¸ªç¨³å®šçš„å‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»åœ¨ React ç»„ä»¶å¤–éƒ¨å£°æ˜å®ƒã€‚æˆ‘å‘ç°è¿™ç§æ¨¡å¼æœ‰ç‚¹å–å·§ï¼Œæ‰€ä»¥åœ¨å‘å¸ƒè¿™ç¯‡æ–‡ç« ä¹‹å‰ï¼Œæˆ‘å¿…é¡»ä» React å›¢é˜Ÿé‚£é‡Œå¾—åˆ°ç¡®è®¤ï¼Œè¿™æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ã€‚

![](https://img.alicdn.com/imgextra/i3/O1CN017cvlgA1wigmFhr4up_!!6000000006342-2-tps-1132-804.png)

æˆ‘å¸Œæœ›æœ‰æ›´ç¬¦åˆäººä½“å·¥å­¦çš„æ–¹æ³•ï¼Œä½†æˆ‘è¿˜æ²¡æœ‰æ‰¾åˆ°ã€‚ä¹Ÿè®¸æˆ‘åº”è¯¥æŠŠè¿™ä¸ªåšæˆä¸€ä¸ªåŒ…â€¦â€¦ ğŸ¤”

* * *

è¿™ç§æ¨¡å¼ä¹Ÿä½¿å¾—åˆ›å»ºä¸€ä¸ª `ClientGate` å˜å¾—éå¸¸å®¹æ˜“â€”â€”ä¸€ä¸ªåªä¼šåœ¨å®¢æˆ·ç«¯æ¸²æŸ“çš„ç»„ä»¶ï¼Œåœ¨é‚£é‡Œä½ å¯ä»¥å®‰å…¨åœ°è®¿é—®ä»…é™æµè§ˆå™¨çš„ APIï¼š

```tsx
function ClientGate({ children }) {
  const isServer = React.useSyncExternalStore(
    emptySubscribe,
    () => false,
    () => true
  )

  return isServer ? null : children()
}

function App() {
  return (
    <main>
      Hello Server
      <ClientGate>{() => `Hello Client ${window.title}`}</ClientGate>
    </main>
  )
}
```

### æœ€å°åŒ–å¸ƒå±€åç§»

å¸ƒå±€åç§»å¹¶ä¸ç†æƒ³ï¼Œä»…å› ä¸ºä¸€ä¸ªç»†èŠ‚ä¾èµ–äºå®¢æˆ·ç«¯ä¿¡æ¯å°±ä¸å®Œå…¨æ¸²æŸ“ä¸€ä¸ªç»„ä»¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ¯”å¿…è¦çš„æ›´å¤§çš„å¸ƒå±€åç§»ã€‚å¦‚æœ JS æ°¸è¿œä¸åŠ è½½â€”â€”æˆ‘ä»¬å°†æ— æ³•æ˜¾ç¤ºå±å¹•é‚£äº›éƒ¨åˆ†çš„ä»»ä½•ä¿¡æ¯ã€‚

æ‰€ä»¥å¦‚æœæˆ‘ä»¬èƒ½åœ¨æœåŠ¡å™¨ä¸Šäº§ç”Ÿä¸€ä¸ªç¨³å®šçš„æ—¥æœŸè¾“å‡ºï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†å†…å®¹çš„å˜åŠ¨é™åˆ¶åœ¨æ—¥æœŸä¸Šï¼Œç±»ä¼¼äºä¹‹å‰å±•ç¤ºçš„ GIF ä¸­é¡µé¢æ‰€åšçš„é‚£æ ·ï¼š

```tsx
const emptySubscribe = () => () => {}

function LastUpdated() {
  const date = React.useSyncExternalStore(
    emptySubscribe,
    () => lastUpdated.toLocaleDateString(),
    () => lastUpdated.toLocaleDateString('en-US')
  )

  return <span>Last updated at: {date}</span>
}
```

è¯·æ³¨æ„ï¼Œä¼ é€’ä¸€ä¸ªé™æ€çš„ locale æ˜¯å¾ˆé‡è¦çš„ï¼Œå› ä¸ºæœåŠ¡å™¨å¿«ç…§å°†åœ¨æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ä¸Šè¿›è¡Œè¯„ä¼°ã€‚å¦‚æœæˆ‘ä»¬è®©è¿è¡Œæ—¶æ¨æ–­ localeï¼ˆé€šè¿‡ä¸ä¼ é€’ä»»ä½•ä¸œè¥¿ï¼‰ï¼Œæˆ‘ä»¬ä¹Ÿä¼šé‡åˆ°æ•´ä¸ª hydration é”™è¯¯åœºæ™¯ã€‚

## Client hints

æœªæ¥ï¼Œ[HTTP Client hints](https://developer.mozilla.org/en-US/docs/Web/HTTP/Client_hints) å¸Œæœ›èƒ½æ”¹å–„æ•´ä¸ªæƒ…å†µï¼Œå› ä¸ºå®ƒå°†ä¸ºæœåŠ¡å™¨æä¾›ä¸€ç§åœ¨æ¸²æŸ“ä»»ä½•å†…å®¹ä¹‹å‰äº†è§£ä»…åœ¨å®¢æˆ·ç«¯å¯ç”¨çš„ä¿¡æ¯çš„æ–¹æ³•ã€‚æœ‰äº†è¿™ä¸ªï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸éœ€è¦è¯‰è¯¸å˜é€šæ–¹æ³•çš„æƒ…å†µä¸‹è¿›è¡Œæ­£ç¡®çš„æœåŠ¡å™¨ç«¯æ¸²æŸ“ï¼ˆSSRï¼‰ã€‚åœ¨é‚£ä¹‹å‰ï¼Œæˆ‘è®¤ä¸ºè¿™å·²ç»æ˜¯ç›®å‰èƒ½åšåˆ°çš„æœ€å¥½çš„äº†ï¼Œè€Œä¸”æˆ‘æ›´å€¾å‘äº `useSyncExternalStore` è€Œä¸æ˜¯æ•ˆæœè§£å†³æ–¹æ¡ˆã€‚

* * *

ä»Šå¤©å°±åˆ°è¿™é‡Œã€‚å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜ï¼Œæ¬¢è¿åœ¨[æ¨ç‰¹](https://twitter.com/tkdodo)ä¸Šè”ç³»æˆ‘ã€‚
