---
title: "377 - 《2023 年最潮的 Demo 编写方式》"
date: 2023-11-23
url: https://sorrycc.com/write-a-demo-2023
---

发布于 2023年11月23日

# 377 - 《2023 年最潮的 Demo 编写方式》

1、今天看到 [https://github.com/esm-dev/esm.sh/releases/tag/v135](https://github.com/esm-dev/esm.sh/releases/tag/v135) [esm.sh](http://esm.sh) run，想着去年写的这篇 [76 - 《2022 最潮的 Demo 编写方式》](https://sorrycc.com/write-a-demo-2022) 是时候该更新了。

2、基于 [esm.sh](http://esm.sh) run 的最简 HTML 如下。支持 JSX、TS、TSX 等。

```html
<!DOCTYPE html>
<html>
<script type="importmap">
  {
    "imports": {
      "@jsxImportSource": "https://esm.sh/react@18.2.0",
      "react-dom/client": "https://esm.sh/react-dom@18.2.0/client"
    }
  }
</script>
<script type="module" src="https://esm.sh/run" defer></script>
<div id="root"></div>
<script type="text/babel">
  import { createRoot } from "react-dom/client";
  const App = () => <div>Hello World</div>;
  createRoot(globalThis.root).render(<App />);
</script>
</html>
```

> 注：React 19 不提供 UMD 包，只提供 ESM。试了下，把上面的 18.2.0 换成 19.0.0-rc-58af67a8f8-20240628 照样能跑。

3、原理要结合 [https://github.com/esm-dev/esm.sh/blob/main/run.ts](https://github.com/esm-dev/esm.sh/blob/main/run.ts) 和 [https://github.com/esm-dev/esm.sh/blob/main/build.ts](https://github.com/esm-dev/esm.sh/blob/main/build.ts) 看。找到所有 type 属性在白名单的 script 标签，依次执行；但由于写的代码是 ts、tsx 或 jsx，浏览器不支持直接执行，所以需要做一次 transform，他 transform 的方法是把 script 标签里的代码、importmaps 信息、hash 值等发请求给 [https://esm.sh/build](https://esm.sh/build) 。返回代码如下。最后把这段代码通过动态插 type=“module” 的 script 标签到 document.body 里执行。

```ts
import{jsx}from"https://esm.sh/react@18.2.0/jsx-runtime";
import{createRoot}from"react-dom/client";
var App=()=>jsx("div",{children:"Hello World a"});
createRoot(globalThis.root).render(jsx(App,{}));
```

4、出于性能考虑，他在 transform 时有做二级缓存，localStorage 和 Cloudflare Edge。所以编译过一次的代码跑起来会快一些。见图。

![](https://img.alicdn.com/imgextra/i4/O1CN01sl41am1TLDb16h498_!!6000000002365-2-tps-3500-1280.png)

5、CSS 除了直接写 style 标签，还支持 unocss，可以想象成简化版的 tailwindcss。多加一段 [https://esm.sh/uno](https://esm.sh/uno) 的 script 标签就可以在 html tag 里写 util class 了。这个 util class 不仅支持 html，也支持 jsx。

```html
<script type="module" src="https://esm.sh/uno" defer></script>
<div class="text-3xl color-red font-bold p-8">Hello World</div>
```

怎么实现？我没找到 [https://esm.sh/uno](https://esm.sh/uno) 的源码，就直接从压缩后的代码上找了下逻辑。先以 html 内容为 key 生成 hash，做 hash 的两级缓存，没有命中缓存时请求 [https://esm.sh/uno-generate/hash](https://esm.sh/uno-generate/hash) 接口动态生成。此外，还有个 dev 模式，此模式下，会动态 import ./@unocss/core 和 ./@unocss/preset-wind?bundle 在浏览器侧执行生成逻辑。

6、想了下这套方案的缺点，感觉还挺多。1）不支持热更，改完得手动刷一下，2）兼容性，加下对应补丁应该能兼容更多浏览器，3）请求瀑布问题，基于 module preload 应该能解，4）依赖远程服务做 transform，有单点依赖，且 build 服务没那么快，改用在 client 端跑 wasm 版 esbuild 或 babel standalone 应该能解，缺点是没有 Cloudflare Edge 缓存，5）手写 importmaps 比较麻烦，应该是可以动态生成基于 latest tag 的。

参考：  
[https://github.com/esm-dev/esm.sh/releases/tag/v135](https://github.com/esm-dev/esm.sh/releases/tag/v135)  
[https://github.com/esm-dev/esm.sh/blob/main/run.ts](https://github.com/esm-dev/esm.sh/blob/main/run.ts)  
[76 - 《2022 最潮的 Demo 编写方式》](https://sorrycc.com/write-a-demo-2022)
