---
title: "182 - 《手撕源码 26：网盘助手》"
date: 2022-09-06
url: https://sorrycc.com/source-26-pan
---

发布于 2022年9月6日

# 182 - 《手撕源码 26：网盘助手》

由于没有安装 baidupan 和 aliyunpan 的客户端，我通常会在浏览器上直接下载云盘资源。baidupan 用「网盘直链下载助手脚本」+「NeatDownloadManager」，aliyunpan 用「阿里云盘脚本」+「浏览器直接下」，基本都可达满速。中午在用某网盘助手时，发现要关注微信公众号才能使用。想着是时候翻翻源码了，实现原理应该不复杂。

操作流程是，1）打开网盘页，2）选中要下载的资源，3）通过网盘助手显示选中资源的链接，4）执行下载。所以技术点是如何获取选中项，以及如何获取选中项的下载链接。

先看 baiduyun。获取选中项可通过 `document.querySelector('.wp-s-core-pan').__vue__.selectedList`，然后每个项里会有 `fs_id` 的数据，然后拼 url `https://pan.baidu.com/rest/2.0/xpan/multimedia?method=filemetas&dlink=1&fsids=[fs_id_1,fs_id_2]` 即可拿到可下载的数据。然后再去拼 Aria、RPC、cURL、IDM 等。

全部代码如下，

```ts
const selected = document.querySelector('.wp-s-core-pan').__vue__.selectedList;
const ids = selected.map(item => item.fs_id);
const fsids = encodeURIComponent(`[${ids.join(',')}]`);
const url = `https://pan.baidu.com/rest/2.0/xpan/multimedia?method=filemetas&dlink=1&fsids=${fsids}`;
const res = await fetch(url);
const json = await res.json();
json.list.forEach(item => {
  console.log(item.dlink);
});
```

再看 aliyunpan。由于我个人用的是「阿里云盘」这个脚本，所以直接看的他的实现。这个更简单，aliyunpan 列表接口其实已经包含下载链接的信息，实现方式是直接改写了 XMLHttpRequest.prototype.send 方法。

```ts
const send = XMLHttpRequest.prototype.send;
XMLHttpRequest.prototype.send = function(data) {
  this.addEventListener("load", function(event) {
    if (this.responseURL.indexOf("/file/list") > 0) {
      this.response.items.forEach((item) => {
        console.log(item.url);
      });
    }
  });
  send.apply(this, arguments);
};
```

参考：  
[https://greasyfork.org/en/scripts/425955-阿里云盘](https://greasyfork.org/en/scripts/425955-%E9%98%BF%E9%87%8C%E4%BA%91%E7%9B%98)  
[https://www.baiduyun.wiki/install.html](https://www.baiduyun.wiki/install.html)
