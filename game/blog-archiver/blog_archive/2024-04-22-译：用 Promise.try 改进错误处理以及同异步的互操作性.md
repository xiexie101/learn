---
title: "è¯‘ï¼šç”¨ Promise.try æ”¹è¿›é”™è¯¯å¤„ç†ä»¥åŠåŒå¼‚æ­¥çš„äº’æ“ä½œæ€§"
date: 2024-04-22
url: https://sorrycc.com/promise-try-to-improve-error-handling-and-sync-async-interoperability
---

å‘å¸ƒäº 2024å¹´4æœˆ22æ—¥

# è¯‘ï¼šç”¨ Promise.try æ”¹è¿›é”™è¯¯å¤„ç†ä»¥åŠåŒå¼‚æ­¥çš„äº’æ“ä½œæ€§

> åŸæ–‡ï¼š[https://pawelgrzybek.com/promise-try-to-improve-error-handling-and-sync-async-interoperability/](https://pawelgrzybek.com/promise-try-to-improve-error-handling-and-sync-async-interoperability/)  
> ä½œè€…ï¼šPaweÅ‚ Grzybek  
> è¯‘è€…ï¼šChatGPT 4 Turbo

**ç¼–è€…æ³¨ï¼šPromise.try å¯æ¥æ”¶åŒæ­¥æˆ–å¼‚æ­¥å‡½æ•°ï¼Œç„¶ååšç»Ÿä¸€çš„é”™è¯¯å¤„ç†ã€‚è¿™ç­‰åŒäº `new Promise(resolve => resolve(f()))`ï¼Œç›¸æ¯” `Promise.resolve().then(f)` ä¼šå°‘æµªè´¹ä¸€ä¸ª tickã€‚**

å‡ ä¸ªæœˆå‰ï¼Œæˆ‘å‘è¡¨äº†ä¸€ç¯‡ [â€œDeferred JavaScript promises using `Promise.withResolvers`â€](https://pawelgrzybek.com/deferred-javascript-promises-using-promise-withresolvers/) çš„æ–‡ç« ï¼Œè§£é‡Šäº†ä¸€ç§ç°ä»£çš„æ–¹å¼æ¥å¤„ç†è‡ª JavaScript Promises ä»¥æ¥å°±å­˜åœ¨çš„ä¸€é¡¹ç¹çå·¥ä½œã€‚éšç€è§„èŒƒå¢åŠ ç®€åŒ–ç¨‹åºçš„ç‰¹æ€§ï¼Œä»Šå¤©æˆ‘ä»¬æ¥è°ˆè°ˆå³å°†åˆ°æ¥çš„ [`Promise.try`](https://github.com/tc39/proposal-promise-try)ï¼Œå®ƒæ­£åœ¨å¿«é€Ÿé€šè¿‡ ECMAScript ææ¡ˆé˜¶æ®µã€‚

å‡è®¾æˆ‘ä»¬æœ‰ä¸¤ä¸ªå‡½æ•°ï¼Œä¸€ä¸ªè¿”å› promiseï¼Œå¦ä¸€ä¸ªåŒæ­¥è¿”å›å€¼ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·æ··åˆä½¿ç”¨å®ƒä»¬ï¼š

```js
const retSync = () => "sync return";
const retAsync = () => new Promise((r) => r("async return"));

(async () =>
  retAsync()
    .then(console.log)
    .then(retSync)
    .then(console.log)
    .catch(console.error))();

// async return
// sync return
```

æˆ‘ä»¬æ¢ä¸€ä¸‹é¡ºåºï¼Œå…ˆæ”¾ä¸€ä¸ªåŒæ­¥å‡½æ•°ã€‚

```js
// ğŸš¨ è¿™è¡Œä¸é€š

const retSync = () => "sync return";
const retAsync = () => new Promise((r) => r("async return"));

(async () =>
  retSync()
    .then(console.log)
    .then(retAsync)
    .then(console.log)
    .catch(console.error))();

// TypeError: retSync().then ä¸æ˜¯ä¸€ä¸ªå‡½æ•°ã€‚ï¼ˆåœ¨ 'retSync().then(console.log)' ä¸­ï¼Œ'retSync().then' æ˜¯ undefinedï¼‰
```

æˆ‘ä»¬ä¸èƒ½é‚£ä¹ˆåšï¼Œå› ä¸º `retSync` çš„è¿”å›å€¼ä¸æ˜¯ä¸€ä¸ª thenable promiseã€‚æˆ‘ä»¬éœ€è¦å°†åŒæ­¥è¿”å›çš„å‡½æ•°åŒ…è£¹åœ¨ä¸€ä¸ª promise ä¸­ã€‚

```js
const retSync = () => "sync return";
const retAsync = () => new Promise((r) => r("async return"));

(async () =>
  Promise.resolve()
    .then(retSync)
    .then(console.log)
    .then(retAsync)
    .then(console.log)
    .catch(console.error))();

// sync return
// async return
```

è¿™æ ·å¯ä»¥è¿è¡Œï¼Œä½†æˆ‘ä»¬æµªè´¹äº†ä¸€ä¸ªäº‹ä»¶å¾ªç¯å‘¨æœŸã€‚ä¸è¿‡ï¼Œæœ‰åŠæ³•è§£å†³è¿™ä¸ªé—®é¢˜ï¼

```js
const retSync = () => "sync return";
const retAsync = () => new Promise((r) => r("async return"));

(async () =>
  new Promise((resolve) => resolve(retSync()))
    .then(console.log)
    .then(retAsync)
    .then(console.log)
    .catch(console.error))();

// sync return
// async return
```

æœ€åï¼Œä½†è¿™ä¸æ˜¯å¾ˆç´¯äººå—ï¼Ÿå¦‚æœèƒ½åœ¨ä¸å…³å¿ƒäº‹ç‰©æ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥çš„æƒ…å†µä¸‹æ··åˆä½¿ç”¨å®ƒä»¬ï¼Œé‚£å°±å¤ªæ£’äº†ã€‚æ­¤å¤–ï¼Œä¸€ä¸ªå¸¸è§çš„ `catch` å­å¥ç”¨äºåœ¨ä¸€ä¸ªåœ°æ–¹å¤„ç†é”™è¯¯ï¼Œæ— éœ€ä¸ºåŒæ­¥å’Œå¼‚æ­¥æ‰§è¡Œåˆ†åˆ«ç¼–å†™é”™è¯¯å¤„ç†ä»£ç æ˜¯å¾ˆæ–¹ä¾¿çš„ã€‚

ç”Ÿæ€ç³»ç»Ÿä¸­å·²ç»æœ‰å¾ˆå¤šè§£å†³æ–¹æ¡ˆï¼š [`p-try` æ¥è‡ª Sindre Sorhus](https://www.npmjs.com/package/p-try)ã€[Bluebird `Promise.try`/`Promise.attempt`](http://bluebirdjs.com/docs/api/promise.try.html) æˆ– [`es6-promise-try`](https://www.npmjs.com/package/es6-promise-try)ï¼Œä»…ä¸¾å‡ ä¾‹ã€‚å¦å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªåŸç”Ÿçš„ [`Promise.try`](https://github.com/tc39/proposal-promise-try) æ­£åœ¨ ECMAScript ææ¡ˆé˜¶æ®µä¸­æ¨è¿›ï¼Œæˆ‘ç›¸ä¿¡å®ƒå¾ˆå¿«å°±ä¼šæˆä¸ºè¯­è¨€è§„èŒƒçš„ä¸€éƒ¨åˆ†ã€‚

```js
const retSync = () => "sync return";
const retAsync = () => new Promise((r) => r("async return"));

(async () =>
  Promise.try(retSync)
    .then(console.log)
    .then(retAsync)
    .then(console.log)
    .catch(console.error))();

// sync return
// async return
```

å¸Œæœ›è¿™ç¯‡æ–‡ç« å¸®åŠ©ä½ ç†è§£äº† `Promise.try` æƒ³è¦è§£å†³çš„ç›®çš„å’Œç±»å‹é—®é¢˜ã€‚ç»§ç»­ç¼–ç ï¼Œä¸‹æ¬¡æˆ‘ä¼š `catch("you")` ğŸ‘‹
