---
title: "317 - 《按需打包 class 方法》"
date: 2023-06-29
url: https://sorrycc.com/class-method-tree-shaking
---

发布于 2023年6月29日

# 317 - 《按需打包 class 方法》

简单记录下昨天群里的问题。

问题是这样。

> 请教下用 rollup、webpack 能根据环境变量的不同，删减不同的类方法吗？能打包出包含 a,b 的类和包含 a,c 的类。不需要的方法能被 treeshaking 掉。比如。

```ts
class Api {
 a() {}
 b() {}
 c() {}
}
```

Tree Shaking 是提问者给出的可能的解，如果大家关注 Tree Shaking 而忽略问题本身，就陷入了 XY Problem。Tree Shaking 是问题的解，不是问题；同时 Tree Shaking 并不是这个问题的正解。

怎么解？基于 Webpack 说下我的思路。拍脑袋能想到有两种解法。

1、简单解 Define  
2、复杂解 AST

方法一 Define 参考 [DefinePlugin | webpack](https://webpack.js.org/plugins/define-plugin/)，但注意不能这样，因为 class 方法套条件语句是非法的。

```ts
class Api {
 a() {}
 if (process.env.FOO = 1) {
 b() {}
 }
 if (process.env.FOO = 2) {
 c() {}
 }
}
```

不过可以稍微调整下 Api Class 的写法。

```ts
class Api {
 a() {}
}
if (process.env.FOO = 1) {
  Api.prototype.b = () => {}
}
if (process.env.FOO = 2) {
  Api.prototype.c = () => {}
}
```

方法二 AST 就是用 AST 的方式，识别环境变量，然后直接删除对应的 ClassMethod 节点。AST 的修改可以用 Babel 来做，也可以[用 Webpack 的插件](https://github.com/umijs/umi/pull/11209)直接做。

参考：  
[Tree shaking class methods · Issue #349 · rollup/rollup · GitHub](https://github.com/rollup/rollup/issues/349)  
[292 - 《避免 XY 问题》](https://sorrycc.com/xy-problem)
