---
title: "424 - 《Node 性能优化（2）》"
date: 2024-03-23
url: https://sorrycc.com/node-performance-optimization-02
---

发布于 2024年3月23日

# 424 - 《Node 性能优化（2）》

> 近期要排查内网框架的性能问题，于是又把这块的经验捡起来，结合昨天群里的讨论，做下记录。

1、Node 性能排查通常有几个方法。

以跑 umi setup 为例。先做下初始化。

```
mkdir myapp && cd myapp
pnpm i umi -D
npx umi g page index
npx umi setup
./node_modules/umi/bin/umi.js setup
```

1）[0x](https://github.com/davidmarkclements/0x)。

```
pnpm i 0x -g
0x ./node_modules/umi/bin/umi.js setup
```

会产生如下的火焰图。

![](https://img.alicdn.com/imgextra/i1/O1CN01rDn8Ss1Vjbxdr3eLc_!!6000000002689-2-tps-3804-1752.png)

2）[clinic](https://clinicjs.org/)。

```bash
pnpm i clinic -g
clinic flame --collect-only -- node ./node_modules/umi/bin/umi.js setup
clinic flame --visualize-only .clinic/xxxxx.clinic-flame
```

会产生如下的火焰图。

![](https://img.alicdn.com/imgextra/i3/O1CN017xrKI91E3cAvvCjrE_!!6000000000296-2-tps-3840-1750.png)

3）node --cpu-prof。

```bash
node --cpu-prof ./node_modules/umi/bin/umi.js setup
```

然后把生成的 .cpuprofile 文件拖到 chrome devtool 的 performance tab 或者 [speedscope](https://www.speedscope.app/) 或者 [cpupro](https://discoveryjs.github.io/cpupro/) 或者用 [CPUpro 的 VSCode 插件](https://marketplace.visualstudio.com/items?itemName=antfu.cpupro)。

![](https://img.alicdn.com/imgextra/i2/O1CN016cyVaQ1StHTNVNRnn_!!6000000002304-2-tps-3840-1748.png)

2、这几个用下来，感觉还是 cpu prof + speedscope 的方式最顺手和能找到问题。cpu prof 专注于 cpu 的消耗，给的信息非常详细；speedscope 提供的 Time Order 和 Left Heavy 视图都很实用，同时选择一个函数还能知道这个函数多次调用的耗时，这也是 chrome devtool 工具里没有的。

3、举一个具体定位到问题的场景，见下图。这是某个非典型项目，执行 umi setup，总耗时 1m6s，其中 1m1s 的时间都在做 deepClone。

![](https://img.alicdn.com/imgextra/i2/O1CN01T2i60k1MK7N7ESHiw_!!6000000001415-2-tps-3830-1206.png)

注释掉这段代码的前后对比。

![](https://img.alicdn.com/imgextra/i3/O1CN01dsVIgh1Y3sikvXjUs_!!6000000003004-2-tps-1240-854.png)

代码在 [https://github.com/umijs/umi/blob/a278fad/packages/preset-umi/src/features/prepare/prepare.ts#L23](https://github.com/umijs/umi/blob/a278fad/packages/preset-umi/src/features/prepare/prepare.ts#L23)，已提 [issue](https://github.com/umijs/umi/issues/12224)。

4、Node 也可以用 Instruments 的 Time Profiler 做 Profile，参考 [https://gist.github.com/zeusdeux/aac6f8500917319213c5](https://gist.github.com/zeusdeux/aac6f8500917319213c5) 。

参考：  
[77 - 《火焰图与 Umi Cli 性能 5 倍提升》](https://sorrycc.com/flame-graph-and-umi-cli)  
[301 - 《Node 性能优化》](https://sorrycc.com/node-performance-optimization)  
[CPU Profiling Nuxt](https://antfu.me/posts/nuxt-cpuprofile)  
[https://clinicjs.org/](https://clinicjs.org/)  
[https://github.com/davidmarkclements/0x](https://github.com/davidmarkclements/0x)  
[https://github.com/jlfwong/speedscope](https://github.com/jlfwong/speedscope)  
[https://nodejs.org/en/learn/getting-started/profiling](https://nodejs.org/en/learn/getting-started/profiling)  
[https://nodejs.org/en/learn/diagnostics/flame-graphs](https://nodejs.org/en/learn/diagnostics/flame-graphs)  
[https://v8.dev/docs/profile](https://v8.dev/docs/profile)  
[https://github.com/jlfwong/speedscope/wiki/Importing-from-Node.js](https://github.com/jlfwong/speedscope/wiki/Importing-from-Node.js)
