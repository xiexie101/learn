---
title: "199 - 《Umi 最佳实践：三方样式覆盖》"
date: 2022-10-18
url: https://sorrycc.com/umi-best-practise-css-overrides
---

发布于 2022年10月18日

# 199 - 《Umi 最佳实践：三方样式覆盖》

# 最佳实践 2022-3：三方样式覆盖

> 计划近期每周更新 1 篇 Bigfish 2022 版的最佳实践，这是第 3 篇。

## 现有方案

我们在项目中，难免有一些场景需要进行三方库样式的覆盖，比如 antd、antv、monaco-editor、echarts 等，尤其是当对方没有提供样式覆盖功能或者提供了但不满足需求时，就需要通过相对暴力的方式进行样式覆盖。虽然覆盖样式存在风险，比如依赖更新后结构变了，但却又是某些场景下的强需求。

Bigfish / Umi 提供了 global.less 的全局样式方案。这个文件的本意是提供全局样式的引入，比如全局的 reset 样式、三方库样式的全局引入等，但大家也通常会在此进行三方库的样式覆盖。

比如：

```ts
.ant-layout {
  min-height: 68vh;
}
```

但是，这种用法其实存在一些不易被发现的隐藏问题。并且这个问题困扰依旧，经常会遇到反馈说「为啥我的样式覆盖没有生效？」。

## 问题

因为样式是有优先级的。

```css
// antd.css
.ant-layout { color: red; }
// global.less
.ant-layout { color: green; }
```

我们期望是如上这样，global.less 覆盖 antd.css 里的样式定义。但由于一些原因，加载顺序可能变成以下这样，从而导致样式覆盖失效。

```css
// global.less
.ant-layout { color: green; }
// antd.css
.ant-layout { color: red; }
```

原因可能有，

1、**动态加载。** 出于性能考虑，我们会做基于路由的代码拆分，这样如果某个页面引用了 antd，那 antd 的样式就会和这个页面打包到一起，然后迟于 global.less 的加载。  
2、**按需加载。** 同样出于性能考虑，我们可能会做重型组件的按需加载，比如使用 import() 的方式挂载 antv 组件，而动态加载 JS 和 CSS 会在打包时拆出去，也会迟于 global.less 的加载。  
3、**Code Splitting 策略。** 可根据需求调整 CSS 的合并和拆分，也可能会影响加载顺序。  
4、**框架升级。** 调整了 global.less 的引入顺序。  
5、**MFSU。** MFSU 方案会将三方库的 JS 和 CSS 拆分打包和加载，所以理论上，三方库的样式肯定会迟于 global.less 的加载。  
6、…

## 新方案

我们先是考虑了基于 Code Splitting 的方案，覆盖样式还是写在 global.less，然后通过配置把所有 CSS 合并到一起，并让 global.less 排到最后。想着都合到一起了，那肯定没有先后顺序的问题了吧。但是，1）不能覆盖 MFSU 或者手动按需加载的场景，2）存在潜在的性能问题，尤其是当 CSS 文件较大时。于是放弃。

然后，讨论后决定这么做。

1、新增约定 overrides.less，专门做样式覆盖。（global.less 让他保留自己名字的意思，全局样式，优先引入。）  
2、overrides.less 里的选择器会自动加上 `#root` 的前缀。（有考虑各种边界场景，比如配置了其他的 mountElementId，或者声明了在 `#root` 之外比如 html、body 的样式）

回到传统的方式，通过优先级确保样式覆盖，不论加载顺序如何。

## 最佳实践

### 全局样式覆盖

请使用「约定式的 overrides.less」。

1、在 src 目录下新增 overrides.less  
2、在里面声明覆盖样式即可，比如

```css
.ant-layout {
  min-height: 68vh;
}
.g6-component-toolbar {
  li:nth-child(1) {
    display: none;
  }
}
```

### 局部样式覆盖

局部样式覆盖是啥？比如你有两个组件都使用了 antd 的 Layout，但只需要针对其中一个 Layout 做样式覆盖。

由于按需加载的存在，仅仅给 Layout 加 className 属性声明样式是不够的。

```ts
import styles from './styles.less';
<Layout className={styles.layout} />
```

```css
.layout { background: red }
```

这可能会导致「切换页面后回退时样式覆盖失效」的问题，比如下图。原因是另一个页面可能也依赖了 antd 的组件，切换过去时会额外加载一份 antd 的样式，此时会对你覆盖过的样式再进行覆盖，导致覆盖样式失效。

![](https://img.alicdn.com/imgextra/i2/O1CN01YmNZbM1xPk0KqnIlF_!!6000000006436-1-tps-625-401.gif)

推荐的做法是「加一层 wrapper 以提升优先级」，这样就可以无视加载顺序了。

```ts
import styles from './styles.less';
<div className={styles.sidebar}>
  <Layout className={styles.layout} />
</div>
```

```css
body .layout { background: red }
```

## 参考

[https://github.com/umijs/umi/pull/9527](https://github.com/umijs/umi/pull/9527)
