---
title: "254 - 《关于语法高亮》"
date: 2023-02-02
url: https://sorrycc.com/code-highlight
---

发布于 2023年2月2日

# 254 - 《关于语法高亮》

> 前几天做 Docaid 时要加语法高亮，做了调研和尝试，以下是个人理解。不是啥新东西，只不过我刚接触这块。

1、语法高亮有老中青三代。老一代是 [highlight.js](https://highlightjs.org/)；中一代是 [prism](https://prismjs.com/)；青一代有 [shiki](https://github.com/shikijs/shiki) 和基于 shiki 的 [rehype-pretty-code](https://github.com/atomiks/rehype-pretty-code)，以及 sandpack（没想到吧…）。

2、highlight.js 是用地最广也是最老的，支持高亮 html 里的 `<pre><code>` 标签。用法是，1）引入 css，2）引入 js，3）执行 hljs 的初始化函数。支持的环境包括浏览器、node 和 worker。主题切换通过引入相应的 css 即可实现，主题列表可以在 [unpkg.com/highlight.js/styles](https://unpkg.com/browse/highlight.js@11.7.0/styles/) 中找到。同时出于性能考虑，你可能不需要支持那么多语言，可以通过只加载 core + 对应语言的方式实现。

```html
<link rel="stylesheet" href="/path/to/styles/default.min.css">
<script src="/path/to/highlight.min.js"></script>
<pre><code class="language-html">...</code></pre>
<script>hljs.highlightAll();</script>
```

3、prism 看起来更现代一些，docusaurus 和 dumi 用的这个。用法和 highlight.js 差不多，1）引入 css，2）引入 js，无需执行初始化函数。支持浏览器和 node 环境。主题也是通过切换 css 实现，但[官方主题](https://unpkg.com/browse/prismjs@1.29.0/themes/)比较少，只有 7 个。出于性能考虑，prism 支持通过 core + autoloader 的方式自动加载相关语言。之所以说 prism 更现代，是因为他有一套插件机制，并且官方提供了像行高亮、显示语言、关键词高亮、Toolbar、复制代码按钮、Treeview 等更现代的功能。

```html
<link rel="stylesheet" href="/path/to/themes/prism.css" />
<pre><code class="language-css">p { color: red }</code></pre>
<script src="/path/to/prism.js"></script>
```

4、shiki 最年轻，typescript 官网、vitepress 官网、vscode 官网、nextra 2 等都用他。shiki 的特点是「使用TextMate语法对字符串进行标记」，这意味着他可以支持任意 vscode 主题包。使用 shiki 会有一些门槛，比如他不支持自动对 `<pre><code>` 做高亮，他只提供了把代码转成 html 的功能，所以我们通常会将他和 markdown 解析器结合使用。shiki 支持 node 和 browser，同时有打包 wasm，所以会更快？

```html
<script src="https://unpkg.com/shiki"></script>
<script>
  shiki
    .getHighlighter({
      theme: 'nord'
    })
    .then(highlighter => {
      const code = highlighter.codeToHtml(`console.log('shiki');`, { lang: 'js' })
      document.getElementById('output').innerHTML = code
    })
</script>
```

5、rehype-pretty-code 是基于 shiki 的 rehype 插件，补全了 prisma 插件提供的一些能力，包含行高亮、行号、关键字高亮等。nextra 2 和 umi plugin doc 都是用的这个。缺点是他是 rehype 插件，只支持 unified、remark、rehype 系的工具，当我要用 markdownit 或 marked 时就无能为力了。

6、这些工具如何与 markdown 解析器结合使用？通常 markdown 解析器挖个高亮的函数坑，把代码部分提出来，交给高亮工具编译成 html 再返回给 markdown 解析器。比如 markdownit + shiki 的组合。

```ts
import { getHighlighter } from 'shiki';
const highlighter = await getHighlighter();
const md = new MarkdownIt({
  highlight: (code, lang) => {
    return highlighter.codeToHtml(code, { lang });
  },
});
md.render(markdownText);
```

7、关于性能和环境。1）在浏览器里跑肯定是性能最差的，需要加载 css、加载 js、找到 pre 和 code 元素、执行渲染，同时有个普遍的需求是，你可能不清楚会用到哪些语言，所以就要尽量多的加载语言包，此时性能就更差了，2）那选择 node 渲染吧，但 node 渲染也有两种形式，一种是包含主题的，一种是不包含的，内联主题的比如 shiki，其渲染出来的 html 已经包含了主题，包括颜色、背景色等行内的 style 属性，不内联主题比如 highlight.js（prism 不清楚，有知道的可以留言告知），生成的是带 class name 的 html，然后你需要加载响应的主题 css 实现高亮，3）node 渲染的这两种方式其实有利有弊，不是说内联主题就一定是更好的，比如一个大量代码块的网站，内联主题的方式，产出的 html 肯定比不内联的要大。

8、docaid 用的啥？目前用的 shiki + node（内联主题）。

9、sandpack 我一直觉得是代码演示工具，但他其实也包含代码高亮功能。写这篇文章之前还没想到他，刚翻 [beta.reactjs.org](http://beta.reactjs.org) 的时候发现，现在想起来，joshwcomeau 的网站和课程应该也是用的 sandpack 做代码高亮和代码演示。

参考：  
[highlight.js](https://highlightjs.org/)  
[Prism](https://prismjs.com/)  
[GitHub - shikijs/shiki: A beautiful Syntax Highlighter.](https://github.com/shikijs/shiki)  
[GitHub - atomiks/rehype-pretty-code: Beautiful code blocks for your MD/MDX docs](https://github.com/atomiks/rehype-pretty-code)  
[GitHub - codesandbox/sandpack: A component toolkit for creating live-running code editing experiences, using the power of CodeSandbox.](https://github.com/codesandbox/sandpack)  
[Enhance TypeScript Code Samples with Compiler Diagnostic - Fatih Kalifa | Interface Engineer](https://fatihkalifa.com/typescript-twoslash)  
[TypeScript-Website/packages/ts-twoslasher at v2 · microsoft/TypeScript-Website · GitHub](https://github.com/microsoft/TypeScript-Website/tree/v2/packages/ts-twoslasher)  
[Code Highlighting in Astro | Destiner’s notes](https://destiner.io/blog/post/code-highlighting-in-astro/)
