---
title: "464 - 《2024 年如何发布 npm 包（2）》"
date: 2024-08-26
url: https://sorrycc.com/how-to-publish-npm-package-in-2024-2
---

发布于 2024年8月26日

# 464 - 《2024 年如何发布 npm 包（2）》

21 年写过一篇 [20 - 《npm 包的工程化》](https://sorrycc.com/npm-package-engineering)，有些内容已经变化了，结合最近看到的文章和理解，做下更新和补充。

1、npm 包有太多选择，看需求。如果只要 esm 或 cjs 一种格式，选 tsc 就够。如果要输出多种格式，比如 esm 和 cjs 都要，那可以选 tsup 或者 [father](https://github.com/umijs/father) 或者其他的。如果还要 umd，father 应该是开箱即用的选择，他是从蚂蚁的需求里打磨出来的。

如果是大型项目，构建还要注意 watch mode 的性能。尤其是 monorepo 的，package 多了，构建一次还是很慢的。这个时候，最近给 father 加的这个 `--incremental` 的特性就很有用了，因为项目文件通常上次都已经 build 过，dev 启动时只要 watch 就行了，无需额外对现有文件做一次完整 build。

2、关于格式选择。之前 [sindresorhus](https://github.com/sindresorhus) 推 esm 其实给社区带来不少坑，虽说现在 Node 可以通过 `--experimental-require-module` 支持 esm 模块的 require，但始终还未转正。所以，个人觉得，如果要支持在 Node 下使用，带上 cjs 格式的产物还是需要的。

3、LICENSE 可以用 [Choose a License](https://choosealicense.com/licenses/) 选适合你的，如果没啥特别，就和我一样，用 MIT 吧。

4、代码格式化首选 prettier（记得加 [@trivago/prettier-plugin-sort-imports](https://github.com/trivago/prettier-plugin-sort-imports) 插件做 import 和 specifier 排序），然后加两个 script，format 和 check，前者用于本地格式化，后者用于 CI 校验。如果项目巨大，像 antd 一样，你可能会在乎性能，这是可选 biome。

5、npm 包有很多坑的，所以如果能在发布前做一些健康检查，会比较好。这部分想到有几个，欢迎补充。1）[@arethetypeswrong/cli](https://arethetypeswrong.github.io/) 可用于检查包导出（包括类型）是否正确，2）father 有个 [father doctor](https://github.com/umijs/father/blob/master/docs/guide/doctor.md)，内置了一些我们经常会犯的错的规则，比如忘记在 files 里声明文件、源码里使用了依赖但未在 package.json 中声明、大小写不匹配、sideEffects 声明错误等。

6、测试首选 Vitest，Jest 已落寞。

7、简单项目可以用 tsc 加 `noEmit` 做 lint，复杂项目有更多规则要求的可选 eslint 或 oxc。

8、Changelog、版本控制和发布，简单项目用 `npm version` 更新版本 + `npm publish` 发布 + github 基于 PR 自动生成 changelog 即可。另一个更流行的选择是用 [Changesets](https://github.com/changesets/changesets)。

9、Git Hooks 依旧是 husky + lint-staged 的组合，这几年就没变过。前者用于配置 git hooks 的执行脚本，后者让执行脚本更快一些，只覆盖修改过（staged）的文件。

10、辅助脚本依旧推荐 zx + [tsx](https://github.com/privatenumber/tsx) 的组合。zx 封装了大量脚本库，无需安装依赖也无需 import 依赖，直接用。

11、关于 monorepo，我的建议是能不用就别用，千万别为了优雅上，其带来的额外的维护、发布、changelog 等成本，不值得，没必要。上了 monorepo，也别用 nx 做 task runner（也有可能是我们自己没用好… 我看 TanStack/router 也在用），用 pnpm 就够了，出于性能考虑，可以上下 turborepo。

12、如果是开源项目，记得「合理」利用 Github Actions 来跑 CI，不用钱。

13、[typos-cli](https://crates.io/crates/typos-cli) 可用于 typos 校验，避免一些低级的拼写问题。

14、依赖预打包会增加项目复杂度，真有需要再上。

15、commitlint 可以考虑加上，安装 @commitlint/cli 和 @commitlint/config-conventional 依赖。

```bash
// .husky/commit-msg
npx --no -- commitlint --edit $1

// .commitlintrc.js
module.exports = { extends: ['@commitlint/config-conventional'] };
```

16、建议加上 [volta](https://volta.sh/) 来管理 node 和 pnpm 版本。

```bash
$ volta pin node@20
$ volta pin pnpm@8
```

参考：  
[20 - 《npm 包的工程化》](https://sorrycc.com/npm-package-engineering)  
[译：如何创建 NPM 包](https://sorrycc.com/how-to-create-an-npm-package)  
[https://x.com/mattpocockuk/status/1827963903382298718](https://x.com/mattpocockuk/status/1827963903382298718)
