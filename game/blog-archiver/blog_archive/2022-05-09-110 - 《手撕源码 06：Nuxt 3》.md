---
title: "110 - 《手撕源码 06：Nuxt 3》"
date: 2022-05-09
url: https://sorrycc.com/source-06-nuxt-3
---

发布于 2022年5月9日

# 110 - 《手撕源码 06：Nuxt 3》

> 这篇偏笔记风格。

nuxt 3 基于 vue 3 和 vitest，目前是 rc.2，月下载量 78K，nuxt 官网还是 2，没有切换到 3。nuxt 3 的维护者有不少社区名人，包括 pi0、antfu 等。

工程化方面。

![](https://img.alicdn.com/imgextra/i1/O1CN01Y36LY11hSSV1PP4U8_!!6000000004276-0-tps-1893-1080.jpg)

1、包管理用的 Yarn 3，还是第一次在流行库里看到 Yarn 3。日志非常清晰，分 Resolution、Fetch 和 Link 三个阶段  
2、monorepo 任务管理用的 lerna，有点过时，lerna 都不维护了  
3、源码构建用 [unbuild](https://github.com/unjs/unbuild)（Star 500+），支持 dts 生成，支持 stub，支持打包依赖  
4、[文档](https://v3.nuxtjs.org/)基于还处于 beta 阶段的 [docus](https://docus.com/) 实现，有需要大家可以申请个 Early Access

源码组织方面。

1、分了 kit、nuxi、nuxt、schema、test-utils、vite 和 webpack 这些包  
2、nuxi 提供命令行，nuxt 是核心引擎，kit 提供开发套件，schema 提供类型和默认配置  
3、vite 和 webpack 分别提供两种构建方式，默认是 vite

依赖库方面。

1、命令行参数解析用 [mri](https://github.com/lukeed/mri)（Star 476，最近更新 2 年前）  
2、color 库用 [colorette](https://github.com/jorgebucaran/colorette)（Star 1.4K）  
3、日志用 [consola](https://github.com/unjs/consola)（Star 3.7K），然后通过 consola.wrapConsole 代理 console 方法到 consola  
4、winPath 处理用 [pathe](https://github.com/unjs/pathe) 代替 path  
5、配置读取用 [c12](https://github.com/unjs/c12)  
6、扩展基于 [hookable](https://github.com/unjs/hookable)（Star 173），提供 hooks 形式的扩展  
7、用 [unctx](https://github.com/unjs/unctx) 提供全局 hook，比如 useNuxt 拿到 nuxt 实例  
…

webpack 构建。

1、临时文件的生成没有产生物理文件，而是通过 webpack-virtual-modules 生成虚拟模块的形式  
2、提供简单的 [applyPresets](https://github.com/nuxt/framework/blob/73ba30fb69b91a25ee595daa447f3d6988b4dc8c/packages/webpack/src/utils/config.ts#L27) 方法用于扩展 webpack 配置  
3、配置部分。使用 esbuild-loader 处理 js 文件，target 配置 server 用 es2019，client 用 chrome85；支持 pug 模板引擎；fs cache 没开；有加 time-fix-plugin 插件

vite 构建。

1、有个 warmup 的过程，把入口文件通过 server.transformRequest 添加，然后再用 server.moduleGraph.getModuleByUrl 找到依赖递归添加 warmup

其他。

1、nuxt 3 有提供 @nuxt/bridge 包，让 nuxt 2 项目也可以享受到 nuxt 3 的部分功能，这也是一种不错的升级策略  
2、命令的具体执行代码通过按需的方式引入，所以命令行的启动速度是很快的  
3、临时文件生成在 .nuxt 目录下，提供类型和 tsconfig.json，然后开发者的 tsconfig.json extends ./.nuxt/tsconfig.json 就好  
4、nuxt 3 依赖 npm client 的 hoist，如果使用 pnpm 安装依赖需要加 --shamefully-hoist 参数，感觉不太好  
5、临时文件没有产生物理文件，而是存在 nuxt.vfs 里，然后在 webpack 里通过 webpack-virtual-modules 和 vite 里通过自定义插件访问  
6、约定式路由实现在 nuxt/src/pages/module.ts 下，是可选的，如果没有 pages 目录，就不会添加 vue-router 依赖

参考：  
[https://v3.nuxtjs.org/](https://v3.nuxtjs.org/)  
[https://github.com/nuxt/framework](https://github.com/nuxt/framework)  
[https://github.com/nuxt/bridge](https://github.com/nuxt/bridge)
