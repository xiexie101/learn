---
title: "167 - 《dva 3》"
date: 2022-08-12
url: https://sorrycc.com/dva-3
---

发布于 2022年8月12日

# 167 - 《dva 3》

整理下 dva 3 的想法。年初立的 Flag，一转眼已经下半年，要开始动工了。

1、延续性。这次升级主要是为了照顾一直使用 dva 的老用户，所以会尽量兼容老用法，不能升完之后面目全非，变得大家都不认识了。这意味着还会继续保留 redux + react-redux + redux-saga 的组合用法，保留 app = dva()、app.model、connect 等常见用法。但可能会不再需要 react-redux，因为 react 官方提供的 useSyncExternalStore 已足够使用。

2、废弃。大版本更新，正式删东西的好时机。之前 dva 的定位，除了数据流之外，还是个运行时框架。所以额外包含了路由、fetch 等，这些应该由真正的框架来决定，dva 3 会回归到纯粹的数据流方案，删除 react-router-dom、isomorphic-fetch 及其相关依赖。

3、依赖升级。dva 好久未更，虽然能跑，但环境变了，依赖已过期，比如 redux、react、redux-saga、immer 等，都需要更新大版本。尤其是 react，目前还不兼容 react 18，这个需求更为急迫一些。

4、异步 Action。之前基于 redux-saga，但 generator 的写法现在看来有些不合时宜，async 基本已够用。我比较倾向于改成默认 async，然后通过扩展支持 redux-saga。既可以写 async function，也可以写 `*function`。

5、组件封装。redux 的三原则之一是「Single source of truth」，即全局有且仅有一个 store，这有好处，但也带来了问题，比如项目大了之后提取带数据流的组件很是麻烦。组件封装会需要多 store。计划提供 createModel(model) + useModel(modelInstance) 的形式，每个 model 都是独立的 store，默认不考虑 SSR，额外提供 Provider/Context 模式支持 SSR。

6、扩展和插件。可能提供 middleware 级的扩展就够了，插件如果没必要就在这个版本删了。然后内置常用扩展，包括持久化、redo/undo、immer、redux devtool 支持等。

7、TypeScript 友好。

* * *

附：拆分的子 Action。

\[ \] 脚手架  
\[ \] 编写代码，跑通老用例  
\[ \] 使用 useSyncExternalStore 代替 react-redux  
\[ \] 支持 react 18  
\[ \] 升级 redux-saga  
\[ \] 完善 TypeScript  
\[ \] 设计扩展和插件  
\[ \] 默认使用 async function 作为 effect，通过扩展支持 redux-saga  
\[ \] 支持组件方式，提供 createModel 和 useModel API  
\[ \] 新增持久化扩展  
\[ \] 新增 immer 扩展  
\[ \] 新增 redo/undo 扩展  
\[ \] 新增 redux devtool 扩展  
\[ \] 编写文档  
\[ \] 编写发布稿  
\[ \] 正式发布
