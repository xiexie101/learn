---
title: "391 - 《React Memo》"
date: 2023-12-26
url: https://sorrycc.com/react-memo
---

发布于 2023年12月26日

# 391 - 《React Memo》

汇总下关于 memo 相关的知识点。

1、React.memo 是一个非常有用的工具。它允许我们对组件本身进行 memorize。如果组件的 re-render 是由其父组件触发，且这个组件被 React.memo 包裹时，那 React 会停下来检查它的 props。如果所有的 props 都没有变化，那么组件将不会被 re-render。

![](https://img.alicdn.com/imgextra/i2/O1CN019eF8XM1nysDQ78KVK_!!6000000005159-2-tps-1488-996.png)

2、memo props 通常是个反模式。比如下面场景的 useCallback 没有必要，因为 Component re-render 时，其子组件肯定会 re-render，加不加 onClick 的 useCallback 其实没有意义。

```tsx
function Component() {
  const onClick = useCallback(() => {}, []);
  return <button onClick={onClick} />;
}
```

3、需要 memo props 通常有两个场景。1）这个 props 被当做 useEffect、useMemo、useCallback 等 hook 的依赖时，被用作下游组件中 hook 依赖也算。

```tsx
function Parent() {
  // 应该要 memo
  const fetch = () => {};
  return <Child onMount={fetch} />
}

function Child({ onMount }) {
  useEffect(() => {
    onMount();
  }, [onMount]);
}
```

2）当组件被 React.memo 包裹时。比如下方的 data 和 onChange，通过 useMemo 和 useCallback 可以保持引用稳定，从而避免 ChildMemo 的 re-render。

```tsx
const Child = ({ data, onChange }) => {};
const ChildMemo = React.memo(Child);

function Parent() {
  const data = useMemo(() => ({}), []);
  const onChange = useCallback(() => {}, []);
  return <ChildMemo data={data} onChange={onChange} />
}
```

4、要确保所有的 props 都被 memoized 并不没有那么容易。坑多，很容易做错，一旦错一个，所有 memorized 工作都将白费。下面是一些例子。

1）透传 props。某一层多传了一个引用类型的 props，会让 React.memo 失效。解法是「别用 props 透传」，同时不要传来自 hooks 或者其他组件的非原始类型的 props。

```tsx
const Child = () => {};
const ChildMemo = React.memo(Child);
const Component = (props) => {
  return <ChildMemo {...props} />;
};
const ComponentInBetween = (props) => {
  return <Component {...props} />;
};
function Parent(props) {
  return <ComponentInBetween {...props} data={{ id: '1' }} />;
}
```

2）child 也是 props。jsx 嵌套是语法糖，下面代码翻译成 props 即 `children={<div>Some text here</div>}`，即 `children={{ type: 'div', … }}`，所以每次 Parent re-render 时，会生成新的引用类型，导致 ChildMemo 的 props 变更进而 re-render。解法是把 children useMemo 一下，比如 `const children = useMemo(() => <div>Some text here</div>, [])`。

```tsx
const ChildMemo = React.memo(Child);
function Parent() {
  return (
    <ChildMemo>
      <div>Some text here</div>
    </ChildMemo>
  );
}
```

参考：  
[https://advanced-react.com/](https://advanced-react.com/)  
[https://react.dev/reference/react/memo](https://react.dev/reference/react/memo)  
[https://overreacted.io/before-you-memo/](https://overreacted.io/before-you-memo/)  
[179 - 《React Re-Render》](https://sorrycc.com/react-re-render)

* * *
