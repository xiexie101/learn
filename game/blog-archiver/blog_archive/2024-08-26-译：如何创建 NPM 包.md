---
title: "è¯‘ï¼šå¦‚ä½•åˆ›å»º NPM åŒ…"
date: 2024-08-26
url: https://sorrycc.com/how-to-create-an-npm-package
---

å‘å¸ƒäº 2024å¹´8æœˆ26æ—¥

# è¯‘ï¼šå¦‚ä½•åˆ›å»º NPM åŒ…

> åŸæ–‡ï¼š[https://www.totaltypescript.com/how-to-create-an-npm-package](https://www.totaltypescript.com/how-to-create-an-npm-package)  
> ä½œè€…ï¼šMatt Pocock  
> è¯‘è€…ï¼šChatGPT 4 Turbo

**ç¼–è€…æ³¨ï¼š [https://x.com/mattpocockuk/status/1827963903382298718](https://x.com/mattpocockuk/status/1827963903382298718) è¿™é‡Œæœ‰å¤ªé•¿ä¸çœ‹ç‰ˆã€‚**

åœ¨è¿™ä¸ªæŒ‡å—ä¸­ï¼Œæˆ‘ä»¬å°†é€æ­¥è®²è§£å‘å¸ƒåŒ…åˆ° npm éœ€è¦åšçš„æ¯ä¸€ä¸ªæ­¥éª¤ã€‚

è¿™ä¸æ˜¯ä¸€ä¸ªæœ€ç®€æŒ‡å—ã€‚æˆ‘ä»¬å°†ä»ä¸€ä¸ªç©ºç›®å½•å¼€å§‹ï¼Œè®¾ç½®ä¸€ä¸ªå®Œå…¨é€‚ç”¨äºç”Ÿäº§ç¯å¢ƒçš„åŒ…ã€‚è¿™å°†åŒ…æ‹¬ï¼š

*   [Git](https://git-scm.com/) ç”¨äºç‰ˆæœ¬æ§åˆ¶
*   [TypeScript](https://www.typescriptlang.org/) ç”¨äºç¼–å†™ä»£ç å¹¶ä¿æŒç±»å‹å®‰å…¨
*   [Prettier](https://prettier.io/) ç”¨äºæ ¼å¼åŒ–ä»£ç 
*   [@arethetypeswrong/cli](https://arethetypeswrong.github.io/) ç”¨äºæ£€æŸ¥æˆ‘ä»¬çš„å¯¼å‡º
*   [tsup](https://tsup.egoist.dev/) ç”¨äºå°†æˆ‘ä»¬çš„ TypeScript ä»£ç ç¼–è¯‘æˆ CJS å’Œ ESM
*   [Vitest](https://vitest.js.org/) ç”¨äºè¿è¡Œæˆ‘ä»¬çš„æµ‹è¯•
*   [GitHub Actions](https://docs.github.com/en/actions) ç”¨äºè¿è¡Œæˆ‘ä»¬çš„ CI æµç¨‹
*   [Changesets](https://github.com/changesets/changesets) ç”¨äºç‰ˆæœ¬æ§åˆ¶å’Œå‘å¸ƒæˆ‘ä»¬çš„åŒ…

å¦‚æœä½ æƒ³çœ‹åˆ°æˆå“ï¼Œè¯·æŸ¥çœ‹è¿™ä¸ª [æ¼”ç¤ºä»“åº“](https://github.com/mattpocock/tt-package-demo)ã€‚

## 0\. è§†é¢‘

å¦‚æœä½ æ›´å–œæ¬¢è§†é¢‘å†…å®¹ï¼Œæˆ‘å·²ç»åˆ›å»ºäº†ä¸€æ®µè¿™ä¸ªæŒ‡å—çš„è§†é¢‘è®²è§£ï¼š

> æ³¨ï¼šåŸæ–‡æœ‰è§†é¢‘è®²è§£ã€‚

## 1\. Git

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªæ–°çš„ git ä»“åº“ï¼Œè®¾ç½®ä¸€ä¸ª `.gitignore`ï¼Œåˆ›å»ºä¸€ä¸ªåˆå§‹æäº¤ï¼Œåœ¨ GitHub ä¸Šåˆ›å»ºä¸€ä¸ªæ–°ä»“åº“ï¼Œå¹¶å°†æˆ‘ä»¬çš„ä»£ç æ¨é€åˆ° GitHubã€‚

### 1.1: åˆå§‹åŒ–ä»“åº“

è¿è¡Œä»¥ä¸‹å‘½ä»¤ä»¥åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„ git ä»“åº“ï¼š

```ts
git init
```

### 1.2: è®¾ç½®ä¸€ä¸ª `.gitignore`

åœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª `.gitignore` æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```ts
node_modules
```

### 1.3: åˆ›å»ºä¸€ä¸ªåˆå§‹æäº¤

è¿è¡Œä»¥ä¸‹å‘½ä»¤åˆ›å»ºä¸€ä¸ªåˆå§‹æäº¤ï¼š

```ts
git add .
git commit -m "Initial commit"
```

### 1.4: åœ¨ GitHub ä¸Šåˆ›å»ºä¸€ä¸ªæ–°ä»“åº“

ä½¿ç”¨ [GitHub CLI](https://cli.github.com/)ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤åˆ›å»ºä¸€ä¸ªæ–°ä»“åº“ã€‚æˆ‘åœ¨è¿™ä¸ªä¾‹å­ä¸­é€‰æ‹©äº† `tt-package-demo` ä½œä¸ºåç§°ï¼š

```ts
gh repo create tt-package-demo --source=. --public
```

### 1.5: æ¨é€åˆ° GitHub

è¿è¡Œä»¥ä¸‹å‘½ä»¤å°†ä½ çš„ä»£ç æ¨é€åˆ° GitHubï¼š

```ts
git push --set-upstream origin main
```

## 2ï¼š`package.json`

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ª `package.json` æ–‡ä»¶ï¼Œæ·»åŠ ä¸€ä¸ª `license` å­—æ®µï¼Œåˆ›å»ºä¸€ä¸ª `LICENSE` æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä¸€ä¸ª `README.md` æ–‡ä»¶ã€‚

### 2.1ï¼šåˆ›å»º `package.json` æ–‡ä»¶

ä½¿ç”¨ä»¥ä¸‹å€¼åˆ›å»ºä¸€ä¸ª `package.json` æ–‡ä»¶ï¼š

```ts
{
  "name": "tt-package-demo",
  "version": "1.0.0",
  "description": "ä¸€ä¸ª Total TypeScript çš„æ¼”ç¤ºåŒ…",
  "keywords": ["demo", "typescript"],
  "homepage": "https://github.com/mattpocock/tt-package-demo",
  "bugs": {
    "url": "https://github.com/mattpocock/tt-package-demo/issues"
  },
  "author": "Matt Pocock <team@totaltypescript.com> (https://totaltypescript.com)",
  "repository": {
    "type": "git",
    "url": "git+https://github.com/mattpocock/tt-package-demo.git"
  },
  "files": ["dist"],
  "type": "module"
}
```

*   `name` æ˜¯äººä»¬å®‰è£…ä½ çš„åŒ…æ—¶ä½¿ç”¨çš„åç§°ã€‚å®ƒåœ¨ npm ä¸Šå¿…é¡»æ˜¯å”¯ä¸€çš„ã€‚ä½ å¯ä»¥å…è´¹åˆ›å»º[ç»„ç»‡èŒƒå›´](https://docs.npmjs.com/about-organization-scopes-and-packages)ï¼ˆå¦‚ `@total-typescript/demo`ï¼‰ï¼Œè¿™å¯ä»¥å¸®åŠ©ä½¿å…¶å”¯ä¸€ã€‚
*   `version` æ˜¯ä½ åŒ…çš„ç‰ˆæœ¬ã€‚å®ƒåº”è¯¥éµå¾ª[è¯­ä¹‰åŒ–ç‰ˆæœ¬æ§åˆ¶](https://semver.org/)ï¼š`0.0.1` æ ¼å¼ã€‚æ¯æ¬¡å‘å¸ƒæ–°ç‰ˆæœ¬æ—¶ï¼Œä½ åº”è¯¥å¢åŠ è¿™ä¸ªæ•°å­—ã€‚
*   `description` å’Œ `keywords` æ˜¯ä½ çš„åŒ…çš„ç®€çŸ­æè¿°ã€‚å®ƒä»¬åœ¨ npm æ³¨å†Œè¡¨çš„æœç´¢ä¸­è¢«åˆ—å‡ºã€‚
*   `homepage` æ˜¯ä½ åŒ…çš„ä¸»é¡µ URLã€‚GitHub ä»“åº“æ˜¯ä¸€ä¸ªå¥½çš„é»˜è®¤å€¼ï¼Œæˆ–è€…å¦‚æœä½ æœ‰çš„è¯ï¼Œä¹Ÿå¯ä»¥æ˜¯æ–‡æ¡£ç«™ç‚¹ã€‚
*   `bugs` æ˜¯äººä»¬å¯ä»¥æŠ¥å‘Šä½ çš„åŒ…çš„é—®é¢˜çš„ URLã€‚
*   `author` æ˜¯ä½ ï¼ä½ å¯ä»¥é€‰æ‹©æ€§åœ°æ·»åŠ ä½ çš„ç”µå­é‚®ä»¶å’Œç½‘ç«™ã€‚å¦‚æœä½ æœ‰å¤šä¸ªè´¡çŒ®è€…ï¼Œä½ å¯ä»¥ä»¥åŒæ ·çš„æ ¼å¼æŒ‡å®šä¸€ä¸ª `contributors` æ•°ç»„ã€‚
*   `repository` æ˜¯ä½ åŒ…çš„ä»“åº“ URLã€‚è¿™åœ¨ npm æ³¨å†Œè¡¨ä¸Šä¸ºä½ çš„ GitHub ä»“åº“åˆ›å»ºäº†ä¸€ä¸ªé“¾æ¥ã€‚
*   `files` æ˜¯ä¸€ä¸ªæ•°ç»„ï¼ŒåŒ…å«å®‰è£…ä½ çš„åŒ…æ—¶åº”è¯¥åŒ…æ‹¬çš„æ–‡ä»¶ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åŒ…å«äº† `dist` æ–‡ä»¶å¤¹ã€‚`README.md`ã€`package.json` å’Œ `LICENSE` é»˜è®¤åŒ…å«åœ¨å†…ã€‚
*   `type` è®¾ç½®ä¸º `module`ï¼Œä»¥æŒ‡ç¤ºä½ çš„åŒ…ä½¿ç”¨ ECMAScript æ¨¡å—ï¼Œè€Œä¸æ˜¯ CommonJS æ¨¡å—ã€‚

### 2.2: æ·»åŠ  `license` å­—æ®µ

åœ¨ä½ çš„ `package.json` ä¸­æ·»åŠ ä¸€ä¸ª `license` å­—æ®µã€‚åœ¨[è¿™é‡Œ](https://choosealicense.com/licenses/)é€‰æ‹©ä¸€ä¸ªè®¸å¯è¯ã€‚æˆ‘é€‰æ‹©äº† [MIT](https://choosealicense.com/licenses/mit/)ã€‚

```ts
{
  "license": "MIT"
}
```

### 2.3: æ·»åŠ ä¸€ä¸ª `LICENSE` æ–‡ä»¶

åˆ›å»ºä¸€ä¸ªå«åš `LICENSE`ï¼ˆæ— æ‰©å±•åï¼‰çš„æ–‡ä»¶ï¼ŒåŒ…å«ä½ çš„è®¸å¯è¯æ–‡æœ¬ã€‚å¯¹äº MIT æ¥è¯´ï¼Œå†…å®¹æ˜¯ï¼š

```ts
MIT License

Copyright (c) [year] [fullname]

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
```

å°† `[year]` å’Œ `[fullname]` å ä½ç¬¦æ›´æ”¹ä¸ºå½“å‰å¹´ä»½å’Œä½ çš„åå­—ã€‚

### 2.4: æ·»åŠ ä¸€ä¸ª `README.md` æ–‡ä»¶

åˆ›å»ºä¸€ä¸ª `README.md` æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«ä½ çš„åŒ…çš„æè¿°ã€‚è¿™é‡Œæ˜¯ä¸€ä¸ªä¾‹å­ï¼š

```ts
**tt-package-demo**

Total TypeScript çš„ä¸€ä¸ªæ¼”ç¤ºåŒ…ã€‚
```

å½“äººä»¬åœ¨ npm æ³¨å†Œè¡¨ä¸ŠæŸ¥çœ‹ä½ çš„åŒ…æ—¶ï¼Œä¼šæ˜¾ç¤ºè¿™æ®µæè¿°ã€‚

## 3: TypeScript

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å®‰è£… TypeScriptï¼Œè®¾ç½® `tsconfig.json`ï¼Œåˆ›å»ºä¸€ä¸ªæºæ–‡ä»¶ï¼Œåˆ›å»ºä¸€ä¸ªç´¢å¼•æ–‡ä»¶ï¼Œè®¾ç½®ä¸€ä¸ª `build` è„šæœ¬ï¼Œè¿è¡Œæˆ‘ä»¬çš„æ„å»ºï¼Œå°† `dist` æ·»åŠ åˆ° `.gitignore`ï¼Œè®¾ç½®ä¸€ä¸ª `ci` è„šæœ¬ï¼Œå¹¶ä¸º DOM é…ç½®æˆ‘ä»¬çš„ `tsconfig.json`ã€‚

### 3.1: å®‰è£… TypeScript

è¿è¡Œä»¥ä¸‹å‘½ä»¤ä»¥å®‰è£… TypeScriptï¼š

```ts
npm install --save-dev typescript
```

æˆ‘ä»¬æ·»åŠ  `--save-dev` æ˜¯ä¸ºäº†å°† TypeScript ä½œä¸ºä¸€ä¸ªå¼€å‘ä¾èµ–æ¥å®‰è£…ã€‚è¿™æ„å‘³ç€å½“äººä»¬å®‰è£…ä½ çš„åŒ…æ—¶ï¼Œå®ƒä¸ä¼šè¢«åŒ…å«è¿›å»ã€‚

### 3.2: è®¾ç½® `tsconfig.json`

ä½¿ç”¨ä»¥ä¸‹å€¼åˆ›å»ºä¸€ä¸ª `tsconfig.json`ï¼š

```ts
{
  "compilerOptions": {
    /* åŸºç¡€é€‰é¡¹ï¼š */
    "esModuleInterop": true,
    "skipLibCheck": true,
    "target": "es2022",
    "allowJs": true,
    "resolveJsonModule": true,
    "moduleDetection": "force",
    "isolatedModules": true,
    "verbatimModuleSyntax": true,

    /* ä¸¥æ ¼æ€§ */
    "strict": true,
    "noUncheckedIndexedAccess": true,
    "noImplicitOverride": true,

    /* å¦‚æœä½¿ç”¨ TypeScript è½¬è¯‘ï¼š */
    "module": "NodeNext",
    "outDir": "dist",
    "rootDir": "src",
    "sourceMap": true,

    /* å¦‚æœä½ åœ¨ä¸ºä¸€ä¸ªåº“æ„å»ºï¼š */
    "declaration": true,

    /* å¦‚æœä½ åœ¨ä¸ºä¸€ä¸ª monorepo ä¸­çš„åº“æ„å»ºï¼š */
    "declarationMap": true
  }
}
```

è¿™äº›é€‰é¡¹åœ¨æˆ‘çš„ [TSConfig é€ŸæŸ¥è¡¨](https://www.totaltypescript.com/tsconfig-cheat-sheet) ä¸­æœ‰è¯¦ç»†è§£é‡Šã€‚

### 3.3: ä¸º DOM é…ç½®ä½ çš„ `tsconfig.json`

å¦‚æœä½ çš„ä»£ç åœ¨ DOM ä¸­è¿è¡Œï¼ˆå³éœ€è¦è®¿é—® `document`ã€`window` æˆ– `localStorage` ç­‰ï¼‰ï¼Œè·³è¿‡è¿™ä¸€æ­¥ã€‚

å¦‚æœä½ çš„ä»£ç ä¸éœ€è¦è®¿é—® DOM APIï¼Œé‚£ä¹ˆåœ¨ä½ çš„ `tsconfig.json` ä¸­æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```ts
{
  "compilerOptions": {
    // ...å…¶ä»–é€‰é¡¹
    "lib": ["es2022"]
  }
}
```

è¿™å¯ä»¥é˜²æ­¢ DOM çš„ç±»å‹å®šä¹‰åœ¨ä½ çš„ä»£ç ä¸­å¯ç”¨ã€‚

å¦‚æœä½ ä¸ç¡®å®šï¼Œè·³è¿‡è¿™ä¸€æ­¥ã€‚

### 3.4: åˆ›å»ºæºæ–‡ä»¶

åˆ›å»ºä¸€ä¸ªåŒ…å«ä»¥ä¸‹å†…å®¹çš„ `src/utils.ts` æ–‡ä»¶ï¼š

```ts
export const add = (a: number, b: number) => a + b;
```

### 3.5: åˆ›å»ºç´¢å¼•æ–‡ä»¶

åˆ›å»ºä¸€ä¸ªåŒ…å«ä»¥ä¸‹å†…å®¹çš„ `src/index.ts` æ–‡ä»¶ï¼š

```ts
export { add } from "./utils.js";
```

`.js` æ‰©å±•åçœ‹èµ·æ¥å¯èƒ½å¾ˆå¥‡æ€ªã€‚[è¿™ç¯‡æ–‡ç« ](https://www.totaltypescript.com/relative-import-paths-need-explicit-file-extensions-in-ecmascript-imports)è¿›è¡Œäº†æ›´å¤šè§£é‡Šã€‚

### 3.6: è®¾ç½® `build` è„šæœ¬

åœ¨ä½ çš„ `package.json` ä¸­æ·»åŠ ä¸€ä¸ª `scripts` å¯¹è±¡ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```ts
{
  "scripts": {
    "build": "tsc"
  }
}
```

è¿™å°†ä¼šæŠŠä½ çš„ TypeScript ä»£ç ç¼–è¯‘æˆ JavaScriptã€‚

### 3.7: è¿è¡Œä½ çš„æ„å»º

è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥ç¼–è¯‘ä½ çš„ TypeScript ä»£ç ï¼š

```ts
npm run build
```

è¿™å°†ä¼šåˆ›å»ºä¸€ä¸ªåŒ…å«ä½ ç¼–è¯‘åçš„ JavaScript ä»£ç çš„ `dist` æ–‡ä»¶å¤¹ã€‚

### 3.8: å°† `dist` æ·»åŠ åˆ° `.gitignore`

å°† `dist` æ–‡ä»¶å¤¹æ·»åŠ åˆ°ä½ çš„ `.gitignore` æ–‡ä»¶ä¸­ï¼š

```ts
dist
```

è¿™å°†ä¼šé˜»æ­¢ä½ ç¼–è¯‘åçš„ä»£ç è¢«åŒ…å«åœ¨ä½ çš„ git ä»“åº“ä¸­ã€‚

### 3.9: è®¾ç½® `ci` è„šæœ¬

åœ¨ä½ çš„ `package.json` ä¸­æ·»åŠ ä¸€ä¸ª `ci` è„šæœ¬ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```ts
{
  "scripts": {
    "ci": "npm run build"
  }
}
```

è¿™ä¸ºæˆ‘ä»¬åœ¨ CI ä¸Šè¿è¡Œæ‰€éœ€æ“ä½œæä¾›äº†ä¸€ä¸ªå¿«æ·æ–¹å¼ã€‚

## 4: Prettier

åœ¨è¿™ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å®‰è£… Prettier ï¼Œè®¾ç½®ä¸€ä¸ª `.prettierrc` ï¼Œè®¾ç½® `format` è„šæœ¬ï¼Œè¿è¡Œ `format` è„šæœ¬ï¼Œè®¾ç½® `check-format` è„šæœ¬ï¼Œå°† `check-format` è„šæœ¬æ·»åŠ åˆ°æˆ‘ä»¬çš„ `CI` è„šæœ¬ä¸­ï¼Œå¹¶è¿è¡Œ `CI` è„šæœ¬ã€‚

Prettier æ˜¯ä¸€ä¸ªä»£ç æ ¼å¼åŒ–å·¥å…·ï¼Œå®ƒä¼šè‡ªåŠ¨å°†ä½ çš„ä»£ç æ ¼å¼åŒ–ä¸ºä¸€è‡´çš„é£æ ¼ã€‚è¿™ä½¿å¾—ä½ çš„ä»£ç æ›´å®¹æ˜“é˜…è¯»å’Œç»´æŠ¤ã€‚

### 4.1: å®‰è£… Prettier

è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥å®‰è£… Prettierï¼š

```ts
npm install --save-dev prettier
```

### 4.2: è®¾ç½® `.prettierrc`

åˆ›å»ºä¸€ä¸ª `.prettierrc` æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```ts
{
  "semi": true,
  "singleQuote": true,
  "trailingComma": "all",
  "printWidth": 80,
  "tabWidth": 2
}
```

ä½ å¯ä»¥åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­æ·»åŠ æ›´å¤šé€‰é¡¹æ¥è‡ªå®šä¹‰ Prettier çš„è¡Œä¸ºã€‚ä½ å¯ä»¥[è¿™é‡Œ](https://prettier.io/docs/en/options.html)æ‰¾åˆ°å®Œæ•´çš„é€‰é¡¹åˆ—è¡¨ã€‚

### 4.3: è®¾ç½® `format` è„šæœ¬

åœ¨ä½ çš„ `package.json` ä¸­æ·»åŠ ä¸€ä¸ª `format` è„šæœ¬ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```ts
{
  "scripts": {
    "format": "prettier --write ."
  }
}
```

è¿™å°†ä¼šä½¿ç”¨ Prettier æ ¼å¼åŒ–ä½ é¡¹ç›®ä¸­çš„æ‰€æœ‰æ–‡ä»¶ã€‚

### 4.4: è¿è¡Œ `format` è„šæœ¬

è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥æ ¼å¼åŒ–ä½ é¡¹ç›®ä¸­çš„æ‰€æœ‰æ–‡ä»¶ï¼š

```ts
npm run format
```

ä½ å¯èƒ½ä¼šæ³¨æ„åˆ°ä¸€äº›æ–‡ä»¶å‘ç”Ÿäº†å˜åŒ–ã€‚è¯·ç”¨ä»¥ä¸‹å‘½ä»¤æäº¤å®ƒä»¬ï¼š

```ts
git add .
git commit -m "ä½¿ç”¨ Prettier æ ¼å¼åŒ–ä»£ç "
```

### 4.5: è®¾ç½® `check-format` è„šæœ¬

åœ¨ä½ çš„ `package.json` ä¸­æ·»åŠ ä¸€ä¸ª `check-format` è„šæœ¬ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```ts
{
  "scripts": {
    "check-format": "prettier --check ."
  }
}
```

è¿™å°†æ£€æŸ¥ä½ é¡¹ç›®ä¸­çš„æ‰€æœ‰æ–‡ä»¶æ˜¯å¦æ ¼å¼æ­£ç¡®ã€‚

### 4.6: æ·»åŠ åˆ°æˆ‘ä»¬çš„ `CI` è„šæœ¬

åœ¨ä½ çš„ `package.json` ä¸­çš„ `ci` è„šæœ¬é‡Œæ·»åŠ  `check-format` è„šæœ¬ï¼š

```ts
{
  "scripts": {
    "ci": "npm run build && npm run check-format"
  }
}
```

è¿™å°†åœ¨ä½ çš„ CI è¿‡ç¨‹ä¸­è¿è¡Œ `check-format` è„šæœ¬ã€‚

## 5: `exports`, `main` å’Œ `@arethetypeswrong/cli`

åœ¨è¿™ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å®‰è£… `@arethetypeswrong/cli`ï¼Œè®¾ç½®ä¸€ä¸ª `check-exports` è„šæœ¬ï¼Œè¿è¡Œ `check-exports` è„šæœ¬ï¼Œè®¾ç½®ä¸€ä¸ª `main` å­—æ®µï¼Œå†æ¬¡è¿è¡Œ `check-exports` è„šæœ¬ï¼Œè®¾ç½®ä¸€ä¸ª `ci` è„šæœ¬ï¼Œå¹¶è¿è¡Œ `ci` è„šæœ¬ã€‚

`@arethetypeswrong/cli` æ˜¯ä¸€ä¸ªå·¥å…·ï¼Œç”¨äºæ£€æŸ¥ä½ çš„åŒ…å¯¼å‡ºæ˜¯å¦æ­£ç¡®ã€‚è¿™éå¸¸é‡è¦ï¼Œå› ä¸ºè¿™äº›å¾ˆå®¹æ˜“æé”™ï¼Œå¹¶ä¸”å¯èƒ½ä¼šç»™ä½¿ç”¨ä½ çš„åŒ…çš„äººå¸¦æ¥é—®é¢˜ã€‚

### 5.1: å®‰è£… `@arethetypeswrong/cli`

è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥å®‰è£… `@arethetypeswrong/cli`ï¼š

```ts
npm install --save-dev @arethetypeswrong/cli
```

### 5.2: è®¾ç½® `check-exports` è„šæœ¬

åœ¨ä½ çš„ `package.json` ä¸­æ·»åŠ ä¸€ä¸ª `check-exports` è„šæœ¬ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```ts
{
  "scripts": {
    "check-exports": "attw --pack ."
  }
}
```

è¿™å°†æ£€æŸ¥ä½ åŒ…çš„æ‰€æœ‰å¯¼å‡ºæ˜¯å¦æ­£ç¡®ã€‚

### 5.3: è¿è¡Œ `check-exports` è„šæœ¬

è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥æ£€æŸ¥ä½ åŒ…çš„æ‰€æœ‰å¯¼å‡ºæ˜¯å¦æ­£ç¡®ï¼š

```ts
npm run check-exports
```

ä½ åº”è¯¥ä¼šæ³¨æ„åˆ°å„ç§é”™è¯¯ï¼š

```ts
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   â”‚ "tt-package-demo"    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ node10            â”‚ ğŸ’€ è§£æå¤±è´¥          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ node16 (æ¥è‡ª CJS) â”‚ ğŸ’€ è§£æå¤±è´¥          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ node16 (æ¥è‡ª ESM) â”‚ ğŸ’€ è§£æå¤±è´¥          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ‰“åŒ…å™¨             â”‚ ğŸ’€ è§£æå¤±è´¥          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

è¿™è¡¨æ˜æ²¡æœ‰ä»»ä½•ç‰ˆæœ¬çš„ Nodeï¼Œæˆ–ä»»ä½•æ‰“åŒ…å·¥å…·ï¼Œå¯ä»¥ä½¿ç”¨æˆ‘ä»¬çš„åŒ…ã€‚

è®©æˆ‘ä»¬æ¥ä¿®å¤è¿™ä¸ªé—®é¢˜ã€‚

### 5.4: è®¾ç½® `main`

åœ¨ä½ çš„ `package.json` ä¸­æ·»åŠ ä¸€ä¸ª `main` å­—æ®µï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```ts
{
  "main": "dist/index.js"
}
```

è¿™å‘Šè¯‰ Node åœ¨å“ªé‡Œæ‰¾åˆ°ä½ çš„åŒ…çš„å…¥å£ç‚¹ã€‚

### 5.5: å†æ¬¡å°è¯• `check-exports`

è¿è¡Œä»¥ä¸‹å‘½ä»¤ä»¥æ£€æŸ¥ä½ çš„åŒ…ä¸­çš„æ‰€æœ‰å¯¼å‡ºæ˜¯å¦æ­£ç¡®ï¼š

```ts
npm run check-exports
```

ä½ åº”è¯¥åªæ³¨æ„åˆ°ä¸€ä¸ªè­¦å‘Šï¼š

```ts
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   â”‚ "tt-package-demo"            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ node10            â”‚ ğŸŸ¢                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ node16 (ä» CJS)   â”‚ âš ï¸ ESMï¼ˆä»…é™åŠ¨æ€å¯¼å…¥ï¼‰        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ node16 (ä» ESM)   â”‚ ğŸŸ¢ (ESM)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ‰“åŒ…å·¥å…·           â”‚ ğŸŸ¢                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

è¿™å‘Šè¯‰æˆ‘ä»¬ï¼Œæˆ‘ä»¬çš„åŒ…ä¸è¿è¡Œ ESM çš„ç³»ç»Ÿå…¼å®¹ã€‚ä½¿ç”¨ CJSï¼ˆç»å¸¸åœ¨é—ç•™ç³»ç»Ÿä¸­ï¼‰çš„äººå°†éœ€è¦ä½¿ç”¨åŠ¨æ€å¯¼å…¥æ¥å¯¼å…¥å®ƒã€‚

å¦‚æœæˆ‘ä»¬æ„¿æ„ï¼Œæˆ‘ä»¬å¯ä»¥ç¨åä¿®å¤è¿™ä¸ªé—®é¢˜ã€‚

### 5.6: æ·»åŠ åˆ°æˆ‘ä»¬çš„ `CI` è„šæœ¬

å°† `check-exports` è„šæœ¬æ·»åŠ åˆ°ä½ çš„ `package.json` ä¸­çš„ `ci` è„šæœ¬é‡Œï¼š

```ts
{
  "scripts": {
    "ci": "npm run build && npm run check-format && npm run check-exports"
  }
}
```

## 6: ä½¿ç”¨ `tsup` æ¥åŒé‡å‘å¸ƒ

å¦‚æœä½ æƒ³åŒæ—¶å‘å¸ƒ CJS å’Œ ESM ä»£ç ï¼Œä½ å¯ä»¥ä½¿ç”¨ `tsup`ã€‚è¿™æ˜¯ä¸€ä¸ªåŸºäº `esbuild` æ„å»ºçš„å·¥å…·ï¼Œå¯ä»¥å°†ä½ çš„ TypeScript ä»£ç ç¼–è¯‘æˆè¿™ä¸¤ç§æ ¼å¼ã€‚

æˆ‘çš„ä¸ªäººå»ºè®®æ˜¯è·³è¿‡è¿™ä¸€æ­¥ï¼Œåªå‘å¸ƒ ES æ¨¡å—ã€‚è¿™ä¼šè®©ä½ çš„è®¾ç½®æ›´ç®€å•ï¼Œé¿å…äº†åŒé‡å‘å¸ƒçš„è®¸å¤šé™·é˜±ï¼Œæ¯”å¦‚ [åŒé‡åŒ…è£¹å±å®³](https://github.com/GeoffreyBooth/dual-package-hazard)ã€‚

ä½†å¦‚æœä½ æƒ³çš„è¯ï¼Œç»§ç»­ã€‚

### 6.1: å®‰è£… `tsup`

æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å®‰è£… `tsup`ï¼š

```ts
npm install --save-dev tsup
```

### 6.2: åˆ›å»ºä¸€ä¸ª `tsup.config.ts` æ–‡ä»¶

åˆ›å»ºä¸€ä¸ª `tsup.config.ts` æ–‡ä»¶ï¼Œå¹¶å¡«å…¥ä»¥ä¸‹å†…å®¹ï¼š

```ts
import { defineConfig } from "tsup";

export default defineConfig({
  entryPoints: ["src/index.ts"],
  format: ["cjs", "esm"],
  dts: true,
  outDir: "dist",
  clean: true,
});
```

*   `entryPoints` æ˜¯ä¸€ä¸ªå…¥å£ç‚¹æ•°ç»„ï¼Œå¯¹äºä½ çš„åŒ…ã€‚åœ¨è¿™ä¸ªæ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ `src/index.ts`ã€‚
*   `format` æ˜¯è¦è¾“å‡ºæ ¼å¼çš„æ•°ç»„ã€‚æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ `cjs`ï¼ˆCommonJSï¼‰å’Œ `esm`ï¼ˆECMAScript æ¨¡å—ï¼‰ã€‚
*   `dts` æ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œå‘Šè¯‰ `tsup` ç”Ÿæˆå£°æ˜æ–‡ä»¶ã€‚
*   `outDir` æ˜¯ç¼–è¯‘ä»£ç çš„è¾“å‡ºç›®å½•ã€‚
*   `clean` å‘Šè¯‰ `tsup` åœ¨æ„å»ºä¹‹å‰æ¸…ç©ºè¾“å‡ºç›®å½•ã€‚

### 6.3: æ›´æ”¹ `build` è„šæœ¬

åœ¨ä½ çš„ `package.json` ä¸­ï¼Œå°† `build` è„šæœ¬æ›´æ”¹ä¸ºä»¥ä¸‹å†…å®¹ï¼š

```ts
{
  "scripts": {
    "build": "tsup"
  }
}
```

ç°åœ¨ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ `tsup` æ¥ç¼–è¯‘æˆ‘ä»¬çš„ä»£ç ï¼Œè€Œä¸æ˜¯ `tsc`ã€‚

### 6.4: æ·»åŠ ä¸€ä¸ª `exports` å­—æ®µ

åœ¨ä½ çš„ `package.json` ä¸­æ·»åŠ ä¸€ä¸ª `exports` å­—æ®µï¼Œå¹¶å¡«å…¥ä»¥ä¸‹å†…å®¹ï¼š

```ts
{
  "exports": {
    "./package.json": "./package.json",
    ".": {
      "import": "./dist/index.js",
      "default": "./dist/index.cjs"
    }
  }
}
```

`exports` å­—æ®µå‘Šè¯‰ä½¿ç”¨ä½ çš„åŒ…çš„ç¨‹åºå¦‚ä½•æ‰¾åˆ° CJS å’Œ ESM ç‰ˆæœ¬çš„ä½ çš„åŒ…ã€‚åœ¨è¿™ä¸ªæ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬æŒ‡å¼•ä½¿ç”¨ `import` çš„äººåˆ° `dist/index.js`ï¼Œä½¿ç”¨ `require` çš„äººåˆ° `dist/index.cjs`ã€‚

è¿˜å»ºè®®å°† `./package.json` æ·»åŠ åˆ° `exports` å­—æ®µã€‚è¿™æ˜¯å› ä¸ºæŸäº›å·¥å…·éœ€è¦è½»æ¾è®¿é—®ä½ çš„ `package.json` æ–‡ä»¶ã€‚

### 6.5: å†æ¬¡å°è¯• `check-exports`

è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œæ£€æŸ¥ä½ çš„åŒ…çš„æ‰€æœ‰å¯¼å‡ºæ˜¯å¦æ­£ç¡®ï¼š

```ts
npm run check-exports
```

ç°åœ¨ï¼Œä¸€åˆ‡éƒ½æ˜¯ç»¿è‰²çš„ï¼š

```ts
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   â”‚ "tt-package-demo" â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ node10            â”‚ ğŸŸ¢                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ node16 (from CJS) â”‚ ğŸŸ¢ (CJS)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ node16 (from ESM) â”‚ ğŸŸ¢ (ESM)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ bundler           â”‚ ğŸŸ¢                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.6ï¼šå°† TypeScript å˜ä¸ºä¸€ä¸ª linter

æˆ‘ä»¬ä¸å†è¿è¡Œ `tsc` æ¥ç¼–è¯‘æˆ‘ä»¬çš„ä»£ç ã€‚å¹¶ä¸” `tsup` å®é™…ä¸Šå¹¶ä¸æ£€æŸ¥æˆ‘ä»¬çš„ä»£ç ä¸­æ˜¯å¦æœ‰é”™è¯¯ - å®ƒåªæ˜¯å°†å…¶è½¬æ¢ä¸º JavaScriptã€‚

è¿™æ„å‘³ç€å¦‚æœæˆ‘ä»¬çš„ä»£ç ä¸­æœ‰ TypeScript é”™è¯¯ï¼Œæˆ‘ä»¬çš„ `ci` è„šæœ¬ä¸ä¼šæŠ¥é”™ã€‚å“å‘€ã€‚

è®©æˆ‘ä»¬æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

#### 6.6.1ï¼šåœ¨ `tsconfig.json` ä¸­æ·»åŠ  `noEmit`

åœ¨ä½ çš„ `tsconfig.json` ä¸­æ·»åŠ ä¸€ä¸ª `noEmit` å­—æ®µï¼š

```ts
{
  "compilerOptions": {
    // ...å…¶ä»–é€‰é¡¹
    "noEmit": true
  }
}
```

#### 6.6.2ï¼šä» `tsconfig.json` ä¸­ç§»é™¤æœªä½¿ç”¨çš„å­—æ®µ

ä»ä½ çš„ `tsconfig.json` ä¸­ç§»é™¤ä»¥ä¸‹å­—æ®µï¼š

*   `outDir`
*   `rootDir`
*   `sourceMap`
*   `declaration`
*   `declarationMap`

åœ¨æˆ‘ä»¬æ–°çš„ â€˜lintingâ€™ è®¾ç½®ä¸­ï¼Œè¿™äº›å­—æ®µä¸å†éœ€è¦ã€‚

#### 6.6.3ï¼šå°† `module` æ”¹ä¸º `Preserve`

å¦‚æœä½ æ„¿æ„ï¼Œä½ ç°åœ¨å¯ä»¥åœ¨ä½ çš„ `tsconfig.json` ä¸­å°† `module` æ”¹ä¸º `Preserve`ï¼š

```ts
{
  "compilerOptions": {
    // ...å…¶ä»–é€‰é¡¹
    "module": "Preserve"
  }
}
```

è¿™æ„å‘³ç€ä½ ä¸å†éœ€è¦ç”¨ `.js` æ‰©å±•åæ¥å¯¼å…¥ä½ çš„æ–‡ä»¶ã€‚è¿™æ„å‘³ç€ `index.ts` å¯ä»¥è¿™æ ·å†™ï¼š

```ts
export * from "./utils";
```

#### 6.6.4ï¼šæ·»åŠ ä¸€ä¸ª `lint` è„šæœ¬

åœ¨ä½ çš„ `package.json` ä¸­æ·»åŠ ä¸€ä¸ª `lint` è„šæœ¬ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```ts
{
  "scripts": {
    "lint": "tsc"
  }
}
```

è¿™å°†è¿è¡Œ TypeScript ä½œä¸ºä¸€ä¸ª linterã€‚

#### 6.6.5ï¼šå°† `lint` æ·»åŠ åˆ°ä½ çš„ `ci` è„šæœ¬

åœ¨ä½ çš„ `package.json` ä¸­ï¼Œå°† `lint` è„šæœ¬æ·»åŠ åˆ°ä½ çš„ `ci` è„šæœ¬ï¼š

```ts
{
  "scripts": {
    "ci": "npm run build && npm run check-format && npm run check-exports && npm run lint"
  }
}
```

ç°åœ¨ï¼ŒTypeScript é”™è¯¯å°†ä½œä¸ºæˆ‘ä»¬ CI æµç¨‹çš„ä¸€éƒ¨åˆ†ã€‚

## 7ï¼šä½¿ç”¨ Vitest è¿›è¡Œæµ‹è¯•

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å®‰è£… `vitest`ï¼Œåˆ›å»ºä¸€ä¸ªæµ‹è¯•ï¼Œè®¾ç½®ä¸€ä¸ª `test` è„šæœ¬ï¼Œè¿è¡Œ `test` è„šæœ¬ï¼Œè®¾ç½®ä¸€ä¸ª `dev` è„šæœ¬ï¼Œå¹¶å°† `test` è„šæœ¬æ·»åŠ åˆ°æˆ‘ä»¬çš„ `CI` è„šæœ¬ä¸­ã€‚

`vitest` æ˜¯ä¸€ä¸ªç”¨äº ESM å’Œ TypeScript çš„ç°ä»£æµ‹è¯•è¿è¡Œå™¨ã€‚å®ƒåƒ Jestï¼Œä½†æ›´å¥½ã€‚

### 7.1ï¼šå®‰è£… `vitest`

è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥å®‰è£… `vitest`ï¼š

```ts
npm install --save-dev vitest
```

### 7.2ï¼šåˆ›å»ºä¸€ä¸ªæµ‹è¯•

åœ¨ `src/utils.test.ts` æ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```ts
import { hello } from "./utils.js";
import { test, expect } from "vitest";

test("hello", () => {
  expect(hello("world")).toBe("Hello, world!");
});
```

è¿™æ˜¯ä¸€ä¸ªç®€å•çš„æµ‹è¯•ï¼Œç”¨æ¥æ£€æŸ¥ `hello` å‡½æ•°æ˜¯å¦è¿”å›æ­£ç¡®çš„å€¼ã€‚

### 7.3: è®¾ç½® `test` è„šæœ¬

åœ¨ä½ çš„ `package.json` ä¸­æ·»åŠ ä¸€ä¸ª `test` è„šæœ¬ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```ts
{
  "scripts": {
    "test": "vitest run"
  }
}
```

`vitest run` å°†è¿è¡Œä½ é¡¹ç›®ä¸­çš„æ‰€æœ‰æµ‹è¯•ä¸€æ¬¡ï¼Œä¸ä¼šè¿›è¡Œç›‘å¬ã€‚

### 7.4: è¿è¡Œ `test` è„šæœ¬

è¿è¡Œä»¥ä¸‹å‘½ä»¤ä»¥è¿è¡Œä½ çš„æµ‹è¯•ï¼š

```ts
npm run test
```

ä½ åº”è¯¥ä¼šçœ‹åˆ°ä»¥ä¸‹è¾“å‡ºï¼š

```ts
âœ“ src/utils.test.ts (1)
   âœ“ hello

 Test Files  1 passed (1)
      Tests  1 passed (1)
```

è¿™è¡¨æ˜ä½ çš„æµ‹è¯•æˆåŠŸé€šè¿‡äº†ã€‚

### 7.5: è®¾ç½® `dev` è„šæœ¬

ä¸€ä¸ªå¸¸è§çš„å·¥ä½œæµç¨‹æ˜¯åœ¨å¼€å‘æ—¶ä»¥ç›‘å¬æ¨¡å¼è¿è¡Œä½ çš„æµ‹è¯•ã€‚åœ¨ä½ çš„ `package.json` ä¸­æ·»åŠ ä¸€ä¸ª `dev` è„šæœ¬ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```ts
{
  "scripts": {
    "dev": "vitest"
  }
}
```

è¿™å°†ä»¥ç›‘å¬æ¨¡å¼è¿è¡Œä½ çš„æµ‹è¯•ã€‚

### 7.6: æ·»åŠ åˆ°æˆ‘ä»¬çš„ `CI` è„šæœ¬

å°† `test` è„šæœ¬æ·»åŠ åˆ°ä½ çš„ `ci` è„šæœ¬ä¸­ï¼Œä½äºä½ çš„ `package.json` ä¸­ï¼š

```ts
{
  "scripts": {
    "ci": "npm run build && npm run check-format && npm run check-exports && npm run lint && npm run test"
  }
}
```

## 8\. ä½¿ç”¨ GitHub Actions è®¾ç½®æˆ‘ä»¬çš„ CI

åœ¨è¿™ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ª GitHub Actions å·¥ä½œæµï¼Œè¿™ä¸ªå·¥ä½œæµä¼šåœ¨æ¯æ¬¡æäº¤å’Œæ‹‰å–è¯·æ±‚æ—¶è¿è¡Œæˆ‘ä»¬çš„ CI è¿‡ç¨‹ã€‚

è¿™æ˜¯ç¡®ä¿æˆ‘ä»¬çš„åŒ…å§‹ç»ˆå¤„äºå·¥ä½œçŠ¶æ€çš„å…³é”®æ­¥éª¤ã€‚

### 8.1: åˆ›å»ºæˆ‘ä»¬çš„å·¥ä½œæµ

åˆ›å»ºä¸€ä¸ª `.github/workflows/ci.yml` æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```ts
name: CI

on:
  pull_request:
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm install

      - name: Run CI
        run: npm run ci
```

è¿™ä¸ªæ–‡ä»¶æ˜¯ GitHub ç”¨æ¥æŒ‡å¯¼å¦‚ä½•è¿è¡Œä½ çš„ CI æµç¨‹çš„è¯´æ˜ã€‚

*   `name` æ˜¯å·¥ä½œæµçš„åç§°ã€‚
*   `on` æŒ‡å®šä½•æ—¶è¿è¡Œå·¥ä½œæµã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒåœ¨ pull requests å’Œæ¨é€åˆ° `main` åˆ†æ”¯æ—¶è¿è¡Œã€‚
*   `concurrency` ä½¿ç”¨ `cancel-in-progress` é˜²æ­¢å¤šä¸ªå·¥ä½œæµå®ä¾‹åŒæ—¶è¿è¡Œï¼Œä»¥å–æ¶ˆä»»ä½•ç°æœ‰è¿è¡Œã€‚
*   `jobs` æ˜¯è¦è¿è¡Œçš„ä¸€ç»„ä½œä¸šã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªåä¸º `ci` çš„ä½œä¸šã€‚
*   `actions/checkout@v4` ä»ä»“åº“æ£€å‡ºä»£ç ã€‚
*   `actions/setup-node@v4` è®¾ç½® Node.js å’Œ npmã€‚
*   `npm install` å®‰è£…é¡¹ç›®çš„ä¾èµ–é¡¹ã€‚
*   `npm run ci` è¿è¡Œé¡¹ç›®çš„ CI è„šæœ¬ã€‚

å¦‚æœæˆ‘ä»¬çš„ CI è¿‡ç¨‹ä¸­çš„ä»»ä½•éƒ¨åˆ†å¤±è´¥ï¼Œå·¥ä½œæµå°†å¤±è´¥ï¼ŒGitHub å°†é€šè¿‡åœ¨æˆ‘ä»¬çš„æäº¤æ—æ˜¾ç¤ºçº¢å‰æ¥é€šçŸ¥æˆ‘ä»¬ã€‚

### 8.2ï¼šæµ‹è¯•æˆ‘ä»¬çš„å·¥ä½œæµ

å°†ä½ çš„æ›´æ”¹æ¨é€åˆ° GitHub å¹¶æ£€æŸ¥ä½ çš„ä»“åº“ä¸­çš„ Actions æ ‡ç­¾ã€‚ä½ åº”è¯¥çœ‹åˆ°ä½ çš„å·¥ä½œæµæ­£åœ¨è¿è¡Œã€‚

è¿™å°†åœ¨æ¯æ¬¡å¯¹ä»“åº“è¿›è¡Œçš„æäº¤ä»¥åŠæ¯ä¸ª PR ä¸Šç»™æˆ‘ä»¬ä¸€ä¸ªè­¦å‘Šã€‚

## 9\. ä½¿ç”¨ Changesets å‘å¸ƒ

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å®‰è£… `@changesets/cli`ï¼Œåˆå§‹åŒ– Changesetsï¼Œå°† changeset å‘å¸ƒè®¾ç½®ä¸ºå…¬å¼€ï¼Œè®¾ç½® `commit` ä¸º `true`ï¼Œè®¾ç½®ä¸€ä¸ª `local-release` è„šæœ¬ï¼Œæ·»åŠ ä¸€ä¸ª changesetï¼Œæäº¤ä½ çš„æ›´æ”¹ï¼Œè¿è¡Œ `local-release` è„šæœ¬ï¼Œæœ€ååœ¨ npm ä¸Šçœ‹åˆ°ä½ çš„åŒ…ã€‚

Changesets æ˜¯ä¸€ä¸ªå¸®åŠ©ä½ å¯¹åŒ…è¿›è¡Œç‰ˆæœ¬æ§åˆ¶å’Œå‘å¸ƒçš„å·¥å…·ã€‚è¿™æ˜¯ä¸€ä¸ªæˆ‘æ¨èç»™ä»»ä½•å‘å¸ƒåŒ…åˆ° npm çš„äººçš„ä¸å¯æ€è®®çš„å·¥å…·ã€‚

### 9.1ï¼šå®‰è£… `@changesets/cli`

è¿è¡Œä»¥ä¸‹å‘½ä»¤ä»¥åˆå§‹åŒ– Changesetsï¼š

```ts
npm install --save-dev @changesets/cli
```

### 9.2ï¼šåˆå§‹åŒ– Changesets

è¿è¡Œä»¥ä¸‹å‘½ä»¤ä»¥åˆå§‹åŒ– Changesetsï¼š

```ts
npx changeset init
```

è¿™å°†åœ¨ä½ çš„é¡¹ç›®ä¸­åˆ›å»ºä¸€ä¸ª `.changeset` æ–‡ä»¶å¤¹ï¼ŒåŒ…å«ä¸€ä¸ª `config.json` æ–‡ä»¶ã€‚ä½ çš„ changesets ä¹Ÿå°†å­˜å‚¨åœ¨è¿™é‡Œã€‚

### 9.3ï¼šå°† changeset å‘å¸ƒè®¾ç½®ä¸ºå…¬å¼€

åœ¨ `.changeset/config.json` ä¸­ï¼Œå°† `access` å­—æ®µæ›´æ”¹ä¸º `public`ï¼š

```ts
// .changeset/config.json
{
  "access": "public"
}
```

å¦‚æœä¸æ›´æ”¹æ­¤å­—æ®µï¼Œ`changesets` å°†ä¸ä¼šå°†ä½ çš„åŒ…å‘å¸ƒåˆ° npmã€‚

### 9.4: å°† `commit` è®¾ä¸º `true`ï¼š

åœ¨ `.changeset/config.json` ä¸­ï¼Œå°† `commit` å­—æ®µæ”¹ä¸º `true`ï¼š

```ts
// .changeset/config.json
{
  "commit": true
}
```

è¿™å°†åœ¨ç‰ˆæœ¬åŒ–åå°†å˜æ›´é›†æäº¤åˆ°ä½ çš„ä»“åº“ã€‚

### 9.5: è®¾ç½®ä¸€ä¸ª `local-release` è„šæœ¬

åœ¨ä½ çš„ `package.json` ä¸­æ·»åŠ ä¸€ä¸ª `local-release` è„šæœ¬ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```ts
{
  "scripts": {
    "local-release": "changeset version && changeset publish"
  }
}
```

æ­¤è„šæœ¬å°†è¿è¡Œä½ çš„ CI æµç¨‹ï¼Œç„¶åå°†ä½ çš„åŒ…å‘å¸ƒåˆ° npmã€‚å½“ä½ æƒ³è¦ä»æœ¬åœ°æœºå™¨å‘å¸ƒåŒ…çš„æ–°ç‰ˆæœ¬æ—¶ï¼Œè¿™å°†æ˜¯ä½ è¿è¡Œçš„å‘½ä»¤ã€‚

### 9.6 åœ¨ `prepublishOnly` ä¸­è¿è¡Œ CI

åœ¨ä½ çš„ `package.json` ä¸­æ·»åŠ ä¸€ä¸ª `prepublishOnly` è„šæœ¬ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```ts
{
  "scripts": {
    "prepublishOnly": "npm run ci"
  }
}
```

è¿™å°†åœ¨å‘å¸ƒä½ çš„åŒ…åˆ° npm ä¹‹å‰è‡ªåŠ¨è¿è¡Œä½ çš„ CI æµç¨‹ã€‚

è¿™åœ¨ä¸ `local-release` è„šæœ¬åˆ†å¼€æ—¶å¾ˆæœ‰ç”¨ï¼Œä»¥é˜²ç”¨æˆ·åœ¨æ²¡æœ‰è¿è¡Œ `local-release` çš„æƒ…å†µä¸‹è¯¯è¿è¡Œ `npm publish`ã€‚æ„Ÿè°¢ [Jordan Harband](https://x.com/ljharb) çš„å»ºè®®ï¼

### 9.7: æ·»åŠ ä¸€ä¸ªå˜æ›´é›†

è¿è¡Œä»¥ä¸‹å‘½ä»¤æ·»åŠ ä¸€ä¸ªå˜æ›´é›†ï¼š

```ts
npx changeset
```

è¿™å°†æ‰“å¼€ä¸€ä¸ªäº¤äº’å¼æç¤ºï¼Œä½ å¯ä»¥åœ¨å…¶ä¸­æ·»åŠ ä¸€ä¸ªå˜æ›´é›†ã€‚å˜æ›´é›†æ˜¯ä¸€ç§å°†å˜æ›´åˆ†ç»„åœ¨ä¸€èµ·å¹¶ç»™å®ƒä»¬ä¸€ä¸ªç‰ˆæœ¬å·çš„æ–¹å¼ã€‚

å°†æ­¤æ¬¡å‘å¸ƒæ ‡è®°ä¸ºä¸€ä¸ª `patch` å‘å¸ƒï¼Œå¹¶ç»™å®ƒä¸€ä¸ªæè¿°ï¼Œå¦‚ â€œåˆå§‹å‘å¸ƒâ€ã€‚

è¿™å°†åœ¨ `.changeset` æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ªå¸¦æœ‰å˜æ›´é›†çš„æ–°æ–‡ä»¶ã€‚

### 9.8: æäº¤ä½ çš„æ›´æ”¹

å°†æ›´æ”¹æäº¤åˆ°ä½ çš„ä»“åº“ï¼š

```ts
git add .
git commit -m "Prepare for initial release"
```

### 9.9: è¿è¡Œ `local-release` è„šæœ¬

è¿è¡Œä»¥ä¸‹å‘½ä»¤å‘å¸ƒä½ çš„åŒ…ï¼š

```ts
npm run local-release
```

è¿™å°†è¿è¡Œä½ çš„ CI æµç¨‹ï¼Œä¸ºä½ çš„åŒ…ç‰ˆæœ¬åŒ–ï¼Œå¹¶å°†å…¶å‘å¸ƒåˆ° npmã€‚

å®ƒå°†åœ¨ä½ çš„ä»“åº“ä¸­åˆ›å»ºä¸€ä¸ª `CHANGELOG.md` æ–‡ä»¶ï¼Œè¯¦ç»†è®°å½•äº†æ­¤æ¬¡å‘å¸ƒçš„æ›´æ”¹ã€‚æ¯æ¬¡å‘å¸ƒæ—¶éƒ½ä¼šæ›´æ–°è¿™ä¸ªæ–‡ä»¶ã€‚

### 9.10ï¼šåœ¨ npm ä¸ŠæŸ¥çœ‹ä½ çš„åŒ…

å‰å¾€ï¼š

```ts
http://npmjs.com/package/<ä½ çš„åŒ…å>
```

ä½ åº”è¯¥èƒ½åœ¨é‚£é‡Œçœ‹åˆ°ä½ çš„åŒ…ï¼ä½ åšåˆ°äº†ï¼ä½ å·²ç»å‘å¸ƒåˆ°äº† npmï¼

## æ€»ç»“

ä½ ç°åœ¨æ‹¥æœ‰äº†ä¸€ä¸ªå®Œå…¨è®¾ç½®å¥½çš„åŒ…ã€‚ä½ å·²ç»è®¾ç½®äº†ï¼š

*   ä¸€ä¸ªå¸¦æœ‰æœ€æ–°è®¾ç½®çš„ TypeScript é¡¹ç›®
*   Prettierï¼Œå®ƒæ—¢æ ¼å¼åŒ–ä½ çš„ä»£ç ï¼Œä¹Ÿæ£€æŸ¥ä»£ç æ ¼å¼æ˜¯å¦æ­£ç¡®
*   `@arethetypeswrong/cli`ï¼Œå®ƒæ£€æŸ¥ä½ çš„åŒ…å¯¼å‡ºæ˜¯å¦æ­£ç¡®
*   `tsup`ï¼Œå®ƒå°†ä½ çš„ TypeScript ä»£ç ç¼–è¯‘ä¸º JavaScript
*   `vitest`ï¼Œå®ƒè¿è¡Œä½ çš„æµ‹è¯•
*   GitHub Actionsï¼Œå®ƒè¿è¡Œä½ çš„ CI æµç¨‹
*   Changesetsï¼Œå®ƒå¯¹ä½ çš„åŒ…è¿›è¡Œç‰ˆæœ¬æ§åˆ¶å’Œå‘å¸ƒ

è¿›ä¸€æ­¥é˜…è¯»ï¼Œæˆ‘å»ºè®®è®¾ç½® [Changesets GitHub action](https://github.com/changesets/action) å’Œ [PR æœºå™¨äºº](https://github.com/changesets/bot) æ¥è‡ªåŠ¨æ¨èè´¡çŒ®è€…åœ¨ä»–ä»¬çš„ PR ä¸­æ·»åŠ å˜æ›´é›†ã€‚å®ƒä»¬éƒ½éå¸¸å‡ºè‰²ã€‚

å¦‚æœä½ è¿˜æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·å‘Šè¯‰æˆ‘ï¼
