---
title: "53 - 《如何在 CJS 中使用 Pure ESM 依赖》"
date: 2022-02-14
url: https://sorrycc.com/cjs-pure-esm
---

发布于 2022年2月14日

# 53 - 《如何在 CJS 中使用 Pure ESM 依赖》

背景是现在社区有越来越多的 Pure ESM 包，比如 chalk、globby 等 sindresorhus 维护的包，以及 mdx 和 remark 系列，而出于一些原因，比如 require.extensions 在 esm 中没有等价实现，编写工具或框架时不能直接切到 esm，只能用 cjs。所以，摆在面前的问题就是 CJS 中如何使用 Pure ESM 包。

解法 1 是把 `require('foo')` 改成 `await import('foo')`。但有几个问题。1）同步变异步，需注意使用场景是否支持异步，2）jest 不支持 cjs 中引入 esm，所以无法做测试，3）和 v8-compile-cache 冲突，4）如果用 tsc 做文件转换，原生不支持，需用 inclusion 或用 workaround 的写法，`eval('import("foo")') as Promise<typeof import('foo')>`，详见 [issue](https://github.com/microsoft/TypeScript/issues/43329)。

解法 2 是做依赖预打包，不管依赖是 cjs、esm + cjs 还是 pure esm，统统打成 cjs。工具可以用 `@vercel/ncc`，但注意 ncc 遇到 `type: 'module'` 的库会自动切换到 esm 模式，需要 patch 下，参考 [https://github.com/umijs/umi-next/blob/21fcc6f6305251dba639c70946b144d705464498/scripts/postinstall.ts#L16-L18](https://github.com/umijs/umi-next/blob/21fcc6f6305251dba639c70946b144d705464498/scripts/postinstall.ts#L16-L18) 。

依赖预打包真是包治百病，我是把解法 1 的坑全踩了一遍后切换到解法 2。
