---
title: "126 - 《一个 CD 构建提速方案》"
date: 2022-06-01
url: https://sorrycc.com/cd-speedup
---

发布于 2022年6月1日

# 126 - 《一个 CD 构建提速方案》

基于 Umi 的蚂蚁内网框架 Bigfish 最近上线了一个新功能，可以让 CD（持续部署）时的项目构建提速 10 倍，从图 1 到 图 2，构建时间从 106.6s 减少到 10.3s。但背后的原理却是如此简单，欢迎有此困扰的同学们自行尝试。

![](https://img.alicdn.com/imgextra/i4/O1CN01Mv7JmC1PIgyHwuNKu_!!6000000001818-2-tps-2334-496.png)

![](https://img.alicdn.com/imgextra/i4/O1CN01mppeSs1Bwcst1zZcQ_!!6000000000010-2-tps-2334-498.png)

这个方案去年在蚂蚁的另一个框架中已经试验过，但由于一些原因下了，可能是缓存失效控制的问题？今年 Bigfish 的新版本也实现了这个，坑不踩过是不知道有多深的，哈哈。

怎么做到的？没有升级机器，没有上 esbuild，也没有切 Vite（Vite 虽然 dev 快，但在 build 时依旧慢，甚至比 webpack 更慢），也不是 MFSU，只是利用了 Webpack 5 缓存。Webpack 5 缓存通常大家都是在本地使用，但其实也可以和流程结合。方法是，构建前下载缓存，构建够上传缓存。

```diff
- 构建
+ 下载缓存 ➡ 构建 ➡ 上传缓存
```

CI & CD 流程中利用缓存其实不少见，比如 Github CI 中通常会做 node\_modules 的缓存。

缓存很重要的一点是 invalidate（失效）处理。Github CI 中 node\_modules 缓存的 invalidate 基于各个 lock 文件的 hash 结果；webpack 5 缓存的 invalidate 是 webpack 内部控制的，支持增量，外部控制好 buildDependencies 就能控制好 invalidate 的时机。

试验下来还有一点是，只要 package.json 中的依赖有变更，webpack 5 缓存就会失效。基于此，我们将缓存控制在一个迭代内，因为通常一个迭代内变更依赖的几率是相对较低，从而有更好的提速效果。
