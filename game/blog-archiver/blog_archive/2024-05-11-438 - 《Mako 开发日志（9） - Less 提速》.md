---
title: "438 - 《Mako 开发日志（9） - Less 提速》"
date: 2024-05-11
url: https://sorrycc.com/mako-devlog-09
---

发布于 2024年5月11日

# 438 - 《Mako 开发日志（9） - Less 提速》

> 注：Less 提速方案由团队同学 @无玄 发起和实现。

1、由于历史原因，蚂蚁的中台和无线项目都在大量使用 Less。虽然 Mako 基于 Rust 重新实现了构建工具，但 Less 并无 Native 实现，这意味着他只能跑在 Node 下。基于 [木桶原理](https://wiki.mbalib.com/zh-tw/%E6%9C%A8%E6%A1%B6%E5%8E%9F%E7%90%86)，Less 很可能会成为我们构建最慢的一环。

2、我们也曾想过用 Rust 重写，rfc 写完后，发现 Less 有一些进阶用法，比如支持在 Less 里使用 js 表达式，这意味着需要在 Rust 里支持 js 表达式，难度一下子上去了。而 antd 用 less 用了大量 less 的高级功能，我们不可能先搞个简单的版本，然后慢慢迭代。所以，出于 ROI 考虑，暂时放弃。

3、我们最终的方案是在 Node 侧利用 worker 提速。因为 Less 编译是无状态的，没有上下文和复杂的数据结构传递，所以放 worker 里做应该是比较合适的，不清楚为啥之前 webpack 的优化方案里没这么做。先看效果，我组织了一个大量 Less 文件的仓库，和 Rust 构建器竞品的 Benchmark 对比如下。

![](https://res.cloudinary.com/sorrycc/image/upload/v1715149825/blog/him5ls7i.png)

4、实现上借助了 [workerpool](https://github.com/josdejong/workerpool) 这个库，让 worker 的调用简单了很多。

```ts
// main thread
import workerpool from 'workerpool';
let pool;
export function compile(filePath) {
  if (!pool) {
    pool = workerpool.pool('/path/to/worker.js');
  }
  let css = await pool.exec('render', [filePath]);
}

// worker.js
import workerpool from 'workerpool';
import less from 'less';
workerpool.worker({
  render(filePath) {
    return (await less.render(input, opts)).css;
  }
});
```

5、说下遇到的问题和限制。

1）传值限制，比如 less 支持 plugin，其 plugin 可以是函数，使用这种方式就不能支持传函数，只能传路径和参数，然后在 worker 里 require 使用。

2）Node 20.3 以下的版本在 Linux 环境上（比如我们内部的 Cloud IDE 和 CD 平台）会有几率退出，疑是 NodeJS Bug，worker 退出导致主进程也退出了，解法是在 Linux + Node 20.3 以下不开，并引导用户升级 Node 版本。

![](https://res.cloudinary.com/sorrycc/image/upload/v1715414189/blog/5uvj2h2r.png)
