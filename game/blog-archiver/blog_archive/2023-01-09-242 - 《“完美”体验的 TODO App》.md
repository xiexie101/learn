---
title: "242 - 《“完美”体验的 TODO App》"
date: 2023-01-09
url: https://sorrycc.com/todo-app
---

发布于 2023年1月9日

# 242 - 《“完美”体验的 TODO App》

1、为了验证 React Query 的功能，我手写了一个 Todo App，数据来自远程服务群，总共花了 5h 左右，手生的很，感觉重新写一遍应该 2h 以内就能完成。地址是 [https://todos.sorrycc.com/](https://todos.sorrycc.com/) 。本地数据的 Todo App 好做，而远程数据的 Todo App 还是要耗费一些精力的。我希望把体验做地尽可能完美，但时间有限，先到这步吧，在此整理下我的收获。

2、为了让数据体验尽可能真实，先是花了点时间搭数据，用的 Headless CMS strapi，部署在 Google App Engine 上，建了 Todo Collection，设为公开访问，并通过 [updown.io](http://updown.io) 5 分钟访问一次保活。可通过 [https://strapi-373300.df.r.appspot.com/api/todos](https://strapi-373300.df.r.appspot.com/api/todos) 以 restful api 的方式做 todos 的增删改查。

Todo 的接口如下，如果有 Todo Demo App 的需要，可直接用这个接口。

```ts
// 查询
GET https://strapi-373300.df.r.appspot.com/api/todos
// 添加
POST https://strapi-373300.df.r.appspot.com/api/todos
{
  "data": {"name": "hahaha"}
}
// 修改
PUT https://strapi-373300.df.r.appspot.com/api/todos/2
{
  "data": {"name": "abcd"}
}
// 删除
DELETE https://strapi-373300.df.r.appspot.com/api/todos/2
```

3、前端技术栈是 umi（框架） + @tanstack/query（请求方案） + axios（请求库） + styled-components（样式方案） + valtio（数据流方案），icons 之前用的 react-icons，umi 新 icons 方案出来后就切过去了，整理研发体验非常流畅。

4、完美体验的 Todo App 应该是怎么样？我觉得虽然数据是远程，但体验也要像本地 App。包括要做更新 Todo 时要做乐观更新、不阻断操作的 loading 处理、错误时做数据回退或消息提醒、在更新数据时做必要的表单 disable 以避免短时数据丢失、数据没有变化时减少不必要的更新请求、请求废弃时利用 signal 取消请求以减少服务端消耗、等等。

5、如何利用 React Query 做乐观更新？参考 [https://tanstack.com/query/v4/docs/react/guides/optimistic-updates](https://tanstack.com/query/v4/docs/react/guides/optimistic-updates) 。

```ts
const queryClient = useQueryClient();
const xxxMutation = useMutation({
  // 发 put 请求到服务器
  mutationFn,
  // 两件事，1）突变 queryClient 本地缓存，2）返回前一次的数据
  onMutate,
  // 失败时，用前一次的数据更新 queryClient 缓存
  onError,
  // 失败或成功时，都重新请求查询接口更新数据
  onSettled,
});
```

6、valtio 数据流用在何处？我的理解是在需要通过 props 来回传数据的时候就可以用 valtio，比如选中的 Filter 类型、当前打开的 Todo Id 等。需要注意的是，不要用来存通过 useQuery() 拿回来的远程数据，会导致 React Query 内部的渲染优化失效。
