---
title: "108 - 《极简的扁平结构约定式路由》"
date: 2022-05-06
url: https://sorrycc.com/flat-conventional-route
---

发布于 2022年5月6日

# 108 - 《极简的扁平结构约定式路由》

约定式路由即文件路由，是现在前端框架的标配，next.js、nuxt.js、remix、umi 等都有实现，规则大同小异。比如 pages 目录下包含 a.js 和 b.js，就会生成 /a 和 /b 的路由。

约定式路由的好处是不用再通过配置的方式定义路由，但也有缺点，其中较大的一个是不能在一个地方看到所有路由（这是配置式路由的优点）。大家可能会想到在 pages 目录下执行 tree 看目录树，能看个大概，但结果上会有不少无关的干扰，比如 css 文件和 components 文件等。

之前有看到 [jamiebuilds](https://github.com/jamiebuilds) 提议的[扁平式约定式路由](https://gist.github.com/jamiebuilds/86d467ee4353cb316edce8e69ad19237)能解这个问题。jamiebuilds 是 react-loadable、unstated 等库的作者，还和 sebmck 一起搞了 babel 和 rome，曾经是 rome 的合伙人但后来退出了。

这个方案举个例子。比如，

```bash
users./Users.route.jsx
users.index/UsersIndex.route.jsx
users.$id.posts/UsersIdPosts.route.jsx
```

以上文件结构会被翻译成以下路由结构。

```
/users (users./Users.route.jsx)
  /users (users.index/UsersIndex.route.jsx)
  /users/:id/posts (users.$id.posts/UsersIdPosts.route.jsx)
```

一些特点，

1、一个目录下即可看全所有路由  
2、用 `*.route.*` 作为唯一路由文件，方便在目录下随意组织其他文件  
3、用 . 当 / 来分割路由  
4、用 . 结尾即 layout 路由，比如 users.  
5、用 $ 前缀表示动态路由  
6、用 $ 后缀表示 splat 路由  
7、用 \_ 作为 Flag，用于在兄弟路由之间使用不同的 layout  
8、index 会被替换为空，作为索引路由

刚看到时我就准备在 umi 中实现的，然后周会上讨论后被大家拦住，因为觉得优先级不高并且优势不明显。但是我个人非常喜欢这个方案，所以在实现「手写 Umi 课程」时，直接把他做成了默认路由方案。

实现方案比嵌套目录的简单多了，代码见 [https://gist.github.com/sorrycc/09fdc9130489c135041b47823dbdea56，仅](https://gist.github.com/sorrycc/09fdc9130489c135041b47823dbdea56%EF%BC%8C%E4%BB%85) 74 行，主要目的是产出以 id 为 key 的路由表（Record<id, Route>）。比如上面的示例结果如下，

```ts
{
  'users.':         { id, file, path: '/users' },
  'users.index':    { id, file, path: '/users', parentId: 'users.' },
  'users.$id.posts': { id, file, path: '/users/:id/posts', parentId: 'users.' },
}
```

实现步骤，

1、先用 fast-glob 匹配 `**/*.route.jsx` 找到所有路由文件  
2、基于路由文件分析出所有路由  
3、id 转 path 规则清楚了其实比较简单，支持各种高级的路由功能  
4、针对路由 id 有个 byLongestFirst 的排序操作，留给后续关联 parentId 用，因为长 id 路由肯定不是短 id 路由的 layout  
5、最后要关联 parentId，即决定哪个是另一个的 layout（父）路由，找到所有 layout 路由，然后逐个给匹配上但没 parentId 的路由设置 parentId，即可完成关联

上面的这份结果最终需要经过渲染才能产出。所以，这篇并不是路由实现的全部，仅包含路由的分析（编译）阶段。要让路由能跑，还需要一个运行时的渲染器。渲染器会在后续的文章中完成，心机的朋友可以看 umi-next 仓库下的 renderer-react 包的实现。

![](https://img.alicdn.com/imgextra/i4/O1CN01ZFx1HR291icKsAijM_!!6000000008008-0-tps-476-512.jpg)
