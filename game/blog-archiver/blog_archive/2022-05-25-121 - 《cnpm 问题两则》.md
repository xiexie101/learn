---
title: "121 - 《cnpm 问题两则》"
date: 2022-05-25
url: https://sorrycc.com/two-cnpm-problems
---

发布于 2022年5月25日

# 121 - 《cnpm 问题两则》

> 对内发的，这里把 tnpm 全量替换成 cnpm 一样适用。

以下问题在 pnpm 下不会存在，cnpm 加油。另外，要是 cnpm 能引入 pnpm mode 开放给开发者选择就更好了。

1、cnpm i 不稳

找个空目录，

```bash
node@16.10.0
darwin arm64 21.4.0
$ cnpm i umi@4.0.0-rc.18
$ npx umi g page index
$ umi dev
```

一切正常。

然后修改 package.json 中的 umi 版本到 4.0.0-rc.19，

```diff
- "umi": "^4.0.0-rc.18"
+ "umi": "^4.0.0-rc.19"
```

执行 `cnpm i`，很快结束了，但感觉不对。

再执行 `npx umi dev`，报错，

```
fatal - TypeError: The 'compilation' argument must be an instance of Compilation
  at Function.getCompilationHooks (/private/tmp/sorrycc-pJQsGL/node_modules/_@umijs_bundler-webpack@4.0.0-rc.19@@umijs/bundler-webpack/compiled/webpack/index.js:83489:10)
  at /private/tmp/sorrycc-pJQsGL/node_modules/_@umijs_bundler-webpack@4.0.0-rc.19@@umijs/bundler-webpack/compiled/webpack/index.js:77235:18
  at Hook.eval [as call] (eval at create (/private/tmp/sorrycc-pJQsGL/node_modules/_@umijs_bundler-utils@4.0.0-rc.18@@umijs/bundler-utils/compiled/tapable/index.js:1:7460), <anonymous>:206:1)
  ...
```

2、hoist 依赖让项目未来随时会挂

而且不是编译时挂，而是运行时挂，可能上线后才会发现。

上午排查问题时发现的，目标项目使用了没有在 package.json 中声明的依赖。项目是 industryprod/csOperationCenter ，项目中依赖了没有在 package.json 中声明的 lodash 和 moment。这些由于被 hoist 到 node\_modules 根目录，所以正常情况下不会被发现。

但这是个随时会爆的雷。什么时候会爆？比如之前任何一盒依赖了 lodash 的库升级了 lodash 大版本，引入 break change，或者有一个库依赖了 lodash 的小版本，都可能会挂。（lodash 就是举个例子，他相对稳定，出现问题的概率比较低。其他依赖就不一定了。）

我觉得这么用的项目不在少数。

此问题在框架层（比如 Umi）也能解。但是，1）会有额外的消耗（比较小），2）每个构建相关的框架和工具都得做一遍（当然也可以做在流程里，但时机太晚）3）除构建之外，还有其他 hoist 问题，导致「现在跑的好好的，未来不知怎么就挂了」。
