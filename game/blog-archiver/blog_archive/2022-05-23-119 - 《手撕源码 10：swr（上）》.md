---
title: "119 - 《手撕源码 10：swr（上）》"
date: 2022-05-23
url: https://sorrycc.com/source-10-swr
---

发布于 2022年5月23日

# 119 - 《手撕源码 10：swr（上）》

[https://swr.vercel.app/](https://swr.vercel.app/)

swr 取名字 stale-while-revalidate，一种 [HTTP RFC 5861](https://tools.ietf.org/html/rfc5861) 里包含的缓存失效策略。这种策略会先用缓存的过期的数据，再发请求验证，最后得到最新数据。这种策略的好处是 UI 可以保持快速响应，因为会不断、自动地获取最新数据。

基本示例如下。

```tsx
const { data, error } = useSWR(key, fetcher, config);  
if (error) return <div>failed to load</div>;  
if (!data) return <div>loading…</div>;  
return <div>hello {data.name}!</div>
```

但是要注意的是，swr 是有适用场景，当数据是需要经常更新时才用。比如比赛实况、订单跟踪，可以 5s revalidate 一次；比如 Feed 类、粘贴簿、新闻，可以 30s-60s revalidate 一次；比如天气、新冠数据这类被动数据更新，用户通常会在背景页保留，不需要定期 revalidate，但用户 Focus Tab 或重新联网后需要 revalidate 一次；比如小块数据的更新像 YouTube 的订阅按钮、Github 的 Star 按钮，点了之后会希望看到自己对此的贡献，也要 revalidate。

而不适用的场景是数据不变化或很少变化的场景，这是用 swr 反而会造成网络阻塞和对于用户流量的不必要消耗。

swr 作者是 [ShuDing](https://github.com/shuding)，目前在 vercel，其他作品还有 tilg、nextra、cobe 等。swr Star 数 22K，周下载 556K。目前版本 2 Beta 中，swr 2 包含 Mutation hook、Improved concurrent UI、Keep previous result、DevTools 等新特性，值得关注。我也是看到 swr 2，才决定翻翻他的源码，相比 swr 刚发版时，已经复杂好多了，源码目录上分了 core、immutable、infinite、mutation 和 `_internal`，可以看出一个基本的功能概况。

工程化方面基于 yarn + prettier + tsc + eslint + jest + bunchee + npm-run-all。源码打包基于 [bunchee](https://github.com/huozhi/bunchee)（Star 144）；jest 中对于 ts 和 js 的 transform 基于 @swc/jest，用于提速；[文档](https://github.com/vercel/swr-site)基于自研的 [nextra](https://github.com/shuding/nextra)（Star 3.5K）。

关于 swr 的实现，我在看之前整理了一些问题。

1、如何实现缓存？  
2、如何做「指数退避算法」重发请求？  
4、如何做 mutate？  
5、如何做基于 hooks 的自动依赖处理和并发优先？  
6、如何做 suspense 支持？Suspense 模式下，无需校验 data 是否为 undefined  
7、SWRConfig 如何实现嵌套，以及 use 值是如何 merge 的？  
8、如何实现中间件？或者说如何实现不区分请求库的中间件？  
9、如何做 Keep previous result？

然后看完之后我整理了一个 [toy-swr](https://gist.github.com/sorrycc/74024efed3284121ae7dce0a3fa57bdf)。119 行代码实现一个极简的 swr，功能包含基础请求调用、错误处理、stale-while-revalidate、缓存、窗口 focus 时的 revalidate。

上面的问题只看了 1、7、8，剩下的还没有看，避免时间拖太长先收个尾。所以预计还会有个「下篇」，也欢迎知道答案的朋友们告诉我。

最后，有个看源码的技巧是，swr 2 功能更多，所以相对比较复杂，有些问题在 swr 1 就有了，所以想知道答案又时间紧的话，可以看 swr 1 的实现。

参考：  
[https://github.com/vercel/swr](https://github.com/vercel/swr)  
[https://swr.vercel.app/](https://swr.vercel.app/)  
[https://www.smashingmagazine.com/2021/09/useswr-react-hook-library-incremental-static-regeneration-nextjs/](https://www.smashingmagazine.com/2021/09/useswr-react-hook-library-incremental-static-regeneration-nextjs/)
