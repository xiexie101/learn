---
title: "359 - 《如何写工程化辅助脚本》"
date: 2023-10-25
url: https://sorrycc.com/how-to-write-script
---

发布于 2023年10月25日

# 359 - 《如何写工程化辅助脚本》

> 本文写作是先用 iOS 17 的听写功能完成初稿，然后在电脑上化 10 分钟做微调。

1、背景是这段时间为 Mako 的工程化写了不少脚本，比如其中一个脚本的功能是去拉 1900 多个内部的 Bigfish 项目，然后自动验证 mako 构建的可行性。我们先是手动验证了几十个项目，然后我发现很多步骤都是重复的，于是就梳理了一个脚本来做这件事情。脚本是提高效率的好工具，一旦把标准的流程梳理清楚，就可以把它转化成脚本，交给电脑去自动运行。昨天一位同事说他验证了三个项目，我说我验证了两百多个项目。

2、这个脚本虽然只有几百行代码，初始实现也很快，但是修修改改加测试也用了几天才比较完善。所以我在想有没有办法，一开始就写的很完善，所以就整理了一些中间遇到的坑以及心得，希望在下次写脚本的时候能够一步到位。

3、很多的时间都是花在异常场景的处理上，可能有 10 多个异常场景，都是一开始没有考虑到的。遇到一个问题脚本中断，然后排查问题、修复脚本、重新执行这个流程，浪费了不少时间。这些场景包括网络情况、权限验证、超时问题、磁盘空间不足问题，输入 URL 的格式问题，项目框架的版本号问题。由于我们内部项目的多样性，所有可能出现问题的地方最终都出了问题。所以感觉这类型的脚本一开始就不能信任所有的输入，此外，还得考虑环境的各种异常。比如网络、磁盘空间、权限，等等。

4、写脚本有很多选择，有些同学会用bash，有些同学会用gulp，还有些同学会用… 我个人主要是基于 zx。他封装的特别好，包含命令脚本相关的大部分常用操作，比如命令的执行、超时处理、stderr 和 stdout 的捕获，终端颜色，参数处理，等等。

```ts
import 'zx/globals';
(async () => {
  await $`echo 0`;
  fs;
  path;
  chalk;
  argv;
  cd;
  fetch;
  spinner;
  glob;
  await retry(10, () => $`curl http://website/`);
}().catch(e => {
  console.error(e);
  process.exit(1);
});
```

6、此外，还有一点值得一提的是，如果要跑的任务量大，要提前点考虑并发执行，或者如果是 CPU 密集型的操作，得考虑分布式去执行。比如我的场景有 1900 百多个项目，要跑每个项目要 git clone、安装依赖、执行原始的构建脚本、执行codemod、删除依赖、再重装依赖、执行新的构建脚本、统计数据。整个流程下来，通常需要 4-5 分钟左右。一天一台电脑能跑 200 个项目，全部跑一遍得10天。这个时间成本太贵了，所以分布式跑脚本肯定少不了。

参考：  
[https://github.com/google/zx](https://github.com/google/zx)  
\[\[Mako 自动验项目\]\]
