---
title: "238 - 《幽灵依赖》"
date: 2023-01-03
url: https://sorrycc.com/phantom-deps
---

发布于 2023年1月3日

# 238 - 《幽灵依赖》

![](https://img.alicdn.com/imgextra/i4/O1CN015w1WoT1Rx79xgFZBN_!!6000000002177-0-tps-109-233.jpg)

1、什么是幽灵依赖？当一个项目使用了一个没有在其 package.json 中声明的包时，就会出现"幽灵依赖"。

比如你的 package.json 长这样，

```json
{  
  "dependencies": {  
    "minimatch": "^3.0.4"  
  },  
  "devDependencies": {  
    "rimraf": "^2.6.2"  
  }
}
```

然后在代码中这么使用依赖，其中 brace-expansion 和 glob 就是幽灵依赖。

```js
var minimatch = require('minimatch');  
var expand = require('brace-expansion'); // ???  
var glob = require('glob'); // ???  
  
// 更多代码
```

那么，使用 devDependencies 里声明的 rimraf 算不上幽灵依赖？

```js
const rimraf = require('rimraf');
```

答案是「看场景」。如果这是项目中的代码，不算；如果这是依赖库的代码，算。因为项目中安装依赖时会安装 devDependencies，而作为依赖库被项目安装时，不会安装依赖库的 devDependencies。

2、为啥使用幽灵依赖却能跑？这和 npm 的安装机制有关，npm 3.x 开始「改进」了安装算法，使其扁平化，扁平化就是把深层的依赖往上提。好处是消除重复依赖，代价则是引入幽灵依赖问题，因为往上提的依赖你在项目中引用时就能跑。（注：pnpm 默认配置彻底解决了幽灵依赖问题，当然他也没有依赖重复问题）

3、幽灵依赖最厉害的点在于，明明跑的好好的项目，过了一晚（也可能过了一周、一个月、一年）之后就挂了。原因在于，如果你没有明确声明依赖及其版本，而是借助 npm 的依赖提升机制，被上提的依赖是不能确保的，可能今天是 1，明天是 2，后天直接消失没有了。潜在的两个危害是，1）不兼容的版本，比如某依赖过了一年发布大版本，然后大版本被提升到 node\_modules root 目录，你就会使用不兼容的版本，2）依赖缺失，比如你的直接依赖小版本更新后不使用你之前依赖的间接依赖，再次安装时就不会出现这个依赖，或者比如多个直接依赖的间接依赖冲突时，可能也不会做提升（我猜的）。

4、蚂蚁现状如何？比我之前预想的更严重一些。韩泽邦在上周五（2022.12.30）[抽查了 13 个项目](https://yuque.antfin.com/wb-hzb770734/share/phantom-dependency-15-projects)，仅有 2 个项目是没有幽灵依赖问题的，一个是模板项目（脚手架创建之后没改过代码），另一个代码极少。一个幽灵依赖就是一颗雷，未来随时可能会💥，而很多项目却是拥有好多颗。

5、怎么解决？先检测，再修复。

如何检测？如果是 Bigfish 4 项目，已内置支持检测，配置开启。（如果是 Bigfish 3 或者更早版本或者其他类型的项目，可尝试通过 pnpm 重装依赖然后跑 `npm run build` 的方式进行检测）

```bash
$ rm -rf node_modules
$ tnpm i
$ npx bigfish -v
4.0.110 // 确保是 4.0.110 或以上
$ npx bigfish config set phantomDependency {}
或者手动修改依赖，加上 phantomDependency: {} 配置
$ npm run build
然后你就知道有没有以及有多少幽灵依赖了。
```

![](https://img.alicdn.com/imgextra/i2/O1CN01RS5sCE1YIXNYh98rZ_!!6000000003036-2-tps-2180-720.png)

如何修复？两个思路。

① 比如 moment、lodash、history、classnames、query-string 这类[已经包含在 bigfish utils 里](https://bigfish.antgroup-inc.cn/docs/api/api#%E5%86%85%E7%BD%AE%E5%B7%A5%E5%85%B7%E5%8C%85)的，可修改 import source 为 `@alipay/bigfish/utils/{包名}` 解决。

```diff
- import lodash from 'lodash';
+ import lodash from '@alipay/bigfish/utils/lodash';
```

② 在 package.json 中显式声明依赖。

```json
{
  "dependencies": {
    "lodash": "4"
  }
}
```

6、为啥 Bigfish 没有默认开启这个功能？因为 90% 的项目有幽灵依赖问题，开启之后可能造成的影响太大，所以，1）目前新项目会通过脚手架默认开启，2）待有幽灵依赖的项目减少到 30% 或以上时（希望有这一天…），Bigfish 将默认开启此功能。

参考：  
[Phantom dependencies | Rush](https://rushjs.io/pages/advanced/phantom_deps/)  
[https://umijs.org/docs/api/config#phantomdependency](https://umijs.org/docs/api/config#phantomdependency)
