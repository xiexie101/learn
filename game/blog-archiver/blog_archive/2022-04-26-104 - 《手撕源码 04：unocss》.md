---
title: "104 - 《手撕源码 04：unocss》"
date: 2022-04-26
url: https://sorrycc.com/source-04-unocss
---

发布于 2022年4月26日

# 104 - 《手撕源码 04：unocss》

先介绍下 unocss，官方定义是「The instant on-demand Atomic CSS engine.」。unocss Star 4.2K，周下载 11K，是类 tailwindcss 和 windycss 的方案，可以理解为 utiility-first 的 CSS 框架，提供大量比如 absolute、flex、pt-4、text-center 的 util 类，然后通过组装的方式完成页面样式。同时这些提供的样式是按需编译产出的。

![](https://img.alicdn.com/imgextra/i1/O1CN01aPQHXf261loWupDgE_!!6000000007602-0-tps-1444-586.jpg)

比如，如下 JS 语句。

```ts
<div class="absolute i-carbon-logo-github">
  hello
</div>
```

会产出如下 CSS 代码。

```css
/* layer: icons */
[i-carbon-logo-github=""]{…}

/* layer: default */
[absolute=""]{position:absolute;}
```

unocss 工程化技术栈是 pnpm + eslint + esno + bumpp + tsc + vitest + unbuild。用 esno 编写 scripts，用 [version-bump-prompt](https://github.com/JS-DevTools/version-bump-prompt)（bumpp，Star 139）更新 npm 包版本，用 vitest 做测试，而源码构建则基于 [unbuild](https://github.com/unjs/unbuild)（Star 500+）。.npmrc 中有两个配置，ignore-workspace-root-check=true 允许在根目录通过 pnpm i xxx 安装依赖，shamefully-hoist=true 开启依赖的 hoist（不建议开）。tsconfig.json 中设置了每个 package 的 paths，用于确保正确的 ts 类型提示。

其他依赖库。命令基于 [cac](https://github.com/cacjs/cac)（Star 1.6K），winPath 处理基于 [pathe](https://github.com/unjs/pathe)（Star 100+），color 基于 [colorette](https://github.com/jorgebucaran/colorette)（Star 1.4K），glob 用 [fast-glob](https://github.com/mrmlnc/fast-glob)（Star 1.6K），配置读取基于 [unconfig](https://github.com/antfu/unconfig)（Star 300+），文件监听用 [chokidar](https://github.com/paulmillr/chokidar) （Star 8.9K）。

产物包不是 type: module，而是同时产出 cjs 和 mjs 产物，通过 main 和 module 属性指定。

unocss 主要的包有 unocss、cli、config、core，以及各种 preset。unocss 包只做 reexport，无实质内容；cli 包仅提供 build 命令，收集文件、合成一个大字符串，然后传给 generate 生成 css 文件；config 包负责用户配置的读取工作，基于 [unconfig](https://github.com/antfu/unconfig)（Star 300+），会返回配置依赖用于 watch 模式下监听变更；core 主要是 generate 方法，基于输入的文件和配置，产出 css 内容。

unocss 扩展的方式是通过 presets，preset 提供 enforce、name、options、extractors、rules、layers、theme、autocomplete、preprocess、postprocess、preflights、variants 和 shortcuts，支持通过 enforce: pre | post 调整顺序，更多配置详见 [https://github.com/unocss/unocss/blob/98317c8607e376b5eb3375ef91628599b74a80e3/packages/core/src/types.ts#L238](https://github.com/unocss/unocss/blob/98317c8607e376b5eb3375ef91628599b74a80e3/packages/core/src/types.ts#L238) 。

generate 的过程主要先用代码中 extract 出 token（`Set<string>`），然后再基于 token 产出 layers，layer 包括。其中 extrator 和 layer 都是可扩展的。

参考：  
[https://github.com/unocss/unocss](https://github.com/unocss/unocss)  
[https://antfu.me/posts/reimagine-atomic-css-zh](https://antfu.me/posts/reimagine-atomic-css-zh)  
[https://unocss.antfu.me/](https://unocss.antfu.me/)
