---
title: "360 - 《从一例 async await 常见错误说起》"
date: 2023-10-26
url: https://sorrycc.com/async-await-error-case
---

发布于 2023年10月26日

# 360 - 《从一例 async await 常见错误说起》

> 注：本文 GPT-4 含量 80%。

逛 X 时 [https://twitter.com/BenLesh/status/1717272722193965511](https://twitter.com/BenLesh/status/1717272722193965511) 看到一个例子。await async 虽好，直到他不会抛错…

```ts
async function willReject() {
  throw new Error("Up yours, developers! - JavaScript");
}

async function test() {
  try {
    return willReject();
  } catch (reason) {
    console.log("LOLOLOL NEVER HIT");
  }
}

test();
```

这段代码存在一个常见的异步错误处理问题。`try-catch`块不能捕获`willReject`函数抛出的异步错误，因为`try-catch`仅适用于同步操作。在这种情况下，错误会导致程序崩溃或未处理的Promise拒绝，而不会触发`catch`块。

几个解法：

1、**使用`await`关键字**：在调用`willReject()`时使用`await`关键字，以便等待该函数执行完成。这样，任何抛出的错误都会被`catch`块捕获。

```ts
async function test() {
  try {
    await willReject();
  } catch (reason) {
    console.log("Caught the error");
  }
}
```

2、**使用`.catch()`**：另一种解决方案是在返回的Promise上调用`.catch()`方法。

```ts
async function test() {
  willReject().catch(reason => {
    console.log("Caught the error");
  });
}
```

3、**使用`Promise.allSettled`**：如果您需要等待多个异步操作，其中某些可能会失败，可以使用`Promise.allSettled`。

```ts
async function test() {
  const results = await Promise.allSettled([willReject()]);
  results.forEach((result) => {
    if (result.status === 'rejected') {
      console.log('Caught the error');
    }
  });
}
```

这类没有 await 或 handle 的 promise 有个名词叫「floating promises」。

好了，你学会了。但是如何让团队同学的代码也不会出现这类问题？考虑你的团队可能不断有新人进来，一个个教一遍成本就太高了。所以，问题编程了「如何工程化地避免这类情况的发生？」。

几个工程化的解法：

1、用 no-floating-promises eslint 规则，这个规则会检测未处理的Promise，迫使开发人员使用 `.catch()` 或者 `await` 与 `try-catch` 来处理所有的异步错误。

2、如果你用 TypeScript，可以用像 `neverthrow` 或者 `ts-results` 这样的库，他们都提供了 `Result` 类型，这可以允许你用更为强类型的方式来处理错误，这样可以在编译时而非运行时捕获更多的错误。

参考：  
[https://twitter.com/BenLesh/status/1717272722193965511](https://twitter.com/BenLesh/status/1717272722193965511)  
[https://github.com/typescript-eslint/typescript-eslint/blob/main/packages/eslint-plugin/docs/rules/no-floating-promises.md](https://github.com/typescript-eslint/typescript-eslint/blob/main/packages/eslint-plugin/docs/rules/no-floating-promises.md)  
[https://github.com/supermacro/neverthrow](https://github.com/supermacro/neverthrow)  
[https://github.com/vultix/ts-results](https://github.com/vultix/ts-results)
