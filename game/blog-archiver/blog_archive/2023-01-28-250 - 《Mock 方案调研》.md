---
title: "250 - 《Mock 方案调研》"
date: 2023-01-28
url: https://sorrycc.com/mock
---

发布于 2023年1月28日

# 250 - 《Mock 方案调研》

> 上午调研了 mock 方案，主要是 [MSW](https://mswjs.io/)，在此整理下笔记和一些思考。

1、什么时候需要用到 mock 方案？1）开发，此时用 mock 数据可无需等待后端 API 开发完成，前后端开发并行实施，可以提升项目进度，2）调试，让后端准备各种场景的 API 数据是困难的，做过业务的都懂，尤其是当涉及多个系统时，mock 可以轻松完成各种场景的准备，之前参加双 12 项目，做过一个组件是有 20+ 场景组合的，3）试验，如果有新的 API 设计思路，可以用 mock 方案快速验证，4）DEMO，和 2 类似，准备不同场景的数据，提供 DEMO 给上下游使用。

2、mock 方案的实现有哪些不同方式？大体有三种，1）mock server，2）monkey patch native 模块，3）service worker。mock server 就是提供专门的 server（也可以是中间件），通过网络的方式访问，缺点是，1）和生产服务器有差异，2）额外的维护成本（比如启动 server），3）开发时需要修改代码指向 Mock 服务器。monkey patch native 模块指通过修改 fetch、xmlhttprequest、http 和 https（node）模块实现 mock，缺点是，1）修改原生模块是危险的，可能有坑，2）也会导致和生产环境的差异，3）不能在 Devtools 的网络面板中看到请求信息。

3、社区流行的 mock 方案有 [Nock](https://github.com/nock/nock)、[JSON Server](https://github.com/typicode/json-server)、[MirageJS](https://github.com/miragejs/miragejs)、[Service Mocker](https://github.com/service-mocker/service-mocker/) 和 [MSW](https://mswjs.io/)。Nock 专门为 Node 设计，不支持 Browser 环境，实现是方案 2；JSON Server 实现是方案 1；MirageJS 只支持 Browser 环境，实现是方案 2；Server Mocker 只支持 Browser 环境，实现是方案 3；MSW 感觉是集大成者，结合了前面方案的优点，目前看没啥明显缺点，支持 Node 和 Browser，实现是方案 3，但又解了 Server Mocker 方案里的一些坑点。

4、Umi 目前的实现是方案 1，以中间件的形式附加在 Umi Dev Server 上。调研后倾向的方案是 MSW，但还有些点需进一步确认，比如由于他基于 Service Worker 实现，就需要确认和 qiankun JS 沙箱的兼容问题，以及父子应用或多个子应用都开了 Service Worker 的场景。

5、如果 Umi 集成 MSW，应该如何做？目前想到的一些。1）把手动的事情配置化和约定化掉，比如[延迟接入](https://mswjs.io/docs/recipes/deferred-mounting) worker 等，2）MSW 有些配置存在 package.json，出于一致性考虑，需支持放在 .umirc.ts 里进行配置，3）为了方便迁移，需要能复用现有 Mock 方案的数据。往深了做的话，还有一些点，1）支持多套 mock 数据，可以实时切换，2）mock 数据上云。

6、巧妇难为无米之炊，有 Mock 方案后，还需要有 Mock 数据。Mock 数据从哪里来？我想到一些。1）纯手写，2）在 1 的基础上加上 [faker](https://github.com/faker-js/faker)、[test-data-bot](https://github.com/jackfranklin/test-data-bot)、[mockjs](https://github.com/nuysoft/Mock) 之类的辅助库，让手写时轻松点，3）通过 openapi 等工具（我们内部有个叫 oneapi）基于后端 controller 生成 mock 数据和 service，4）自动捕获正常访问时请求数据，存起来给 Mock 用。

参考：  
[GitHub - mswjs/msw: Seamless REST/GraphQL API mocking library for browser and Node.js.](https://github.com/mswjs/msw)  
[GitHub - mswjs/interceptors: Low-level HTTP/HTTPS/XHR/fetch request interception library.](https://github.com/mswjs/interceptors)  
[Stop mocking fetch](https://kentcdodds.com/blog/stop-mocking-fetch)  
[GitHub - faker-js/faker: Generate massive amounts of fake data in the browser and node.js](https://github.com/faker-js/faker)  
[GitHub - jackfranklin/test-data-bot](https://github.com/jackfranklin/test-data-bot)
