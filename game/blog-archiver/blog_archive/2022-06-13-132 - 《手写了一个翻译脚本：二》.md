---
title: "132 - 《手写了一个翻译脚本：二》"
date: 2022-06-13
url: https://sorrycc.com/how-to-write-translate-script-02
---

发布于 2022年6月13日

# 132 - 《手写了一个翻译脚本：二》

周末继续完善了下上周写的翻译脚本（[130 - 《手写了一个翻译脚本：一》](https://sorrycc.com/how-to-write-translate-script-01)），效果见下图，已基本达到我想要的状态。周末用了下，感觉阅读英文文章时效率有所提升。

![](https://img.alicdn.com/imgextra/i3/O1CN01MgsLlg24hKWUTR9tA_!!6000000007422-2-tps-800-726.png)

操作步骤，

1、网页中选中英文文本  
2、复制  
3、命令行执行脚本  
4、产生中英文相间的 markdown 文件  
5、通过预览模式浏览文件

实现步骤，

1、pasteboard 到 html  
2、html 到 markdown  
3、markdown 到翻译

pasteboard 到 html 在 web 里好做，直接用 [Clipboard API](https://developer.mozilla.org/en-US/docs/Web/API/Clipboard_API) 就好，在 node 端比较麻烦一些。先是找了 [clipboardy](https://github.com/sindresorhus/clipboardy)，但是翻了下源码，发现在 mac 下是基于命令行 pbcopy 和 pbpaste 实现的，只能从粘贴板里读取纯文本。然后再找到周下载只有 2 的 [pb](https://github.com/SheetJS/pb)，基于 objc bridge 实现，支持 plaintext、html 和 rtf。搞定！

html 到 markdown 是基于 [turndown](https://github.com/mixmark-io/turndown)。遇到 [domino 的 bug](https://github.com/fgnass/domino/issues/146)，绕过的办法是用 turndown 的 umd，引用 domino 的地方手动改成了 domino-next。搞定！后面想到更好的方案应该是用 [rehype-remark](https://github.com/rehypejs/rehype-remark)，找时间再试试。

markdown 到翻译在上一篇的基础上做了些改良。1）支持长文翻译，先把文本切成少于 4000 字符的多个 Block，逐个 Block 翻译，完成后再合并；2）支持翻译时跳过代码块和图片块，在合并时加回去；3）翻译接口后加了随机数延迟，避免接口被封。

以上代码见 [https://gist.github.com/sorrycc/2adc1e97da9884ee58df3e92032ddda3](https://gist.github.com/sorrycc/2adc1e97da9884ee58df3e92032ddda3) 。

下一步？可能会实现英文版 PDF 输入，中英文间隔版 PDF 输出。
