---
title: "102 - 《手撕源码 02：sveltekit》"
date: 2022-04-22
url: https://sorrycc.com/source-02-sveltekit
---

发布于 2022年4月22日

# 102 - 《手撕源码 02：sveltekit》

svelte 念做 `[svelt]`。

sveltekit Star 数 8K，周下载 49K，主库 svelte 的周下载是 222K。作者是 [Rich-Harris](https://twitter.com/rich_harris)，他同时也是 svelte、rollup、magic-string 的作者，就职于 vercel。

实现用 JavaScript 而非 TypeScript，但有在注释里加类型，解不了类型时作者还在注释里[吐槽了下 TypeScript](https://t.zsxq.com/3Fmae6A)… 作者也是实用主义，整个仓库只有少量的测试用例。因为没有插件等「花里胡哨」的功能，整体源码非常简单易懂，我上午花 1 个小时就看完 80% 功能，强烈建议想入门框架源码的同学阅读。

工程化和上一篇的 Astro 类似，turbo + typescript + prettier + eslint + pnpm + changeset + playwright，现代 monorepo 类 npm 包工程化的标配。产物是 type: module 格式。源码通过 rollup 打包到 dist 目录，打包时同时打包了依赖，所以我们看 kit 的 package.json，会发现大量用到的依赖写在 devDependencies。

部分依赖库。命令行基于 [sade](https://github.com/lukeed/sade)（900+ Star）；https 证书用 [selfsigned](https://github.com/jfromaniello/selfsigned)（Star 191）生成私钥和证书，实测并没有自动信任，所以体验可能没有 mkcert 的方案好；端口检测和查找用 Rich Harris 自研的 [port-authority](https://github.com/Rich-Harris/port-authority)（Star 52）实现，可以实现更精准的检测端口、查找可用端口、获取端口进程、kill 端口进程等；colors 方案用 [kleur](https://github.com/lukeed/kleur)（Star 1.3K）；请求用的 node-fetch，还有个 [install fetch](https://github.com/sveltejs/kit/blob/master/packages/kit/src/install-fetch.js) 的过程，node 18 已内置 fetch，node 下用 fetch 应该是未来的方向。

配置仅支持 .js 后缀，所以很简单，直接 import() 即可。配置校验是自研的 [https://github.com/sveltejs/kit/blob/master/packages/kit/src/core/config/options.js](https://github.com/sveltejs/kit/blob/master/packages/kit/src/core/config/options.js) ，功能上同时包含校验和默认值。

sveltekit 有且仅有提供 5 个命令，dev、build、preview、package 和 sync。

sync 是在 .svelte-kit 目录下生成临时文件，包含运行时、临时文件、关于路由组件 assets 等的 manifest、根组件、tsconfig.json、类型等，等于在此目录下重新构建了完整的 js 项目（源码除外，对于源码还是通过相对路径的引用方式）。

dev 和 build 的功能很好理解。由于是 SSR 框架，会包含 client 和 server 的构建，同时 build 时还会做 prerender 和 service worker 的生成。prerender 是拿 server 构建的产物，把 client 路由挨个跑一遍。构建基于 Vite，相比 Astro，Sveltekit 对 Vite 的定制是很轻的，只做了一些简单的配置，以及增加了 [https://github.com/sveltejs/vite-plugin-svelte](https://github.com/sveltejs/vite-plugin-svelte) 插件做 .svelte 文件的处理。这里有学到的一点是，封装 Vite 可以通过 build.rollupOptions.input 参数配置入口文件，而无需先走 html 文件再分析出入口。

preview 命令 vite 和 umi 都有，用于把 build 产物发布上线之前再做一次验证。

package 命令还处于 experimental 阶段，但思路很好，我想抄，呃不对，想学习到 Umi 中。功能是把项目的 lib 目录打包成 npm 包发布，供他人使用。这其中也有不少细节问题，包含类型生成、别名处理等。

时间有限，还留了个问题没调研透：adapter 的接入方式。umi 也有 adapter，但感觉 sveltekit 的方式会更通用。

[https://kit.svelte.dev/docs/introduction](https://kit.svelte.dev/docs/introduction)  
[https://github.com/sveltejs/kit](https://github.com/sveltejs/kit)  
[https://github.com/sveltejs/vite-plugin-svelte](https://github.com/sveltejs/vite-plugin-svelte)
