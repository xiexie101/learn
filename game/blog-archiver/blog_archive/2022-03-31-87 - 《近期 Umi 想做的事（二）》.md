---
title: "87 - 《近期 Umi 想做的事（二）》"
date: 2022-03-31
url: https://sorrycc.com/umi-tasks-2022-02
---

发布于 2022年3月31日

# 87 - 《近期 Umi 想做的事（二）》

希望可以带来点灵感，上次有认领的同学记得赶下进度。

1️⃣ 完善 umi g

提供更多模板，

```bash
# 生成 src/components/Foo/{index.ts, Foo.ts}
$ umi g component foo
# 生成 src/api/foo.ts，提供 GET /api/foo 的请求处理
$ umi g api foo
# 生成 mock/foo.ts，提供 GET /mock/foo 的请求响应。
$ umi g mock foo
```

2️⃣ 默认 react 18，使用 Suspense 渲染

解什么问题？

React 18 发布后，社区需要跟上；同时 Suspense 可以让渲染更流畅。

思路。

1、默认 react 18。  
2、默认 Suspense 渲染，遇到低版本 react，降级为 loadable。使用 Suspense 的好处是可以边请求边渲染，让渲染更快。  
3、卡点是 antd 还不支持 react 18，所以使用 antd 的项目需手动依赖 react 17，框架层可以做适当提醒

3️⃣ 调研 form + action + useTransition 的可行性 @映高

解什么问题？

1、一致性问题，让大家在统一的地方写表单提交  
2、更优雅，不用在组件内写 useEffect 等  
3、框架统一管理后，有更多想象空间，比如和 loader 的联动

思路。

1、在路由组件上添加 export function action() {} 来处理表单提交，框架自动做 e.preventDefault、ErrorBoundary、自动调用 loader 获取新数据、处理 race condition 等  
2、在组件内通过 useTransition 获取提交状态

参考 [https://remix.run/blog/remixing-react-router](https://remix.run/blog/remixing-react-router)

4️⃣ umi dev 启动后不阻断，而是在 browser 里显示 loading 和进度

解什么问题？

1、现在启动后虽然 server 显示快，但是 webpack 打包还需要一些时间，页面会卡主  
2、MFSU 没有好的时候也会卡主  
3、为了命令行的简洁，同时社区现有的 progress 插件有 bug，比如之前大家经常遇到的 99% 进度即完成的问题，带来不少答疑量，所以 Umi 4 中移除的命令行的进度条显示

思路。

1、增加中间件，检测 server 状态，如果 webpack 或 mfsu（如果有开）没有好，返回 loading 页，可参考 [https://twitter.com/atinux/status/1509169207946235908?s=21&t=nR--3Vro-xAaDwxF9xilxQ](https://twitter.com/atinux/status/1509169207946235908?s=21&t=nR--3Vro-xAaDwxF9xilxQ)  
2、增加 `/__umi/api/buildStatus` 返回当前 build 状态  
3、loading 页不参与构建，不影响开发者项目的构建速度
