---
title: "81 - 《SSR 数据方案的迭代和 Umi 4》"
date: 2022-03-24
url: https://sorrycc.com/ssr-data-solution-and-umi4
---

发布于 2022年3月24日

# 81 - 《SSR 数据方案的迭代和 Umi 4》

Umi 4 的 SSR 进行中，和同事讨论后，做下整理。

1、

SSR 不止是 ReactDOM.renderToString() + ReactDOM.hydrate()，还有 server 产物的 bundle、SSG、数据加载策略、路由文件的拆分、CSR & SSR 的选择和混用、assets 资源的处理、逻辑复用、HTML 拼接、路由和数据的加载及隐射关系、组件如何获取数据、潜在内存问题的处理等。

2、

SSR 的加载策略已今时不同往日。加载策略要考虑不同的时机，1）页面初始加载时 2）页面切换时 3）build（即 SSG）时。不同时机的环境是不同的，初始加载时和 SSG 时肯定发生在 node 侧，而页面切换时用 node 侧还是 browser 侧是可以选择的。

Next.js 最早用的是 getInitialProps，getInitialProps 在页面加载时会在 node（server）侧执行，而在页面切换时会在 browser 侧执行。Umi 3 实现参考了这种实现。这种方式的问题是，node 和 browser 能拿到的入参是不同的，比如 node 下拿到 request 和 response，访问 database 等，这个方法如果要设计成既在 node 跑又在 browser 跑，那能做的事的边界就小了，比如只能做做 fetch 之类的。

```tsx
Page.getInitialProps = async (ctx) => {
 return { data: await fetch('/url') };
};
```

大家如果有看 Next.js 的文档，会发现他已不推荐使用 getInitialProps，而是推荐用 getStaticProps 和 getServerSideProps，适用不同的场景，其中前者是给 SSG 用的。

getServerSideProps 顾名思义，只在 server 端跑。那他如何解路由切换时的数据加载问题？答案是通过 API 请求。切换路由时，框架会匹配路由，请求 API 加载数据，API 背后是路由组件里定义的 getServerSideProps。由于只在 node 侧跑，能做的事的边界会比较宽。

```tsx
export async function getServerSideProps() {
 return { data: await fetch('/url') };
}
```

回头看最近新出的 Remix 方案，SSR 的方式和 getServerSideProps 是一致的。所以 Umi 4 用啥？必须与时俱进，也是相同的方式，哈哈。

3、

框架级 SSR 的路由组件数据请求是优化过的。之前有写过组件请求的方式 [https://t.zsxq.com/N3FuJaY](https://t.zsxq.com/N3FuJaY) ，1）渲染时请求 2）请求后渲染 3）边请求边渲染，明显越往后越快，3>2>1。

处理方式是先匹配路由，拿到所有路由的数据加载方法，并行执行，最后通过 Hooks 获取数据，这就是请求后渲染。然后搭配 Suspense，可实现边请求边渲染。

4、

回头看 CSR。Umi 3 是支持一键切换到 CSR 模式，并且也是通过 getInitialProps 声明数据依赖的。同时蚂蚁内部 99% 是 CSR，上述请求优化方式如何让 CSR 的应用也受益呢？这就是国外框架不太会关心的事了，但 Umi 需要关心。

实现方案是在路由组件额外定义单独的客户端请求方法，比如叫 clientLoader。然后这个 loader 会被拆到统一的 loader 方法 Map 中，后续和 SSR 的请求方式一致，匹配路由，拿到所有路由的数据加载方法，并行执行，最后通过 Hooks 获取数据。

这种方式会让所有基于 Umi 的 CSR 项目受益，让渲染提前，不用等页面组件的 JS 开始加载就可以做相应的数据请求。代价是有代码改动，需要把请求方法写在约定的方法里。

5、

最终，Umi 4 的 SSR + CSR 的数据方案是这样。

```tsx
// 使用数据
useLoaderData()
// SSR 加载数据
export async loader() {}
// CSR 加载数据
export async clientLoader() {}
```

参考：  
[https://nextjs.org/docs/api-reference/data-fetching/get-initial-props](https://nextjs.org/docs/api-reference/data-fetching/get-initial-props)  
[https://remix.run/docs/en/v1/api/conventions#loader](https://remix.run/docs/en/v1/api/conventions#loader)  
[69 - 《React 请求机制及其工程化》](https://sorrycc.com/react-request-solution-and-engineering)
