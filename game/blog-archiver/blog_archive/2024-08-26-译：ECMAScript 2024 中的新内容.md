---
title: "è¯‘ï¼šECMAScript 2024 ä¸­çš„æ–°å†…å®¹"
date: 2024-08-26
url: https://sorrycc.com/whats-new-in-ecmascript-2024
---

å‘å¸ƒäº 2024å¹´8æœˆ26æ—¥

# è¯‘ï¼šECMAScript 2024 ä¸­çš„æ–°å†…å®¹

> åŸæ–‡ï¼š[https://pawelgrzybek.com/whats-new-in-ecmascript-2024/](https://pawelgrzybek.com/whats-new-in-ecmascript-2024/)  
> ä½œè€…ï¼šPaweÅ‚ Grzybek  
> è¯‘è€…ï¼šChatGPT 4 Turbo

**ç¼–è€…æ³¨ï¼šè¿™äº›ï¼ŒisWellFormedã€Atomics.waitAsyncã€RegExp v Flagã€ArrayBuffer å¯è°ƒæ•´å¯è½¬ç§»ã€æ•°ç»„ groupByï¼ˆå±…ç„¶æ”¾ Object ä¸Šâ€¦ï¼‰ã€Promise.withResolversã€‚**

[ECMAScript 2024 è¯­è¨€è§„èŒƒ](https://tc39.es/ecma262/2024/)çš„æœ€ç»ˆç‰ˆæœ¬å·²äº [6 æœˆ 26 æ—¥](https://github.com/tc39/ecma262/releases/tag/es2024) è·æ‰¹å‡†ã€‚æ–°çš„ JavaScript ç‰¹æ€§åˆ—è¡¨ç°å·²ç¡®è®¤ï¼Œä¸ºäº†ä¿æŒæˆ‘æ¯å¹´çš„ä¼ ç»Ÿï¼Œæˆ‘ä¸ºä½ å’Œæœªæ¥çš„æˆ‘å‘å¸ƒäº†è¿™ç¯‡å¹´åº¦å›é¡¾ã€‚å¯¹è¿‡å»å‡ å¹´æ„Ÿåˆ°å¥½å¥‡çš„æœ‹å‹ï¼Œè¿™é‡Œæœ‰ä¹‹å‰å‡ å¹´çš„å¸–å­ï¼š[2023](https://pawelgrzybek.com/whats-new-in-ecmascript-2023/)ã€[2022](https://pawelgrzybek.com/whats-new-in-ecmascript-2022/)ã€[2021](https://pawelgrzybek.com/whats-new-in-ecmascript-2021/)ã€[2020](https://pawelgrzybek.com/whats-new-in-ecmascript-2020/)ã€[2019](https://pawelgrzybek.com/whats-new-in-ecmascript-2019/)ã€[2018](https://pawelgrzybek.com/whats-new-in-ecmascript-2018/)ã€[2017](https://pawelgrzybek.com/whats-new-in-ecmascript-2017/) å’Œ [2016](https://pawelgrzybek.com/whats-new-in-ecmascript-2016-es7/)ã€‚

ä¸€äº›å®ç”¨çš„åŠŸèƒ½æˆä¸ºäº†è§„èŒƒçš„ä¸€éƒ¨åˆ†ï¼Œä½†æœ‰äº›åˆ™æ›´åŠ ç»†è‡´ã€åº•å±‚ï¼Œä¸åœ¨å¸¸è§„åº”ç”¨åˆ¶ä½œè€…ï¼ˆåƒæˆ‘ï¼‰å¸¸ç”¨å·¥å…·é›†ä¹‹å¤–ã€‚æˆ‘å·²ç»åšäº†æˆ‘çš„åŠŸè¯¾ï¼Œåœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†å‘é‚£äº›å¾ˆå°‘æ·±å…¥ç ”ç©¶å¤æ‚çš„æ­£åˆ™è¡¨è¾¾å¼ã€Unicode å­—ç¬¦ç¼–ç å’Œç¼“å†²åŒºæ“ä½œçš„äººè§£é‡Šå®ƒä»¬ã€‚

* * *

## æ ¼å¼è‰¯å¥½çš„ Unicode å­—ç¬¦ä¸²

JavaScript ä¸­çš„å­—ç¬¦ä¸²ç”±ä¸€ç³»åˆ— UTF-16 ç ç‚¹è¡¨ç¤ºã€‚åç§°ä¸­çš„ 16 ä»£è¡¨ç”¨äºå­˜å‚¨ç ç‚¹çš„æ¯”ç‰¹æ•°ï¼Œå®ƒæä¾›äº† 65536 ç§å¯èƒ½çš„ç»„åˆï¼ˆ2^16ï¼‰ã€‚è¿™ä¸ªæ•°é‡è¶³ä»¥å­˜å‚¨æ‹‰ä¸æ–‡ã€å¸Œè…Šæ–‡ã€è¥¿é‡Œå°”æ–‡å’Œä¸œäºšå­—æ¯çš„å­—ç¬¦ï¼Œä½†ä¸è¶³ä»¥å­˜å‚¨å¦‚ä¸­æ–‡ã€æ—¥æ–‡ã€éŸ©æ–‡è¡¨æ„æ–‡å­—æˆ–è¡¨æƒ…ç¬¦å·ä¹‹ç±»çš„å†…å®¹ã€‚é¢å¤–çš„å­—ç¬¦å­˜å‚¨åœ¨ä¸€å¯¹ 16 ä½ç å…ƒç»„ä¸­ï¼Œç§°ä¸ºæ›¿ä»£å¯¹ã€‚

```js
'a'.length
// 1
'a'.split('')
// [ 'a' ]

'ğŸ¥‘'.length
// 2
'ğŸ¥‘'.split('')
//[ '\ud83e', '\udd51' ] ğŸ‘ˆ æ›¿ä»£å¯¹
```

é¦–å°¾æ›¿ä»£å¯¹è¢«é™å®šåœ¨ä¸€ä¸ªä¸ç”¨äºç¼–ç å•ç å…ƒå­—ç¬¦çš„ç å…ƒèŒƒå›´å†…ï¼Œä»¥é¿å…æ­§ä¹‰ã€‚å¦‚æœä¸€å¯¹æ›¿ä»£å¯¹ç¼ºå°‘ä¸€ä¸ªé¦–éƒ¨æˆ–å°¾éƒ¨ç å…ƒï¼Œæˆ–è€…å®ƒä»¬çš„é¡ºåºè¢«é¢ å€’ï¼Œæˆ‘ä»¬å¤„ç†çš„æ˜¯â€œå­¤ç«‹æ›¿ä»£â€ï¼Œæ•´ä¸ªå­—ç¬¦ä¸²æ˜¯â€œæ ¼å¼ä¸è‰¯çš„â€ã€‚å¯¹äºå­—ç¬¦ä¸²æ¥è¯´ï¼Œâ€œæ ¼å¼è‰¯å¥½â€ï¼Œå®ƒå¿…é¡»ä¸å«æœ‰å­¤ç«‹çš„æ›¿ä»£å¯¹ã€‚

[Unicode å­—ç¬¦ä¸²æ ¼å¼è‰¯å¥½æ€§ææ¡ˆ](https://github.com/tc39/proposal-is-usv-string) å¼•å…¥äº†ä¸€ä¸ª `String.prototype.isWellFormed()` æ–¹æ³•æ¥éªŒè¯å­—ç¬¦ä¸²æ˜¯å¦æ ¼å¼è‰¯å¥½ã€‚æ­¤å¤–ï¼Œå®ƒå¸¦æœ‰ä¸€ä¸ª `String.prototype.toWellFormed()` è¾…åŠ©æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å°†æ‰€æœ‰å­¤ç«‹çš„æ›¿ä»£ç å…ƒæ›¿æ¢ä¸ºæ›¿æ¢å­—ç¬¦ï¼ˆ`U+FFFD`ï¼Œï¿½ï¼‰ã€‚

```js
'\ud83e\udd51'
// ğŸ¥‘

'\ud83e\udd51'.isWellFormed()
// true

'\ud83e'.isWellFormed() // æ²¡æœ‰å°¾éšæ›¿ä»£ç 
// false

'\ud83e'.toWellFormed()
// ï¿½
```

## ECMAScript å¼‚æ­¥åŸå­ç­‰å¾…

Workers å®ç°äº† JavaScript ä¸­çš„å¤šçº¿ç¨‹åŠŸèƒ½ã€‚`SharedArrayBuffer` æ˜¯ä¸€ä¸ªåº•å±‚ APIï¼Œå®ƒå…è®¸æˆ‘ä»¬å¯¹ä¸»çº¿ç¨‹å’Œ Workersï¼ˆä»£ç†ï¼‰ä¹‹é—´çš„å…±äº«å†…å­˜è¿›è¡Œæ“ä½œã€‚`Atomics` å¯¹è±¡ä¸Šçš„ä¸€ç»„é™æ€æ–¹æ³•å¸®åŠ©æˆ‘ä»¬é¿å…è¯»å†™æ“ä½œä¹‹é—´çš„å†²çªã€‚

å¸¸è§çš„åšæ³•æ˜¯ä½¿ä¸€ä¸ª worker ä¼‘çœ å¹¶åœ¨éœ€è¦æ—¶å”¤é†’å®ƒã€‚æˆ‘ä»¬ç»“åˆä½¿ç”¨ `Atomics.wait()` å’Œ `Atomics.notify()` æ–¹æ³•æ¥å®ç°è¿™ä¸€ç‚¹ã€‚ç„¶è€Œï¼Œè¿™å¯èƒ½å› ä¸º `Atomics.wait()` æ˜¯ä¸€ä¸ªåŒæ­¥ API è€Œå—åˆ°é™åˆ¶ï¼Œå¹¶ä¸”ä¸èƒ½åœ¨ä¸»çº¿ç¨‹ä¸Šä½¿ç”¨ã€‚

[å¼‚æ­¥åŸå­ç­‰å¾…ææ¡ˆ](https://github.com/tc39/proposal-atomics-wait-async) æä¾›äº†ä¸€ç§åœ¨ä¸»çº¿ç¨‹ä¸Šå¼‚æ­¥æ‰§è¡Œæ­¤æ“ä½œçš„æ–¹æ³•ï¼Œæœ€é‡è¦çš„æ˜¯ï¼Œå®ƒèƒ½åœ¨ä¸»çº¿ç¨‹ä¸Šå®Œæˆã€‚

```js
// ä¸»çº¿ç¨‹
let i32a = null;

const w = new Worker("worker.js");
w.onmessage = function (env) {
  i32a = env.data;
};

setTimeout(() => {
  Atomics.store(i32a, 0, 1);
  Atomics.notify(i32a, 0);
}, 1000);
```

```js
// worker çº¿ç¨‹
const sab = new SharedArrayBuffer(Int32Array.BYTES_PER_ELEMENT);
const i32a = new Int32Array(sab);
postMessage(i32a);

const wait = Atomics.waitAsync(i32a, 0, 0);

// { async: false; value: "not-equal" | "timed-out"; }
// æˆ–
// { async: true; value: Promise<"ok" | "timed-out">; }

if (wait.async) {
  wait.value.then((value) => console.log(value));
} else {
  console.log(wait.value);
}
```

## RegExp `v` æ ‡å¿—ä¸é›†åˆè¡¨ç¤ºæ³•åŠå­—ç¬¦ä¸²å±æ€§

[æ–°çš„ RegExp `v` æ ‡å¿—](https://github.com/tc39/proposal-regexp-v-flag) ç±»ä¼¼äº [2015 å¹´æ–°å¢çš„æ”¯æŒ unicode çš„æ­£åˆ™è¡¨è¾¾å¼ï¼ˆ`u` æ ‡å¿—ï¼‰](https://mathiasbynens.be/notes/es6-unicode-regex)ï¼Œä½†åŠŸèƒ½æ›´å¼ºå¤§ã€‚ç”±äºä¸ `u` æ ‡å¿—çš„ç›¸ä¼¼æ€§å’Œä¸€äº›ä¸å…¼å®¹æ€§ï¼Œè¿™ä¸¤ä¸ªæ ‡å¿—ä¸èƒ½ç»„åˆä½¿ç”¨ã€‚æ–°çš„ `v` æ­£åˆ™æ¨¡å¼å¯ç”¨äº†ä¸‰ä¸ªåŠŸèƒ½ï¼šé’ˆå¯¹ [Unicode å­—ç¬¦ä¸²å±æ€§](https://www.unicode.org/reports/tr18/#Full_Properties) çš„å­é›†è¿›è¡Œæ£€æŸ¥ï¼Œæ‰§è¡Œå‡æ³•/äº¤é›†/å¹¶é›†åŒ¹é…ï¼Œå¹¶æ”¹è¿›äº†å¤§å°å†™ä¸æ•æ„ŸåŒ¹é…ã€‚

```js
// `u` å’Œ `v` æ¨¡å¼ç±»ä¼¼ï¼Œä½†å®ƒä»¬ä¸èƒ½ç»„åˆ
const pattern = /./vu;
// SyntaxError: æ— æ•ˆçš„æ­£åˆ™è¡¨è¾¾å¼ï¼šæ— æ•ˆçš„æ ‡å¿—
```

### é’ˆå¯¹ Unicode å­—ç¬¦ä¸²å±æ€§å­é›†çš„æ£€æŸ¥

Unicode æ ‡å‡†å®šä¹‰äº†ä¸€ä¸ªç®€åŒ–æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼çš„å±æ€§åˆ—è¡¨ã€‚ä¾‹å¦‚ï¼Œ`/\p{Math}/u` ç”¨äºæ£€æŸ¥æ•°å­¦è¿ç®—ç¬¦ï¼Œ`/\p{Dash}/u` ç”¨äºæ£€æŸ¥è¿å­—ç¬¦æ ‡ç‚¹ç¬¦å·æˆ– `/\p{Hex_Digit}/u` ç”¨äºæ£€æŸ¥ç”¨äºè¡¨ç¤ºåå…­è¿›åˆ¶æ•°å­—çš„ç¬¦å·ã€‚

```js
const patternMath = /\p{Math}/u;
const patternDash = /\p{Dash}/u;
const patternHex = /\p{Hex_Digit}/u;

patternMath.test('+'); // true
patternMath.test('z'); // false

patternDash.test('-'); // true
patternDash.test('z'); // false

patternHex.test('f'); // true
patternHex.test('z'); // false
```

å¤§å¤šæ•°å±æ€§é€‚ç”¨äºå•ä¸ªä»£ç ç‚¹ï¼Œä½†æœ‰ä¸€äº›ï¼ˆç›®å‰ä¸»è¦æ˜¯ä¸ emoji ç›¸å…³çš„ï¼‰é€‚ç”¨äºå­—ç¬¦ä¸²ï¼ˆå¤šä¸ªä»£ç ç‚¹ï¼‰ã€‚ä¾‹å¦‚ `Basic_Emoji`ã€`RGI_Emoji` å’Œ `RGI_Emoji_Flag_Sequence`ã€‚è¿™äº›æ˜¯ `u` æ¨¡å¼ä¸æ”¯æŒçš„ç±»å‹ï¼Œå°½ç®¡[æœ‰ä¸€äº›è®¨è®ºå¸Œæœ›æ”¹å˜è¿™ä¸€ç‚¹](https://github.com/tc39/proposal-regexp-v-flag/issues/49#issuecomment-988956561)ã€‚å¹¸è¿çš„æ˜¯ï¼Œ`v` æ¨¡å¼çš„ä¸€ä¸ªç‰¹æ€§å°±æ˜¯èƒ½å¤Ÿå¯¹ Unicode å­—ç¬¦ä¸²å±æ€§è¿›è¡Œæ£€æŸ¥ã€‚

```js
const pattern = /\p{RGI_Emoji}/u
// SyntaxError: æ— æ•ˆçš„æ­£åˆ™è¡¨è¾¾å¼ï¼š /\p{RGI_Emoji}/uï¼šæ— æ•ˆçš„å±æ€§åç§°
```

```js
const pattern = /\p{RGI_Emoji}/v;

// å•ä¸ªä»£ç ç‚¹ emoji
pattern.test('ğŸ˜€') // true

// å¤šä¸ªä»£ç ç‚¹çš„ emoji
pattern.test('ğŸ«¶ğŸ¾') // true
```

### å‡æ³•/äº¤é›†/å¹¶é›†åŒ¹é…

`v` æ¨¡å¼çš„å¦ä¸€ä¸ªç‰¹æ€§æ˜¯å±æ€§çš„å­—ç¬¦ä¸²çš„å‡æ³•ï¼ˆ`--`ï¼‰ã€äº¤é›†ï¼ˆ`&&`ï¼‰å’Œå¹¶é›†ã€‚åœ¨å­—ç¬¦ç±»ä¸­ï¼ˆå¤šå­—ç¬¦å­—ç¬¦ä¸²ï¼‰å†…ä½¿ç”¨æ–°çš„ `\q` è¿›è¡Œå­—ç¬¦ä¸²å­—é¢é‡çš„æ ‡è®°ä¹Ÿå€¼å¾—æ³¨æ„ã€‚

```js
// åŒ¹é…æ‰€æœ‰ emoji é™¤äº†ä¸€å † poo

const pattern = /[\p{RGI_Emoji}--\q{ğŸ’©}]/v;

pattern.test('ğŸ˜œ') // true
pattern.test('ğŸ’©') // false
```

```js
// ä»…åŒ¹é…å¤§å†™ï¼Œåå…­è¿›åˆ¶å®‰å…¨å­—ç¬¦

const pattern = /[\p{Uppercase}&&\p{Hex_Digit}]/v;

pattern.test('f') // true
pattern.test('F') // false
```

```js
// ä»…åŒ¹é…ç“œç±»å’Œæµ†æœ

const pattern = /^[\q{ğŸˆ|ğŸ‰|ğŸ“|ğŸ«}]$/v;

pattern.test('ğŸ¥‘') // false
pattern.test('ğŸ«') // true
```

### æ”¹è¿›çš„å¤§å°å†™ä¸æ•æ„Ÿæ€§

åœ¨ `u` æ¨¡å¼ä¸‹å¦‚ä½•æ£€æŸ¥å¤§å°å†™æ•æ„Ÿæ€§ä»¤äººå›°æƒ‘ã€‚å¯ç”¨äº†å¿½ç•¥å¤§å°å†™æ ‡å¿—ï¼ˆ`i`ï¼‰çš„åå‘æ¨¡å¼é’ˆå¯¹ç‰¹å®šçš„å¤§å°å†™ç»„ï¼ˆ`Lowercase_Letter` æˆ– `Uppercase_Letter`ï¼‰ä¸ä¼šäº§ç”Ÿç›´è§‚çš„ç»“æœã€‚æ–°çš„ `v` æ ‡å¿—ä½¿ç»“æœå˜å¾—æ›´åŠ å¯é¢„æµ‹ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¿™ä¸¤ä¸ªæ ‡å¿—ä¸èƒ½ç»“åˆä½¿ç”¨çš„åŸå› ã€‚

## åŸåœ°å¯è°ƒæ•´å¤§å°ä¸”å¯å¢é•¿çš„ ArrayBuffer

JavaScript ä¸­çš„ `ArrayBuffer` å¯¹è±¡æ˜¯è¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ç¼“å†²åŒºçš„ä¸€ç§æ–¹å¼ã€‚åœ¨ ECMAScript 2024 ä¹‹å‰ï¼Œè°ƒæ•´ `ArrayBuffer` çš„å¤§å°æ˜¯ä¸€ä¸ªç¹ççš„è¿‡ç¨‹ï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„å¹¶å°†æ•°æ®ä»ä¸€ä¸ªç§»åŠ¨åˆ°å¦ä¸€ä¸ªã€‚å¤šäºäº†[â€œåŸåœ°å¯è°ƒæ•´å¤§å°ä¸”å¯å¢é•¿çš„ ArrayBuffer ææ¡ˆâ€](https://github.com/tc39/proposal-resizablearraybuffer)ï¼Œæˆ‘ä»¬æœ‰äº†ä¸€ç§ä½¿ç”¨ `options.maxByteLength` å±æ€§å®šä¹‰å¯å¢é•¿ç¼“å†²åŒºå¹¶é€šè¿‡è°ƒç”¨ `resize()` æ–¹æ³•æ¥è°ƒæ•´å…¶å¤§å°çš„åŸç”Ÿæ–¹å¼ã€‚

```js
const buffer = new ArrayBuffer(8, { maxByteLength: 16 });

buffer.resizable; // true
buffer.byteLength; // 8
buffer.maxByteLength; // 16

buffer.resize(16);

buffer.byteLength; // 16
buffer.maxByteLength; // 16
```

## ArrayBuffer è½¬ç§»

éšç€ `ArrayBuffer` çš„æ–°è°ƒæ•´å¤§å°èƒ½åŠ›ï¼Œ[`arrayBuffer.prototype.transfer` åŠç›¸å…³ææ¡ˆ](https://github.com/tc39/proposal-arraybuffer-transfer) å¢åŠ äº†è½¬ç§»æ‰€æœ‰æƒçš„åŠŸèƒ½ã€‚ `transfer()` æˆ– `transferToFixedLength()` æ–¹æ³•å…è®¸æˆ‘ä»¬æ ¹æ®ç›®çš„åœ°é‡æ–°å®šä½å­—èŠ‚ã€‚æ–°çš„ `detached` getter æ˜¯ä¸€ç§æ£€æŸ¥å·²é‡Šæ”¾ç¼“å†²åŒºçš„æ–°åŸç”Ÿè§£å†³æ–¹æ¡ˆã€‚

```js
const buffer = new ArrayBuffer();
buffer.detached; // false

const newBuffer = buffer.transfer();
buffer.detached; // true
```

## æ•°ç»„åˆ†ç»„

æ„Ÿè°¢ [æ•°ç»„åˆ†ç»„ææ¡ˆ](https://github.com/tc39/proposal-array-grouping)ï¼Œä¸€ä¸ªå—åˆ° [Lodash](https://lodash.com/docs/4.17.15#groupBy)ã€[Ramda](https://ramdajs.com/docs/#groupBy) ç­‰æ¬¢è¿çš„ `groupBy` æ–¹æ³•ç°åœ¨å·²æˆä¸º ECMAScript çš„ä¸€éƒ¨åˆ†ã€‚æœ€åˆçš„æƒ³æ³•æ˜¯å°†å…¶å®ç°ä¸º `Array.prototype.groupBy`ï¼Œè¿™ä¸å¸¸ç”¨çš„ [Sugar å·¥å…·](https://sugarjs.com)å‘ç”Ÿäº†å†²çªã€‚å®ƒä½œä¸ºä¸€ä¸ª `Object.groupBy` / `Map.groupBy` é™æ€æ–¹æ³•å®ç°ã€‚

```js
const langs = [
  { name: "Rust", compiled: true, released: 2015 },
  { name: "Go", compiled: true, released: 2009 },
  { name: "JavaScript", compiled: false, released: 1995 },
  { name: "Python", compiled: false, released: 1991 },
];

const callback = ({ compiled }) => (compiled ? "compiled" : "interpreted");

const langsByType = Object.groupBy(langs, callback);

console.log({ langsByType });
// {
//   compiled: [
//     { name: "Rust", compiled: true, released: 2015 },
//     { name: "Go", compiled: true, released: 2009 }
//   ],
//   interpreted: [
//     { name: "JavaScript", compiled: false, released: 1995 },
//     { name: "Python", compiled: false, released: 1991 }
//   ]
// }
```

## Promise.withResolvers

[The `Promise.withResolvers` proposal](https://github.com/tc39/proposal-promise-with-resolvers) å‘è¯­è¨€ä¸­æ·»åŠ äº†å»¶è¿Ÿçš„ promisesï¼Œè¿™æ˜¯ä¸€ä¸ªä»¥å‰è¢« [jQuery](https://api.jquery.com/jQuery.Deferred/)ã€[bluebird](http://bluebirdjs.com/docs/api/deferred-migration.html)ã€[p-defer](https://github.com/sindresorhus/p-defer) å’Œè®¸å¤šå…¶ä»–åº“å®ç°çš„å—æ¬¢è¿æ¨¡å¼ã€‚ä½ å¯ä»¥ä½¿ç”¨å®ƒæ¥é¿å…åœ¨ promise æ‰§è¡Œå™¨ä¸­åµŒå¥—ï¼Œå°½ç®¡å½“ä½ éœ€è¦å°† resolve æˆ– reject ä¼ é€’ç»™å¤šä¸ªè°ƒç”¨è€…æ—¶ï¼Œå®ƒä¼šæ›´åŠ å‡ºè‰²ã€‚åœ¨æµæˆ–åŸºäºäº‹ä»¶çš„ç³»ç»Ÿä¸­å·¥ä½œæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ä½¿ç”¨æ¡ˆä¾‹ã€‚

çœ‹çœ‹è¿™ä¸ªä¾‹å­ï¼Œä¸€ä¸ª `createEventsAggregator`ï¼Œå–è‡ª[â€œä½¿ç”¨ Promise.withResolvers å»¶è¿Ÿ JavaScript promisesâ€](https://pawelgrzybek.com/deferred-javascript-promises-using-promise-withresolvers/)ï¼Œæˆ‘å‡ ä¸ªæœˆå‰å‘å¸ƒäº†è¿™ç¯‡æ–‡ç« ã€‚å®ƒè¿”å›ä¸€ä¸ª `add` æ–¹æ³•æ¥æ¨é€ä¸€ä¸ªæ–°äº‹ä»¶å’Œä¸€ä¸ª `abort` æ–¹æ³•æ¥å–æ¶ˆèšåˆã€‚æœ€é‡è¦çš„æ˜¯ï¼Œå®ƒè¿”å›ä¸€ä¸ª `events` promiseï¼Œå½“å®ƒè¾¾åˆ° eventsCount é™åˆ¶æ—¶è§£å†³ï¼Œæˆ–è€…å½“è§¦å‘ `abort` æ—¶æ‹’ç»ã€‚

```js
function createEventsAggregator(eventsCount) {
  const events = [];
  const { promise, resolve, reject } = Promise.withResolvers();

  return {
    add: (event) => {
      if (events.length < eventsCount) events.push(event);
      if (events.length === eventsCount) resolve(events);
    },
    abort: () => reject("Events aggregation aborted."),
    events: promise,
  };
}
```

```js
const eventsAggregator = createEventsAggregator(3);

eventsAggregator.events
  .then((events) => console.log("Resolved:", events))
  .catch((reason) => console.error("Rejected:", reason));

eventsAggregator.add("event-one");
eventsAggregator.add("event-two");
eventsAggregator.add("event-three");

// Resolved: [ "event-one", "event-two", "event-three" ]
```

* * *

å°±æ˜¯è¿™æ ·äº†ï¼Œ2024 å¹´ã€‚æˆ‘ä»¬æ˜å¹´å†è§ ğŸ‘‹
