---
title: "103 - 《手撕源码 03：ice-next》"
date: 2022-04-24
url: https://sorrycc.com/source-03-ice-next
---

发布于 2022年4月24日

# 103 - 《手撕源码 03：ice-next》

看到 ice 也在开发 3.0，翻了翻源码（[https://github.com/ice-lab/ice-next）。ice](https://github.com/ice-lab/ice-next%EF%BC%89%E3%80%82ice) 是阿里巴巴淘系团队开发的框架，国内和 umi、modern.js 应该是竞品，Star 17K+，周下载 1.6K。

工程化技术栈是 pnpm + esno + husky + prettier + eslint + vitest。和 Umi 比较像，区别是有引入 vitest 做测试。非 Vite 项目用 Vitest 做测试我是存疑的，跑起来并不会比 jest + esbuild 快。另外有引入 dependency-check 做 import 依赖有效性的检测。prettier 规则基于 [AppLint](https://github.com/apptools-lab/AppLint)（Star 12），淘系的质量规范库。

产出是 type=module，esm 格式，直接针对源码做 tsc 编译产出。npm 包有点大，只安装 @ice/app 是 329.7MB，相比之下 umi@4 是 115.2MB。

ice 通过 [build-scripts](https://github.com/ice-lab/build-scripts) 提供 config 读取和 plugin 能力。build-scripts 是 ice 2 的核心能力，除了config 和 plugin，还包含 command、webpack、test 等。而 ice 3 只用了 config 和 plugin 能力，command 和 webpack 在 ice 3 仓库中自行实现，猜测目前是过渡阶段而不是最终设计。

其他依赖。命令行基于 [commander.js](https://github.com/tj/commander.js)（Star 22K)，https 证书基于自研的 [trusted-cert](https://github.com/sprying/trusted-cert)（Star 2），端口检测基于 [detect-port](https://github.com/node-modules/detect-port)（Star 300+），日志基于 [consola](https://github.com/unjs/consola)（Star 3.7K）。

ice 提供了 build、start 和 test 三个命令，test 应该还在施工中，没看到代码。

build 只支持 webpack（我记得 ice 2 是支持 vite 的）；start 就是 dev，直接基于 webpack-dev-server 实现。一个有意思的点是有使用 [unplugin](https://github.com/unjs/unplugin)（Star 1.1K）做 webpack 插件开发，应该是给未来同时支持 Vite 提前做的布局。build 时还会额外构建 src/app 到 node\_modules/entry.mjs，基于 esbuild。ice 中适当封装了 esbuild，提供 style、assets 和 alias 插件适配常见场景。

整体感觉还处于开发阶段，有不少缺失的功能，同时没有看到 ice 3 的亮点，过段时间再研究了。

参考：  
[https://github.com/ice-lab/ice-next](https://github.com/ice-lab/ice-next)  
[https://github.com/ice-lab/build-scripts](https://github.com/ice-lab/build-scripts)
