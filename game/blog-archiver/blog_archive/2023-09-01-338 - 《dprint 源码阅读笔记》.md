---
title: "338 - 《dprint 源码阅读笔记》"
date: 2023-09-01
url: https://sorrycc.com/dprint
---

发布于 2023年9月1日

# 338 - 《dprint 源码阅读笔记》

1、实现了一个 Environment 的 trait，所有和物理环境的交互都基于此。真实项目用 real\_environment，测试项目用 test\_environment（即 memo fs）。能想到的一个好处是后续如果要产出 wasm 跑在浏览器里时会非常容易。

2、插件基于 wasm 实现。实现上用 wasmer（[https://github.com/wasmerio/wasmer）挂载和执行。以](https://github.com/wasmerio/wasmer%EF%BC%89%E6%8C%82%E8%BD%BD%E5%92%8C%E6%89%A7%E8%A1%8C%E3%80%82%E4%BB%A5) dprint-plugin-typescript 为例，插件需要依赖 dprint-core 并实现 SyncPluginHandler 或 AsyncPluginHandler，通常我们能在 generation/generate.rs 里找到 ast to code 的实现。

3、错误处理是 anyhow + thiserror。错误通过 anyhow::Result 层层往上传，最终在 main 层通过 eprintln 打印 AppError 并退出。AppError 实现 From traint 方便做各个错误类型到 AppError 的类型转换。但有个交互上的例外是，format 相关的错误遇到了是会实时打印出来的。

anyhow 两个 tip，1）用 bail! 简化 return anyhow::Error 的写法，2）用 context 可以让一个错误类型拥有多个不同的上下文，先 use anyhow::Context; 然后 .context() 或 .with\_context()。

4、Mutex、RwLock、Condvar 这些数据类型用的 parking\_lot 的实现，据说比标准库的快 5-50 倍。

5、命令行解析基于 clap。

6、最后，学习下 dprint 里用到的其他依赖包。

one\_cell，用于实现 lazy statics。  
dunce，处理 win 路径。  
crossterm，terminal 操作库，比如改写光标位置、输出不同颜色、清空 Terminal 等。  
dirs，兼容多平台地找 home、config、可执行等目录。  
ignore，目录的快速迭代器，支持 ignore、glob 等过滤规则。  
similar，包含多种文本 diff 算法。  
ureq，最简请求库。  
rkyv，零拷贝反序列化框架。  
pretty\_assertions，用于测试环节代替 assert\_eq 等。  
tempfile，用于确定临时文件和临时目录。

参考：  
[https://github.com/dprint/dprint](https://github.com/dprint/dprint)
