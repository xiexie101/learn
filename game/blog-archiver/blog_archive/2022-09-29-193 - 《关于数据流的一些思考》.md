---
title: "193 - 《关于数据流的一些思考》"
date: 2022-09-29
url: https://sorrycc.com/data-flow-thoughts
---

发布于 2022年9月29日

# 193 - 《关于数据流的一些思考》

这几天把 valtio 内置到 umi 了，以插件的形式（Bigfish 中无需插件）。随后就开始写大量示例，自己先踩踩坑，写了远程数据的 Todo List、HackerNews Clone、有本地存储和文件系统的 Markdown 预览工具。感觉又回到了 Redux 和 Dva 的时代，但是以更现代的方式，写起来感觉很爽，因为数据和视图分离和我的心智非常契合。代码在 [https://github.com/umijs/example-with-valtio](https://github.com/umijs/example-with-valtio) 。

## 优点

先说下优点。

1、数据与视图分离的心智模型。不再需要在 React 组件或 hooks 里用 useState 和 useReducer 定义数据，或者在 useEffect 里发送初始化请求，或者考虑用 context 还是 props 传递数据。如果熟悉 dva，你会在此方案中找到一丝熟悉的感觉，概念上就是 reducer 和 effects 换成了 actions，subscriptions 则换了种形式存在。

```ts
const store = proxyWithSubScriptions({
  count: 1,
  actions: { add() { store.count += 1; } }
}, {
  subscriptions: {
    setup({ history }) { return history.listen(...); },
  },
});
```

如果你想要 dva 的语法糖，还可以再包一层变这样，有没有很熟悉？

```ts
const store = createStore({
  state: { count: 1 },
  actions: { add() { store.count += 1; } },
  subscriptions: {
    setup({ history }) { return history.listen(...); },
  },
});
```

2、更现代的 dva？「现代」主要出于这些点，1）基于 proxy，mutable，所以更新更简单，同时读取更高效，无需 selector，tracking with usage，2）没有中心化的 actions，以及基于组合式的扩展机制，这些都是对 TypeScript 更友好的方式，3）更少脚手架代码。

## 缺点

再看缺点。

1、兼容性。由于基于 proxy，所以不支持 IE 11、Chrome 48、Safari 9.1、Firefox 17 和 Opera 35 等。如果你的项目目前或未来有兼容需求，不要用。

2、非 Hooks 数据流。这不一定算缺点，看从什么角度看。但如果你是从 useModel、hox 这类 Hooks 数据流切过来，会发现有些事情不能做了。不能在 state 里组合其他的 hooks 数据，也不能在 actions 调用其他的 hooks 方法。我就想用 hooks 的方式组织，怎么办？解法是把 valtio 的 store 作为一个原子，和其他 hook 结合使用，而不是在 store 里调用其他 hook。

```ts
function customHook() {
  const [text, setText] = useState();
  const { count } = useSnapshot(store);
  function setCount(count) { store.count = count };
  return [count, text, setText, setCount];
}
```

## 怎么选

再看怎么选。不数不知道，一数。。。发现 Umi/Bigfish 体系里居然一共有 5 个方案可以选，纯 Hooks、useRequest、useModel、dva 和 valtio。现在你拿到一个项目，在这些方案面前，应该如何选？

个人的建议如下。

1、遇到之前适用于 useModel 和 dva 的场景，换 valtio。valtio 既使用简单场景，也适用复杂场景。

2、Hooks 可用于保存一些临时的 UI 数据，但不要把纯 Hooks 当数据流用，即用来存大量状态。纯 Hooks 管理大量状态，会面临着代码量多、useState useReducer 选择困难、context props 传值选择困难、代码放 component 还是 hooks 的选择困难、潜在的性能问题、immutable 方式更新数据繁琐等问题。以及，还有 Hooks 陡峭的学习曲线。

3、useRequest 类远程状态库和 valtio 数据流之间如何选，我还没完全想透。1）当我们只需同步远程服务器的状态时而无需本地操作状态时，用 useRequest，2）当我们有本地状态操作需求，或者有状态的 redo/undo、持久化、跨组件/路由/应用共享时，用 valtio 数据流，3）没想好的是，前两个场景之间还有不少中间状态，这些我还没想透应该定什么样的标准，以帮助开发者做选择。

## 开始使用

先在配置开启 `valtio: {}`。

```ts
export default {
  valtio: {},
}
```

然后就能从 `@alipay/bigfish` 中使用 valtio 相应的 API 了。

```ts
import {
  proxy, useSnapshot, snapshot, subscribe,
  proxyWithComputed,
  proxyWithHistory,
  proxyWithDevtools,
  proxyMap,
  proxySet,
} from '@alipay/bigfish';
```

通常是在 `src/stores` 下新建 store 文件，或者在 page 下新建 page 级的 `store.ts`。

```ts
export const store = proxy({
  count: 1,
  actions: { add() { store.count += 1; } }
});
```

然后在组件里使用。

```ts
function App() {
  const { count } = useSnapshot(store);
  return <div onClick={store.actions.add}>{count}</div>;
}
```

详见[使用文档](https://bigfish.antgroup-inc.cn/docs/advanced/valtio)。
