---
title: "68 - 《手写 prettier 插件》"
date: 2022-03-07
url: https://sorrycc.com/write-a-prettier-plugin
---

发布于 2022年3月7日

# 68 - 《手写 prettier 插件》

prettier 虽内置了大量规则，但遇到特殊场景，还是有自定义的需求。比如 umi-next 仓库中的 schema 定义，[https://shrtm.nu/lL14，包含大量配置，而由于量大，我希望这里是基于字母排序的。但是](https://shrtm.nu/lL14%EF%BC%8C%E5%8C%85%E5%90%AB%E5%A4%A7%E9%87%8F%E9%85%8D%E7%BD%AE%EF%BC%8C%E8%80%8C%E7%94%B1%E4%BA%8E%E9%87%8F%E5%A4%A7%EF%BC%8C%E6%88%91%E5%B8%8C%E6%9C%9B%E8%BF%99%E9%87%8C%E6%98%AF%E5%9F%BA%E4%BA%8E%E5%AD%97%E6%AF%8D%E6%8E%92%E5%BA%8F%E7%9A%84%E3%80%82%E4%BD%86%E6%98%AF) 1）手动排序费精力 2）多人协作时很容易忽视。

这类工作交给工具是比较合适的。有个可选项是 eslint，因为 eslint 有 sort-keys 的规则。但是风格类的我更希望交给 prettier，eslint 管质量类的就好。然后翻了下 prettier 是否有相关规则和插件，没有找到，于是只能手写 prettier 插件了。

prettier 插件包含两部分，parser 和 printer。parser 用于将源码转成 ast，printer 用于做 ast 的风格化。所以写插件其实有不少选择，在 parser.preprocess、parser.parse、printer.print 都可以实现需求。

1、比如 prettier-plugin-organize-imports 是在 parser.preprocess 里做的 import 排序。preprocess 里拿到源码，然后通过任意方式处理，比如正则、Babel、Typescript Language Service 均可。prettier-plugin-organize-imports 用 TypeScript Language Service 做的，因为 ts 里正好有 organizeImport 的实现。

2、比如 prettier-plugin-tailwindcss 是在 parser.parse 里做的处理。这个方案比较轻，相比 preprocess 里用 babel 解析一遍，性能会更好。方案是调用原 parse 拿到 ast，操作 ast 即可。

示例代码如下，在 transform 里操作 AST 即可，

```ts
const { parsers: typescriptParsers } = require('prettier/parser-typescript');
function createParser(original, transform) {
 return {
  ...original,
  parse: (text, parsers, options) => {
   const ast = original.parse(text, parsers, options);
   transform(ast, { ...options, text });
   return ast;
  }
 }
}
function transform(ast, options) {
 // 这里操作 AST
}
export.parsers = {
 typescript: createParser(typescriptParsers.typescript, transform),
}
```

详见 Commit，[https://github.com/umijs/umi-next/commit/865d0e163aa0880c2a78086ba33696530eba8c3b](https://github.com/umijs/umi-next/commit/865d0e163aa0880c2a78086ba33696530eba8c3b)

3、prettier 没有提供 printer 的扩展方法，所以不太容易在 printer 层修改 AST，不建议在这一层处理。printer 通常是给新的语言用，比如要支持 .toml 或其他 prettier 没有内置支持的文件类型。

参考：  
[https://eslint.org/docs/rules/sort-keys](https://eslint.org/docs/rules/sort-keys)  
[https://prettier.io/docs/en/plugins.html](https://prettier.io/docs/en/plugins.html)  
[https://github.com/simonhaenisch/prettier-plugin-organize-imports](https://github.com/simonhaenisch/prettier-plugin-organize-imports)  
[https://github.com/tailwindlabs/prettier-plugin-tailwindcss](https://github.com/tailwindlabs/prettier-plugin-tailwindcss)
