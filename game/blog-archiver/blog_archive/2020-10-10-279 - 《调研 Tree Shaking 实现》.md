---
title: "279 - 《调研 Tree Shaking 实现》"
date: 2020-10-10
url: https://sorrycc.com/tree-shaking
---

发布于 2023年3月28日

# 279 - 《调研 Tree Shaking 实现》

> 调研了下 Tree Shaking 的实现，没实操，有些细节的点还不够清楚。以下是笔记。

## 什么是 tree-shaking？

比如两个文件 a.js 和 main.js 如下，其中 main.js 是入口文件。可以看出，a.js 里的 b 没有被用到，所以产物里不应该出现。这就是 tree-shaking。

```ts
// a.js
export const a = 1;
export const b = 2;

// main.js
import { a } from './a';
console.log(a);
```

> Tree shaking, also known as dead code elimination, is the practice of removing unused code in your production build. It’s important to ship as little code to your end-users as possible. By statically analyzing our source code, we can determine what’s not being used and exclude it from our final bundle.

树摇，也称为死代码消除，是在生产构建中删除未使用的代码的实践。将尽可能少的代码发送给最终用户非常重要。通过静态分析源代码，我们可以确定哪些内容没有被使用，并将其从最终捆绑包中排除掉。

上面的例子是最基础的 export 级的 tree-shaking。而 tree-shaking 要做好，需要在安全的基础上，尽可能多删除无用代码。所以，还会有大量进阶的例子。比如：

*   支持 `export *` 和 `import *`（可能有多级）
*   支持内部模块 tree-shaking（比如内部的一个变量、函数或 class 没有被用到，也可以删除）
*   支持 cjs（cjs 是动态 require 的，理论上不能 tree-shaking，但其实没用到动态 require 功能的 cjs 也可以支持）
*   支持 package.json 中的 sideEffects 声明（用于声明当前包的是否有副作用，有则不参与 tree-shaking）
*   支持 `await import()`（[rollup 不支持](https://github.com/rollup/rollup/issues/3447)）
*   支持 `cycle` 依赖（比较难）
*   识别有副作用的写法
*   …

## Webpack 如何实现？

以下是 webpack 4 的实现。

webpack 4 实现的思路分几步。1）分析是得出每个 module 的 export 信息；2）标记出每个 module 的 export 的使用情况；3）基于标记信息生产代码，没有被使用的 export 不会出 `__webpack_require__.d(__webpack_exports__, {})` 的定义里，4）基于 Terser、UglifyJS 等压缩工具的 DCE（Dead Code Elimination） 能力清除代码。

webpack 5 在 4 的基础上改进了很多，包括不基于压缩工具的 DCE 等。

## Rollup 如何实现？

Rollup 的实现复杂很多，基于 AST 做 bind、include 和 render 等操作来建立语句之间的关联，以此精确实现废弃代码的删除。所以理论上，Rollup 的 tree-shaking 效果应该是更好的。

基本思路是这样。（没详细看完，以下基于代码加小部分个人猜测）

1、给 modules 排序，比如 a > b > c，那么应该是 c、b、a 这样的顺序，被依赖的往前  
2、算出 cycle module，比如 a > b > c > b，那么 b 就是 cycle module，需要注意的是，比如 a > b > d + a > c > d，这个 d 同时被 b 和 c 依赖，但他不是 cycle module（cycle module 不 tree-shaking）  
3、dynamicImport 的 module 单独计算排序和 cycle 依赖  
4、bind reference，绑定赋值到变量，同时处理作用域  
5、include statement  
6、处理 entry module、cycle module、cjs module、side effects 等，不做 tree-shaking  
7、render，基于 statement graph，只渲染（生成）用到的代码

> Rather than excluding dead code, we’re including live code. – Rich Harris

Rollup 的思路是反着来的，不是消除死代码，而是 include 用到的代码。

参考：  
[Tree-shaking versus dead code elimination | by Rich Harris | Medium](https://medium.com/@Rich_Harris/tree-shaking-versus-dead-code-elimination-d3765df85c80)  
[GitHub - rollup/rollup: Next-generation ES module bundler](https://github.com/rollup/rollup)  
[Webpack 原理系列九：Tree-Shaking 实现原理 - 掘金](https://juejin.cn/post/7002410645316436004)  
[Webpack 5 release (2020-10-10) | webpack](https://webpack.js.org/blog/2020-10-10-webpack-5-release/)  
[Tooling.Report](https://bundlers.tooling.report/)  
[feat: tree shake by wre232114 · Pull Request #99 · farm-fe/farm · GitHub](https://github.com/farm-fe/farm/pull/99)  
[GitHub - lukastaegert/eslint-plugin-tree-shaking: Marks side-effects in module initialization that would interfere with tree-shaking](https://github.com/lukastaegert/eslint-plugin-tree-shaking)  
[rspack/crates/rspack/tests/tree-shaking · GitHub](https://github.com/modern-js-dev/rspack/blob/6c22915b71d791bed63579646e520aa7636c79c5/crates/rspack/tests/tree-shaking)
