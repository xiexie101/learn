---
title: "94 - 《Bigfish 4 特性 06：那些小而美的改进》"
date: 2022-04-11
url: https://sorrycc.com/bigfish-4-feat-06-small-improvements
---

发布于 2022年4月11日

# 94 - 《Bigfish 4 特性 06：那些小而美的改进》

> 4 月会更新 20 篇 Bigfish 4（含 Umi 4）的新特性，这是第六篇。

Bigfish 4 做了不少小而美的改进，算不上大功能，但却又有助于提升开发者体验（DX）。时间仓促，先凭记忆整理一上篇，之后会再补一下篇。

1、项目级插件：plugin.ts

Bigfish 是高度可定制的，定制的方式可以通过配置或插件，但二者能修改的点还是相差很大的。配置可以修改 40%，而插件可以修改 80%。所以要定制 Bigfish，会配置和会写插件是完全两个层级的。同时写插件的门槛也并不高。

为进一步降低项目中使用插件的门槛，Bigfish 4 中约定项目根目录下的 plugin.ts 为插件，开发者可在此直接调用插件 API，无需注册，支持 TypeScript。

有了这个文件，我们可以在项目级做很多事。比如，

```js
import { IApi } from '@alipay/bigfish';
export default (api: IApi) => {
 // 比如修改 HTML
 api.modifyHTML($ => {
  return $;
 });
 // 比如在入口的 umi.ts 中添加代码
 api.addEntryCodeAhead(() => [`console.log('entry code ahead')`]);
 api.addEntryCode(() => [`console.log('entry code')`]);
 // 比如在构建完成时做额外的事
 api.onBuildComplete((opts) => {});
 // 比如在启动阶段做额外的事
 api.onStart((opts) => {});
 // 比如校验每个 JavaScript/TypeScript 代码
 api.onCheckCode((args) => {});
 // 比如动态修改路由
 api.modifyRoutes((routes) => {});
}
```

2、umi.js 产物调试

不知大家是否会有这样的需求，开发项目时发现一些比较复杂的问题时，需要调整构建产物的代码。而 Bigfish 基于 webpack-dev-server，在 dev 阶段所有文件都存于内存中，没有物理文件的形式，并不方便直接修改后验证效果。

如果大家用 Bigfish 4，可以把 umi.js 等产物文件保存到项目根目录，然后可以直接修改即生效。（注：临时文件用完记得删除，否则修改源码会不生效。）

![](https://img.alicdn.com/imgextra/i1/O1CN01n94qZF1To4ZRp6OKj_!!6000000002428-1-tps-776-611.gif)

3、自动 https

Bigfish 4 的 https dev server 的实现基于 mkcert，启动过程中会基于 hosts 自动生成对应的 key 和 cert。开发者除了安装前置的 mkcert，其他无需关心。

![](https://img.alicdn.com/imgextra/i4/O1CN01DtjfW81YqQghVVCcv_!!6000000003110-1-tps-702-462.gif)

4、浏览器里的构建进度条

Bigfish 4 的 dev 启动后虽然 server 快，但 webpack 构建还需要一些时间，同时如果没有 MFSU 缓存，MFSU 也会需要一些时间，这时页面会一片空白，对开发者的体感不好。同时，为了命令行的简洁，以及社区 Progress webpack 插件在处理多实例时存在 99% 进度即完成的问题（Bigfish 3 用户应该经常遇到），所以 Bigfish 4 中不再在命令行中显示构建进度条。

解法是在浏览器中显示，支持 webpack 多实例，支持 MFSU，完成初始构建后会自动跳转到项目页。见下图。（样式没加，有点难看，意思是这个意思）

![](https://img.alicdn.com/imgextra/i4/O1CN01OelPLl1bCzQcdjfRp_!!6000000003430-1-tps-768-465.gif)

5、把日志打到 terminal 中

此功能复刻自 [https://github.com/patak-dev/vite-plugin-terminal。](https://github.com/patak-dev/vite-plugin-terminal%E3%80%82)

有些开发者会更希望在命令行里看到项目里通过 console 输出的日志，比如我。因为命令行日志不会随着刷新而失效，大家可能都经历过一些一闪而过的页面，想截屏都难；同时命令行日志还可以做物理存储，导出后可以方便他人排查。

开发者在项目中这么写，

```js
import { terminal } from '@alipay/bigfish';
terminal.log(`Some info from the app`);
terminal.log({
 json: { foo: 'bar' },
});
terminal.info(`Hey terminal, A message from the browser`);
terminal.warn(`Watch out, warning from the browser`);
terminal.error(`Ups, testing an error message from the browser`);
```

然后就可以在命令行中看到日志，

![](https://img.alicdn.com/imgextra/i3/O1CN01bYSxy3216HdblRqLS_!!6000000006935-0-tps-914-446.jpg)
