---
title: "245 - 《按需加载 PC 和 Mobile 资源》"
date: 2023-01-15
url: https://sorrycc.com/load-on-demand-pc-and-mobile
---

发布于 2023年1月15日

# 245 - 《按需加载 PC 和 Mobile 资源》

先说下背景。上周在给蚂蚁招聘官网做优化，调研时发现，由于招聘官网同时有 pc 和 mobile 的访问需求，所以会需要用到 antd 和 antd-mobile，而存在的问题是，antd 和 antd-mobile 会被打包在一起。这意味着，不管你是用 pc 还是 mobile 访问，都会给你 antd + antd-mobile。这肯定不是期望的，期望的是 pc 访问时给 antd，mobile 访问时给 antd-mobile。

怎么做呢？我先为了下「Umi Contributor」群里的同学，得到如下答案：

1、hooks + suspense + throw promise  
2、umd proxy  
3、await import() + splitChunks  
4、index.pc.ts + index.mobile.ts，打包两套产物

然后找团队同学实践了下，得到的方案是「React.lazy + isMobile + await Import()」，代码见 [https://github.com/sorrycc/pc-mobile-example/tree/master/lazy-isMobile-awaitImport](https://github.com/sorrycc/pc-mobile-example/tree/master/lazy-isMobile-awaitImport) 。

先定义一个兼容用的 Button 组件，基于 isMobile 判断，决定装载 antd 还是 antd-mobile。

```ts
import React from 'react';

let Button;
const isMobile =
  /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
    navigator.userAgent,
  );
if (isMobile) {
  Button = React.lazy(async () => {
    const antdMobile = await import/* webpackChunkName: "antd-mobile" */('antd-mobile');
    return { default: antdMobile.Button };
  });
} else {
  Button = React.lazy(async () => {
    const antd = await import/* webpackChunkName: "antd" */('antd');
    return { default: antd.Button };
  });
}

export { Button };
```

几个注意点，

1、React.lazy 返回的是 `Promise<Module>`，记得要用 `{default}` 把你的组件包起来  
2、加 webpackChunkName 可以让产物更明确  
3、这里做了简化，Antd 和 AntdMobile 的 Button 在 props 时差异较大，可能需要包一层组件做兼容

然后我再试了下 umd proxy 的方案，就是基于上述方案，然后把 antd 和 antd-mobile 用 umd 的方式引用，代码见 [https://github.com/sorrycc/pc-mobile-example/tree/master/umd-proxy](https://github.com/sorrycc/pc-mobile-example/tree/master/umd-proxy) 。

Umi 配置如下。

```ts
export default {
  externals: {
    react: 'React',
    'react-dom': 'ReactDOM',
    dayjs: 'dayjs',
    antd: ["script https://unpkg.com/antd@5.1.4/dist/antd.min.js", 'antd'],
    'antd-mobile': ["script https://unpkg.com/antd-mobile@5.28.0/umd/antd-mobile.js", 'antdMobile'],
  },
  headScripts: [
    'https://unpkg.com/react@18.2.0/umd/react.production.min.js',
    'https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js',
    'https://unpkg.com/dayjs@1.11.7/dayjs.min.js',
  ],
};
```

几个注意点，

1、external antd（v5） 还需要 external react、react-dom 和 dayjs  
2、antd 和 antd-mobile 我用了 script external，这是一种按需 external 的方法，参考 [35 - 《按需 externals》](https://sorrycc.com/dynamic-externals)

hooks + suspense + throw promise 的方案我没有试，因为感觉这个需求不存在。通过 hooks 的作用在于，实时判断 isMobile，然后返回 pc 或 mobile 的组件。而我们通常要么在 pc 打开，要么在 mobile 打开。不会存在先 pc 打开，然后动态切换到 mobile 的场景，这只有在开发者自己调试时才会这么做。
