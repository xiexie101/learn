---
title: "113 - 《手撕源码 08：unbuild》"
date: 2022-05-12
url: https://sorrycc.com/source-08-unbuild
---

发布于 2022年5月12日

# 113 - 《手撕源码 08：unbuild》

unbuild 依赖了 mkdist、jiti、untyped、defu、hookable 等库。这些库都在 [unjs](https://github.com/unjs/) 的 org 下，这是一套包含如何实现工具/库的底层库。

★ 三种构建模式。  
unbuild 支持三种构建模式，1）mkdist 文件到文件，2）rollup 打包模式，3）untyped。untyped 是 unbuild 独创的功能，基于 Object 对象然后生成类型、schema 和 markdown 文件。

★ 如何区分是 mkdist 还是 rollup？  
entry 如果以 / 结尾，会用 mkdist 做文件到文件的编译，否则用 rollup 做打包编译。

★ mkdist 如何做文件到文件的编译？  
用 globby 找出所有文件，通过一个简单的 loader 机制（内置了 vue 和 js loader），让每个文件跑一遍 loader 做转换，然后输出到 ouput 目录。js loader 中，ts 到 js 的编译时用 esbuild，mjs 到 cjs 的编译时用 jiti().transform()。

★ stub 是干啥的？  
stub 时不做具体编译。如果是 mkdist 的文件到文件编译，只是把 input symlink 到 output 目录；如果是 rollup 编译，生成产物需要的 .cjs、.mjs 和 .d.ts，其内容是从 input 文件动态引入。有个小点是，如果文件是 shebang 文件，会改成 0755 可执行文件。

★ 类型如何生成？  
rollup 模式下，类型基于 rollup-plugin-dts 实现，会单独做一次类型构建；mkdist 模式下，类型用 typescript 库生成，并且通过 vfs 虚拟文件的方式，改写了 tsHost 的 writeFile 和 readFile，只产出对应文件的类型文件。

```ts
const tsHost = ts.createCompilerHost(compilerOptions);
const program = ts.createProgram(input, compilerOptions, tsHost);
await program.emit();
```

★ untyped 构建是做什么的？  
声明了 builder 为 untyped 的会做 untyped 构建。untyped 会声明。

★ 额外的校验环节。  
build 结构后会做依赖和 package.json 的校验。依赖校验是，告诉你有哪些未使用的依赖和使用了却未声明的依赖；package.json 的校验是，找出 package.json 中声明的文件，如果某文件不存在，给警告。
