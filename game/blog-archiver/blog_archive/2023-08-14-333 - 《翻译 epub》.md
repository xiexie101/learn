---
title: "333 - 《翻译 epub》"
date: 2023-08-14
url: https://sorrycc.com/translate-epub
---

发布于 2023年8月14日

# 333 - 《翻译 epub》

前几天看到有人分享如何利用 [Immersive Translate](https://chrome.google.com/webstore/detail/immersive-translate/bpoadfkcbjbfhfodiogcnhhhpibjhbnh) 翻译 epub，想起之前问同事要过相关 Shell 代码却没看过，晚上翻了下，转成 Node.js 的风格，把流程跑通了。

代码如下。

```ts
import assert from 'assert';
import 'zx/globals';

$.verbose = false;

(async () => {
  const cwd = process.cwd();
  const book = argv._[0];
  assert(book, 'book name is required');
  const bookPath = path.resolve(cwd, book);
  const targetBookPath = bookPath.replace(/\.epub$/, '.translated.epub');
  assert(fs.existsSync(bookPath), `book ${book} not found`);
  const tempDir = path.join(__dirname, 'tmp', 'translate-epub-book');
  await $`rm -rf ${tempDir}`;
  await $`mkdir -p ${tempDir}`;
  await $`unzip "${bookPath}" -d  ${tempDir}`;
  const files = globby.globbySync('**/*.(xhtml|html|htm)', { cwd: tempDir });
  for (const file of files) {
    await translateFile(path.join(tempDir, file));
  }
  await $`cd ${tempDir} && zip -X0  ../test.book.epub  mimetype`;
  await $`cd ${tempDir} && zip -rDX9 ../test.book.epub * -x *.DS_Store -x mimetype`;
  fs.moveSync(path.join(tempDir, '../test.book.epub'), targetBookPath);
})().catch((e) => {
  console.error(e);
  process.exit(1);
});

async function translateFile(file: string) {
  let content = fs.readFileSync(file, 'utf-8');
  // TODO: translate
  content = content.replace('</body></html>', '<h1>Translated</h1></body></html>');
  fs.writeFileSync(file, content, 'utf-8');
}
```

补充一些说明，

1、epub 本质上就是 zip 格式，如果你手动改成 .zip 后缀，就可以用解压软件解压了。关于 epub 的具体格式可以问下 chatgpt 。

2、解压出来可能包含 html、htm 或 xhtml，这些属于内容文件。我们所需要做的就是把这些内容文件翻译。所以基本思路是，1）解压，2）翻译，3）压回 epub。

3、translate 部分由于我目前基于的 deepl 大家没办法直接用就不展开写了，大家可以用 openai、caiyun、腾讯等服务代替。基本思路是用 cheerio 分析 dom，然后以此翻译 h1、h2、h3、h4、p、li、blockquote 等标签，并插入翻译后的版本到标签后面。
