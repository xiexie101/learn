<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤å¤æ‹ç«‹å¾— - é»˜è®¤ç…§ç‰‡ç‰ˆ</title>
    <style>
        /* =========================================
           1. å…¨å±€åŸºç¡€æ ·å¼
           ========================================= */
        body {
            margin: 0;
            height: 100vh;
            background-color: #dcdcdc;
            background-image: radial-gradient(#b0b0b0 15%, transparent 16%), radial-gradient(#b0b0b0 15%, transparent 16%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            font-family: "KaiTi", "STKaiti", "Courier New", serif;
            overflow: hidden;
            overscroll-behavior: none;
            user-select: none;
            display: flex;
            flex-direction: column;
        }
    
        /* =========================================
           2. è®¾ç½®é¢æ¿ (æ¡Œé¢ç«¯é»˜è®¤æ ·å¼)
           ========================================= */
        .settings-panel {
            position: absolute; left: 20px; top: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            z-index: 500;
            display: flex; flex-direction: column; gap: 15px;
            width: 240px;
            backdrop-filter: blur(5px);
        }
    
        .panel-section { display: flex; flex-direction: column; gap: 5px; }
        .panel-label { font-size: 12px; font-weight: bold; color: #666; letter-spacing: 1px; }
        
        .text-input {
            padding: 8px; border: 1px solid #ccc; border-radius: 8px;
            font-family: "KaiTi", "STKaiti", "Comic Sans MS", sans-serif; 
            font-size: 16px; outline: none; width: 100%; box-sizing: border-box;
            color: #333; background: #fafafa;
        }
        .text-input:focus { border-color: #333; background: #fff; }
    
        .color-options { display: flex; gap: 10px; }
        .color-dot {
            width: 24px; height: 24px; border-radius: 50%; 
            cursor: pointer; border: 2px solid #eee; transition: transform 0.2s;
        }
        .color-dot:hover { transform: scale(1.1); }
        .color-dot.active { border-color: #333; transform: scale(1.1); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        .filter-options { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .filter-btn {
            padding: 6px; border: 1px solid #ddd; background: #fff; border-radius: 6px; 
            cursor: pointer; font-size: 13px; font-family: "KaiTi", "STKaiti", sans-serif; transition: all 0.2s;
        }
        .filter-btn:hover { background: #f0f0f0; }
        .filter-btn.active { background: #333; color: white; border-color: #333; }
    
        /* =========================================
           3. æŒ‰é’®ç»„
           ========================================= */
        .ui-buttons {
            position: absolute; top: 20px; right: 20px; z-index: 2000; display: flex; gap: 10px;
        }
        .btn {
            padding: 10px 20px; border: 2px solid #333; background: white;
            border-radius: 30px; cursor: pointer; font-weight: bold; font-size: 14px;
            box-shadow: 2px 2px 0 rgba(0,0,0,0.1); font-family: "KaiTi", "STKaiti", sans-serif; transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.95); box-shadow: none; }
        .btn.disabled { opacity: 0.6; background: #eee; pointer-events: none; color: #999; border-color: #ccc; box-shadow: none; }
        .btn-download { background: #333; color: white; border-color: #fff; }
    
        /* =========================================
           4. ä¸»å®¹å™¨ä¸ç›¸æœº
           ========================================= */
        #app-container {
            display: flex; width: 100%; height: 100%;
            flex-direction: row; align-items: center; justify-content: space-between;
            padding: 0 50px; box-sizing: border-box;
        }
    
        .camera-wrapper {
            position: relative; width: 400px; z-index: 10; flex-shrink: 0; margin-left: 280px;
        }
        .camera-img {
            width: 100%; display: block; filter: drop-shadow(0 15px 35px rgba(0,0,0,0.3)); pointer-events: none;
        }
        .lens-container {
            position: absolute; top: 37%; left: 43.5%; width: 35%; height: 35%;
            border-radius: 50%; overflow: hidden; background: #111; z-index: 1; box-shadow: inset 0 0 15px #000;
        }
        video#viewfinder {
            width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); transition: filter 0.3s; opacity: 0.9;
        }
        .lens-glare {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2) 0%, transparent 60%);
            pointer-events: none; z-index: 2;
        }
        .flash-overlay {
            position: absolute; top: 14%; left: 14%; width: 24%; height: 18%;
            background: white; opacity: 0; pointer-events: none; z-index: 30;
            mix-blend-mode: hard-light; border-radius: 4px; filter: blur(2px); transition: opacity 0.1s;
        }
        .shutter-trigger {
            position: absolute; top: 51%; left: 15%; width: 14%; aspect-ratio: 1/1;
            border-radius: 50%; background: transparent; border: none; 
            cursor: pointer; z-index: 20; -webkit-tap-highlight-color: transparent;
        }
        .shutter-trigger:active { transform: scale(0.9); }
    
        /* =========================================
           5. ç…§ç‰‡å¢™
           ========================================= */
        #gallery-area { flex: 1; height: 100%; position: relative; margin-left: 20px; }
        .polaroid {
            position: absolute; width: 160px;
            padding: 10px 10px 40px 10px;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.15);
            transition: transform 0.2s, box-shadow 0.2s;
            transform-origin: center; cursor: grab; touch-action: none;
        }
        .polaroid:active { cursor: grabbing; }
        .polaroid.selected {
            box-shadow: 0 0 0 3px #4a90e2, 15px 15px 40px rgba(0,0,0,0.3);
            z-index: 9999 !important; transform: scale(1.05) !important;
        }
        .polaroid img {
            width: 100%; display: block; background: #000;
            transition: filter 4s ease-in-out; pointer-events: none;
        }
        .polaroid-text {
            position: absolute; bottom: 10px; left: 0; width: 100%;
            text-align: center; font-size: 12px;
            font-family: "KaiTi", "STKaiti", "Comic Sans MS", sans-serif; pointer-events: none;
        }
    
    
        /* =========================================
           ğŸ”¥ğŸ”¥ğŸ”¥ ç§»åŠ¨ç«¯é€‚é…ï¼šå•è¡Œæ»‘åŠ¨ + æç¤º ğŸ”¥ğŸ”¥ğŸ”¥
           ========================================= */
        @media (max-width: 768px) {
            
            #app-container {
                flex-direction: column;
                padding: 0;
                justify-content: flex-start;
            }
    
            /* --- 1. è®¾ç½®é¢æ¿ (å•è¡Œæ»‘åŠ¨ç‰ˆ) --- */
            .settings-panel {
                position: relative; 
                top: 0; left: 0; 
                width: 100%;
                height: auto; 
                
                /* å…³é”®å¸ƒå±€ï¼šå•è¡Œ + æ»šåŠ¨ */
                display: flex;
                flex-direction: row; 
                flex-wrap: nowrap; /* å…³é”®ï¼šç¦æ­¢æ¢è¡Œ */
                align-items: center;
                justify-content: flex-start;
                
                overflow-x: auto; /* å¼€å¯æ¨ªå‘æ»šåŠ¨ */
                -webkit-overflow-scrolling: touch;
                
                border-radius: 0 0 15px 15px;
                /* åº•éƒ¨åŠ  padding ç»™æç¤ºæ–‡å­—ç•™ä½ç½® */
                padding: 12px 15px 25px 15px; 
                box-sizing: border-box; 
                gap: 20px; 
                box-shadow: 0 5px 10px rgba(0,0,0,0.05);
            }
            
            .settings-panel::-webkit-scrollbar { display: none; }
    
            /* --- è§†è§‰æç¤º 1ï¼šåº•éƒ¨æ–‡å­— --- */
            .settings-panel::after {
                content: "â† å·¦å³æ»‘åŠ¨æ›´å¤šé€‰é¡¹ â†’"; /* æç¤ºæ–‡æ¡ˆ */
                position: absolute;
                bottom: 5px;
                left: 0;
                width: 100%;
                text-align: center;
                font-size: 10px;
                color: #999;
                pointer-events: none;
            }
    
            /* --- è§†è§‰æç¤º 2ï¼šå³ä¾§æ¸å˜ (æš—ç¤ºè¿˜æœ‰å†…å®¹) --- */
            .settings-panel::before {
                content: "";
                position: absolute;
                right: 0; top: 0; bottom: 0;
                width: 40px;
                /* ä»é€æ˜åˆ°ç™½è‰²çš„æ¸å˜ */
                background: linear-gradient(to right, transparent, rgba(255,255,255,0.95));
                pointer-events: none;
                z-index: 10;
                border-radius: 0 0 15px 0;
            }
    
            /* --- å…³é”®ï¼šé˜²æ­¢å­æ¿å—å˜å½¢ --- */
            .panel-section { 
                flex-shrink: 0; /* å…³é”®ï¼šå¼ºåˆ¶ä¸è®¸å‹ç¼©ï¼ */
                min-width: auto; 
                align-items: center;
            }
    
            .text-input { width: 130px; font-size: 14px; padding: 6px;}
            .filter-options { display: flex; gap: 8px; }
            .filter-btn { padding: 6px 10px; white-space: nowrap; }
    
            /* --- å…¶ä»–ç»„ä»¶ --- */
            #gallery-area { width: 100%; flex: 1; margin: 0; z-index: 5; }
            .polaroid { width: 130px; }
    
            .camera-wrapper {
                width: 85%; max-width: 340px; margin: 0 auto;
                margin-bottom: 90px; 
            }
    
            .ui-buttons {
                position: fixed; top: auto; bottom: 25px;
                right: 50%; transform: translateX(50%);
                width: 90%; justify-content: center;
                background: rgba(255,255,255,0.9);
                padding: 12px; border-radius: 40px;
                backdrop-filter: blur(10px);
                box-shadow: 0 -5px 20px rgba(0,0,0,0.15);
            }
            .btn { flex: 1; text-align: center; padding: 12px 0; }
        }
    </style>
</head>
<body>

    <!-- é¢æ¿ -->
    <div class="settings-panel">
        <div class="panel-section">
            <div class="panel-label">æ–‡å­—ç•™è¨€</div>
            <input type="text" class="text-input" id="customText" value="é‡è§ç¾å¥½ 2025" maxlength="15">
        </div>
        <div class="panel-section panel-sectionOne">
            <div class="panel-label">æ»¤é•œé£æ ¼</div>
            <div class="filter-options">
                <button class="filter-btn active" onclick="setFilter('none', this)">åŸç‰‡</button>
                <button class="filter-btn" onclick="setFilter('grayscale(1) contrast(1.2)', this)">é»‘ç™½</button>
                <button class="filter-btn" onclick="setFilter('sepia(0.5) contrast(1.1)', this)">å¤å¤</button>
                <button class="filter-btn" onclick="setFilter('hue-rotate(180deg)', this)">å†·è°ƒ</button>
            </div>
        </div>
        <div class="panel-section">
            <div class="panel-label">ç›¸çº¸èƒŒæ™¯</div>
            <div class="color-options">
                <div class="color-dot active" style="background:#fff" onclick="setFrameColor('#fff','#222',this)"></div>
                <div class="color-dot" style="background:#222" onclick="setFrameColor('#222','#fff',this)"></div>
                <div class="color-dot" style="background:#ffc0cb" onclick="setFrameColor('#ffc0cb','#222',this)"></div>
            </div>
        </div>
    </div>

    <!-- æŒ‰é’® -->
    <div class="ui-buttons">
        <button class="btn" onclick="resetGallery()">æ¸…ç©º/é‡ç½®</button>
        <button class="btn btn-download disabled" id="downloadBtn" onclick="downloadSelectedPhoto()">ä¸‹è½½å›¾ç‰‡</button>
    </div>

    <div id="app-container">
        <div id="gallery-area"></div>
        <div class="camera-wrapper">
            <!-- ç¡®ä¿ camera_bg.png å­˜åœ¨ -->
            <img src="camera_bg.png" class="camera-img" alt="ç›¸æœºèƒŒæ™¯" onerror="this.style.background='#fdf3d5'">
            <div class="lens-container">
                <video id="viewfinder" autoplay playsinline></video>
                <div class="lens-glare"></div>
            </div>
            <div class="flash-overlay"></div>
            <button class="shutter-trigger" id="shutterBtn"></button>
        </div>
    </div>

    <script>
        const video = document.getElementById('viewfinder');
        const gallery = document.getElementById('gallery-area');
        const shutterBtn = document.getElementById('shutterBtn');
        const flashOverlay = document.querySelector('.flash-overlay');
        const downloadBtn = document.getElementById('downloadBtn');
        const customTextInput = document.getElementById('customText');
        
        let zIndexCounter = 100;
        let audioContext = null;
        let selectedPhotoElement = null;
        let currentFilter = 'none';
        let currentFrameBg = '#fff';
        let currentTextColor = '#222';

        // ğŸ”¥ æ–°å¢ï¼šæ ‡è®°æ˜¯å¦ä¸ºç¬¬ä¸€å¼ ï¼ˆç”¨äºæ¸…é™¤é»˜è®¤ç…§ç‰‡ï¼‰
        let isFirstShot = true;

        // åˆå§‹åŒ–
        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "user", width: { ideal: 1280 }, height: { ideal: 1280 }, aspectRatio: 1 } 
                });
                video.srcObject = stream;
            } catch (err) { console.error(err); }
            
            // ğŸ”¥ é¡µé¢åŠ è½½å®Œæ¯•åï¼Œç”Ÿæˆé»˜è®¤ç…§ç‰‡
            generateDefaultPhotos();
        }

        // ğŸ”¥ æ–°å¢ï¼šç”Ÿæˆ3å¼ é»˜è®¤ç…§ç‰‡çš„å‡½æ•°
        function generateDefaultPhotos() {
            // è¿™é‡Œä½¿ç”¨å ä½å›¾ç‰‡ï¼Œä½ å¯ä»¥æ¢æˆä½ å–œæ¬¢çš„çŒ«çŒ«å›¾æˆ–è€…å…¶ä»–é“¾æ¥
            // ä¸ºäº†æ¼”ç¤ºæ•ˆæœï¼Œæˆ‘ç”¨äº†çº¯è‰²å›¾ç‰‡æˆ–è€…ç½‘ç»œå ä½ç¬¦
            const defaults = [
                { 
                    img: './images/cat.jpg', 
                    text: 'Welcome', date: '2025/01/01', rot: -5, top: 20, left: 20 
                },
                { 
                    img: './images/cat2.jpg', 
                    text: 'To My', date: '2025/02/14', rot: 8, top: 50, left: 60 
                },
                { 
                    img: './images/cat.jpg',  
                    text: 'Camera App', date: '2025/05/20', rot: -3, top: 70, left: 30 
                }
            ];

            const isMobile = window.innerWidth <= 768;

            defaults.forEach((d, index) => {
                const div = document.createElement('div');
                div.className = 'polaroid developed'; // ğŸ”¥ ç›´æ¥åŠ ä¸Š developed ç±»ï¼Œé»˜è®¤ç…§ç‰‡ä¸éœ€è¦æ˜¾å½±åŠ¨ç”»
                
                // å­˜å‚¨æ•°æ®æ–¹ä¾¿ä¸‹è½½
                // æ³¨æ„ï¼šå› ä¸ºæ˜¯ç½‘ç»œå›¾ç‰‡ï¼Œä¸‹è½½å¯èƒ½ä¼šæœ‰è·¨åŸŸé—®é¢˜ï¼Œè¿™é‡Œä»…åšæ¼”ç¤º
                // å®é™…ä¸‹è½½åŠŸèƒ½é€šå¸¸ç”¨äºç”¨æˆ·è‡ªå·±æ‹çš„ç…§ç‰‡
                div.dataset.fullImg = d.img;
                div.dataset.date = d.date;
                div.dataset.text = d.text;
                div.dataset.filter = 'none';
                div.dataset.bgColor = '#fff';
                div.dataset.textColor = '#222';

                div.innerHTML = `
                    <img src="${d.img}" draggable="false">
                    <div class="polaroid-text" style="color:#222">
                        ${d.text}<br>
                        <span style="font-size:9px;opacity:0.6;font-family:'Courier New'">${d.date}</span>
                    </div>
                `;
                
                gallery.appendChild(div);

                // ç®€å•çš„åˆ†æ•£æ’åˆ—é€»è¾‘
                let finalTop, finalLeft;
                if(isMobile) {
                    // æ‰‹æœºç«¯ï¼šåˆ†æ•£åœ¨ä¸Šæ–¹åŒºåŸŸ
                    finalTop = (10 + index * 10) + '%'; 
                    finalLeft = (10 + index * 15) + '%';
                    div.style.transform = `rotate(${d.rot}deg) scale(0.8)`;
                } else {
                    // æ¡Œé¢ç«¯ï¼šåˆ†æ•£åœ¨å³ä¾§åŒºåŸŸ
                    finalTop = d.top + '%';
                    finalLeft = d.left + '%';
                    div.style.transform = `rotate(${d.rot}deg) scale(1)`;
                }
                
                div.style.top = finalTop;
                div.style.left = finalLeft;
                div.style.zIndex = index + 1;
                div.style.opacity = 1;
                
                setupInteraction(div);
            });
        }

        // åˆ‡æ¢æ»¤é•œ
        window.setFilter = function(f, btn) {
            currentFilter = f; video.style.filter = f;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
        // åˆ‡æ¢èƒŒæ™¯
        window.setFrameColor = function(bg, txt, btn) {
            currentFrameBg = bg; currentTextColor = txt;
            document.querySelectorAll('.color-dot').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        // æ‹ç…§
        shutterBtn.addEventListener('click', () => {
            // ğŸ”¥ å…³é”®é€»è¾‘ï¼šå¦‚æœæ˜¯ç¬¬ä¸€å¼ ï¼Œæ¸…ç©ºé»˜è®¤ç…§ç‰‡
            if (isFirstShot) {
                gallery.innerHTML = '';
                isFirstShot = false; // æ ‡è®°ä¸ºå·²å¼€å§‹æ‹ç…§
                deselect();
            }

            playSound('shutter');
            flashOverlay.style.opacity = 1;
            setTimeout(() => flashOverlay.style.opacity = 0, 100);

            const text = customTextInput.value || " ";
            const now = new Date();
            const dateStr = `${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()}`;

            const cvs = document.createElement('canvas');
            const size = Math.min(video.videoWidth, video.videoHeight);
            cvs.width = 800; cvs.height = 800; 
            const ctx = cvs.getContext('2d');
            ctx.translate(800, 0); ctx.scale(-1, 1);
            const sx = (video.videoWidth - size)/2; 
            const sy = (video.videoHeight - size)/2;
            ctx.drawImage(video, sx, sy, size, size, 0, 0, 800, 800);
            
            createPolaroid(cvs.toDataURL('image/jpeg', 0.8), dateStr, text, currentFilter, currentFrameBg, currentTextColor);
            setTimeout(() => playSound('motor'), 200);
        });

        // åˆ›å»ºç…§ç‰‡ DOM
        function createPolaroid(imgSrc, date, text, filter, bg, txtColor) {
            const div = document.createElement('div');
            div.className = 'polaroid';
            div.style.backgroundColor = bg;
            
            div.dataset.fullImg = imgSrc; div.dataset.date = date; 
            div.dataset.text = text; div.dataset.filter = filter;
            div.dataset.bgColor = bg; div.dataset.textColor = txtColor;

            div.innerHTML = `
                <img src="${imgSrc}" draggable="false" style="filter:brightness(0.2) grayscale(1) contrast(1.2)">
                <div class="polaroid-text" style="color:${txtColor}">${text}<br><span style="font-size:9px;opacity:0.6;font-family:'Courier New'">${date}</span></div>
            `;
            
            gallery.appendChild(div);

            const isMobile = window.innerWidth <= 768;
            if(isMobile) {
                div.style.top = '100%'; div.style.left = '50%'; 
                div.style.transform = 'translate(-50%, 0) scale(0.2)';
            } else {
                div.style.top = '50%'; div.style.left = '200px';
                div.style.transform = 'scale(0.2)';
            }
            div.style.zIndex = zIndexCounter++;
            div.offsetHeight; 

            requestAnimationFrame(() => {
                div.style.opacity = 1;
                const rRot = (Math.random() * 20 - 10);
                if(isMobile) {
                    const rTop = Math.random() * 30 + 5; 
                    const rLeft = Math.random() * 60 + 10; 
                    div.style.top = rTop + '%'; div.style.left = rLeft + '%';
                    div.style.transform = `rotate(${rRot}deg) scale(0.8)`; 
                } else {
                    const rTop = Math.random() * 50 + 10;
                    const rLeft = Math.random() * 30 + 40;
                    div.style.top = rTop + '%'; div.style.left = rLeft + '%';
                    div.style.transform = `rotate(${rRot}deg) scale(1)`;
                }
            });

            setTimeout(() => {
                div.classList.add('developed'); // æ ‡è®°ä¸ºå·²æ˜¾å½±
                div.querySelector('img').style.filter = (filter === 'none') ? 'none' : filter;
            }, 800);
            
            setupInteraction(div);
        }

        // æ‹–æ‹½äº¤äº’
        function setupInteraction(el) {
            let isDown = false, startX, startY, initL, initT;
            const start = (e) => {
                if(selectedPhotoElement && selectedPhotoElement !== el) deselect();
                selectedPhotoElement = el; el.classList.add('selected');
                downloadBtn.classList.remove('disabled');
                isDown = true; el.style.transition = 'none'; el.style.zIndex = 99999;
                const t = e.touches ? e.touches[0] : e;
                startX = t.clientX; startY = t.clientY;
                const rect = el.getBoundingClientRect();
                const pRect = gallery.getBoundingClientRect();
                initL = rect.left - pRect.left; initT = rect.top - pRect.top;
            };
            const move = (e) => {
                if(!isDown) return;
                const t = e.touches ? e.touches[0] : e;
                el.style.left = (initL + t.clientX - startX) + 'px';
                el.style.top = (initT + t.clientY - startY) + 'px';
            };
            const end = () => {
                if(!isDown) return;
                isDown = false; el.style.transition = 'transform 0.2s, box-shadow 0.2s';
                el.style.zIndex = zIndexCounter++;
            };
            el.addEventListener('mousedown', start); window.addEventListener('mousemove', move); window.addEventListener('mouseup', end);
            el.addEventListener('touchstart', start, {passive:false}); window.addEventListener('touchmove', move, {passive:false}); window.addEventListener('touchend', end);
        }

        function deselect() {
            if(selectedPhotoElement) {
                selectedPhotoElement.classList.remove('selected');
                selectedPhotoElement = null;
                downloadBtn.classList.add('disabled');
            }
        }

        document.addEventListener('click', (e) => {
            if(!e.target.closest('.polaroid') && !e.target.closest('.ui-buttons') && !e.target.closest('.camera-wrapper') && !e.target.closest('.settings-panel')) {
                deselect();
            }
            if(audioContext?.state === 'suspended') audioContext.resume();
        });

        // ä¸‹è½½
        async function downloadSelectedPhoto() {
            if(!selectedPhotoElement) return;
            downloadBtn.innerText = "ä¿å­˜ä¸­...";
            const d = selectedPhotoElement.dataset;
            
            // å¦‚æœæ˜¯é»˜è®¤çš„ç½‘ç»œå›¾ç‰‡ï¼Œç›´æ¥å°è¯•ä¸‹è½½å¯èƒ½ä¼šè·¨åŸŸï¼Œè¿™é‡Œåšä¸ªç®€å•çš„å…¼å®¹ï¼š
            // å®é™…é¡¹ç›®ä¸­ï¼Œé»˜è®¤å›¾ç‰‡å¦‚æœæ˜¯æœ¬åœ°ç›¸å¯¹è·¯å¾„ (å¦‚ ./img/1.jpg) åˆ™æ²¡æœ‰é—®é¢˜ã€‚
            // å¦‚æœæ˜¯ base64 çš„ dataUrl ä¹Ÿæ²¡é—®é¢˜ã€‚
            
            const cvs = document.createElement('canvas'); cvs.width=800; cvs.height=960;
            const ctx = cvs.getContext('2d');
            const img = new Image();
            img.crossOrigin = "Anonymous"; // å°è¯•è§£å†³ç½‘ç»œå›¾ç‰‡è·¨åŸŸ
            img.onload = () => {
                ctx.fillStyle = d.bgColor; ctx.fillRect(0,0,800,960);
                ctx.save(); if(d.filter!=='none') ctx.filter=d.filter;
                ctx.drawImage(img, 40, 40, 720, 720); ctx.restore();
                ctx.strokeStyle='rgba(0,0,0,0.1)'; ctx.strokeRect(40,40,720,720);
                ctx.fillStyle = d.textColor; ctx.textAlign='center';
                ctx.font = 'bold 32px "KaiTi", "STKaiti", "Comic Sans MS", sans-serif'; 
                ctx.fillText(d.text, 400, 890);
                ctx.font = '20px Courier New'; ctx.globalAlpha=0.7; 
                ctx.fillText(d.date, 400, 930);
                const a = document.createElement('a'); 
                a.download = 'Polaroid_'+Date.now()+'.jpg';
                a.href = cvs.toDataURL('image/jpeg', 0.9); a.click();
                downloadBtn.innerText = "ä¸‹è½½å›¾ç‰‡";
            };
            img.onerror = () => {
                alert("æ— æ³•ä¸‹è½½è¿™å¼ é»˜è®¤çš„ç½‘ç»œå›¾ç‰‡ï¼ˆè·¨åŸŸé™åˆ¶ï¼‰ï¼Œè¯·è¯•ç€æ‹ä¸€å¼ æ–°ç…§ç‰‡ä¸‹è½½ï¼");
                downloadBtn.innerText = "ä¸‹è½½å›¾ç‰‡";
            };
            img.src = d.fullImg;
        }

        // ğŸ”¥ é‡ç½®åŠŸèƒ½ä¿®æ”¹
        function resetGallery() { 
            gallery.innerHTML = ''; 
            deselect(); 
            // é‡ç½®æ ‡è®°
            isFirstShot = true;
            // é‡æ–°ç”Ÿæˆé»˜è®¤ç…§ç‰‡
            generateDefaultPhotos();
        }

        function playSound(t) {
            if(!audioContext) audioContext = new (window.AudioContext||window.webkitAudioContext)();
            if(audioContext.state==='suspended') audioContext.resume();
            const osc = audioContext.createOscillator(); const g = audioContext.createGain();
            osc.connect(g); g.connect(audioContext.destination);
            const now = audioContext.currentTime;
            if(t==='shutter') {
                osc.frequency.setValueAtTime(800,now); osc.frequency.exponentialRampToValueAtTime(100,now+0.1);
                g.gain.setValueAtTime(0.3,now); g.gain.exponentialRampToValueAtTime(0.01,now+0.1);
                osc.start(now); osc.stop(now+0.1);
            } else {
                osc.type='sawtooth'; osc.frequency.setValueAtTime(100,now); osc.frequency.linearRampToValueAtTime(50,now+0.5);
                g.gain.setValueAtTime(0.05,now); g.gain.linearRampToValueAtTime(0,now+0.5);
                osc.start(now); osc.stop(now+0.5);
            }
        }

        initCamera();
    </script>
</body>
</html>