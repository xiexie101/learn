<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- å…³é”®ï¼šç¦æ­¢ç¼©æ”¾ï¼Œä¿è¯ App è´¨æ„Ÿ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Retro Camera Mobile</title>
    <style>
        /* --- 1. å…¨å±€åŸºç¡€ --- */
        body {
            margin: 0;
            height: 100vh;
            /* ä¾ç„¶ä¿æŒå¤å¤æ³¢ç‚¹èƒŒæ™¯ */
            background-color: #dcdcdc;
            background-image: radial-gradient(#b0b0b0 15%, transparent 16%), radial-gradient(#b0b0b0 15%, transparent 16%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            font-family: 'Courier New', Courier, monospace;
            overflow: hidden; /* ç¦æ­¢é¡µé¢æ»šåŠ¨ */
            overscroll-behavior: none;
            user-select: none;
            display: flex;
            flex-direction: column;
        }

        /* --- 2. è®¾ç½®é¢æ¿ (é»˜è®¤æ¡Œé¢ç«¯ï¼šå·¦ä¸Šè§’) --- */
        .settings-panel {
            position: absolute;
            left: 20px;
            top: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            z-index: 500;
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 220px;
            backdrop-filter: blur(5px);
        }
        .panel-section { display: flex; flex-direction: column; gap: 5px; }
        .panel-label { font-size: 10px; font-weight: bold; color: #888; letter-spacing: 1px; text-transform: uppercase;}
        
        .text-input {
            padding: 8px; border: 1px solid #ccc; border-radius: 8px;
            font-family: 'Comic Sans MS', sans-serif; font-size: 14px; outline: none; width: 100%; box-sizing: border-box;
        }
        .color-options { display: flex; gap: 8px; }
        .color-dot {
            width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid #eee;
        }
        .color-dot.active { border-color: #333; transform: scale(1.1); }
        
        .filter-options { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
        .filter-btn {
            padding: 6px; border: 1px solid #ddd; background: #fff; border-radius: 6px; cursor: pointer; font-size: 12px;
        }
        .filter-btn.active { background: #333; color: white; border-color: #333; }

        /* --- 3. é¡¶éƒ¨æŒ‰é’® (é»˜è®¤æ¡Œé¢ç«¯ï¼šå³ä¸Šè§’) --- */
        .ui-buttons {
            position: absolute;
            top: 20px; right: 20px;
            z-index: 2000;
            display: flex; gap: 10px;
        }
        .btn {
            padding: 10px 20px; border: 2px solid #333; background: white;
            border-radius: 30px; cursor: pointer; font-weight: bold; font-size: 14px;
            box-shadow: 2px 2px 0 rgba(0,0,0,0.1);
        }
        .btn:active { transform: scale(0.95); }
        .btn.disabled { opacity: 0.5; background: #eee; pointer-events: none; }
        .btn-download { background: #333; color: white; border-color: #fff; }

        /* --- 4. ä¸»å®¹å™¨å¸ƒå±€ --- */
        #app-container {
            display: flex;
            width: 100%;
            height: 100%;
            /* æ¡Œé¢ç«¯ï¼šå·¦å³å¸ƒå±€ */
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            padding: 0 50px;
            box-sizing: border-box;
        }

        /* --- 5. ç›¸æœºä¸»ä½“ --- */
        .camera-wrapper {
            position: relative;
            width: 400px;
            z-index: 10;
            flex-shrink: 0;
            margin-left: 260px; /* æ¡Œé¢ç«¯é¿å¼€å·¦ä¾§é¢æ¿ */
        }
        .camera-img {
            width: 100%; display: block;
            filter: drop-shadow(0 15px 35px rgba(0,0,0,0.3));
            pointer-events: none;
        }
        /* é•œå¤´ */
        .lens-container {
            position: absolute; top: 37%; left: 43.5%; width: 35%; height: 35%;
            border-radius: 50%; overflow: hidden; background: #111; z-index: 1;
            box-shadow: inset 0 0 10px #000;
        }
        video#viewfinder {
            width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); transition: filter 0.3s; opacity: 0.9;
        }
        .lens-glare {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2) 0%, transparent 60%);
            pointer-events: none; z-index: 2;
        }
        /* é—ªå…‰ç¯ */
        .flash-overlay {
            position: absolute; top: 14%; left: 14%; width: 24%; height: 18%;
            background: white; opacity: 0; pointer-events: none; z-index: 30;
            mix-blend-mode: hard-light; border-radius: 4px; filter: blur(2px);
        }
        /* å¿«é—¨çƒ­åŒº */
        .shutter-trigger {
            position: absolute; top: 51%; left: 15%; width: 14%; aspect-ratio: 1/1;
            border-radius: 50%; background: transparent; border: none; cursor: pointer; z-index: 20;
            -webkit-tap-highlight-color: transparent;
        }
        .shutter-trigger:active { transform: scale(0.9); }

        /* --- 6. ç…§ç‰‡å¢™ --- */
        #gallery-area {
            flex: 1; height: 100%; position: relative; margin-left: 20px;
        }
        .polaroid {
            position: absolute; width: 160px;
            padding: 10px 10px 40px 10px;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.15);
            transition: transform 0.2s, box-shadow 0.2s;
            transform-origin: center; cursor: grab; touch-action: none;
        }
        .polaroid.selected {
            box-shadow: 0 0 0 3px #4a90e2, 10px 10px 30px rgba(0,0,0,0.3);
            z-index: 9999 !important; transform: scale(1.05) !important;
        }
        .polaroid img {
            width: 100%; display: block; background: #000;
            transition: filter 4s ease-in-out; pointer-events: none;
        }
        .polaroid-text {
            position: absolute; bottom: 10px; left: 0; width: 100%;
            text-align: center; font-size: 10px;
            font-family: 'Comic Sans MS', sans-serif; pointer-events: none;
        }


        /* =========================================
           ğŸ”¥ğŸ”¥ğŸ”¥ ç§»åŠ¨ç«¯æ ¸å¿ƒé€‚é… (Mobile Layout) ğŸ”¥ğŸ”¥ğŸ”¥
           ========================================= */
        @media (max-width: 768px) {
            
            /* 1. å…¨å±€å‚ç›´å¸ƒå±€ */
            #app-container {
                flex-direction: column; /* ä»ä¸Šåˆ°ä¸‹æ’åˆ— */
                padding: 0;
                justify-content: flex-start;
            }

            /* 2. è®¾ç½®é¢æ¿ï¼šç§»åŠ¨åˆ°æœ€é¡¶éƒ¨ï¼Œæ¨ªå‘æ’åˆ— */
            .settings-panel {
                position: relative; /* å æ®æ–‡æ¡£æµï¼Œä¸é®æŒ¡ */
                top: 0; left: 0;
                width: 100%;
                height: auto; /* é«˜åº¦è‡ªé€‚åº” */
                flex-direction: row; /* å†…å®¹æ¨ªå‘æ’å¸ƒ */
                align-items: center;
                overflow-x: auto; /* å…è®¸æ¨ªå‘æ»‘åŠ¨ */
                border-radius: 0 0 15px 15px;
                padding: 10px 15px;
                box-sizing: border-box;
                gap: 15px;
                box-shadow: 0 5px 10px rgba(0,0,0,0.05);
            }
            /* è°ƒæ•´é¢æ¿å†…éƒ¨å…ƒç´ å¤§å°ä»¥é€‚åº”æ‰‹æœº */
            .panel-section { min-width: 80px; justify-content: center; }
            .text-input { width: 120px; font-size: 12px; padding: 5px;}
            .filter-options { display: flex; gap: 5px; } /* æ»¤é•œæ¨ªç€æ’ */
            .filter-btn { padding: 4px 8px; white-space: nowrap; }

            /* 3. ç…§ç‰‡å¢™ï¼šå æ®ä¸­é—´å‰©ä½™åŒºåŸŸ */
            #gallery-area {
                width: 100%;
                flex: 1; /* æ’‘æ»¡ä¸­é—´ */
                margin: 0;
                z-index: 5; /* ä¿è¯ç…§ç‰‡åœ¨ç›¸æœºåé¢ä¸€ç‚¹ï¼Œæˆ–è€…å‰é¢ï¼Œçœ‹éœ€æ±‚ */
            }
            /* æ‰‹æœºä¸Šç…§ç‰‡å°ä¸€ç‚¹ */
            .polaroid { width: 130px; }

            /* 4. ç›¸æœºï¼šå›ºå®šåœ¨åº•éƒ¨ */
            .camera-wrapper {
                width: 85%; /* å®½åº¦è‡ªé€‚åº” */
                max-width: 340px;
                margin: 0 auto; /* å±…ä¸­ */
                /* ç•™å‡ºåº•éƒ¨æŒ‰é’®çš„ç©ºé—´ */
                margin-bottom: 80px; 
            }

            /* 5. æŒ‰é’®ï¼šå›ºå®šåœ¨å±å¹•æœ€åº•ç«¯ */
            .ui-buttons {
                position: fixed; /* å›ºå®šå®šä½ */
                top: auto; 
                bottom: 20px;
                right: 50%;
                transform: translateX(50%); /* æ°´å¹³å±…ä¸­ */
                width: 90%;
                justify-content: center;
                background: rgba(255,255,255,0.8); /* åŠ ä¸ªèƒŒæ™¯é˜²æ­¢çœ‹ä¸æ¸… */
                padding: 10px;
                border-radius: 40px;
                backdrop-filter: blur(5px);
                box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
            }
            .btn { flex: 1; text-align: center; font-size: 12px; padding: 12px 0; }
        }
    </style>
</head>
<body>

    <!-- é¡¶éƒ¨è®¾ç½®é¢æ¿ (æ‰‹æœºç«¯ä¼šåœ¨æœ€ä¸Šé¢) -->
    <div class="settings-panel">
        <div class="panel-section">
            <div class="panel-label">TEXT</div>
            <input type="text" class="text-input" id="customText" value="HELLO 2025" maxlength="15">
        </div>
        <div class="panel-section">
            <div class="panel-label">FILTERS</div>
            <div class="filter-options">
                <button class="filter-btn active" onclick="setFilter('none', this)">Nor</button>
                <button class="filter-btn" onclick="setFilter('grayscale(1) contrast(1.2)', this)">B&W</button>
                <button class="filter-btn" onclick="setFilter('sepia(0.5) contrast(1.1)', this)">Retro</button>
                <button class="filter-btn" onclick="setFilter('hue-rotate(180deg)', this)">Cool</button>
            </div>
        </div>
        <div class="panel-section">
            <div class="panel-label">COLOR</div>
            <div class="color-options">
                <div class="color-dot active" style="background:#fff" onclick="setFrameColor('#fff','#222',this)"></div>
                <div class="color-dot" style="background:#222" onclick="setFrameColor('#222','#fff',this)"></div>
                <div class="color-dot" style="background:#ffc0cb" onclick="setFrameColor('#ffc0cb','#222',this)"></div>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨æŒ‰é’®ç»„ (æ‰‹æœºç«¯å›ºå®šåœ¨æœ€åº•ä¸‹) -->
    <div class="ui-buttons">
        <button class="btn" onclick="resetGallery()">RESET</button>
        <button class="btn btn-download disabled" id="downloadBtn" onclick="downloadSelectedPhoto()">DOWNLOAD</button>
    </div>

    <div id="app-container">
        
        <!-- æ‰‹æœºç«¯ï¼šç…§ç‰‡å¢™ (åœ¨ä¸Š) -->
        <div id="gallery-area"></div>

        <!-- æ‰‹æœºç«¯ï¼šç›¸æœº (åœ¨ä¸‹) -->
        <div class="camera-wrapper">
            <img src="camera_bg.png" class="camera-img" alt="Camera" onerror="this.style.background='#fdf3d5'">
            <div class="lens-container">
                <video id="viewfinder" autoplay playsinline></video>
                <div class="lens-glare"></div>
            </div>
            <div class="flash-overlay"></div>
            <button class="shutter-trigger" id="shutterBtn"></button>
        </div>

    </div>

    <script>
        // --- JS é€»è¾‘éƒ¨åˆ† ---
        const video = document.getElementById('viewfinder');
        const gallery = document.getElementById('gallery-area');
        const shutterBtn = document.getElementById('shutterBtn');
        const flashOverlay = document.querySelector('.flash-overlay');
        const downloadBtn = document.getElementById('downloadBtn');
        const customTextInput = document.getElementById('customText');
        
        let zIndexCounter = 100;
        let audioContext = null;
        let selectedPhotoElement = null;

        // çŠ¶æ€
        let currentFilter = 'none';
        let currentFrameBg = '#fff';
        let currentTextColor = '#222';

        // 1. åˆå§‹åŒ–
        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "user", width: { ideal: 1280 }, height: { ideal: 1280 }, aspectRatio: 1 } 
                });
                video.srcObject = stream;
            } catch (err) { console.error(err); alert("è¯·å…è®¸æ‘„åƒå¤´æƒé™"); }
        }

        window.setFilter = function(f, btn) {
            currentFilter = f; video.style.filter = f;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        window.setFrameColor = function(bg, txt, btn) {
            currentFrameBg = bg; currentTextColor = txt;
            document.querySelectorAll('.color-dot').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        // 2. æ‹ç…§
        shutterBtn.addEventListener('click', () => {
            playSound('shutter');
            flashOverlay.style.opacity = 1;
            setTimeout(() => flashOverlay.style.opacity = 0, 100);

            const text = customTextInput.value || "";
            const now = new Date();
            const dateStr = `${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()}`;

            // æˆªå–é«˜æ¸…å›¾
            const cvs = document.createElement('canvas');
            const size = Math.min(video.videoWidth, video.videoHeight);
            cvs.width = 800; cvs.height = 800; 
            const ctx = cvs.getContext('2d');
            ctx.translate(800, 0); ctx.scale(-1, 1);
            const sx = (video.videoWidth - size)/2; 
            const sy = (video.videoHeight - size)/2;
            ctx.drawImage(video, sx, sy, size, size, 0, 0, 800, 800);
            
            createPolaroid(cvs.toDataURL('image/jpeg', 0.8), dateStr, text, currentFilter, currentFrameBg, currentTextColor);
            setTimeout(() => playSound('motor'), 200);
        });

        // 3. åˆ›å»ºç…§ç‰‡ (å…³é”®ï¼šè°ƒæ•´é£å‡ºåæ ‡)
        function createPolaroid(imgSrc, date, text, filter, bg, txtColor) {
            const div = document.createElement('div');
            div.className = 'polaroid';
            div.style.backgroundColor = bg;
            
            div.dataset.fullImg = imgSrc; div.dataset.date = date; 
            div.dataset.text = text; div.dataset.filter = filter;
            div.dataset.bgColor = bg; div.dataset.textColor = txtColor;

            div.innerHTML = `<img src="${imgSrc}" draggable="false" style="filter:brightness(0.2) grayscale(1) contrast(1.2)"><div class="polaroid-text" style="color:${txtColor}">${text}<br><span style="font-size:9px;opacity:0.6">${date}</span></div>`;
            
            gallery.appendChild(div);

            // --- åŠ¨ç”»åæ ‡è®¡ç®— ---
            const isMobile = window.innerWidth <= 768;
            
            // åˆå§‹ä½ç½®ï¼š
            // æ‰‹æœºï¼šä»ä¸‹æ–¹ç›¸æœºä½ç½®å‡ºæ¥ (bottom: 0, left: 50%)
            // æ¡Œé¢ï¼šä»å·¦ä¾§ç›¸æœºä½ç½®å‡ºæ¥ (top: 50%, left: 200px)
            if(isMobile) {
                div.style.top = '100%'; // å±å¹•åº•éƒ¨
                div.style.left = '50%'; 
                div.style.transform = 'translate(-50%, 0) scale(0.2)';
            } else {
                div.style.top = '50%';
                div.style.left = '200px';
                div.style.transform = 'scale(0.2)';
            }
            div.style.zIndex = zIndexCounter++;

            // å¼ºåˆ¶é‡ç»˜
            div.offsetHeight;

            // é£å‡ºç›®æ ‡ä½ç½®ï¼š
            // æ‰‹æœºï¼šé£åˆ°ä¸Šæ–¹åŒºåŸŸ (gallery-area)
            // æ¡Œé¢ï¼šé£åˆ°å³ä¾§
            requestAnimationFrame(() => {
                div.style.opacity = 1;
                const rRot = (Math.random() * 20 - 10);
                
                if(isMobile) {
                    // æ‰‹æœºç«¯ï¼šéšæœºåˆ†å¸ƒåœ¨å±å¹•ä¸ŠåŠéƒ¨åˆ† (10% - 40% é«˜åº¦)
                    const rTop = Math.random() * 30 + 5; 
                    const rLeft = Math.random() * 60 + 10; // 10% - 70% å®½åº¦
                    div.style.top = rTop + '%';
                    div.style.left = rLeft + '%';
                    div.style.transform = `rotate(${rRot}deg) scale(0.8)`; // æ‰‹æœºä¸Šç…§ç‰‡å°ä¸€ç‚¹
                } else {
                    const rTop = Math.random() * 50 + 10;
                    const rLeft = Math.random() * 30 + 40;
                    div.style.top = rTop + '%';
                    div.style.left = rLeft + '%';
                    div.style.transform = `rotate(${rRot}deg) scale(1)`;
                }
            });

            setTimeout(() => {
                div.querySelector('img').style.filter = (filter === 'none') ? 'none' : filter;
            }, 800);
            
            setupInteraction(div);
        }

        // 4. äº¤äº’ (æ‹–æ‹½)
        function setupInteraction(el) {
            let isDown = false, startX, startY, initL, initT;
            const start = (e) => {
                if(selectedPhotoElement && selectedPhotoElement !== el) deselect();
                selectedPhotoElement = el; el.classList.add('selected');
                downloadBtn.classList.remove('disabled');
                
                isDown = true; el.style.transition = 'none'; el.style.zIndex = 99999;
                const t = e.touches ? e.touches[0] : e;
                startX = t.clientX; startY = t.clientY;
                const rect = el.getBoundingClientRect();
                // è·å–ç›¸å¯¹äºçˆ¶å®¹å™¨çš„åæ ‡
                const pRect = gallery.getBoundingClientRect();
                initL = rect.left - pRect.left;
                initT = rect.top - pRect.top;
            };
            const move = (e) => {
                if(!isDown) return;
                const t = e.touches ? e.touches[0] : e;
                el.style.left = (initL + t.clientX - startX) + 'px';
                el.style.top = (initT + t.clientY - startY) + 'px';
            };
            const end = () => {
                if(!isDown) return;
                isDown = false; el.style.transition = 'transform 0.2s, box-shadow 0.2s';
                el.style.zIndex = zIndexCounter++;
            };
            el.addEventListener('mousedown', start); window.addEventListener('mousemove', move); window.addEventListener('mouseup', end);
            el.addEventListener('touchstart', start, {passive:false}); window.addEventListener('touchmove', move, {passive:false}); window.addEventListener('touchend', end);
        }

        function deselect() {
            if(selectedPhotoElement) {
                selectedPhotoElement.classList.remove('selected');
                selectedPhotoElement = null;
                downloadBtn.classList.add('disabled');
            }
        }

        document.addEventListener('click', (e) => {
            if(!e.target.closest('.polaroid') && !e.target.closest('.ui-buttons') && !e.target.closest('.camera-wrapper') && !e.target.closest('.settings-panel')) {
                deselect();
            }
            if(audioContext?.state === 'suspended') audioContext.resume();
        });

        // 5. ä¸‹è½½ä¸éŸ³æ•ˆ
        async function downloadSelectedPhoto() {
            if(!selectedPhotoElement) return;
            downloadBtn.innerText = "...";
            const d = selectedPhotoElement.dataset;
            const cvs = document.createElement('canvas'); cvs.width=800; cvs.height=960;
            const ctx = cvs.getContext('2d');
            const img = new Image();
            img.onload = () => {
                ctx.fillStyle = d.bgColor; ctx.fillRect(0,0,800,960);
                ctx.save(); if(d.filter!=='none') ctx.filter=d.filter;
                ctx.drawImage(img, 40, 40, 720, 720); ctx.restore();
                ctx.strokeStyle='rgba(0,0,0,0.1)'; ctx.strokeRect(40,40,720,720);
                ctx.fillStyle = d.textColor; ctx.textAlign='center';
                ctx.font = 'bold 30px "Comic Sans MS", sans-serif'; ctx.fillText(d.text, 400, 890);
                ctx.font = '20px Courier New'; ctx.globalAlpha=0.7; ctx.fillText(d.date, 400, 930);
                const a = document.createElement('a'); a.download = 'polaroid_'+Date.now()+'.jpg';
                a.href = cvs.toDataURL('image/jpeg', 0.9); a.click();
                downloadBtn.innerText = "DOWNLOAD";
            };
            img.src = d.fullImg;
        }

        function resetGallery() { gallery.innerHTML = ''; deselect(); }

        function playSound(t) {
            if(!audioContext) audioContext = new (window.AudioContext||window.webkitAudioContext)();
            if(audioContext.state==='suspended') audioContext.resume();
            const osc = audioContext.createOscillator(); const g = audioContext.createGain();
            osc.connect(g); g.connect(audioContext.destination);
            const now = audioContext.currentTime;
            if(t==='shutter') {
                osc.frequency.setValueAtTime(800,now); osc.frequency.exponentialRampToValueAtTime(100,now+0.1);
                g.gain.setValueAtTime(0.3,now); g.gain.exponentialRampToValueAtTime(0.01,now+0.1);
                osc.start(now); osc.stop(now+0.1);
            } else {
                osc.type='sawtooth'; osc.frequency.setValueAtTime(100,now); osc.frequency.linearRampToValueAtTime(50,now+0.5);
                g.gain.setValueAtTime(0.05,now); g.gain.linearRampToValueAtTime(0,now+0.5);
                osc.start(now); osc.stop(now+0.5);
            }
        }

        initCamera();
    </script>
</body>
</html>