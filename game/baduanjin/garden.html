<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>禅意花园运动追踪器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'rice-paper': '#F7F4ED',
                        'ink-black': '#1A1A1A',
                        'ink-dark': '#333333',
                        'ink-light': '#666666',
                        'bamboo': '#4A7050',
                        'bamboo-light': '#6B8E23',
                        'vermilion': '#BC412B', // For seals/stamps
                    },
                    fontFamily: {
                        'serif': ['"KaiTi"', '"STKaiti"', '"Noto Serif SC"', 'serif'],
                        'sans': ['"Noto Sans SC"', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;400;500;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            /* Rice Paper Texture - Subtle noise */
            --bg-texture: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
            --primary-color: #4A7050;
            /* Bamboo Green */
            --ink-spread-color: rgba(74, 112, 80, 0.2);
        }

        body {
            font-family: 'Noto Serif SC', serif;
            background-color: #F7F4ED;
            background-image: var(--bg-texture);
            color: #333333;
            overflow-x: hidden;
        }

        /* Ink Card Style - Replaces Glassmorphism */
        .ink-card {
            background-color: rgba(255, 255, 255, 0.4);
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 4px;
            /* Slightly rounded, almost square */
            box-shadow:
                0 4px 6px -1px rgba(0, 0, 0, 0.02),
                0 2px 4px -1px rgba(0, 0, 0, 0.02),
                inset 0 0 20px rgba(247, 244, 237, 0.5);
            /* Inner glow blending with bg */
            position: relative;
            transition: all 0.3s ease;
        }

        /* Handwritten-like border effect for some cards */
        .ink-border {
            border: 2px solid transparent;
            border-image: url("data:image/svg+xml,%3Csvg width='100' height='100' xmlns='http://www.w3.org/2000/svg'%3E%3Cstyle%3Epath%7Bfill:none;stroke:%23333;stroke-width:1;vector-effect:non-scaling-stroke;stroke-dasharray:200 10;%7D%3C/style%3E%3Crect x='2' y='2' width='96' height='96' rx='2' ry='2' opacity='0.2'/%3E%3C/svg%3E") 5 stretch;
        }

        .ink-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
            transform: translateY(-1px);
            border-color: rgba(74, 112, 80, 0.3);
            /* Subtle bamboo tint on hover */
        }

        /* Button Styles */
        .btn-ink {
            background-color: var(--primary-color);
            color: #F7F4ED;
            border: none;
            border-radius: 2px;
            font-family: 'KaiTi', 'STKaiti', 'Noto Serif SC', serif;
            letter-spacing: 0.1em;
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn-ink::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s ease-out, height 0.6s ease-out;
        }

        .btn-ink:hover {
            background-color: #3D5C42;
            /* Darker bamboo */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
        }

        .btn-ink:hover::after {
            width: 200%;
            height: 200%;
        }

        .btn-ghost {
            color: #666666;
            background: transparent;
            border: 1px solid transparent;
        }

        .btn-ghost:hover {
            color: #1A1A1A;
            background-color: rgba(0, 0, 0, 0.05);
            border-color: rgba(0, 0, 0, 0.1);
        }

        /* Typography Override */
        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: 'KaiTi', 'STKaiti', 'Noto Serif SC', serif;
            font-weight: bold;
            color: #1A1A1A;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #F7F4ED;
        }

        ::-webkit-scrollbar-thumb {
            background: #D1D1C6;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #999;
        }

        /* Move Item Checkbox Style */
        .move-item-label {
            display: block;
            padding: 0.75rem 1rem;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            background-color: rgba(255, 255, 255, 0.6);
            font-family: 'Noto Serif SC', serif;
            color: #333;
        }

        .move-item-label:hover {
            border-color: var(--primary-color);
            background-color: #fff;
        }

        .move-item-input:checked+.move-item-label {
            background-color: var(--primary-color);
            color: #F7F4ED;
            border-color: var(--primary-color);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Progress Bar */
        .ink-progress-bg {
            background-color: rgba(0, 0, 0, 0.05);
            border-radius: 99px;
            /* Pill shape */
            overflow: hidden;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .progress-bar-inner {
            background-image: linear-gradient(90deg, #4A7050, #6B8E23);
            border-radius: 99px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Calendar Styles */
        .calendar-day.practiced {
            background-color: var(--primary-color);
            color: #fff;
            border-radius: 50%;
            /* Make it look like a stamp/seal roughly */
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .calendar-day.today {
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            border-radius: 50%;
        }

        /* Achievement Seals */
        .achievement-seal {
            border: 2px solid #BC412B;
            /* Vermilion */
            color: #BC412B;
            border-radius: 4px;
            padding: 2px;
            opacity: 0.3;
            filter: grayscale(100%);
            transition: all 0.5s ease;
        }

        .achievement-seal.unlocked {
            opacity: 1;
            filter: none;
            transform: rotate(-2deg);
            /* Slightly skewed like a manual stamp */
            box-shadow: 0 2px 4px rgba(188, 65, 43, 0.1);
        }

        /* Animations */
        @keyframes inkSpread {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .fade-in {
            animation: inkSpread 0.8s ease-out forwards;
        }

        .zen-garden-element {
            position: absolute;
            transition: opacity 1.5s ease-in-out, transform 1.5s ease-in-out;
            opacity: 0;
            transform: scale(0.9);
            filter: contrast(0.9) sepia(0.2);
            /* Blend into paper */
        }

        .zen-garden-element.visible {
            opacity: 1;
            transform: scale(1);
        }
    </style>
</head>

<body class="min-h-screen p-4 sm:p-6 lg:p-8">

    <div id="loading-overlay" class="fixed inset-0 bg-white/50 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-t-transparent border-indigo-500 rounded-full animate-spin"></div>
            <p class="mt-4 text-lg font-semibold text-gray-700">正在加载您的禅意花园...</p>
        </div>
    </div>

    <main id="app-container"
        class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6 opacity-0 transition-opacity duration-500">
        <!-- Left Column: Main Controls & Garden -->
        <svg style="display: none;">
            <defs>
                <!-- Global Ink Filters -->
                <filter id="ink-wash" x="-20%" y="-20%" width="140%" height="140%">
                    <feTurbulence type="fractalNoise" baseFrequency="0.04" numOctaves="3" result="noise" />
                    <feDisplacementMap in="SourceGraphic" in2="noise" scale="3" xChannelSelector="R"
                        yChannelSelector="G" />
                    <feGaussianBlur stdDeviation="0.5" result="blur" />
                    <feComposite operator="in" in="blur" in2="SourceGraphic" result="composite" />
                    <feColorMatrix type="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 18 -7" in="composite" />
                </filter>
                <filter id="ink-bleed" x="-50%" y="-50%" width="200%" height="200%">
                    <feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="4" result="noise" />
                    <feDisplacementMap in="SourceGraphic" in2="noise" scale="4" />
                    <feGaussianBlur stdDeviation="2" />
                </filter>
                <filter id="paper-roughness">
                    <feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="3" result="noise" />
                    <feDiffuseLighting in="noise" lighting-color="#fff" surfaceScale="1">
                        <feDistantLight azimuth="45" elevation="60" />
                    </feDiffuseLighting>
                    <feComposite operator="in" in2="SourceGraphic" />
                </filter>
            </defs>
        </svg>
        <div class="lg:col-span-2 space-y-6">
            <!-- Header -->
            <div
                class="ink-card rounded-md p-6 flex flex-col sm:flex-row justify-between items-start sm:items-center ink-border">
                <div>
                    <h1 class="text-3xl font-bold text-ink-black">禅意花园运动追踪器</h1>
                    <p id="zen-quote" class="mt-2 text-ink-light font-serif italic">每日禅语：加载中...</p>
                </div>
                <div class="mt-4 sm:mt-0 flex items-center gap-3">
                    <div id="user-level" class="text-center">
                        <div class="font-bold text-lg text-bamboo">--</div>
                        <div class="text-sm text-ink-light">等级</div>
                    </div>
                    <button id="export-btn"
                        class="p-2 text-ink-light hover:bg-ink-dark/5 rounded-full transition-colors"
                        title="导出数据 (Ctrl+E)">
                        <i data-lucide="download"></i>
                    </button>
                    <button id="import-btn"
                        class="p-2 text-ink-light hover:bg-ink-dark/5 rounded-full transition-colors" title="导入数据">
                        <i data-lucide="upload"></i>
                    </button>
                    <button id="reset-btn"
                        class="p-2 text-ink-light hover:bg-vermilion/10 hover:text-vermilion rounded-full transition-colors"
                        title="重置数据 (Ctrl+R)">
                        <i data-lucide="trash-2"></i>
                    </button>
                    <input type="file" id="import-file-input" class="hidden" accept=".json">
                </div>
            </div>

            <!-- Zen Garden -->
            <div class="ink-card rounded-md p-6 h-96 relative">
                <div id="zen-garden"
                    class="relative w-full h-full bg-[#fcfbf8] rounded border border-ink-light/20 overflow-hidden">
                    <!-- Static Background: Ground & Path -->
                    <svg class="absolute inset-0 w-full h-full pointer-events-none" preserveAspectRatio="none">
                        <defs>
                            <radialGradient id="groundGrad" cx="50%" cy="80%" r="80%">
                                <stop offset="0%" stop-color="#EFEBE2" stop-opacity="1" />
                                <stop offset="100%" stop-color="#E6E2D8" stop-opacity="1" />
                            </radialGradient>
                            <filter id="bg-grain">
                                <feTurbulence type="fractalNoise" baseFrequency="0.6" numOctaves="3" result="noise" />
                                <feColorMatrix type="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 0.1 0" />
                                <feComposite operator="in" in2="SourceGraphic" result="composite" />
                                <feBlend mode="multiply" in="composite" in2="SourceGraphic" />
                            </filter>
                        </defs>
                        <!-- Ground Wash -->
                        <rect width="100%" height="100%" fill="url(#groundGrad)" filter="url(#bg-grain)" />

                        <!-- Winding Path (Negative Space/Lighter) -->
                        <path d="M-10,150 Q100,100 150,180 T350,250" stroke="#fff" stroke-width="60" fill="none"
                            opacity="0.4" filter="url(#ink-wash)" transform="scale(1, 0.5)" />

                        <!-- Distant Mountains/Hills (Atmospheric) -->
                        <path d="M0,80 Q50,60 100,80 T200,70 T300,90 V150 H0 Z" fill="#ccc" fill-opacity="0.1"
                            filter="url(#ink-wash)" transform="translate(0, -20) scale(4, 1)" />
                    </svg>
                    <!-- Garden elements will be injected here -->
                    <div id="garden-msg"
                        class="absolute top-4 left-4 text-sm text-ink-dark bg-rice-paper/80 px-4 py-2 rounded-sm border border-ink-light/20 shadow-sm font-serif">
                        您的花园空灵宁静...</div>
                </div>
            </div>

            <!-- Practice Tracker -->
            <div class="ink-card rounded-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-ink-black">今日练习</h2>
                    <button id="select-all-btn" class="text-sm btn-ghost px-3 py-1 rounded-sm">全选</button>
                </div>
                <div id="ba-duan-jin-moves" class="grid grid-cols-2 sm:grid-cols-5 gap-3 mb-6">
                    <!-- Moves will be injected here -->
                </div>
                <button id="complete-practice-btn"
                    class="w-full btn-ink font-bold py-3 px-4 rounded-sm text-lg flex items-center justify-center gap-2">
                    <i data-lucide="check-circle"></i>
                    <span>完成今日练习</span>
                </button>
            </div>
        </div>

        <!-- Right Column: Stats & History -->
        <div class="space-y-6">
            <!-- Stats Dashboard -->
            <div class="ink-card rounded-md p-6">
                <h2 class="text-xl font-semibold mb-4 text-ink-black">修行总览</h2>
                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-sm font-medium text-ink-dark">当前等级: <span id="level-name"
                                    class="font-bold">--</span></span>
                            <span class="text-sm font-medium text-ink-light"><span id="xp-current">0</span> / <span
                                    id="xp-next">100</span> XP</span>
                        </div>
                        <div class="w-full bg-ink-light/10 rounded-full h-2.5 ink-progress-bg">
                            <div id="xp-bar" class="bg-bamboo h-2.5 rounded-full progress-bar-inner" style="width: 0%">
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div class="bg-white/40 rounded-sm p-3 border border-ink-light/10">
                            <p class="text-2xl font-bold text-ink-black" id="streak-days">0</p>
                            <p class="text-sm text-ink-light">连续练习</p>
                        </div>
                        <div class="bg-white/40 rounded-sm p-3 border border-ink-light/10">
                            <p class="text-2xl font-bold text-ink-black" id="total-days">0</p>
                            <p class="text-sm text-ink-light">总练习天数</p>
                        </div>
                        <div class="bg-white/40 rounded-sm p-3 border border-ink-light/10">
                            <p class="text-2xl font-bold text-ink-black" id="days-since-start">0</p>
                            <p class="text-sm text-ink-light">已修行(天)</p>
                        </div>
                        <div class="bg-white/40 rounded-sm p-3 border border-ink-light/10">
                            <p class="text-lg font-bold text-ink-black" id="start-date">--</p>
                            <p class="text-sm text-ink-light">开始时间</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Achievements -->
            <div class="ink-card rounded-md p-6">
                <h2 class="text-xl font-semibold mb-4 text-ink-black">成就印章</h2>
                <div id="achievements-grid" class="grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-3 gap-4">
                    <!-- Achievements will be injected here -->
                </div>
            </div>

            <!-- Calendar -->
            <div class="ink-card rounded-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <button id="prev-month-btn" class="p-2 rounded-full hover:bg-ink-dark/5 text-ink-light"><i
                            data-lucide="chevron-left"></i></button>
                    <h2 id="calendar-header" class="text-lg font-semibold text-ink-black"></h2>
                    <button id="next-month-btn" class="p-2 rounded-full hover:bg-ink-dark/5 text-ink-light"><i
                            data-lucide="chevron-right"></i></button>
                </div>
                <div class="grid grid-cols-7 text-center text-xs text-ink-light mb-2 font-serif">
                    <span>日</span><span>一</span><span>二</span><span>三</span><span>四</span><span>五</span><span>六</span>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 text-center gap-1 font-serif">
                    <!-- Calendar days will be injected here -->
                </div>
            </div>
        </div>
    </main>

    <!-- Modal for reset confirmation -->
    <div id="reset-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl p-8 shadow-xl max-w-sm w-full mx-4">
            <h3 class="text-xl font-bold text-gray-800 mb-4">确认重置</h3>
            <p class="text-gray-600 mb-6">您确定要重置所有数据吗？此操作不可撤销，您的禅意花园和所有进度都将消失。</p>
            <div class="flex justify-end gap-4">
                <button id="cancel-reset-btn"
                    class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors">取消</button>
                <button id="confirm-reset-btn"
                    class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">确认重置</button>
            </div>
        </div>
    </div>


    <script type="module">
        // Firebase is not used in this version for simplicity and to ensure it runs anywhere.
        // All data is stored in localStorage.

        // --- CONFIGURATION ---
        const CONFIG = {
            // Feature flag for low performance devices
            lowPerformanceMode: false, // Set to true to disable heavy filters
            moves: [
                "两手托天理三焦", "左右开弓似射雕", "调理脾胃须单举", "五劳七伤往后瞧",
                "摇头摆尾去心火", "两手攀足固肾腰", "攒拳怒目增气力", "背后七颠百病消",
                "核心训练", "超慢跑"
            ],
            levels: [
                { name: "初学者", xp: 0 }, { name: "入门者", xp: 100 }, { name: "修行者", xp: 300 },
                { name: "精进者", xp: 700 }, { name: "禅定者", xp: 1500 }, { name: "得道者", xp: 3000 },
                { name: "宗师", xp: 5000 }
            ],
            achievements: {
                first_glimpse: { name: "初窥门径", icon: "eye", desc: "完成第一次练习", goal: (data) => data.totalDays >= 1 },
                three_day_perseverance: { name: "三日之功", icon: "git-commit", desc: "连续练习3天", goal: (data) => data.streak >= 3 },
                seven_day_zen: { name: "七日禅心", icon: "sparkles", desc: "连续练习7天", goal: (data) => data.streak >= 7 },
                thirty_day_habit: { name: "三十日养成", icon: "calendar-days", desc: "总计练习30天", goal: (data) => data.totalDays >= 30 },
                hundred_day_mastery: { name: "百日筑基", icon: "award", desc: "总计练习100天", goal: (data) => data.totalDays >= 100 },
                heaven_lifter: { name: "托天宗师", icon: "chevrons-up", desc: "完成“两手托天理三焦”50次", goal: (data) => (data.moveCounts?.[0] || 0) >= 50 },
                archer_master: { name: "射雕英雄", icon: "crosshair", desc: "完成“左右开弓似射雕”50次", goal: (data) => (data.moveCounts?.[1] || 0) >= 50 },
                core_master: { name: "核心达人", icon: "star", desc: "完成“核心训练”50次", goal: (data) => (data.moveCounts?.[8] || 0) >= 50 },
                jogging_pro: { name: "慢跑健将", icon: "footprints", desc: "完成“超慢跑”50次", goal: (data) => (data.moveCounts?.[9] || 0) >= 50 },
                grandmaster: { name: "运动宗师", icon: "crown", desc: "达到宗师等级", goal: (data) => data.level >= 6 },
            },
            zenQuotes: [
                "身心合一，气贯长虹。", "流水不腐，户枢不蠹。", "动以养形，静以养神。",
                "恬淡虚无，真气从之。", "一呼一吸，皆是修行。", "筋长一寸，寿延十年。",
                "气血通畅，百病不生。"
            ],
            gardenStages: [
                { level: 0, msg: "您的花园空灵宁静，等待第一颗石头的落下。", elements: [{ type: 'stone', x: '50%', y: '50%' }, { type: 'grass', x: '10%', y: '80%' }] },
                { level: 1, msg: "青苔悄然生长，为花园增添一抹绿意。", elements: [{ type: 'moss', x: '45%', y: '55%' }, { type: 'grass', x: '80%', y: '75%' }] },
                { level: 2, msg: "一株小草破土而出，充满生命力。", elements: [{ type: 'grass', x: '60%', y: '40%' }, { type: 'grass', x: '20%', y: '45%' }] },
                // Level 3: Pond enters. Needs to be large and central.
                { level: 3, msg: "一朵莲花在池中绽放，清净无染。", elements: [{ type: 'pond', x: '5%', y: '45%' }, { type: 'lotus', x: '25%', y: '60%' }] },
                // Level 4: Koi enters, swimming in the pond area.
                { level: 4, msg: "锦鲤在池中嬉戏，花园更添生机。", elements: [{ type: 'koi', x: '45%', y: '70%' }, { type: 'grass', x: '90%', y: '60%' }] },
                { level: 5, msg: "一棵小树茁壮成长，象征着您的坚持。", elements: [{ type: 'tree', x: '70%', y: '20%' }, { type: 'grass', x: '65%', y: '45%' }] },
                { level: 6, msg: "石灯笼点亮，照亮您的修行之路。花园已然圆满。", elements: [{ type: 'lantern', x: '10%', y: '15%' }, { type: 'grass', x: '5%', y: '30%' }] },
            ],
            gardenElementSVG: {
                // Stone: Heavy wash base, dry brush overlay
                stone: `<svg viewBox="0 0 200 150" width="100" height="75">
    <g filter="url(#ink-wash)">
        <!-- Wash Layer (Mogu) -->
        <path d="M40,100 Q30,70 60,50 Q120,20 160,60 Q180,110 140,130 Q80,140 40,100 Z" fill="#e0e0e0" fill-opacity="0.8" />
        <path d="M50,110 Q45,80 70,65 Q110,40 140,70" fill="none" stroke="#a0a0a0" stroke-width="15" stroke-linecap="round" opacity="0.4" />
    </g>
    <!-- Skeleton Layer (Gugfa) -->
    <path d="M40,100 Q30,70 60,50 Q120,20 160,60 Q180,110 140,130 Q80,140 40,100" fill="none" stroke="#2c2c2c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="filter: url(#ink-bleed);" />
    <path d="M60,90 Q55,75 80,60 M120,70 Q140,90 130,110" fill="none" stroke="#1a1a1a" stroke-width="1.5" stroke-linecap="round" />
    <!-- Moss Accents -->
    <circle cx="50" cy="110" r="3" fill="#4A7050" opacity="0.6" filter="url(#ink-bleed)" />
    <circle cx="130" cy="120" r="4" fill="#4A7050" opacity="0.5" filter="url(#ink-bleed)" />
</svg>`,

                // Moss: Clustered dots with bleed
                moss: `<svg viewBox="0 0 100 100" width="60" height="60">
    <g filter="url(#ink-bleed)">
        <circle cx="30" cy="50" r="10" fill="#4A7050" opacity="0.6" />
        <circle cx="45" cy="45" r="8" fill="#556B2F" opacity="0.7" />
        <circle cx="40" cy="60" r="9" fill="#4A7050" opacity="0.5" />
        <circle cx="55" cy="55" r="7" fill="#6B8E23" opacity="0.6" />
    </g>
    <!-- Dry brush texture -->
    <path d="M30,50 L32,48 M45,45 L47,43 M40,60 L42,58" stroke="#1a1a1a" stroke-width="0.5" opacity="0.3" />
</svg>`,

                // Grass: Lush, wild ink grass cluster
                grass: `<svg viewBox="0 0 100 100" width="60" height="60">
    <g transform="translate(10,10)">
        <!-- Wash background for volume -->
        <path d="M10,80 Q30,60 50,80 Q70,50 90,80" fill="#4A7050" opacity="0.2" filter="url(#ink-wash)" />
        <!-- Structural Blades -->
        <g stroke="#2c2c2c" stroke-width="1" fill="none" stroke-linecap="round">
             <path d="M20,85 Q15,40 5,30" opacity="0.6" />
             <path d="M25,85 Q30,35 40,20" opacity="0.8" />
             <path d="M30,85 Q40,50 55,40" opacity="0.7" />
             <path d="M40,85 Q35,60 30,50" opacity="0.5" />
        </g>
        <!-- Accent Blades (Bamboo Green) -->
        <g stroke="#4A7050" stroke-width="1.5" fill="none" stroke-linecap="round" filter="url(#ink-bleed)">
            <path d="M15,85 Q20,50 10,40" />
            <path d="M35,85 Q45,45 60,30" />
            <path d="M50,85 Q60,60 70,50" />
        </g>
    </g>
</svg>`,


                // Pond: Large environment with shoreline and water depth
                pond: `<svg viewBox="0 0 500 300" width="400" height="240">
    <defs>
        <radialGradient id="pondWaterGrad" cx="50%" cy="40%" r="60%" fx="50%" fy="40%">
            <stop offset="0%" stop-color="#E6F3F7" stop-opacity="0.9" />
            <stop offset="70%" stop-color="#D0E8F0" stop-opacity="0.6" />
            <stop offset="100%" stop-color="#E6F3F7" stop-opacity="0" />
        </radialGradient>
        <filter id="shore-blur">
             <feGaussianBlur stdDeviation="1.5" />
        </filter>
    </defs>
    
    <!-- Water Body (Expanded) -->
    <path d="M20,150 Q60,80 200,90 Q350,100 450,150 Q480,200 380,250 Q250,280 100,260 Q10,230 20,150 Z" fill="url(#pondWaterGrad)" filter="url(#ink-wash)" />
    
    <!-- Shoreline / Banks (Ink Strokes) -->
    <g transform="translate(0, 0)" opacity="0.8">
        <!-- Left Bank -->
        <path d="M10,160 Q30,120 80,100" stroke="#2c2c2c" stroke-width="3" fill="none" stroke-linecap="round" filter="url(#paper-roughness)" opacity="0.6" />
        
        <!-- Right Bank (Distant) -->
        <path d="M350,140 Q420,160 460,200" stroke="#2c2c2c" stroke-width="2" fill="none" stroke-linecap="round" filter="url(#paper-roughness)" opacity="0.5" />
        
        <!-- Bottom Edge (Fade out) -->
        <path d="M120,270 Q250,290 350,250" stroke="#88B0C3" stroke-width="4" fill="none" stroke-linecap="round" filter="url(#shore-blur)" opacity="0.4" />
    </g>

    <!-- Water Ripples (Scattered) -->
    <g stroke="#88B0C3" stroke-width="1.5" fill="none" stroke-linecap="round" opacity="0.5">
        <path d="M150,120 Q200,115 250,120" />
        <path d="M300,200 Q350,205 380,195" />
        <path d="M80,210 Q120,215 150,205" />
    </g>

    <!-- Floating Pads (Background elements) -->
    <g fill="#4A7050" opacity="0.4" filter="url(#ink-wash)">
        <ellipse cx="380" cy="180" rx="20" ry="7" />
        <ellipse cx="60" cy="220" rx="15" ry="5" />
    </g>
    
    <!-- Reeds (Background) -->
    <g stroke="#1a1a1a" stroke-width="0.8" fill="none" opacity="0.4">
        <path d="M40,110 Q45,90 40,70" />
        <path d="M45,115 Q55,95 60,80" />
        <path d="M35,115 Q30,100 25,85" />
    </g>
</svg>`,

                // Lotus: Anchored with large leaf
                lotus: `<svg viewBox="0 0 140 160" width="100" height="115">
    <g transform="translate(70, 130)">
        <!-- Large Base Leaf (Pad) - The anchor -->
        <path d="M-40,-10 Q-60,-20 -50,-40 Q-20,-60 10,-40 Q40,-20 30,-10 Q0,10 -40,-10 Z" fill="#2E8B57" opacity="0.6" filter="url(#ink-wash)" stroke="#1a1a1a" stroke-width="0.5" />
        <path d="M-10,-30 L-30,-20 M-10,-30 L10,-20" stroke="#1a1a1a" stroke-width="0.5" opacity="0.3" />
        
        <!-- Stem (Rising from center of leaf) -->
        <path d="M-10,-30 Q-5,-60 0,-90" stroke="#1a1a1a" stroke-width="2" fill="none" filter="url(#paper-roughness)" />
        
        <!-- Flower Head -->
        <g transform="translate(0, -95)">
            <!-- Back Petals -->
            <ellipse cx="0" cy="-5" rx="18" ry="30" fill="#FFE4E1" opacity="0.8" filter="url(#ink-wash)" transform="rotate(-20)" />
            <ellipse cx="0" cy="-5" rx="18" ry="30" fill="#FFE4E1" opacity="0.8" filter="url(#ink-wash)" transform="rotate(20)" />
            <!-- Front Petal layer -->
            <ellipse cx="0" cy="0" rx="15" ry="25" fill="#FFC0CB" opacity="0.85" filter="url(#ink-wash)" />
            
            <!-- Veins & Outline -->
            <g stroke="#BC412B" stroke-width="0.8" fill="none" opacity="0.7">
                <path d="M0,0 Q-10,-10 0,-25" />
                <path d="M0,0 Q10,-10 0,-25" />
            </g>
            
            <!-- Pod -->
            <circle cx="0" cy="-5" r="4" fill="#FFD700" />
        </g>
    </g>
</svg>`,

                // Koi: Realistic Swimming Form
                koi: `<svg viewBox="0 0 120 70" width="70" height="40">
    <g transform="rotate(5, 60, 35)">
        <!-- Tail Flow -->
        <path d="M20,35 Q10,20 0,25 Q5,35 0,45 Q10,50 20,35" fill="#BC412B" opacity="0.6" filter="url(#ink-wash)" />
        <path d="M20,35 L5,28 M20,35 L5,42" stroke="#BC412B" stroke-width="1" opacity="0.5" />

        <!-- Body Main Mass -->
        <path d="M20,35 Q40,15 80,30 Q95,35 85,45 Q50,55 20,35" fill="#BC412B" opacity="0.9" filter="url(#ink-wash)" />
        
        <!-- Scales Hint (Cross-hatch style) -->
        <g stroke="#8B0000" stroke-width="0.5" opacity="0.3">
            <path d="M40,30 Q45,25 50,30" />
            <path d="M50,30 Q55,25 60,30" />
            <path d="M45,35 Q50,30 55,35" />
            <path d="M55,35 Q60,30 65,35" />
        </g>

        <!-- Fins -->
        <path d="M60,25 Q50,10 65,15" fill="#BC412B" opacity="0.7" />
        <path d="M60,45 Q50,60 65,55" fill="#BC412B" opacity="0.7" />

        <!-- Head & Features -->
        <circle cx="85" cy="38" r="2" fill="#1a1a1a" /> <!-- Eye -->
        <path d="M90,40 Q95,42 90,44" stroke="#8B0000" stroke-width="1" fill="none" /> <!-- Mouth/Whiskers -->
    </g>
</svg>`,

                // Tree: Distinct Pine Needles and Gnarled Trunk
                tree: `<svg viewBox="0 0 250 300" width="180" height="220">
    <!-- Trunk (Gnarled, distinct strokes) -->
    <g filter="url(#paper-roughness)">
        <path d="M120,280 Q100,200 130,150 Q160,100 120,50" stroke="#2c2c2c" stroke-width="8" fill="none" stroke-linecap="round" />
        <path d="M130,150 L180,130" stroke="#2c2c2c" stroke-width="5" fill="none" stroke-linecap="round" />
        <path d="M110,180 L70,190" stroke="#2c2c2c" stroke-width="4" fill="none" stroke-linecap="round" />
        <!-- Bark Texture -->
        <path d="M120,260 L125,240 M115,220 L120,200 M135,140 L140,120" stroke="#1a1a1a" stroke-width="2" opacity="0.6" />
    </g>
    
    <!-- Pine Needles (Clusters of radiating lines) -->
    <g stroke="#4A7050" stroke-width="1.5" stroke-linecap="round" >
        <!-- Cluster 1 (Top) -->
        <g transform="translate(120, 50)">
            <line x1="0" y1="0" x2="-10" y2="-15" /> <line x1="0" y1="0" x2="0" y2="-20" /> <line x1="0" y1="0" x2="10" y2="-15" />
            <line x1="0" y1="0" x2="-15" y2="-5" /> <line x1="0" y1="0" x2="15" y2="-5" />
            <circle cx="0" cy="0" r="15" fill="#4A7050" opacity="0.2" filter="url(#ink-wash)" />
        </g>
        <!-- Cluster 2 (Right Branch) -->
        <g transform="translate(180, 130)">
            <line x1="0" y1="0" x2="-5" y2="-15" /> <line x1="0" y1="0" x2="10" y2="-10" /> <line x1="0" y1="0" x2="15" y2="5" />
            <circle cx="0" cy="0" r="12" fill="#4A7050" opacity="0.2" filter="url(#ink-wash)" />
        </g>
         <!-- Cluster 3 (Left Branch) -->
        <g transform="translate(70, 190)">
             <line x1="0" y1="0" x2="-10" y2="-10" /> <line x1="0" y1="0" x2="-15" y2="5" /> <line x1="0" y1="0" x2="-5" y2="15" />
             <circle cx="0" cy="0" r="12" fill="#4A7050" opacity="0.2" filter="url(#ink-wash)" />
        </g>
    </g>
</svg>`,

                // Lantern: Detailed Stone Structure + Warm Glow
                lantern: `<svg viewBox="0 0 100 140" width="70" height="100">
    <!-- Structure (Ink Outline) -->
    <g stroke="#2c2c2c" stroke-width="2" fill="none" stroke-linejoin="round" stroke-linecap="round" filter="url(#paper-roughness)">
        <!-- Roof -->
        <path d="M20,50 Q50,20 80,50 L75,60 L25,60 Z" fill="#e0e0e0" fill-opacity="0.5" />
        <circle cx="50" cy="25" r="4" fill="#2c2c2c" />
        <!-- Light Box -->
        <rect x="35" y="60" width="30" height="35" />
        <line x1="42" y1="60" x2="42" y2="95" stroke-width="1" />
        <line x1="58" y1="60" x2="58" y2="95" stroke-width="1" />
        <line x1="35" y1="70" x2="65" y2="70" stroke-width="1" />
        <line x1="35" y1="85" x2="65" y2="85" stroke-width="1" />
        <!-- Base -->
        <path d="M40,95 L60,95 L65,110 L35,110 Z" />
        <path d="M30,110 L70,110 L70,125 L30,125 Z" fill="#ccc" fill-opacity="0.3" />
    </g>
    <!-- Warm Glow (Inner) -->
    <rect x="36" y="61" width="28" height="33" fill="#FFD700" opacity="0.3" filter="url(#ink-wash)" />
    <!-- Radiating Light -->
    <circle cx="50" cy="77" r="15" fill="url(#lanternGlow)" opacity="0.6" filter="url(#ink-bleed)" />
    <defs>
        <radialGradient id="lanternGlow" cx="50%" cy="50%" r="50%">
            <stop offset="0%" stop-color="#FFD700" stop-opacity="0.8" />
            <stop offset="100%" stop-color="#FFD700" stop-opacity="0" />
        </radialGradient>
    </defs>
</svg>`,
            }
        };

        // --- STATE MANAGEMENT ---
        let state = {};
        let calendarDate = new Date();

        function getDefaultState() {
            return {
                xp: 0,
                level: 0,
                practiceHistory: [], // dates in "YYYY-MM-DD" format
                moveCounts: Array(CONFIG.moves.length).fill(0),
                achievements: [],
                lastPracticeDate: null,
                streak: 0,
                totalDays: 0,
                startDate: null, // NEW: Track the start date
            };
        }

        // --- DATA PERSISTENCE (localStorage) ---
        function saveData() {
            try {
                localStorage.setItem('baDuanJinTrackerData', JSON.stringify(state));
            } catch (e) {
                console.error("Failed to save data:", e);
                // Optional: Alert user if quota exceeded, but don't crash
                if (e.name === 'QuotaExceededError') {
                    alert("警告：存储空间已满，本次进度可能未保存。建议导出数据清理空间。");
                }
            }
        }

        function loadData() {
            const savedData = localStorage.getItem('baDuanJinTrackerData');
            state = savedData ? JSON.parse(savedData) : getDefaultState();
            state = { ...getDefaultState(), ...state };

            // Retroactively set startDate for old users for compatibility
            if (!state.startDate && state.practiceHistory.length > 0) {
                state.startDate = state.practiceHistory[0];
            }
        }

        // --- AUDIO ---
        let audioContext;
        function initAudio() {
            if (!audioContext) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.error("Web Audio API is not supported in this browser.");
                }
            }
        }

        function playSuccessSound() {
            if (!audioContext) return;
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.type = 'sine';
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.5, audioContext.currentTime + 0.05);

            oscillator.frequency.setValueAtTime(440, audioContext.currentTime); // A4
            oscillator.frequency.exponentialRampToValueAtTime(880, audioContext.currentTime + 0.2);

            gainNode.gain.exponentialRampToValueAtTime(0.00001, audioContext.currentTime + 0.5);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        }

        // --- UI RENDERING ---
        function updateUI() {
            renderPracticeMoves();
            renderDashboard();
            renderAchievements();
            renderCalendar();
            renderZenGarden();
            updateCompleteButton();
        }

        function renderPracticeMoves() {
            const container = document.getElementById('ba-duan-jin-moves');
            container.innerHTML = CONFIG.moves.map((move, index) => `
                <div class="move-item">
                    <input type="checkbox" id="move-${index}" data-index="${index}" class="move-item-input hidden">
                    <label for="move-${index}" class="move-item-label text-sm">${move}</label>
                </div>
            `).join('');
        }

        function renderDashboard() {
            const currentLevel = CONFIG.levels[state.level];
            const nextLevel = CONFIG.levels[state.level + 1];

            document.getElementById('user-level').innerHTML = `
                <div class="font-bold text-lg text-bamboo">${state.level + 1}</div>
                <div class="text-sm text-ink-light">等级</div>`;

            document.getElementById('level-name').textContent = currentLevel.name;
            document.getElementById('xp-current').textContent = state.xp;

            if (nextLevel) {
                document.getElementById('xp-next').textContent = nextLevel.xp;
                const progress = Math.min(100, ((state.xp - currentLevel.xp) / (nextLevel.xp - currentLevel.xp)) * 100);
                document.getElementById('xp-bar').style.width = `${progress}%`;
            } else {
                document.getElementById('xp-next').textContent = 'MAX';
                document.getElementById('xp-bar').style.width = '100%';
            }

            document.getElementById('streak-days').textContent = state.streak;
            document.getElementById('total-days').textContent = state.totalDays;

            // NEW: Render start date and days since start
            if (state.startDate) {
                const startDateObj = new Date(state.startDate);
                const today = new Date();
                // Normalize dates to midnight to get a clean day difference
                const start = new Date(startDateObj.getFullYear(), startDateObj.getMonth(), startDateObj.getDate());
                const end = new Date(today.getFullYear(), today.getMonth(), today.getDate());

                const diffTime = Math.abs(end - start);
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;

                document.getElementById('days-since-start').textContent = diffDays;
                document.getElementById('start-date').textContent = state.startDate.replace(/-/g, '.');
            } else {
                document.getElementById('days-since-start').textContent = 0;
                document.getElementById('start-date').textContent = '尚未开始';
            }
        }

        function renderAchievements() {
            const container = document.getElementById('achievements-grid');
            container.innerHTML = Object.entries(CONFIG.achievements).map(([key, ach]) => {
                const unlocked = state.achievements.includes(key);
                return `
                    <div class="text-center p-2 rounded-sm achievement-seal ${unlocked ? 'unlocked' : ''} transition-all duration-500" title="${ach.desc}">
                        <div class="w-10 h-10 mx-auto flex items-center justify-center">
                            <i data-lucide="${ach.icon}" class="w-8 h-8"></i>
                        </div>
                        <p class="text-xs mt-1 font-bold font-serif">${ach.name}</p>
                    </div>
                `;
            }).join('');
            if (window.lucide) {
                window.lucide.createIcons();
            }
        }

        function renderCalendar() {
            const header = document.getElementById('calendar-header');
            const grid = document.getElementById('calendar-grid');

            header.textContent = `${calendarDate.getFullYear()}年 ${calendarDate.getMonth() + 1}月`;
            grid.innerHTML = '';

            const year = calendarDate.getFullYear();
            const month = calendarDate.getMonth();

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

            // Optimization for large data: Use Set for O(1) lookup
            const historySet = new Set(state.practiceHistory);

            for (let i = 0; i < firstDay; i++) {
                grid.innerHTML += `<div></div>`;
            }

            for (let i = 1; i <= daysInMonth; i++) {
                const dayStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                // Use Set.has instead of Array.includes
                const isPracticed = historySet.has(dayStr);
                const isToday = dayStr === todayStr;


                grid.innerHTML += `
                    <div class="calendar-day w-8 h-8 flex items-center justify-center text-sm
                        ${isPracticed ? 'practiced' : ''}
                        ${isToday ? 'today' : ''}
                    ">
                        ${i}
                    </div>
                `;
            }
        }

        // Track rendered state to avoid full re-renders
        let renderedElementsCount = 0;

        function renderZenGarden() {
            const garden = document.getElementById('zen-garden');
            const gardenMsg = document.getElementById('garden-msg');

            let stage = CONFIG.gardenStages[0];
            for (let i = CONFIG.gardenStages.length - 1; i >= 0; i--) {
                if (state.level >= CONFIG.gardenStages[i].level) {
                    stage = CONFIG.gardenStages[i];
                    break;
                }
            }

            gardenMsg.textContent = stage.msg;

            // correct filter usage based on perf mode
            if (CONFIG.lowPerformanceMode) {
                garden.style.filter = 'none';
            }

            // Calculate target elements
            let targetElements = [];
            for (let i = 0; i <= state.level && i < CONFIG.gardenStages.length; i++) {
                if (CONFIG.gardenStages[i].elements) {
                    targetElements.push(...CONFIG.gardenStages[i].elements);
                }
            }

            // If we have fewer elements than target (or 0), decision time.
            // Case 1: Reset or downgrade -> Clear all
            if (targetElements.length < renderedElementsCount) {
                garden.querySelectorAll('.zen-garden-element').forEach(el => el.remove());
                renderedElementsCount = 0;
            }

            // Case 2: New elements to add
            if (targetElements.length > renderedElementsCount) {
                const newElements = targetElements.slice(renderedElementsCount);

                newElements.forEach((el, index) => {
                    const elementDiv = document.createElement('div');
                    elementDiv.className = 'zen-garden-element';
                    elementDiv.style.left = el.x;
                    elementDiv.style.top = el.y;

                    // Optimization: Remove filters in SVG string if low perf
                    let svgContent = CONFIG.gardenElementSVG[el.type];
                    if (CONFIG.lowPerformanceMode) {
                        // Strip filter attributes regex-style for simplicity in this MVP
                        svgContent = svgContent.replace(/filter="url\(#.*?\)"/g, '');
                    }

                    elementDiv.innerHTML = svgContent;
                    garden.appendChild(elementDiv);

                    // Stagger animation
                    setTimeout(() => {
                        elementDiv.classList.add('visible');
                    }, 100 * (index + 1));
                });

                renderedElementsCount = targetElements.length;
            }
            // Case 3: key === count -> Do nothing (Stable)
        }

        function updateCompleteButton() {
            const todayStr = getTodayString();
            const btn = document.getElementById('complete-practice-btn');
            if (state.practiceHistory.includes(todayStr)) {
                btn.disabled = true;
                btn.classList.add('bg-bamboo/50', 'cursor-not-allowed', 'opacity-80');
                btn.classList.remove('btn-ink');
                btn.innerHTML = `<i data-lucide="check-check"></i><span>今日已完成</span>`;
            } else {
                btn.disabled = false;
                btn.classList.remove('bg-bamboo/50', 'cursor-not-allowed', 'opacity-80');
                btn.classList.add('btn-ink');
                btn.innerHTML = `<i data-lucide="check-circle"></i><span>完成今日练习</span>`;
            }
            if (window.lucide) {
                window.lucide.createIcons();
            }
        }

        function showCelebration() {
            if (typeof window.confetti !== 'function') {
                console.error('Confetti function not found!');
                return;
            }

            const duration = 3 * 1000;
            const animationEnd = Date.now() + duration;
            // Use softer colors for confetti
            const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 100, colors: ['#4A7050', '#BC412B', '#000000', '#F7F4ED'] };

            function randomInRange(min, max) {
                return Math.random() * (max - min) + min;
            }

            // Reduce particles if low performance
            let pCountBase = CONFIG.lowPerformanceMode ? 20 : 50;

            const interval = setInterval(function () {
                const timeLeft = animationEnd - Date.now();
                if (timeLeft <= 0) return clearInterval(interval);

                const particleCount = pCountBase * (timeLeft / duration);
                // Use window.confetti to ensure it's called from the global scope
                window.confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } });
                window.confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } });
            }, 250);
        }

        // --- GAME LOGIC ---
        function getTodayString() {
            const today = new Date();
            return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        }

        function completePractice() {
            initAudio(); // Ensure audio context is ready on user interaction
            const todayStr = getTodayString();
            if (state.practiceHistory.includes(todayStr)) {
                console.log("Already practiced today.");
                return;
            }

            // NEW: Set start date on first practice
            if (!state.startDate) {
                state.startDate = todayStr;
            }

            // 1. Get selected moves
            const selectedMoves = [];
            document.querySelectorAll('#ba-duan-jin-moves .move-item-input:checked').forEach(cb => {
                const index = parseInt(cb.dataset.index);
                selectedMoves.push(index);
                state.moveCounts[index]++;
            });

            if (selectedMoves.length === 0) {
                alert("请至少选择一个动作来完成练习。");
                return;
            }

            // 2. Grant XP
            const xpGained = 10 + selectedMoves.length * 2; // Base XP + bonus per move
            state.xp += xpGained;

            // 3. Update history and stats
            state.practiceHistory.push(todayStr);
            state.totalDays++;

            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = `${yesterday.getFullYear()}-${String(yesterday.getMonth() + 1).padStart(2, '0')}-${String(yesterday.getDate()).padStart(2, '0')}`;

            if (state.lastPracticeDate === yesterdayStr) {
                state.streak++;
            } else {
                state.streak = 1;
            }
            state.lastPracticeDate = todayStr;

            // 4. Check for level up
            const oldLevel = state.level;
            while (state.level < CONFIG.levels.length - 1 && state.xp >= CONFIG.levels[state.level + 1].xp) {
                state.level++;
            }
            const leveledUp = state.level > oldLevel;

            // 5. Check for achievements
            const newAchievements = [];
            Object.entries(CONFIG.achievements).forEach(([key, ach]) => {
                if (!state.achievements.includes(key) && ach.goal(state)) {
                    state.achievements.push(key);
                    newAchievements.push(ach.name);
                }
            });

            // 6. Save and update UI
            saveData();
            updateUI();

            // 7. Feedback
            showCelebration();
            playSuccessSound();

            // Show summary
            let summary = `练习完成！获得 ${xpGained} XP.`;
            if (leveledUp) summary += `\n🎉 等级提升至 ${CONFIG.levels[state.level].name}!`;
            if (newAchievements.length > 0) summary += `\n🏅 获得新成就: ${newAchievements.join(', ')}`;
            setTimeout(() => alert(summary), 100); // Use alert as a simple notification
        }

        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            document.getElementById('complete-practice-btn').addEventListener('click', completePractice);

            document.getElementById('select-all-btn').addEventListener('click', (e) => {
                const checkboxes = document.querySelectorAll('#ba-duan-jin-moves .move-item-input');
                const allSelected = Array.from(checkboxes).every(cb => cb.checked);

                checkboxes.forEach(cb => {
                    cb.checked = !allSelected;
                });

                e.target.textContent = allSelected ? '全选' : '取消全选';
            });

            document.getElementById('prev-month-btn').addEventListener('click', () => {
                calendarDate.setMonth(calendarDate.getMonth() - 1);
                renderCalendar();
            });
            document.getElementById('next-month-btn').addEventListener('click', () => {
                calendarDate.setMonth(calendarDate.getMonth() + 1);
                renderCalendar();
            });

            // Import / Export / Reset
            const importBtn = document.getElementById('import-btn');
            const importInput = document.getElementById('import-file-input');
            const exportBtn = document.getElementById('export-btn');
            const resetBtn = document.getElementById('reset-btn');
            const resetModal = document.getElementById('reset-modal');
            const cancelResetBtn = document.getElementById('cancel-reset-btn');
            const confirmResetBtn = document.getElementById('confirm-reset-btn');

            exportBtn.addEventListener('click', exportData);
            importBtn.addEventListener('click', () => importInput.click());
            importInput.addEventListener('change', importData);
            resetBtn.addEventListener('click', () => resetModal.classList.remove('hidden'));
            cancelResetBtn.addEventListener('click', () => resetModal.classList.add('hidden'));
            confirmResetBtn.addEventListener('click', () => {
                resetModal.classList.add('hidden');
                resetData();
            });

            // Keyboard shortcuts
            window.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key.toLowerCase() === 'e') {
                    e.preventDefault();
                    exportData();
                }
                if (e.ctrlKey && e.key.toLowerCase() === 'r') {
                    e.preventDefault();
                    resetModal.classList.remove('hidden');
                }
            });
        }

        // --- DATA ACTIONS ---
        function exportData() {
            const dataStr = JSON.stringify(state, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `zen-garden-tracker-data-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);

                    // Strick Schema Validation
                    const isValid = importedData
                        && typeof importedData.xp === 'number'
                        && typeof importedData.level === 'number'
                        && Array.isArray(importedData.practiceHistory)
                        && Array.isArray(importedData.achievements)
                        && Array.isArray(importedData.moveCounts)
                        && (importedData.totalDays === undefined || typeof importedData.totalDays === 'number'); // Optional support

                    if (isValid) {
                        if (confirm("您确定要用导入的数据覆盖当前进度吗？")) {
                            state = { ...getDefaultState(), ...importedData };
                            // Add backward compatibility for imported data without startDate
                            if (!state.startDate && state.practiceHistory.length > 0) {
                                state.startDate = state.practiceHistory[0];
                            }
                            // Reset render count to force full redraw logic if needed (or let renderZenGarden handle the drop count)
                            // We don't manually reset renderedElementsCount here because updateUI calls renderZenGarden
                            // and our Case 1 logic (target < current) might not trigger if level is same but data strictly different? 
                            // Actually, importing data implies a full state reset.
                            // Let's force a DOM clear to be safe.
                            document.getElementById('zen-garden').querySelectorAll('.zen-garden-element').forEach(el => el.remove());
                            renderedElementsCount = 0;

                            saveData();
                            updateUI();
                            alert("数据导入成功！");
                        }
                    } else {
                        throw new Error("Invalid data format: Missing required fields (xp, level, practiceHistory, achievements)");
                    }
                } catch (error) {
                    alert("导入失败。请确保文件格式正确。");
                    console.error("Import error:", error);
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset input
        }

        function resetData() {
            if (confirm("最后一次确认：真的要重置所有数据吗？")) {
                state = getDefaultState();
                saveData();
                location.reload(); // Reload to ensure clean state
            }
        }

        // --- INITIALIZATION ---
        function init() {
            document.getElementById('loading-overlay').style.display = 'flex';

            // Set random zen quote
            const quote = CONFIG.zenQuotes[Math.floor(Math.random() * CONFIG.zenQuotes.length)];
            document.getElementById('zen-quote').textContent = `每日禅语：${quote}`;

            if (window.lucide) {
                window.lucide.createIcons();
            }

            loadData();
            setupEventListeners();
            updateUI();

            // Fade in app
            setTimeout(() => {
                document.getElementById('loading-overlay').style.display = 'none';
                document.getElementById('app-container').classList.remove('opacity-0');
            }, 500);
        }

        // Run on DOM ready
        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>

</html>