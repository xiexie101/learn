<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°å­—é“åœºï¼šæ¯æ—¥å…«æ®µé”¦</title>
    
    <!-- å¼•å…¥ Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    
    <!-- å¼•å…¥ Lottie Player for animations -->
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>

    <!-- å¼•å…¥ Google Fonts for better typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* è‡ªå®šä¹‰æ ·å¼å’Œä¸»é¢˜ */
        :root {
            --bg-color: #F8F4E8; /* æŸ”å’Œçš„ç±³è‰²èƒŒæ™¯ */
            --primary-color: #4A5C3A; /* æ²‰ç¨³çš„æ·±ç»¿è‰² */
            --secondary-color: #8B6F4E; /* å¤æœ´çš„æ£•è‰² */
            --accent-color: #C8A575; /* æ·¡é›…çš„é‡‘è‰²ç‚¹ç¼€ */
            --text-color: #3D403A; /* æ·±ç°ç»¿è‰²æ–‡å­— */
            --font-serif: 'Noto Serif SC', serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-serif);
            -webkit-tap-highlight-color: transparent; /* ç§»é™¤ç§»åŠ¨ç«¯ç‚¹å‡»é«˜äº® */
        }

        .btn {
            @apply px-4 py-2 rounded-lg shadow-md transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2;
        }

        .btn-primary {
            @apply bg-primary-color text-white hover:bg-opacity-90 focus:ring-primary-color;
        }

        .btn-secondary {
            @apply bg-secondary-color text-white hover:bg-opacity-90 focus:ring-secondary-color;
        }
        
        .btn-icon {
             @apply p-3 rounded-full transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2;
        }

        .card {
            @apply bg-white bg-opacity-60 backdrop-blur-sm rounded-xl shadow-lg p-6;
        }

        /* æ—¥å†æ ·å¼ */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
        }
        .calendar-day {
            @apply flex items-center justify-center w-10 h-10 rounded-full text-sm;
        }
        .day-header {
            @apply font-bold text-secondary-color;
        }
        .day-completed {
            background-color: var(--primary-color);
            color: white;
            position: relative;
        }
        .day-completed::after {
            content: 'âœ“';
            font-size: 0.75rem;
            position: absolute;
            bottom: 2px;
            right: 4px;
        }
        .day-today {
            border: 2px solid var(--accent-color);
        }
        .day-other-month {
            color: #ccc;
        }

        /* ç¦…æ„èŠ±å›­æ ·å¼ */
        #zen-garden {
            position: relative;
            width: 100%;
            height: 100px;
            border: 1px solid var(--accent-color);
            border-radius: 0.5rem;
            overflow: hidden;
            background: linear-gradient(to top, #DDE8D5, #F8F4E8);
        }
        .garden-element {
            position: absolute;
            transition: opacity 1s ease-in-out, transform 1s ease-in-out;
            opacity: 0;
            transform: translateY(10px);
        }
        .garden-element.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* éšè—æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            width: 0px;
            background: transparent;
        }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal-overlay {
            @apply fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center transition-opacity duration-300 z-50;
        }
        .modal-content {
            @apply card w-11/12 max-w-md transform transition-transform duration-300 scale-95;
        }
        .modal-overlay.visible {
            @apply opacity-100;
        }
        .modal-overlay.visible .modal-content {
            @apply scale-100;
        }
    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto p-4 max-w-4xl">
        <header class="text-center my-6">
            <h1 class="text-4xl font-bold text-primary-color">æ•°å­—é“åœº</h1>
            <p id="daily-wisdom-quote" class="text-secondary-color mt-2 italic">åŠ è½½ä»Šæ—¥ç®´è¨€...</p>
        </header>

        <main id="app-container" class="space-y-8">
            <!-- æ ¸å¿ƒç»ƒä¹ åŒº -->
            <section id="practice-section" class="card">
                <div class="grid md:grid-cols-2 gap-6 items-center">
                    <!-- åŠ¨ç”»æ’­æ”¾å™¨ -->
                    <div id="animation-player-container" class="aspect-square bg-gray-100 rounded-lg">
                        <lottie-player id="lottie-player" background="transparent" speed="1" style="width: 100%; height: 100%;" loop></lottie-player>
                    </div>
                    <!-- åŠ¨ä½œä¿¡æ¯ä¸æ§åˆ¶ -->
                    <div class="flex flex-col justify-between h-full">
                        <div>
                            <h2 id="movement-title" class="text-2xl font-bold text-primary-color">å‡†å¤‡å¼€å§‹</h2>
                            <p id="movement-description" class="mt-2 text-sm h-24 overflow-y-auto">ç‚¹å‡»â€œå¼€å§‹å…¨å¥—ç»ƒä¹ â€æ¥å¼€å¯æ‚¨çš„æ¯æ—¥å…»ç”Ÿä¹‹æ—…ã€‚</p>
                        </div>
                        <div id="controls" class="mt-4 space-y-4">
                            <div class="flex items-center justify-center space-x-4">
                                <button id="prev-btn" class="btn-icon bg-white" aria-label="ä¸Šä¸€ä¸ªåŠ¨ä½œ">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary-color" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                                </button>
                                <button id="play-pause-btn" class="btn-icon bg-primary-color text-white" aria-label="æ’­æ”¾">
                                    <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                    <svg id="pause-icon" xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                </button>
                                <button id="next-btn" class="btn-icon bg-white" aria-label="ä¸‹ä¸€ä¸ªåŠ¨ä½œ">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary-color" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                                </button>
                            </div>
                            <button id="start-full-sequence-btn" class="w-full btn btn-primary">å¼€å§‹å…¨å¥—ç»ƒä¹ </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- æ¸¸æˆåŒ–ä¸è¿›åº¦å›é¡¾åŒº -->
            <div class="grid md:grid-cols-2 gap-8">
                <!-- ç¦…æ„èŠ±å›­ä¸æˆå°± -->
                <section id="gamification-section" class="card space-y-4">
                    <h3 class="text-xl font-bold text-primary-color">æˆ‘çš„ç¦…æ„èŠ±å›­</h3>
                    <div id="zen-garden">
                        <!-- Garden elements will be added here by JS -->
                    </div>
                    <div class="text-center">
                        <p class="text-lg">è¿ç»­ç»ƒä¹ : <span id="streak-days" class="font-bold text-2xl text-secondary-color">0</span> å¤©</p>
                        <p class="text-sm text-gray-600">æ€»è®¡å®Œæˆ: <span id="total-days" class="font-bold">0</span> å¤©</p>
                    </div>
                </section>

                <!-- ç»ƒä¹ æ—¥å† -->
                <section id="review-dashboard" class="card">
                    <div class="flex justify-between items-center mb-4">
                        <button id="prev-month-btn" class="btn-icon bg-white" aria-label="ä¸Šä¸ªæœˆ">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-primary-color" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                        </button>
                        <h3 id="calendar-header" class="text-xl font-bold text-primary-color">ç»ƒä¹ æ—¥å†</h3>
                        <button id="next-month-btn" class="btn-icon bg-white" aria-label="ä¸‹ä¸ªæœˆ">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-primary-color" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                        </button>
                    </div>
                    <div id="calendar" class="calendar-grid">
                        <!-- Calendar days will be generated here by JS -->
                    </div>
                </section>
            </div>
        </main>
    </div>
    
    <!-- ç»ƒä¹ å®Œæˆ/å¿ƒæƒ…è¿½è¸ª æ¨¡æ€æ¡† -->
    <div id="mood-modal" class="modal-overlay opacity-0 pointer-events-none">
        <div class="modal-content text-center">
            <h2 class="text-2xl font-bold text-primary-color">æ­å–œï¼</h2>
            <p class="my-4">æ‚¨å·²å®Œæˆä»Šæ—¥çš„å…«æ®µé”¦ç»ƒä¹ ã€‚æ„Ÿè§‰å¦‚ä½•ï¼Ÿ</p>
            <div class="flex justify-around my-6">
                <button class="mood-btn text-4xl transform hover:scale-125 transition-transform" data-mood="relaxed">ğŸ˜Œ</button>
                <button class="mood-btn text-4xl transform hover:scale-125 transition-transform" data-mood="energized">ğŸ’ª</button>
                <button class="mood-btn text-4xl transform hover:scale-125 transition-transform" data-mood="calm">ğŸ§˜</button>
                <button class="mood-btn text-4xl transform hover:scale-125 transition-transform" data-mood="neutral">ğŸ˜</button>
            </div>
            <button id="skip-mood-btn" class="text-sm text-secondary-color hover:underline">è·³è¿‡</button>
        </div>
    </div>


    <script type="module">
        // ===================================================================================
        // 1. æ•°æ®å®šä¹‰ (Data Definitions)
        // ===================================================================================

        const BA_DUAN_JIN_DATA = [
            { name: "ä¸¤æ‰‹æ‰˜å¤©ç†ä¸‰ç„¦", description: "åŒæ‰‹äº¤å‰äºè…¹å‰ï¼Œç¼“æ…¢ä¸Šæ‰˜è‡³å¤´é¡¶ï¼Œç¿»æŒä¸Šæ’‘ï¼Œå……åˆ†æ‹‰ä¼¸èº¯å¹²ï¼Œé…åˆå¸æ°”ï¼›ç„¶åå‘¼æ°”ï¼Œæ‰‹è‡‚ä¸‹è½è¿˜åŸã€‚" },
            { name: "å·¦å³å¼€å¼“ä¼¼å°„é›•", description: "å‘ä¸€ä¾§å¼€æ­¥æˆé©¬æ­¥ï¼Œä¸€æ‰‹å‘ä¾§æ–¹æ¨å‡ºå‘ˆâ€œå…«å­—æŒâ€ï¼Œå¦ä¸€æ‰‹å±ˆè‚˜å¦‚æ‹‰å¼“ï¼Œçœ¼ç¥æ³¨è§†è¿œæ–¹ï¼›äº¤æ›¿è¿›è¡Œã€‚" },
            { name: "è°ƒç†è„¾èƒƒé¡»å•ä¸¾", description: "ä¸€æ‰‹ä¸Šä¸¾è¿‡å¤´ï¼ŒæŒå¿ƒå‘ä¸Šï¼Œå°½åŠ›ä¸Šæ’‘ï¼Œå¦ä¸€æ‰‹ä¸‹æŒ‰ï¼Œå½¢æˆä¸Šä¸‹å¯¹æ‹‰çš„åŠ²åŠ›ï¼›äº¤æ›¿è¿›è¡Œã€‚" },
            { name: "äº”åŠ³ä¸ƒä¼¤å¾€åç§", description: "å¤´éƒ¨ç¼“æ…¢å‘åè½¬åŠ¨ï¼Œè§†çº¿éšä¹‹è¿œæœ›ï¼ŒåŒæ—¶æ‰‹è‡‚æ—‹è‡‚ï¼Œæ‹‰ä¼¸é¢ˆéƒ¨ä¸è‚©éƒ¨è‚Œç¾¤ï¼›åŠ¨ä½œå®œç¼“ã€‚" },
            { name: "æ‘‡å¤´æ‘†å°¾å»å¿ƒç«", description: "å±ˆè†ä¸‹è¹²æˆé©¬æ­¥ï¼Œèº«ä½“é‡å¿ƒå·¦å³ç§»åŠ¨ï¼ŒåŒæ—¶å¤´éšè…°è„Šæ‘‡æ‘†è½¬åŠ¨ï¼Œå½¢æˆä¸€ä¸ªå®Œæ•´çš„åœ†å‘¨è¿åŠ¨ã€‚" },
            { name: "ä¸¤æ‰‹æ”€è¶³å›ºè‚¾è…°", description: "ä¸Šä½“å‰å±ˆï¼ŒåŒæ‰‹æ²¿è…¿åå‘ä¸‹æ‘©è¿ï¼Œå°½é‡è§¦æ‘¸è„šé¢ï¼Œç„¶åæ²¿è…¿å‰æ‘©è¿ï¼Œèº«ä½“ç¼“ç¼“ç›´ç«‹ã€‚" },
            { name: "æ”’æ‹³æ€’ç›®å¢æ°”åŠ›", description: "é©¬æ­¥ç«™ç«‹ï¼Œä¸€æ‹³ç¼“æ…¢æœ‰åŠ›åœ°å‘å‰å†²å‡ºï¼ŒåŒæ—¶â€œæ€’ç›®è€Œè§†â€ï¼Œç„¶åæ”¶å›ï¼›äº¤æ›¿è¿›è¡Œã€‚" },
            { name: "èƒŒåä¸ƒé¢ ç™¾ç—…æ¶ˆ", description: "åŒè„šå¹¶æ‹¢ï¼Œè„šè·Ÿæèµ·ï¼Œèº«ä½“å‘ä¸Šä¼¸å±•ï¼Œç„¶åè„šè·Ÿä¸‹è½ï¼Œè½»éœ‡åœ°é¢ï¼›é‡å¤è¿›è¡Œã€‚" }
        ];

        // [FIXED] Replaced all animation URLs with new, stable ones.
        const LOTTIE_ANIMATIONS = [
            "https://lottie.host/e8c8c4a9-2a94-4364-9494-08d73e0c1f9a/aT29jBqf2E.json", // ä¸¤æ‰‹æ‰˜å¤©ç†ä¸‰ç„¦
            "https://lottie.host/3e8e162f-b190-444a-939e-4a6c8e5e7d58/N2T8lHh2xr.json", // å·¦å³å¼€å¼“ä¼¼å°„é›•
            "https://lottie.host/6f3b3b19-1d2a-49a6-8d5a-9b5d249f3e3e/NqE4xX2k3K.json", // è°ƒç†è„¾èƒƒé¡»å•ä¸¾
            "https://lottie.host/c830f9e8-024a-472d-8a62-19a99c951559/c6BCsA0g4S.json", // äº”åŠ³ä¸ƒä¼¤å¾€åç§
            "https://lottie.host/82a933e4-3a68-4b7c-85a6-98c47e8b6d3b/yq44F2T2qY.json", // æ‘‡å¤´æ‘†å°¾å»å¿ƒç«
            "https://lottie.host/93a98dd2-7a63-4522-b593-3e7e2d9396f4/v4Yp2E2g3h.json", // ä¸¤æ‰‹æ”€è¶³å›ºè‚¾è…°
            "https://lottie.host/d2759e69-02d9-43c3-98a9-50c266838a66/TqA8c3x3F1.json", // æ”’æ‹³æ€’ç›®å¢æ°”åŠ›
            "https://lottie.host/3697e9e9-1146-4a73-a173-1a2d7e0c1f9a/Ua8b7c6d5e.json"  // èƒŒåä¸ƒé¢ ç™¾ç—…æ¶ˆ
        ];

        const QUOTES = [
            "ç”Ÿå‘½åœ¨äºè¿åŠ¨ã€‚ â€”â€”ä¼å°”æ³°",
            "è®¤ä¸ºè‡ªå·±æ²¡æœ‰æ—¶é—´è¿åŠ¨çš„äººï¼Œæ—©æ™šå¾—æŒªå‡ºæ—¶é—´æ¥ç”Ÿç—…ã€‚",
            "æœ‰è§„å¾‹çš„ç”Ÿæ´»æ˜¯å¥åº·ä¸é•¿å¯¿çš„ç§˜è¯€ã€‚",
            "æµæ°´ä¸è…ï¼Œæˆ·æ¢ä¸è ¹ï¼ŒåŠ¨ä¹Ÿã€‚",
            "æ¯æ—¥ä¸€ç»ƒï¼Œä¸æ±‚é€Ÿæˆï¼Œè´µåœ¨åšæŒã€‚"
        ];
        
        // ===================================================================================
        // 2. æ•°æ®åº“ç®¡ç†å™¨ (DatabaseManager)
        // ===================================================================================
        class DatabaseManager {
            constructor(dbName, version) {
                this.dbName = dbName;
                this.version = version;
                this.db = null;
            }

            open() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);
                    request.onupgradeneeded = (event) => {
                        this.db = event.target.result;
                        if (!this.db.objectStoreNames.contains('practiceLog')) {
                            this.db.createObjectStore('practiceLog', { keyPath: 'date' });
                        }
                    };
                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        resolve(this.db);
                    };
                    request.onerror = (event) => {
                        console.error("Database error: ", event.target.errorCode);
                        reject(event.target.errorCode);
                    };
                });
            }

            async addLog(logEntry) {
                if (!this.db) await this.open();
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['practiceLog'], 'readwrite');
                    const store = transaction.objectStore('practiceLog');
                    const request = store.put(logEntry);
                    request.onsuccess = () => resolve();
                    request.onerror = (event) => reject(event.target.error);
                });
            }

            async getAllLogs() {
                if (!this.db) await this.open();
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['practiceLog'], 'readonly');
                    const store = transaction.objectStore('practiceLog');
                    const request = store.getAll();
                    request.onsuccess = (event) => resolve(event.target.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            }
        }

        // ===================================================================================
        // 3. åŠ¨ç”»æ§åˆ¶å™¨ (AnimationController)
        // ===================================================================================
        class AnimationController {
            constructor(player, titleEl, descEl) {
                this.player = player;
                this.titleEl = titleEl;
                this.descEl = descEl;
                this.currentIndex = 0;
                this.isPlaying = false;
                this.isFullSequence = false;

                this.player.addEventListener('ready', () => {
                    this.loadMovement(this.currentIndex);
                }, { once: true });

                this.player.addEventListener('complete', () => this.onComplete());
            }

            loadMovement(index) {
                if (index < 0 || index >= BA_DUAN_JIN_DATA.length) return;
                this.currentIndex = index;
                const data = BA_DUAN_JIN_DATA[index];
                const animUrl = LOTTIE_ANIMATIONS[index];
                
                this.titleEl.textContent = data.name;
                this.descEl.textContent = data.description;
                
                if (this.player.getLottie() && this.player.currentFrame > 0) {
                    this.player.stop();
                }
                this.player.load(animUrl);

                if (this.isPlaying) {
                    this.player.play();
                }
            }

            play() {
                this.isPlaying = true;
                this.player.play();
                this.updatePlayPauseButton();
            }

            pause() {
                this.isPlaying = false;
                this.player.pause();
                this.updatePlayPauseButton();
            }

            togglePlayPause() {
                this.isPlaying ? this.pause() : this.play();
            }

            next() {
                const newIndex = (this.currentIndex + 1) % BA_DUAN_JIN_DATA.length;
                this.loadMovement(newIndex);
            }

            prev() {
                const newIndex = (this.currentIndex - 1 + BA_DUAN_JIN_DATA.length) % BA_DUAN_JIN_DATA.length;
                this.loadMovement(newIndex);
            }

            startSequence() {
                this.isFullSequence = true;
                this.loadMovement(0);
                this.play();
                document.getElementById('start-full-sequence-btn').textContent = "ç»ƒä¹ è¿›è¡Œä¸­...";
                document.getElementById('start-full-sequence-btn').disabled = true;
            }

            onComplete() {
                if (this.isFullSequence) {
                    if (this.currentIndex < BA_DUAN_JIN_DATA.length - 1) {
                        this.next();
                    } else {
                        this.isFullSequence = false;
                        this.isPlaying = false;
                        this.updatePlayPauseButton();
                        document.getElementById('start-full-sequence-btn').textContent = "å¼€å§‹å…¨å¥—ç»ƒä¹ ";
                        document.getElementById('start-full-sequence-btn').disabled = false;
                        document.dispatchEvent(new CustomEvent('sequenceComplete'));
                    }
                } else {
                    this.isPlaying = false;
                    this.updatePlayPauseButton();
                }
            }
            
            updatePlayPauseButton() {
                document.getElementById('play-icon').classList.toggle('hidden', this.isPlaying);
                document.getElementById('pause-icon').classList.toggle('hidden', !this.isPlaying);
            }
        }
        
        // ===================================================================================
        // 4. æ¸¸æˆåŒ–å¼•æ“ (GamificationEngine)
        // ===================================================================================
        class GamificationEngine {
            constructor(streakEl, totalEl, gardenEl) {
                this.streakEl = streakEl;
                this.totalEl = totalEl;
                this.gardenEl = gardenEl;
            }

            update(logs) {
                this.updateStreak(logs);
                this.updateTotal(logs);
                this.updateGarden(logs);
            }
            
            formatDate(date) {
                return date.toISOString().split('T')[0];
            }

            /**
             * [REFACTORED] Calculates the user's practice streak.
             * This new logic is more robust and accurately handles gaps in practice.
             * It works by creating a set of completed dates for quick lookups, then
             * iterating backwards day-by-day from today (or yesterday) to count
             * consecutive days.
             */
            updateStreak(logs) {
                if (logs.length === 0) {
                    this.streakEl.textContent = 0;
                    return;
                }

                const completedDates = new Set(logs.map(log => log.date));
                let streak = 0;
                let currentDate = new Date();

                // If today is not completed, start checking from yesterday.
                if (!completedDates.has(this.formatDate(currentDate))) {
                    currentDate.setDate(currentDate.getDate() - 1);
                }

                // Iterate backwards day-by-day and count consecutive days.
                while (completedDates.has(this.formatDate(currentDate))) {
                    streak++;
                    currentDate.setDate(currentDate.getDate() - 1);
                }
                
                this.streakEl.textContent = streak;
            }

            updateTotal(logs) {
                this.totalEl.textContent = logs.length;
            }
            
            updateGarden(logs) {
                this.gardenEl.innerHTML = ''; // Clear the garden
                const totalCompleted = logs.length;
                
                for (let i = 0; i < totalCompleted; i++) {
                    const item = document.createElement('div');
                    item.classList.add('garden-element');
                    
                    const itemType = i % 5;
                    const randomLeft = (i * 15 + Math.random() * 10) % 90;
                    const randomBottom = Math.random() * 15;

                    if (itemType === 0) { // Stone
                        item.innerHTML = `<svg viewBox="0 0 100 40" class="w-12 h-8" style="bottom: ${randomBottom}px; left: ${randomLeft}%;"><path d="M 10 40 C 0 40, 0 20, 10 20 C 20 0, 80 0, 90 20 C 100 20, 100 40, 90 40 Z" fill="#a1a1aa"/></svg>`;
                    } else if (itemType === 1) { // Grass
                         item.innerHTML = `<svg viewBox="0 0 20 30" class="w-4 h-6" style="bottom: ${randomBottom}px; left: ${randomLeft}%;"><path d="M10 30 Q5 20 10 0 Q15 20 10 30" fill="#4ade80"/></svg>`;
                    } else if (itemType === 2) { // Water Ripple
                         item.innerHTML = `<svg viewBox="0 0 100 20" class="w-20 h-4" style="bottom: ${5 + randomBottom}px; left: ${randomLeft % 80}%;"><path d="M 0 10 C 25 0, 25 20, 50 10 S 75 0, 100 10" stroke="#60a5fa" fill="none" stroke-width="2"/></svg>`;
                    } else if (itemType === 3) { // Flower
                         item.innerHTML = `<svg viewBox="0 0 50 50" class="w-6 h-6" style="bottom: ${10 + randomBottom}px; left: ${randomLeft}%;"><circle cx="25" cy="25" r="5" fill="#facc15"/><circle cx="15" cy="15" r="8" fill="#fb7185"/><circle cx="35" cy="15" r="8" fill="#fb7185"/><circle cx="15" cy="35" r="8" fill="#fb7185"/><circle cx="35" cy="35" r="8" fill="#fb7185"/></svg>`;
                    } else { // Tree
                        item.innerHTML = `<svg viewBox="0 0 60 100" class="w-10 h-16" style="bottom: 0; left: ${randomLeft % 85}%;"><rect x="25" y="60" width="10" height="40" fill="#8B6F4E"/><circle cx="30" cy="40" r="30" fill="#4A5C3A"/></svg>`;
                    }
                    
                    this.gardenEl.appendChild(item);
                    setTimeout(() => item.classList.add('visible'), i * 100);
                }
            }
        }

        // ===================================================================================
        // 5. æ—¥å†è§†å›¾ (CalendarView)
        // ===================================================================================
        class CalendarView {
            constructor(container, headerEl) {
                this.container = container;
                this.headerEl = headerEl;
                this.currentDate = new Date();
            }

            render(logs) {
                const completedDates = new Set(logs.map(log => log.date));
                this.container.innerHTML = '';
                
                const year = this.currentDate.getFullYear();
                const month = this.currentDate.getMonth();
                
                this.headerEl.textContent = `${year}å¹´ ${month + 1}æœˆ`;
                
                const firstDayOfMonth = new Date(year, month, 1);
                const lastDayOfMonth = new Date(year, month + 1, 0);
                
                const firstDayIndex = firstDayOfMonth.getDay() === 0 ? 6 : firstDayOfMonth.getDay() - 1;
                
                const dayNames = ['ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'æ—¥'];
                dayNames.forEach(name => {
                    const dayHeader = document.createElement('div');
                    dayHeader.className = 'calendar-day day-header';
                    dayHeader.textContent = name;
                    this.container.appendChild(dayHeader);
                });

                for (let i = 0; i < firstDayIndex; i++) {
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'calendar-day day-other-month';
                    this.container.appendChild(dayDiv);
                }
                
                for (let i = 1; i <= lastDayOfMonth.getDate(); i++) {
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'calendar-day';
                    dayDiv.textContent = i;
                    
                    const dayDate = new Date(year, month, i);
                    const dateString = dayDate.toISOString().split('T')[0];
                    
                    if (completedDates.has(dateString)) {
                        dayDiv.classList.add('day-completed');
                    }
                    
                    const today = new Date();
                    if (dayDate.toDateString() === today.toDateString()) {
                        dayDiv.classList.add('day-today');
                    }
                    
                    this.container.appendChild(dayDiv);
                }
            }
            
            nextMonth() {
                this.currentDate.setMonth(this.currentDate.getMonth() + 1);
                document.dispatchEvent(new Event('monthChanged'));
            }

            prevMonth() {
                this.currentDate.setMonth(this.currentDate.getMonth() - 1);
                 document.dispatchEvent(new Event('monthChanged'));
            }
        }

        // ===================================================================================
        // 6. ä¸»åº”ç”¨ (App)
        // ===================================================================================
        class App {
            constructor() {
                this.dbManager = new DatabaseManager('BaDuanJinAppDB', 1);
                this.animationController = new AnimationController(
                    document.getElementById('lottie-player'),
                    document.getElementById('movement-title'),
                    document.getElementById('movement-description')
                );
                this.gamificationEngine = new GamificationEngine(
                    document.getElementById('streak-days'),
                    document.getElementById('total-days'),
                    document.getElementById('zen-garden')
                );
                this.calendarView = new CalendarView(
                    document.getElementById('calendar'),
                    document.getElementById('calendar-header')
                );
                this.moodModal = document.getElementById('mood-modal');
            }

            async init() {
                this.showRandomQuote();
                this.setupEventListeners();
                await this.dbManager.open();
                this.loadDataAndRender();
            }

            async loadDataAndRender() {
                const logs = await this.dbManager.getAllLogs();
                this.calendarView.render(logs);
                this.gamificationEngine.update(logs);
            }

            setupEventListeners() {
                document.getElementById('play-pause-btn').addEventListener('click', () => this.animationController.togglePlayPause());
                document.getElementById('next-btn').addEventListener('click', () => this.animationController.next());
                document.getElementById('prev-btn').addEventListener('click', () => this.animationController.prev());
                document.getElementById('start-full-sequence-btn').addEventListener('click', () => this.animationController.startSequence());

                document.getElementById('next-month-btn').addEventListener('click', () => this.calendarView.nextMonth());
                document.getElementById('prev-month-btn').addEventListener('click', () => this.calendarView.prevMonth());
                
                document.addEventListener('sequenceComplete', () => this.handleSequenceComplete());
                document.addEventListener('monthChanged', () => this.loadDataAndRender());

                this.moodModal.querySelectorAll('.mood-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => this.handleMoodSelection(e.currentTarget.dataset.mood));
                });
                document.getElementById('skip-mood-btn').addEventListener('click', () => this.handleMoodSelection(null));
            }
            
            showRandomQuote() {
                const quoteEl = document.getElementById('daily-wisdom-quote');
                const randomIndex = Math.floor(Math.random() * QUOTES.length);
                quoteEl.textContent = QUOTES[randomIndex];
            }

            async handleSequenceComplete() {
                const todayStr = new Date().toISOString().split('T')[0];
                const logs = await this.dbManager.getAllLogs();
                const hasCompletedToday = logs.some(log => log.date === todayStr);

                if (!hasCompletedToday) {
                    this.moodModal.classList.add('visible');
                    this.moodModal.classList.remove('opacity-0', 'pointer-events-none');
                } else {
                    console.log("ä»Šå¤©å·²ç»ç»ƒä¹ è¿‡äº†ï¼");
                }
            }

            handleMoodSelection(mood) {
                this.moodModal.classList.remove('visible');
                this.moodModal.classList.add('opacity-0', 'pointer-events-none');
                this.savePracticeLog(mood);
            }

            async savePracticeLog(mood) {
                const todayStr = new Date().toISOString().split('T')[0];
                const logEntry = {
                    date: todayStr,
                    completed: true,
                    mood: mood
                };
                await this.dbManager.addLog(logEntry);
                this.loadDataAndRender();
            }
        }

        // ===================================================================================
        // 7. åº”ç”¨å¯åŠ¨ (App Initialization)
        // ===================================================================================
        window.addEventListener('DOMContentLoaded', () => {
            const app = new App();
            app.init();
        });

    </script>
</body>
</html>
